head	1.14;
access;
symbols
	binutils-2_24-branch:1.14.0.8
	binutils-2_24-branchpoint:1.14
	binutils-2_21_1:1.13
	binutils-2_23_2:1.14
	binutils-2_23_1:1.14
	binutils-2_23:1.14
	binutils-2_23-branch:1.14.0.6
	binutils-2_23-branchpoint:1.14
	binutils-2_22_branch:1.14.0.4
	binutils-2_22:1.14
	binutils-2_22-branch:1.14.0.2
	binutils-2_22-branchpoint:1.14
	binutils-2_21:1.13
	binutils-2_21-branch:1.13.0.4
	binutils-2_21-branchpoint:1.13
	binutils-2_20_1:1.13
	binutils-2_20:1.13
	binutils-arc-20081103-branch:1.12.0.8
	binutils-arc-20081103-branchpoint:1.12
	binutils-2_20-branch:1.13.0.2
	binutils-2_20-branchpoint:1.13
	dje-cgen-play1-branch:1.12.0.6
	dje-cgen-play1-branchpoint:1.12
	arc-20081103-branch:1.12.0.4
	arc-20081103-branchpoint:1.12
	binutils-2_19_1:1.12
	binutils-2_19:1.12
	binutils-2_19-branch:1.12.0.2
	binutils-2_19-branchpoint:1.12
	binutils-2_18:1.10.2.1
	binutils-2_18-branch:1.10.0.2
	binutils-2_18-branchpoint:1.10
	binutils-csl-coldfire-4_1-32:1.7
	binutils-csl-sourcerygxx-4_1-32:1.7
	binutils-csl-innovasic-fido-3_4_4-33:1.7
	binutils-csl-sourcerygxx-3_4_4-32:1.6
	binutils-csl-coldfire-4_1-30:1.7
	binutils-csl-sourcerygxx-4_1-30:1.7
	binutils-csl-coldfire-4_1-28:1.7
	binutils-csl-sourcerygxx-4_1-29:1.7
	binutils-csl-sourcerygxx-4_1-28:1.7
	binutils-csl-arm-2006q3-27:1.7
	binutils-csl-sourcerygxx-4_1-27:1.7
	binutils-csl-arm-2006q3-26:1.7
	binutils-csl-sourcerygxx-4_1-26:1.7
	binutils-csl-sourcerygxx-4_1-25:1.7
	binutils-csl-sourcerygxx-4_1-24:1.7
	binutils-csl-sourcerygxx-4_1-23:1.7
	binutils-csl-sourcerygxx-4_1-21:1.7
	binutils-csl-arm-2006q3-21:1.7
	binutils-csl-sourcerygxx-4_1-22:1.7
	binutils-csl-palmsource-arm-prelinker-1_0-1:1.7
	binutils-csl-sourcerygxx-4_1-20:1.7
	binutils-csl-arm-2006q3-19:1.7
	binutils-csl-sourcerygxx-4_1-19:1.7
	binutils-csl-sourcerygxx-4_1-18:1.7
	binutils-csl-renesas-4_1-9:1.7
	binutils-csl-sourcerygxx-3_4_4-25:1.6
	binutils-csl-renesas-4_1-8:1.7
	binutils-csl-renesas-4_1-7:1.7
	binutils-csl-renesas-4_1-6:1.7
	binutils-csl-sourcerygxx-4_1-17:1.7
	binutils-csl-sourcerygxx-4_1-14:1.7
	binutils-csl-sourcerygxx-4_1-15:1.7
	binutils-csl-sourcerygxx-4_1-13:1.7
	binutils-2_17:1.7
	binutils-csl-sourcerygxx-4_1-12:1.7
	binutils-csl-sourcerygxx-3_4_4-21:1.7
	binutils-csl-wrs-linux-3_4_4-24:1.6
	binutils-csl-wrs-linux-3_4_4-23:1.6
	binutils-csl-sourcerygxx-4_1-9:1.7
	binutils-csl-sourcerygxx-4_1-8:1.7
	binutils-csl-sourcerygxx-4_1-7:1.7
	binutils-csl-arm-2006q1-6:1.7
	binutils-csl-sourcerygxx-4_1-6:1.7
	binutils-csl-wrs-linux-3_4_4-22:1.6
	binutils-csl-coldfire-4_1-11:1.7
	binutils-csl-sourcerygxx-3_4_4-19:1.7
	binutils-csl-coldfire-4_1-10:1.7
	binutils-csl-sourcerygxx-4_1-5:1.7
	binutils-csl-sourcerygxx-4_1-4:1.7
	binutils-csl-wrs-linux-3_4_4-21:1.6
	binutils-csl-morpho-4_1-4:1.7
	binutils-csl-sourcerygxx-3_4_4-17:1.7
	binutils-csl-wrs-linux-3_4_4-20:1.6
	binutils-2_17-branch:1.7.0.4
	binutils-2_17-branchpoint:1.7
	binutils-csl-2_17-branch:1.7.0.2
	binutils-csl-2_17-branchpoint:1.7
	binutils-csl-gxxpro-3_4-branch:1.6.0.6
	binutils-csl-gxxpro-3_4-branchpoint:1.6
	binutils-2_16_1:1.6
	binutils-csl-arm-2005q1b:1.6
	binutils-2_16:1.6
	binutils-csl-arm-2005q1a:1.6
	binutils-csl-arm-2005q1-branch:1.6.0.4
	binutils-csl-arm-2005q1-branchpoint:1.6
	binutils-2_16-branch:1.6.0.2
	binutils-2_16-branchpoint:1.6
	csl-arm-2004-q3d:1.5
	csl-arm-2004-q3:1.5
	binutils-2_15:1.4
	binutils-2_15-branchpoint:1.4
	csl-arm-2004-q1a:1.4
	csl-arm-2004-q1:1.4
	binutils-2_15-branch:1.4.0.8
	cagney_bfdfile-20040213-branch:1.4.0.6
	cagney_bfdfile-20040213-branchpoint:1.4
	cagney_bigcore-20040122-branch:1.4.0.4
	cagney_bigcore-20040122-branchpoint:1.4
	csl-arm-2003-q4:1.4
	binutils-2_14:1.4
	binutils-2_14-branch:1.4.0.2
	binutils-2_14-branchpoint:1.4
	binutils-2_13_2_1:1.3
	binutils-2_13_2:1.3
	binutils-2_13_1:1.3
	binutils-2_13:1.3
	binutils-2_13-branchpoint:1.3
	binutils-2_13-branch:1.3.0.4
	binutils-2_12_1:1.3
	binutils-2_12:1.3
	binutils-2_12-branch:1.3.0.2
	binutils-2_12-branchpoint:1.3
	cygnus_cvs_20020108_pre:1.3
	binutils_latest_snapshot:1.14;
locks; strict;
comment	@# @;


1.14
date	2011.04.13.07.50.15;	author nickc;	state Exp;
branches;
next	1.13;

1.13
date	2009.09.02.07.22.33;	author amodra;	state Exp;
branches;
next	1.12;

1.12
date	2007.10.26.06.45.07;	author amodra;	state Exp;
branches;
next	1.11;

1.11
date	2007.08.09.11.43.03;	author amodra;	state Exp;
branches;
next	1.10;

1.10
date	2007.07.05.16.54.45;	author nickc;	state Exp;
branches
	1.10.2.1;
next	1.9;

1.9
date	2007.01.08.17.21.49;	author nickc;	state Exp;
branches;
next	1.8;

1.8
date	2006.09.20.11.35.11;	author nickc;	state Exp;
branches;
next	1.7;

1.7
date	2005.05.08.14.17.41;	author nickc;	state Exp;
branches;
next	1.6;

1.6
date	2005.03.03.11.46.15;	author amodra;	state Exp;
branches;
next	1.5;

1.5
date	2004.05.12.03.28.45;	author bje;	state Exp;
branches;
next	1.4;

1.4
date	2003.04.22.17.31.08;	author nickc;	state Exp;
branches;
next	1.3;

1.3
date	2001.07.27.16.16.07;	author hjl;	state Exp;
branches;
next	1.2;

1.2
date	2001.07.24.19.24.09;	author hjl;	state Exp;
branches;
next	1.1;

1.1
date	2001.07.18.23.56.41;	author dj;	state Exp;
branches;
next	;

1.10.2.1
date	2007.08.09.11.45.03;	author amodra;	state Exp;
branches;
next	;


desc
@@


1.14
log
@	* windres.c (usage): Add new --preprocessor-arg option.
	(option_values): Add new OPTION_PREPROCESSOR_ARG enumerator.
	(option long_options): Add preprocessor-arg option.
	(main): Handle it.
	* doc/binutils.texi: Add documentation for --preprocessor-arg
	option.
	* NEWS: Add line about new --preprocessor-arg option for windres.

	* binutils-all/windres/windres.exp: Add '// cpparg <option>' command
	to rc file interpretation to specify addition pre-processor commands
	as script option.
	* binutils-all/windres/strtab3.rc: New.
	* binutils-all/windres/strtab3.rsd: New.
	* binutils-all/windres/README: Add note about cpparg script option.
	argument
@
text
@# Copyright 2001, 2003, 2004, 2006, 2007, 2009 Free Software Foundation, Inc.

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.

# Please email any bugs, comments, and/or additions to this file to:
# bug-dejagnu@@prep.ai.mit.edu

# Written by DJ Delorie <dj@@redhat.com>

if {![istarget "i*86-*-*"] && ![istarget "x86_64-*-mingw*"] } {
    return
}

if {![info exists WINDRES]} then {
    return
}

if {[which $WINDRES] == 0} then {
    return
}

set wr "$WINDRES --include-dir $srcdir/$subdir"

if [file exists "$srcdir/../../winsup/w32api/include"] {
    set wr "$wr --include-dir $srcdir/../../winsup/w32api/include"
} else {
    send_log "\nWarning: Assuming windres can find the win32 headers\n\n"
}

set res_list [lsort [glob -nocomplain $srcdir/$subdir/*.rc]]

proc oneline { file } {
    while { 1 } {
	if { [gets $file line] == -1 } {
	    return ""
	}
	if [regexp "^ \[0-9a-z\]\[0-9a-z\]* " $line] {
	    return $line
	}
    }
}

foreach res $res_list {
    set sroot [file rootname $res]
    set broot [file tail $sroot]
    set done 0
    set cpp_opts ""

    set rc [open $res]
    while { [gets $rc line] != -1 } {
	if ![regexp "^(//|/\*|#)" $line] {
	    break
	}
	if [regexp "\[xp\]fail *(\[^ \]*)" $line junk sys] {
	    setup_xfail $sys
	    continue
	}
	if [regexp "cpparg *(\[^ \]*)" $line junk cppopt] {
	    set cpp_opts "--preprocessor-arg \"$cppopt\""
	    continue
	}
    }

    verbose "$wr -J rc -O res $res tmpdir/$broot.res" 1
    catch "exec $wr $cpp_opts -J rc -O res $res tmpdir/$broot.res" err

    if ![string match "" $err] then {
	send_log "$err\n"
	verbose "$err" 1
	if [string match "*windows.h: No such file*" $err] then {
	    unsupported "windres/$broot (parse)"
	} else {
	    fail "windres/$broot (parse)"
	}
	continue
    }
    pass "windres/$broot (parse)"

    set rc [open $res]
    while { [gets $rc line] != -1 } {
	if ![regexp "^(//|/\*|#)" $line] {
	    break
	}
	if [regexp "parse-only" $line] {
	    file delete "tmpdir/$broot.res"
	    set done 1
	    break
	}
	if [regexp "\[xc\]fail *(\[^ \]*)" $line junk sys] {
	    setup_xfail $sys
	    continue
	}
    }
    if { $done != 0 } {
	continue
    }

    verbose "$OBJDUMP -b binary -s tmpdir/$broot.res > tmpdir/$broot.dump" 1
    catch "exec $OBJDUMP -b binary -s tmpdir/$broot.res > tmpdir/$broot.dump" err

    if ![string match "" $err] then {
	send_log "$err\n"
	verbose "$err" 1
	fail "windres/$broot (compare)"
	continue
    }

    set pat [open "$sroot.rsd"]
    set out [open "tmpdir/$broot.dump"]
    set patline "foo"

    while { ![string match $patline ""] } {
	set patline [oneline $pat]
	set outline [oneline $out]

	if ![string match $patline $outline] {
	    send_log "< $patline\n"
	    send_log "> $outline\n"
	    fail "windres/$broot (compare)"
	    set done 1
	    break
	}
    }
    if { $done == 0 } {
	pass "windres/$broot (compare)"
	file delete "tmpdir/$broot.res"
	file delete "tmpdir/$broot.dump"
    }
}
@


1.13
log
@update copyright dates
@
text
@d59 1
d70 4
d77 1
a77 1
    catch "exec $wr -J rc -O res $res tmpdir/$broot.res" err
@


1.12
log
@	* binutils-all/windres/windres.exp: Don't xfail.
@
text
@d1 1
a1 1
# Copyright 2001, 2003, 2004, 2006, 2007 Free Software Foundation, Inc.
@


1.11
log
@	* windres/windres.exp: Return unsupported rather than fail if
	windows.h not found.
@
text
@a25 9
if {![istarget "i*86-*-*pe*"] \
    && ![istarget "i*86-*-cygwin*"] \
    && ![istarget "i*86-*-mingw32*"] \
    && ![istarget "x86_64-*-mingw*"] } {
    set target_xfail "yes"
} else {
    set target_xfail "no"
}

a37 1
    set target_xfail "no"
a70 4
    if { "$broot" != "bmpalign" && "$target_xfail" == "yes" } {
	setup_xfail *-*
    }

a104 4
    if { "$broot" != "bmpalign" && "$target_xfail" == "yes" } {
	setup_xfail *-*
    }

@


1.10
log
@Change sources over to using GPLv3
@
text
@d91 5
a95 1
	fail "windres/$broot (parse)"
@


1.10.2.1
log
@binutils/testsuite/
	* binutils-all/copy-2.d (not-target): Match *-*-*aout.
	* binutils-all/copy-3.d (not-target): Likewise.
	* binutils-all/objcopy.exp (objcopy_test): Remove extraneous
	setup_xfail.
	* windres/windres.exp: Return unsupported rather than fail if
	windows.h not found.
gas/testsuite/
	* gas/all/weakref1u.d (not-target): Match *-*-*aout.
@
text
@d91 1
a91 5
	if [string match "*windows.h: No such file*" $err] then {
	    unsupported "windres/$broot (parse)"
	} else {
	    fail "windres/$broot (parse)"
	}
@


1.9
log
@Renamed target x86_64-*-mingw64 to x86_64-*-mingw*.
@
text
@d1 1
a1 1
# Copyright 2001, 2003, 2004, 2006 Free Software Foundation, Inc.
d5 1
a5 1
# the Free Software Foundation; either version 2 of the License, or
@


1.8
log
@Add x86_64-mingw64 target
@
text
@d22 1
a22 1
if {![istarget "i*86-*-*"] && ![istarget "x86_64-*-mingw64"] } {
d29 1
a29 1
    && ![istarget "x86_64-*-mingw64*"] } {
@


1.7
log
@Update FSF address
@
text
@d1 1
a1 1
# Copyright 2001, 2003, 2004 Free Software Foundation, Inc.
d22 1
a22 1
if {![istarget "i*86-*-*"]} {
d28 2
a29 1
    && ![istarget "i*86-*-mingw32*"] } {
@


1.6
log
@update copyright dates
@
text
@d15 1
a15 1
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
@


1.5
log
@	* binutils-all/ar.exp: Remove stray semicolons.
	* binutils-all/dlltool.exp: Likewise.
	* binutils-all/objcopy.exp: Likewise.
	* binutils-all/readelf.exp: Likewise.
	* binutils-all/windres/windres.exp: Likewise.
	* lib/utils-lib.exp: Likewise.
@
text
@d1 1
a1 1
# Copyright 2001, 2003 Free Software Foundation, Inc.
@


1.4
log
@Rename -I to -J.   Deprecate old use of -I, but leave it enabled for now.
@
text
@d76 1
a76 1
	    continue;
d91 1
a91 1
	continue;
d103 1
a103 1
	    break;
d107 1
a107 1
	    continue;
d111 1
a111 1
	continue;
d125 1
a125 1
	continue;
d137 3
a139 3
	    send_log "< $patline\n";
	    send_log "> $outline\n";
	    fail "windres/$broot (compare)";
d141 1
a141 1
	    break;
@


1.3
log
@2001-07-27  H.J. Lu  <hjl@@gnu.org>

	* binutils-all/windres/windres.exp: Don't set xfail for
	bmpalign (compare) on none-ix86/pe targets.
@
text
@d1 1
a1 1
# Copyright 2001 Free Software Foundation, Inc.
d84 2
a85 2
    verbose "$wr -I rc -O res $res tmpdir/$broot.res" 1
    catch "exec $wr -I rc -O res $res tmpdir/$broot.res" err
@


1.2
log
@2001-07-24  H.J. Lu  <hjl@@gnu.org>

	* binutils-all/windres/windres.exp: Set xfail on none-ix86/pe
	targets.
@
text
@d114 1
a114 1
    if { "$target_xfail" == "yes" } {
@


1.1
log
@* config/default.exp (WINDRES): Add.
* binutils-all/windres/windres.exp: New.
* binutils-all/windres/README: New.
* binutils-all/windres/bmp1.bmp: New.
* binutils-all/windres/bmpalign.rc: New.
* binutils-all/windres/bmpalign.rsd: New.
* binutils-all/windres/lang.rc: New.
* binutils-all/windres/lang.rsd: New.
* binutils-all/windres/msupdate: New.
* binutils-all/windres/strtab1.rc: New.
* binutils-all/windres/strtab1.rsd: New.
@
text
@d26 8
d46 1
d80 4
d112 4
@

