head	1.1;
access;
symbols
	binutils-2_24-branch:1.1.0.40
	binutils-2_24-branchpoint:1.1
	binutils-2_21_1:1.1
	binutils-2_23_2:1.1
	binutils-2_23_1:1.1
	binutils-2_23:1.1
	binutils-2_23-branch:1.1.0.38
	binutils-2_23-branchpoint:1.1
	binutils-2_22_branch:1.1.0.36
	binutils-2_22:1.1
	binutils-2_22-branch:1.1.0.34
	binutils-2_22-branchpoint:1.1
	binutils-2_21:1.1
	binutils-2_21-branch:1.1.0.32
	binutils-2_21-branchpoint:1.1
	binutils-2_20_1:1.1
	binutils-2_20:1.1
	binutils-arc-20081103-branch:1.1.0.30
	binutils-arc-20081103-branchpoint:1.1
	binutils-2_20-branch:1.1.0.28
	binutils-2_20-branchpoint:1.1
	dje-cgen-play1-branch:1.1.0.26
	dje-cgen-play1-branchpoint:1.1
	arc-20081103-branch:1.1.0.24
	arc-20081103-branchpoint:1.1
	binutils-2_19_1:1.1
	binutils-2_19:1.1
	binutils-2_19-branch:1.1.0.22
	binutils-2_19-branchpoint:1.1
	binutils-2_18:1.1
	binutils-2_18-branch:1.1.0.20
	binutils-2_18-branchpoint:1.1
	binutils-csl-coldfire-4_1-32:1.1
	binutils-csl-sourcerygxx-4_1-32:1.1
	binutils-csl-innovasic-fido-3_4_4-33:1.1
	binutils-csl-sourcerygxx-3_4_4-32:1.1
	binutils-csl-coldfire-4_1-30:1.1
	binutils-csl-sourcerygxx-4_1-30:1.1
	binutils-csl-coldfire-4_1-28:1.1
	binutils-csl-sourcerygxx-4_1-29:1.1
	binutils-csl-sourcerygxx-4_1-28:1.1
	binutils-csl-arm-2006q3-27:1.1
	binutils-csl-sourcerygxx-4_1-27:1.1
	binutils-csl-arm-2006q3-26:1.1
	binutils-csl-sourcerygxx-4_1-26:1.1
	binutils-csl-sourcerygxx-4_1-25:1.1
	binutils-csl-sourcerygxx-4_1-24:1.1
	binutils-csl-sourcerygxx-4_1-23:1.1
	binutils-csl-sourcerygxx-4_1-21:1.1
	binutils-csl-arm-2006q3-21:1.1
	binutils-csl-sourcerygxx-4_1-22:1.1
	binutils-csl-palmsource-arm-prelinker-1_0-1:1.1
	binutils-csl-sourcerygxx-4_1-20:1.1
	binutils-csl-arm-2006q3-19:1.1
	binutils-csl-sourcerygxx-4_1-19:1.1
	binutils-csl-sourcerygxx-4_1-18:1.1
	binutils-csl-renesas-4_1-9:1.1
	binutils-csl-sourcerygxx-3_4_4-25:1.1
	binutils-csl-renesas-4_1-8:1.1
	binutils-csl-renesas-4_1-7:1.1
	binutils-csl-renesas-4_1-6:1.1
	binutils-csl-sourcerygxx-4_1-17:1.1
	binutils-csl-sourcerygxx-4_1-14:1.1
	binutils-csl-sourcerygxx-4_1-15:1.1
	binutils-csl-sourcerygxx-4_1-13:1.1
	binutils-2_17:1.1
	binutils-csl-sourcerygxx-4_1-12:1.1
	binutils-csl-sourcerygxx-3_4_4-21:1.1
	binutils-csl-wrs-linux-3_4_4-24:1.1
	binutils-csl-wrs-linux-3_4_4-23:1.1
	binutils-csl-sourcerygxx-4_1-9:1.1
	binutils-csl-sourcerygxx-4_1-8:1.1
	binutils-csl-sourcerygxx-4_1-7:1.1
	binutils-csl-arm-2006q1-6:1.1
	binutils-csl-sourcerygxx-4_1-6:1.1
	binutils-csl-wrs-linux-3_4_4-22:1.1
	binutils-csl-coldfire-4_1-11:1.1
	binutils-csl-sourcerygxx-3_4_4-19:1.1
	binutils-csl-coldfire-4_1-10:1.1
	binutils-csl-sourcerygxx-4_1-5:1.1
	binutils-csl-sourcerygxx-4_1-4:1.1
	binutils-csl-wrs-linux-3_4_4-21:1.1
	binutils-csl-morpho-4_1-4:1.1
	binutils-csl-sourcerygxx-3_4_4-17:1.1
	binutils-csl-wrs-linux-3_4_4-20:1.1
	binutils-2_17-branch:1.1.0.18
	binutils-2_17-branchpoint:1.1
	binutils-csl-2_17-branch:1.1.0.16
	binutils-csl-2_17-branchpoint:1.1
	binutils-csl-gxxpro-3_4-branch:1.1.0.14
	binutils-csl-gxxpro-3_4-branchpoint:1.1
	binutils-2_16_1:1.1
	binutils-csl-arm-2005q1b:1.1
	binutils-2_16:1.1
	binutils-csl-arm-2005q1a:1.1
	binutils-csl-arm-2005q1-branch:1.1.0.12
	binutils-csl-arm-2005q1-branchpoint:1.1
	binutils-2_16-branch:1.1.0.10
	binutils-2_16-branchpoint:1.1
	csl-arm-2004-q3d:1.1
	csl-arm-2004-q3:1.1
	binutils-2_15:1.1
	binutils-2_15-branchpoint:1.1
	csl-arm-2004-q1a:1.1
	csl-arm-2004-q1:1.1
	binutils-2_15-branch:1.1.0.8
	cagney_bfdfile-20040213-branch:1.1.0.6
	cagney_bfdfile-20040213-branchpoint:1.1
	cagney_bigcore-20040122-branch:1.1.0.4
	cagney_bigcore-20040122-branchpoint:1.1
	csl-arm-2003-q4:1.1
	binutils-2_14:1.1
	binutils-2_14-branch:1.1.0.2
	binutils-2_14-branchpoint:1.1
	binutils_latest_snapshot:1.1;
locks; strict;
comment	@# @;


1.1
date	2003.01.24.23.44.45;	author jakub;	state Exp;
branches;
next	;


desc
@@


1.1
log
@bfd/
	* elf32-sparc.c (_bfd_sparc_elf_howto_table): Add TLS relocs.
	(elf32_sparc_rev32_howto): New variable.
	(sparc_reloc_map): Add TLS relocs.
	(elf32_sparc_reloc_type_lookup, elf32_sparc_info_to_howto):
	Handle REV32.
	(sparc_elf_hix22_reloc, sparc_elf_lox10_reloc, elf32_sparc_mkobject):
	New functions.
	(struct elf32_sparc_dyn_relocs, struct elf32_sparc_link_hash_entry,
	struct elf32_sparc_link_hash_table):
	New structures.
	(elf32_sparc_tdata, elf32_sparc_local_got_tls_type,
	elf32_sparc_hash_table): Define.
	(link_hash_newfunc, elf32_sparc_link_hash_table_create,
	create_got_section, elf32_sparc_create_dynamic_sections,
	elf32_sparc_copy_indirect_symbol, elf32_sparc_tls_transition): New
	functions.
	(elf32_sparc_check_relocs): Handle TLS relocs.  Add dynamic reloc
	reference counting.
	(elf32_sparc_gc_sweep_hook): Likewise.
	(elf32_sparc_adjust_dynamic_symbol): Likewise.
	(elf32_sparc_size_dynamic_sections): Likewise.
	(elf32_sparc_relocate_section): Likewise.
	(allocate_dynrelocs, readonly_dynrelocs, dtpoff_base, tpoff):
	New functions.
	(elf32_sparc_object_p): Allocate backend private object data.
	(bfd_elf32_bfd_link_hash_table_create,
	elf_backend_copy_indirect_symbol, bfd_elf32_mkobject,
	elf_backend_can_refcount): Define.
	(elf_backend_create_dynamic_sections): Define to
	elf32_sparc_create_dynamic_sections.
	* reloc.c: Add SPARC TLS relocs.
	* bfd-in2.h, libbfd.h: Rebuilt.
	* elf64-sparc.c (sparc64_elf_howto_table): Add TLS relocs.
	(sparc_reloc_map): Likewise.
gas/
	* config/tc-sparc.c (sparc_ip): Handle TLS % operators.
	(tc_gen_reloc): Handle TLS relocs.
	(sparc_cons, cons_fix_new_sparc): Handle %r_tls_dtpoff.
	* config/tc-sparc.h (tc_fix_adjustable): Don't adjust TLS
	relocs.
	* config/obj-elf.c (obj_elf_section_word): Handle tls.
	(obj_elf_type): Handle tls_object.
include/
	* elf/sparc.h: Add TLS relocs.  Move R_SPARC_REV32 to 252.
ld/testsuite/
	* ld-sparc/sparc.exp: New.
	* ld-sparc/tlsg32.s: New test.
	* ld-sparc/tlsg32.sd: Likewise.
	* ld-sparc/tlsg64.s: Likewise.
	* ld-sparc/tlsg64.sd: Likewise.
	* ld-sparc/tlslib.s: Likewise.
	* ld-sparc/tlsnopic.s: Likewise.
	* ld-sparc/tlspic.s: Likewise.
	* ld-sparc/tlssunbin32.dd: Likewise.
	* ld-sparc/tlssunbin32.rd: Likewise.
	* ld-sparc/tlssunbin32.s: Likewise.
	* ld-sparc/tlssunbin32.sd: Likewise.
	* ld-sparc/tlssunbin32.td: Likewise.
	* ld-sparc/tlssunbin64.dd: Likewise.
	* ld-sparc/tlssunbin64.rd: Likewise.
	* ld-sparc/tlssunbin64.s: Likewise.
	* ld-sparc/tlssunbin64.sd: Likewise.
	* ld-sparc/tlssunbin64.td: Likewise.
	* ld-sparc/tlssunbinpic32.s: Likewise.
	* ld-sparc/tlssunbinpic64.s: Likewise.
	* ld-sparc/tlssunnopic32.dd: Likewise.
	* ld-sparc/tlssunnopic32.rd: Likewise.
	* ld-sparc/tlssunnopic32.s: Likewise.
	* ld-sparc/tlssunnopic32.sd: Likewise.
	* ld-sparc/tlssunnopic64.dd: Likewise.
	* ld-sparc/tlssunnopic64.rd: Likewise.
	* ld-sparc/tlssunnopic64.s: Likewise.
	* ld-sparc/tlssunnopic64.sd: Likewise.
	* ld-sparc/tlssunpic32.dd: Likewise.
	* ld-sparc/tlssunpic32.rd: Likewise.
	* ld-sparc/tlssunpic32.s: Likewise.
	* ld-sparc/tlssunpic32.sd: Likewise.
	* ld-sparc/tlssunpic32.td: Likewise.
	* ld-sparc/tlssunpic64.dd: Likewise.
	* ld-sparc/tlssunpic64.rd: Likewise.
	* ld-sparc/tlssunpic64.s: Likewise.
	* ld-sparc/tlssunpic64.sd: Likewise.
	* ld-sparc/tlssunpic64.td: Likewise.
@
text
@	.data
	.align	4096
	.section ".tdata", #alloc, #write, #tls
	.align	4
	.globl sg1, sg2, sg3, sg4, sg5, sg6, sg7, sg8
	.globl sh1, sh2, sh3, sh4, sh5, sh6, sh7, sh8
	.hidden sh1, sh2, sh3, sh4, sh5, sh6, sh7, sh8
sg1:	.word 17
sg2:	.word 18
sg3:	.word 19
sg4:	.word 20
sg5:	.word 21
sg6:	.word 22
sg7:	.word 23
sg8:	.word 24
sl1:	.word 65
sl2:	.word 66
sl3:	.word 67
sl4:	.word 68
sl5:	.word 69
sl6:	.word 70
sl7:	.word 71
sl8:	.word 72
sh1:	.word 257
sh2:	.word 258
sh3:	.word 259
sh4:	.word 260
sh5:	.word 261
sh6:	.word 262
sh7:	.word 263
sh8:	.word 264

	.text
	.align	4096
.LLGETPC0:
	retl
	add	%o7, %l7, %l7

	.globl	fn1
	.type	fn1,#function
	.proc	04
fn1:
	save	%sp, -160, %sp
	sethi	%hi(_GLOBAL_OFFSET_TABLE_-4), %l7
	call	.LLGETPC0
	add	%l7, %lo(_GLOBAL_OFFSET_TABLE_+4), %l7
	nop;nop;nop;nop

	/* GD */
	sethi	%tgd_hi22(sg1), %l1
	nop
	add	%l1, %tgd_lo10(sg1), %l2
	nop
	add	%l7, %l2, %o0, %tgd_add(sg1)
	nop
	call	__tls_get_addr, %tgd_call(sg1)
	nop
	nop;nop;nop;nop

	/* GD -> IE because variable is referenced through IE too */
	sethi	%tgd_hi22(sg2), %o0
	add	%o0, %tgd_lo10(sg2), %o1
	add	%l7, %o1, %o0, %tgd_add(sg2)
	call	__tls_get_addr, %tgd_call(sg2)
	nop
	nop;nop;nop;nop

	/* GD against local variable */
	sethi	%tgd_hi22(sl1), %o4
	add	%o4, %tgd_lo10(sl1), %o4
	add	%l7, %o4, %o0, %tgd_add(sl1)
	call	__tls_get_addr, %tgd_call(sl1)
	nop
	nop;nop;nop;nop

	/* GD -> IE against local variable referenced through IE too */
	sethi	%tgd_hi22(sl2), %o0
	add	%o0, %tgd_lo10(sl2), %o0
	add	%l7, %o0, %o0, %tgd_add(sl2)
	call	__tls_get_addr, %tgd_call(sl2)
	nop
	nop;nop;nop;nop

	/* GD against hidden and local variable */
	sethi	%tgd_hi22(sh1), %o4
	add	%o4, %tgd_lo10(sh1), %o4
	add	%l7, %o4, %o0, %tgd_add(sh1)
	call	__tls_get_addr, %tgd_call(sh1)
	nop
	nop;nop;nop;nop

	/* GD -> IE against hidden and local variable referenced through
	   IE too */
	sethi	%tgd_hi22(sh2), %o0
	add	%o0, %tgd_lo10(sh2), %o0
	add	%l7, %o0, %o0, %tgd_add(sh2)
	call	__tls_get_addr, %tgd_call(sh2)
	nop
	nop;nop;nop;nop

	/* GD against hidden but not local variable */
	sethi	%tgd_hi22(sH1), %o4
	add	%o4, %tgd_lo10(sH1), %o4
	add	%l7, %o4, %o0, %tgd_add(sH1)
	call	__tls_get_addr, %tgd_call(sH1)
	nop
	nop;nop;nop;nop

	/* GD -> IE against hidden but not local variable referenced through
	   IE too */
	sethi	%tgd_hi22(sH2), %o0
	add	%o0, %tgd_lo10(sH2), %o0
	add	%l7, %o0, %o0, %tgd_add(sH2)
	call	__tls_get_addr, %tgd_call(sH2)
	nop
	nop;nop;nop;nop

	/* LD */
	sethi	%tldm_hi22(sl1), %l1
	nop
	add	%l1, %tldm_lo10(sl1), %l2
	nop
	add	%l7, %l2, %o0, %tldm_add(sl1)
	nop
	call	__tls_get_addr, %tldm_call(sl1)
	nop
	sethi	%tldo_hix22(sl1), %l3
	nop
	xor	%l3, %tldo_lox10(sl1), %l4
	nop
	add	%o0, %l4, %l5, %tldo_add(sl1)
	nop
	sethi	%tldo_hix22(sl2 + 2), %l2
	nop
	xor	%l2, %tldo_lox10(sl2 + 2), %l3
	nop
	lduh	[%o0 + %l3], %l6, %tldo_add(sl2 + 2)
	nop;nop;nop;nop

	/* LD against hidden and local variables */
	sethi	%tldm_hi22(sh1), %o1
	sethi	%tldo_hix22(sh1), %l3
	add	%o1, %tldm_lo10(sh1), %o2
	sethi	%tldo_hix22(sh2 + 1), %l2
	add	%l7, %o2, %o0, %tldm_add(sh1)
	xor	%l3, %tldo_lox10(sh1), %l4
	call	__tls_get_addr, %tldm_call(sh1)
	xor	%l2, %tldo_lox10(sh2 + 1), %l3
	ldx	[%o0 + %l4], %l5, %tldo_add(sh1)
	add	%o0, %l3, %l6, %tldo_add(sh2 + 1)
	nop;nop;nop;nop

	/* LD against hidden but not local variables */
	sethi	%tldm_hi22(sH1), %o1
	sethi	%tldo_hix22(sH1 + 3), %l3
	add	%o1, %tldm_lo10(sH1), %o2
	sethi	%tldo_hix22(sH2), %l2
	add	%l7, %o2, %o0, %tldm_add(sH1)
	xor	%l3, %tldo_lox10(sH1 + 3), %l4
	call	__tls_get_addr, %tldm_call(sH1)
	xor	%l2, %tldo_lox10(sH2), %l3
	add	%o0, %l4, %l5, %tldo_add(sH1 + 3)
	ld	[%o0 + %l3], %l6, %tldo_add(sH2)
	nop;nop;nop;nop

	/* IE against global var  */
	sethi	%tie_hi22(sg2), %l1
	nop
	add	%l1, %tie_lo10(sg2), %l2
	nop
	ldx	[%l7 + %l2], %l2, %tie_ldx(sg2)
	nop
	add	%g7, %l2, %l2, %tie_add(sg2)
	nop;nop;nop;nop

	/* IE against local var  */
	sethi	%tie_hi22(sl2), %o3
	add	%o3, %tie_lo10(sl2), %o3
	ldx	[%l7 + %o3], %o2, %tie_ldx(sl2)
	add	%g7, %o2, %o4, %tie_add(sl2)
	nop;nop;nop;nop

	/* IE against hidden and local var  */
	sethi	%tie_hi22(sh2), %l1
	add	%l1, %tie_lo10(sh2), %l2
	ldx	[%l7 + %l2], %l2, %tie_ldx(sh2)
	add	%g7, %l2, %l2, %tie_add(sh2)
	nop;nop;nop;nop

	/* IE against hidden but not local var  */
	sethi	%tie_hi22(sH2), %l1
	add	%l1, %tie_lo10(sH2), %l2
	ldx	[%l7 + %l2], %l2, %tie_ldx(sH2)
	add	%g7, %l2, %l2, %tie_add(sH2)
	nop;nop;nop;nop

	/* Direct access through %g7  */

	/* IE against global var  */
	sethi	%tie_hi22(sg5), %l1
	add	%l1, %tie_lo10(sg5), %l2
	ldx	[%l7 + %l2], %l2, %tie_ldx(sg5)
	ldx	[%g7 + %l2], %l2, %tie_add(sg5)
	nop;nop;nop;nop

	/* IE against local var  */
	sethi	%tie_hi22(sl5), %o3
	add	%o3, %tie_lo10(sl5), %o4
	ldx	[%l7 + %o4], %o5, %tie_ldx(sl5)
	stb	%l2, [%g7 + %o5], %tie_add(sl5)
	nop;nop;nop;nop

	/* IE against hidden and local var  */
	sethi	%tie_hi22(sh5), %o3
	add	%o3, %tie_lo10(sh5), %o4
	ldx	[%l7 + %o4], %o5, %tie_ldx(sh5)
	stx	%l2, [%g7 + %o5], %tie_add(sh5)
	nop;nop;nop;nop

	/* IE against hidden but not local var  */
	sethi	%tie_hi22(sH5), %o3
	add	%o3, %tie_lo10(sH5), %o4
	ldx	[%l7 + %o4], %o5, %tie_ldx(sH5)
	st	%l2, [%g7 + %o5], %tie_add(sH5)
	nop;nop;nop;nop

	return	%i7 + 8
	nop
@
