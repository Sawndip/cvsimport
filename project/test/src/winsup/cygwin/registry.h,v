head	1.14;
access;
symbols
	cygwin-1_7_35-release:1.14
	cygwin-1_7_34-release:1.14
	cygwin-1_7_33-release:1.13
	cygwin-1_7_32-release:1.13
	cygwin-1_7_31-release:1.13
	cygwin-1_7_30-release:1.13
	cygwin-1_7_29-release:1.13
	cygwin-1_7_29-release-branchpoint:1.13.0.4
	cygwin-pre-user-db:1.13
	cygwin-1_7_28-release:1.13
	cygwin-1_7_27-release:1.13
	cygwin-1_7_26-release:1.13
	cygwin-1_7_25-release:1.13
	cygwin-1_7_24-release:1.13
	cygwin-1_7_23-release:1.13
	cygwin-1_7_22-release:1.13
	cygwin-1_7_21-release:1.13
	cygwin-1_7_20-release:1.13
	cygwin-1_7_19-release:1.13
	cygwin-64bit-postmerge:1.13
	cygwin-64bit-premerge-branch:1.13.0.2
	cygwin-64bit-premerge:1.13
	cygwin-1_7_18-release:1.13
	post-ptmalloc3:1.12.4.1
	pre-ptmalloc3:1.12.4.1
	cygwin-1_7_17-release:1.12
	cygwin-64bit-branch:1.12.0.4
	cygwin-1_7_16-release:1.12
	cygwin-1_7_15-release:1.12
	cygwin-1_7_14_2-release:1.12
	cygwin-1_7_14-release:1.12
	cygwin-1_7_12-release:1.12
	cygwin-1_7_11-release:1.12
	cygwin-1_7_10-release:1.12
	signal-rewrite:1.12.0.2
	pre-notty:1.12
	cygwin-1_7_9-release:1.10
	cv-post-1_7_9:1.10.0.2
	cygwin-1_7_8-release:1.10
	cygwin-1_7_7-release:1.10
	cygwin-1_7_5-release:1.9
	cygwin-1_7_4-release:1.9
	cygwin-1_7_3-release:1.9
	cygwin-1_7_2-release:1.9
	fifo_doover3:1.9.0.2
	cygwin-1_7_1-release:1.9
	prefifo:1.8
	cv-branch-2:1.8.0.2
	pre-ripout-set_console_state_for_spawn:1.8
	EOL_registry_mounts:1.8
	preoverlapped:1.6
	drop_9x_support_start:1.6
	cr-0x5f1:1.6.0.8
	cv-branch:1.6.0.6
	pre-ptymaster-archetype:1.6
	cr-0x3b58:1.6.0.4
	cr-0x5ef:1.6.0.2
	after-mmap-privanon-noreserve:1.5
	after-mmap-revamp:1.5
	before-mmap-revamp:1.5
	cgf-more-exit-sync:1.5
	post_wait_sig_exit:1.5
	pre_wait_sig_exit:1.5
	reparent-point:1.3
	noreparent:1.3.0.18
	cr-0x5e6:1.3.0.16
	cr-0x9e:1.3.0.14
	cr-0x9d:1.3.0.12
	cgf-deleteme:1.3.0.10
	pre-sigrewrite:1.3
	corinna-01:1.3
	cr-0x9c:1.3.0.8
	cr-0x9b:1.3.0.6
	cr-0x99:1.3
	Z-emcb-cygwin_daemon:1.3.0.2
	w32api-2_2:1.3
	mingw-runtime-2_4:1.3
	pre-cgf-merge:1.3
	cgf-dev-branch:1.3.0.56
	predaemon:1.3
	cygwin_daemon_merge_HEAD:1.3
	pregp02r1:1.3.0.34
	cygnus_cvs_20020108_pre:1.3
	Z-cygwin_daemon_merge-new_HEAD:1.3
	Z-cygwin_daemon_merge_HEAD:1.3
	cygwin_daemon:1.3.0.4;
locks; strict;
comment	@ * @;


1.14
date	2014.12.02.10.49.47;	author corinna;	state Exp;
branches;
next	1.13;

1.13
date	2013.01.21.04.38.28;	author cgf;	state Exp;
branches;
next	1.12;

1.12
date	2011.04.23.13.15.46;	author corinna;	state Exp;
branches
	1.12.4.1;
next	1.11;

1.11
date	2011.04.19.10.02.06;	author corinna;	state Exp;
branches;
next	1.10;

1.10
date	2010.05.18.14.30.51;	author cgf;	state Exp;
branches;
next	1.9;

1.9
date	2009.10.20.14.54.47;	author corinna;	state Exp;
branches;
next	1.8;

1.8
date	2008.04.01.13.22.46;	author corinna;	state Exp;
branches;
next	1.7;

1.7
date	2008.02.14.16.47.11;	author corinna;	state Exp;
branches;
next	1.6;

1.6
date	2006.01.03.17.44.26;	author cgf;	state Exp;
branches;
next	1.5;

1.5
date	2004.12.03.02.00.37;	author phumblet;	state Exp;
branches;
next	1.4;

1.4
date	2004.11.20.19.09.18;	author phumblet;	state Exp;
branches;
next	1.3;

1.3
date	2001.09.11.20.01.00;	author cgf;	state Exp;
branches;
next	1.2;

1.2
date	2001.06.24.22.26.52;	author cgf;	state Exp;
branches;
next	1.1;

1.1
date	2000.09.08.02.56.54;	author cgf;	state Exp;
branches;
next	;

1.12.4.1
date	2013.01.21.13.52.10;	author corinna;	state Exp;
branches;
next	;


desc
@@


1.14
log
@	* autoload.cc (CreateProfile): Import.
	(LoadUserProfileW): Import.
	* registry.cc (get_registry_hive_path): Move to sec_auth.cc.
	(load_registry_hive): Remove.
	* registry.h (get_registry_hive_path): Drop declaration.
	(load_registry_hive): Ditto.
	* sec_auth.cc (get_user_profile_directory): Moved from registry.cc and
	renamed.  Take third parameter with buffer length.
	(load_user_profile): New function taking over for load_registry_hive.
	Use official functions to load profile.  If profile is missing, create
	it on Vista and later.
	* security.h (get_user_profile_directory): Declare.
	(load_user_profile): Declare.
	* syscalls.cc (seteuid32): Replace call to load_registry_hive with call
	to load_user_profile.
	* uinfo.cc (cygheap_user::env_userprofile): Replace call to
	get_registry_hive_path with call to get_user_profile_directory.
@
text
@/* registry.h: shared info for cygwin

   Copyright 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
   2011, 2012, 2014 Red Hat, Inc.

This file is part of Cygwin.

This software is a copyrighted work licensed under the terms of the
Cygwin license.  Please consult the file "CYGWIN_LICENSE" for
details. */

class reg_key
{
private:

  HANDLE key;
  NTSTATUS key_is_invalid;
  DWORD _disposition;

public:

  reg_key (HKEY toplev, REGSAM access, ...);
  reg_key (bool isHKLM, REGSAM access, ...);

  void *operator new (size_t, void *p) {return p;}
  void build_reg (HKEY key, REGSAM access, va_list av);

  bool error () {return key == NULL;}

  DWORD get_dword (PCWSTR, DWORD);
  NTSTATUS get_string (PCWSTR, PWCHAR, size_t, PCWSTR);

  NTSTATUS set_dword (PCWSTR, DWORD);
  NTSTATUS set_string (PCWSTR, PCWSTR);

  bool created () const {return _disposition & REG_CREATED_NEW_KEY;}

  ~reg_key ();
};
@


1.13
log
@Throughout, update copyrights to reflect dates which correspond to main-branch
checkins.  Regularize copyright format.
@
text
@d4 1
a4 1
   2011 Red Hat, Inc.
a39 4

/* Evaluates path to the directory of the local user registry hive */
PWCHAR __stdcall get_registry_hive_path (PCWSTR name, PWCHAR path);
void __stdcall load_registry_hive (PCWSTR name);
@


1.12
log
@	* registry.cc (reg_key::get_dword): Rename from get_int, use DWORD
	rather than int type.  Avoid compiler warning.
	(reg_key::set_dword): Rename from set_int, use DWORD rather than int
	type.  Change return type to NTSTATUS.
	(reg_key::get_string): Change return type to NTSTATUS.
	(reg_key::set_string): Ditto.
	* registry.h: Accommodate above changes.
	* environ.cc (regopt): Test return value of reg_key::get_string as
	NTSTATUS.
	* sched.cc (sched_rr_get_interval): Change local int vars to DWORD.
	Call reg_key::get_dword instead of reg_key::get_int.
	* shared.cc (init_installation_root): Test return value of
	reg_key::get_string as NTSTATUS.
	(shared_info::heap_slop_size): Call reg_key::get_dword rather than
	reg_key::get_int.
	(shared_info::heap_chunk_size): Ditto.
	* shared_info.h (CURR_SHARED_MAGIC): Update.
	(class shared_info): Change heap_chunk and heap_slop to DWORD  values.
@
text
@d3 2
a4 2
   Copyright 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009,
   2010, 2011 Red Hat, Inc.
@


1.12.4.1
log
@Pull in changes from HEAD
@
text
@d3 2
a4 2
   Copyright 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
   2011 Red Hat, Inc.
@


1.11
log
@	* Makefile.in (DLL_IMPORTS): Drop advapi32.dll.
	* autoload.cc: Enable autoloading advapi32 functions.
	* environ.cc (regopt): Use wide char arguments in reg_key functions.
	* fhandler_console.cc (beep): Ditto.  Use WCHAR throughout.
	* registry.cc (reg_key): Rewrite reg_key class to use native NT registry
	functions.  Use WCHAR string parameters throughout.  Use PCWSTR rather
	than const WCHAR.  Drop multibyte char functionality.  Drop unused
	methods.
	(get_registry_hive_path): Use RtlQueryRegistryValues to fetch path from
	registry.
	(load_registry_hive): Drop useless check for user hive being available.
	Load hive using NtLoadKey.
	* registry.h: Accommodate above changes.
	* sched.cc (sched_rr_get_interval): Use wide char arguments in reg_key
	functions.
	* shared.cc (init_installation_root): Ditto.
	(shared_info::init_obcaseinsensitive): Use RtlQueryRegistryValues to
	fetch obcaseinsensitive value.
	(shared_info::heap_slop_size): Use wide char arguments in reg_key
	functions.
	(shared_info::heap_chunk_size): Ditto.
	* syscalls.cc (gethostid): Ditto.
	* winsup.h (__WIDE): Define.
	(_WIDE): Define.
	* libc/minires-os-if.c (get_registry_dns_items): Don't fetch values
	from registry.  Just extract them from given UNICODE_STRING parameter.
	(get_registry_dns): Fetch all registry values at once using
	RtlQueryRegistryValues.
@
text
@d28 1
a28 1
  int error () {return key == NULL;}
d30 2
a31 2
  int get_int (PCWSTR, int);
  int get_string (PCWSTR, PWCHAR, size_t, PCWSTR);
d33 2
a34 2
  int set_int (PCWSTR, int);
  int set_string (PCWSTR, PCWSTR);
@


1.10
log
@* environ.cc (regopt): Change the first argument to wide char string.
(environ_init): Accommodate change to the first argument of regopt.
* exception.cc (open_stackdumpfile): Accommodate change to the type of progname
in _pinfo.
* external.cc (fillout_pinfo): Ditto.
* fhandler_process.cc (format_process_winexename): Ditto.
(format_process_stat): Ditto.
* fork.cc (fork::parent): Ditto.
* pinfo.cc (pinfo_basic::pinfo_basic): Call GetModuleFileNameW instead of
GetModuleFileName.
(pinfo::thisproc): Accommodate change to the type of progname in _pinfo.
(pinfo_init): Ditto.
* pinfo.h (_pinfo): Change the type of progname to a wide char array.
* registry.h (reg_key::get_int): Change the first argument from constant point
to pointer to constant.
(reg_key::get_string): Ditto.  Change the last argument likewise.
* registry.cc (reg_key::get_int): Accommodate change to the declaration.
(reg_key::get_string): Ditto.
* strace.cc (strace::hello): Accommodate change to the type of progname in
_pinfo.
(strace::vsprntf): Ditto.
@
text
@d3 2
a4 1
   Copyright 2000, 2001, 2004, 2006, 2008 Red Hat, Inc.
d16 2
a17 2
  HKEY key;
  LONG key_is_invalid;
d28 1
a28 1
  int error () {return key == (HKEY) INVALID_HANDLE_VALUE;}
d30 2
a31 2
  int kill (const char *child);
  int killvalue (const char *name);
d33 2
a34 11
  HKEY get_key ();

  int get_int (const char *, int);
  int get_int (const WCHAR *, int);
  int get_string (const char *, char *, size_t, const char *);
  int get_string (const WCHAR *, PWCHAR, size_t, const WCHAR *);

  int set_int (const char *, int);
  int set_int (const PWCHAR, int);
  int set_string (const char *, const char *);
  int set_string (const PWCHAR, const PWCHAR);
d42 2
a43 2
PWCHAR __stdcall get_registry_hive_path (const PWCHAR name, PWCHAR path);
void __stdcall load_registry_hive (const PWCHAR name);
@


1.9
log
@	* registry.cc (reg_key::get_int): Add alternative implementation
	taking WCHAR strings.
	(reg_key::set_int): Ditto.
	(reg_key::get_string): Ditto.
	(reg_key::set_string): Ditto.
	* registry.h (struct reg_key): Add prototypes for added methods.
@
text
@d35 1
a35 1
  int get_int (const PWCHAR, int);
d37 1
a37 1
  int get_string (const PWCHAR, PWCHAR, size_t, const PWCHAR);
@


1.8
log
@	* Fix copyright dates.
@
text
@d33 11
a43 4
  int get_int (const char *,int def);
  int get_string (const char *, char *buf, size_t len, const char *def);
  int set_string (const char *,const char *);
  int set_int (const char *, int val);
@


1.7
log
@	* cygheap.cc (cwcsdup): New function.
	(cwcsdup1): New function.
	* cygheap.h (cygheap_user::get_windows_id): New method returning PWCHAR.
	(cwcsdup): Declare.
	(cwcsdup1): Declare.
	* registry.cc (get_registry_hive_path): Use WCHAR instead of char
	throughout.
	(load_registry_hive): Ditto.
	* registry.h (get_registry_hive_path): Change declaration accordingly.
	(load_registry_hive): Ditto.
	* sec_helper.cc (cygpsid::string): New method returning PWCHAR.
	* security.h (cygpsid::string): Declare.
	* syscalls.cc (seteuid32): Convert local name var to WCHAR.
	* uinfo.cc (cygheap_user::env_userprofile): Convert local name buffers
	to WCHAR.  Call sys_wcstombs_alloc to generate puserprof buffer.

	* winsup.h: Fix comment.
	(NT_MAX_PATH): New definition for maximum internal path length.
	Use throughout where appropriate.
	* include/limits.h (PATH_MAX): Set to 4096 as on Linux.
@
text
@d3 1
a3 1
   Copyright 2000, 2001, 2004, 2006 Red Hat, Inc.
@


1.6
log
@* dir.cc (readdir_worker): Minor code cleanup.
* fhandler_console.cc (beep): Use a more Windows-generic wav file if the beep
is missing.  Use a more foolproof way to find out whether we should be
recreating the missing key.
* registry.h (reg_key::_disposition): New field.
(reg_key::created): New function.
* registry.cc (reg_key::reg_key): Set _disposition to zero by default.
(reg_key::build_key): Fill in _disposition field.
@
text
@d43 2
a44 2
char *__stdcall get_registry_hive_path (const char *name, char *path);
void __stdcall load_registry_hive (const char *name);
@


1.5
log
@2004-12-03  Pierre Humblet <pierre.humblet@@ieee.org>

	* registry.h (reg_key::reg_key): Change arguments.
	* shared_info.h (class mount_info): Remove had_to_create_mount_areas.
	* registry.cc (reg_key::reg_key): Change constructors to always handle
	HKLM and to avoid relying on HKCU.
	Do not set mount_table->had_to_create_mount_areas.
	* path.cc (mount_info::conv_to_win32_path): Improve update of
	sys_mount_table_counter.
	(mount_info::read_mounts): Use new reg_key constructor.
	(mount_info::add_reg_mount): Ditto.
	(mount_info::del_reg_mount): Ditto.
	(mount_info::read_cygdrive_info_from_registry): Ditto.
	(mount_info::write_cygdrive_info_to_registry): Ditto.
	Update cygwin_shared->sys_mount_table_counter after registry update.
	(mount_info::get_cygdrive_info): Ditto.
	* shared.cc (shared_info::heap_chunk_size): Use new reg_key constructor.
	* environ.cc (regopt): Ditto.
@
text
@d3 1
a3 1
   Copyright 2000, 2001 Red Hat, Inc.
d17 1
d37 1
@


1.4
log
@2004-11-20  Pierre Humblet <pierre.humblet@@ieee.org>

	* cygheap.h (cygheap_user::get_windows_id): New method.
	* registry.h (get_registry_hive_path): Change argument type.
	(load_registry_hive): Ditto.
	* registry.cc (get_registry_hive_path): Change argument type and take
	Win9x keys into account.
	(load_registry_hive): Ditto.
	* uinfo.cc (cygheap_user::env_userprofile): Use get_windows_id, even
	for SYSTEM.
	* shared.cc (user_shared_initialize): Use get_windows_id.
	* syscalls.cc (seteuid32): Load the registry hive and reload the user
	shared also on Win9x.
@
text
@d21 1
a21 2
  reg_key (REGSAM access, ...);
  reg_key (REGSAM access = KEY_ALL_ACCESS);
@


1.3
log
@Update copyrights.
@
text
@d42 2
a43 2
char *__stdcall get_registry_hive_path (const PSID psid, char *path);
void __stdcall load_registry_hive (PSID psid);
@


1.2
log
@forced commit
@
text
@d3 1
a3 1
   Copyright 2000 Cygnus Solutions.
@


1.1
log
@Break out more header info into separate files.  Use appropriate header files
throughout.
* shared.h: Remove.
* cygwin_version.h: New file.
* delqueue.h: New file.
* environ.h: New file.
* host_dependent.h: New file.
* perprocess.h: New file.
* registry.h: New file.
* security.h: New file.
@
text
@@

