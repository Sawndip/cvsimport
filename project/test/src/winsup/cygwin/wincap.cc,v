head	1.134;
access;
symbols
	cygwin-1_7_35-release:1.134
	cygwin-1_7_34-release:1.134
	cygwin-1_7_33-release:1.132
	cygwin-1_7_32-release:1.132
	cygwin-1_7_31-release:1.132
	cygwin-1_7_30-release:1.132
	cygwin-1_7_29-release:1.132
	cygwin-1_7_29-release-branchpoint:1.132.0.2
	cygwin-pre-user-db:1.132
	cygwin-1_7_28-release:1.132
	cygwin-1_7_27-release:1.132
	cygwin-1_7_26-release:1.132
	cygwin-1_7_25-release:1.129
	cygwin-1_7_24-release:1.129
	cygwin-1_7_23-release:1.129
	cygwin-1_7_22-release:1.129
	cygwin-1_7_21-release:1.129
	cygwin-1_7_20-release:1.128
	cygwin-1_7_19-release:1.128
	cygwin-64bit-postmerge:1.128
	cygwin-64bit-premerge-branch:1.127.0.2
	cygwin-64bit-premerge:1.127
	cygwin-1_7_18-release:1.127
	post-ptmalloc3:1.125.2.3
	pre-ptmalloc3:1.125.2.3
	cygwin-1_7_17-release:1.125
	cygwin-64bit-branch:1.125.0.2
	cygwin-1_7_16-release:1.124
	cygwin-1_7_15-release:1.124
	cygwin-1_7_14_2-release:1.123
	cygwin-1_7_14-release:1.123
	cygwin-1_7_12-release:1.122
	cygwin-1_7_11-release:1.122
	cygwin-1_7_10-release:1.120
	signal-rewrite:1.118.0.2
	pre-notty:1.117
	cygwin-1_7_9-release:1.110
	cv-post-1_7_9:1.108.0.2
	cygwin-1_7_8-release:1.107
	cygwin-1_7_7-release:1.101
	cygwin-1_7_5-release:1.99
	cygwin-1_7_4-release:1.99
	cygwin-1_7_3-release:1.99
	cygwin-1_7_2-release:1.99
	fifo_doover3:1.98.0.2
	cygwin-1_7_1-release:1.97
	prefifo:1.94
	cv-branch-2:1.92.0.2
	pre-ripout-set_console_state_for_spawn:1.86
	EOL_registry_mounts:1.83
	preoverlapped:1.78
	drop_9x_support_start:1.63
	cr-0x5f1:1.52.0.4
	cv-branch:1.52.0.2
	pre-ptymaster-archetype:1.52
	cr-0x3b58:1.48.0.4
	cr-0x5ef:1.48.0.2
	after-mmap-privanon-noreserve:1.45
	after-mmap-revamp:1.45
	before-mmap-revamp:1.44
	cgf-more-exit-sync:1.43
	post_wait_sig_exit:1.40
	pre_wait_sig_exit:1.40
	reparent-point:1.31
	noreparent:1.31.0.2
	cr-0x5e6:1.30.0.2
	cr-0x9e:1.27.0.6
	cr-0x9d:1.27.0.4
	cgf-deleteme:1.27.0.2
	pre-sigrewrite:1.26
	corinna-01:1.26
	cr-0x9c:1.24.0.6
	cr-0x9b:1.24.0.4
	cr-0x99:1.24
	Z-emcb-cygwin_daemon:1.24.0.2
	w32api-2_2:1.18
	mingw-runtime-2_4:1.18
	pre-cgf-merge:1.24
	cgf-dev-branch:1.18.0.12
	predaemon:1.10
	cygwin_daemon_merge_HEAD:1.10
	pregp02r1:1.9.0.2
	cygnus_cvs_20020108_pre:1.8
	Z-cygwin_daemon_merge-new_HEAD:1.17
	Z-cygwin_daemon_merge_HEAD:1.17
	cygwin_daemon:1.5.0.2;
locks; strict;
comment	@// @;


1.134
date	2014.12.01.14.02.54;	author corinna;	state Exp;
branches;
next	1.133;

1.133
date	2014.05.08.19.33.07;	author corinna;	state Exp;
branches;
next	1.132;

1.132
date	2013.11.19.22.21.11;	author corinna;	state Exp;
branches;
next	1.131;

1.131
date	2013.11.19.20.37.27;	author corinna;	state Exp;
branches;
next	1.130;

1.130
date	2013.11.19.18.01.04;	author corinna;	state Exp;
branches;
next	1.129;

1.129
date	2013.06.14.15.41.17;	author corinna;	state Exp;
branches;
next	1.128;

1.128
date	2013.04.23.09.44.34;	author corinna;	state Exp;
branches;
next	1.127;

1.127
date	2013.03.29.17.00.36;	author corinna;	state Exp;
branches;
next	1.126;

1.126
date	2013.01.21.04.38.29;	author cgf;	state Exp;
branches;
next	1.125;

1.125
date	2012.07.24.13.56.14;	author corinna;	state Exp;
branches
	1.125.2.1;
next	1.124;

1.124
date	2012.05.03.08.34.44;	author corinna;	state Exp;
branches;
next	1.123;

1.123
date	2012.04.15.17.51.22;	author cgf;	state Exp;
branches;
next	1.122;

1.122
date	2012.02.21.17.03.51;	author corinna;	state Exp;
branches;
next	1.121;

1.121
date	2012.02.17.14.26.18;	author corinna;	state Exp;
branches;
next	1.120;

1.120
date	2011.12.19.12.50.35;	author corinna;	state Exp;
branches;
next	1.119;

1.119
date	2011.10.15.16.31.57;	author corinna;	state Exp;
branches;
next	1.118;

1.118
date	2011.07.30.20.50.23;	author cgf;	state Exp;
branches;
next	1.117;

1.117
date	2011.05.20.07.23.11;	author corinna;	state Exp;
branches;
next	1.116;

1.116
date	2011.05.16.10.27.14;	author corinna;	state Exp;
branches;
next	1.115;

1.115
date	2011.05.10.15.39.02;	author corinna;	state Exp;
branches;
next	1.114;

1.114
date	2011.05.10.10.17.30;	author corinna;	state Exp;
branches;
next	1.113;

1.113
date	2011.04.28.07.27.51;	author corinna;	state Exp;
branches;
next	1.112;

1.112
date	2011.04.04.12.23.36;	author corinna;	state Exp;
branches;
next	1.111;

1.111
date	2011.04.02.11.30.27;	author corinna;	state Exp;
branches;
next	1.110;

1.110
date	2011.03.23.21.33.36;	author cgf;	state Exp;
branches;
next	1.109;

1.109
date	2011.03.20.15.34.29;	author corinna;	state Exp;
branches;
next	1.108;

1.108
date	2011.03.08.14.26.15;	author corinna;	state Exp;
branches
	1.108.2.1;
next	1.107;

1.107
date	2011.03.01.00.19.23;	author cgf;	state Exp;
branches;
next	1.106;

1.106
date	2011.01.30.21.52.11;	author corinna;	state Exp;
branches;
next	1.105;

1.105
date	2011.01.11.14.50.45;	author corinna;	state Exp;
branches;
next	1.104;

1.104
date	2010.10.09.10.54.13;	author corinna;	state Exp;
branches;
next	1.103;

1.103
date	2010.09.25.20.06.21;	author corinna;	state Exp;
branches;
next	1.102;

1.102
date	2010.09.19.20.18.36;	author cgf;	state Exp;
branches;
next	1.101;

1.101
date	2010.08.30.10.39.43;	author corinna;	state Exp;
branches;
next	1.100;

1.100
date	2010.07.15.08.00.52;	author corinna;	state Exp;
branches;
next	1.99;

1.99
date	2010.01.22.22.31.31;	author corinna;	state Exp;
branches;
next	1.98;

1.98
date	2009.12.18.20.32.04;	author corinna;	state Exp;
branches;
next	1.97;

1.97
date	2009.11.03.09.31.45;	author corinna;	state Exp;
branches;
next	1.96;

1.96
date	2009.10.24.08.26.01;	author corinna;	state Exp;
branches;
next	1.95;

1.95
date	2009.08.08.20.24.54;	author corinna;	state Exp;
branches;
next	1.94;

1.94
date	2009.07.20.15.44.54;	author corinna;	state Exp;
branches;
next	1.93;

1.93
date	2009.06.26.15.12.06;	author corinna;	state Exp;
branches;
next	1.92;

1.92
date	2009.05.09.15.56.37;	author corinna;	state Exp;
branches;
next	1.91;

1.91
date	2009.01.29.20.32.08;	author corinna;	state Exp;
branches;
next	1.90;

1.90
date	2009.01.20.11.16.59;	author corinna;	state Exp;
branches;
next	1.89;

1.89
date	2008.11.12.11.04.27;	author corinna;	state Exp;
branches;
next	1.88;

1.88
date	2008.10.23.21.00.45;	author corinna;	state Exp;
branches;
next	1.87;

1.87
date	2008.07.08.20.12.46;	author corinna;	state Exp;
branches;
next	1.86;

1.86
date	2008.05.15.16.34.01;	author corinna;	state Exp;
branches;
next	1.85;

1.85
date	2008.04.28.08.47.06;	author corinna;	state Exp;
branches;
next	1.84;

1.84
date	2008.04.27.16.12.00;	author corinna;	state Exp;
branches;
next	1.83;

1.83
date	2008.04.01.13.22.47;	author corinna;	state Exp;
branches;
next	1.82;

1.82
date	2008.02.13.09.42.22;	author corinna;	state Exp;
branches;
next	1.81;

1.81
date	2007.12.12.12.12.24;	author corinna;	state Exp;
branches;
next	1.80;

1.80
date	2007.07.19.09.06.54;	author corinna;	state Exp;
branches;
next	1.79;

1.79
date	2007.07.19.08.33.22;	author corinna;	state Exp;
branches;
next	1.78;

1.78
date	2007.06.21.15.57.54;	author corinna;	state Exp;
branches;
next	1.77;

1.77
date	2007.03.29.16.37.36;	author corinna;	state Exp;
branches;
next	1.76;

1.76
date	2007.02.23.15.15.50;	author corinna;	state Exp;
branches;
next	1.75;

1.75
date	2007.02.23.14.47.45;	author corinna;	state Exp;
branches;
next	1.74;

1.74
date	2007.02.23.12.01.52;	author corinna;	state Exp;
branches;
next	1.73;

1.73
date	2007.02.23.10.51.59;	author corinna;	state Exp;
branches;
next	1.72;

1.72
date	2007.02.23.09.49.49;	author corinna;	state Exp;
branches;
next	1.71;

1.71
date	2007.02.22.18.01.13;	author corinna;	state Exp;
branches;
next	1.70;

1.70
date	2007.02.22.17.35.14;	author corinna;	state Exp;
branches;
next	1.69;

1.69
date	2007.02.22.17.09.46;	author corinna;	state Exp;
branches;
next	1.68;

1.68
date	2007.02.22.16.22.38;	author corinna;	state Exp;
branches;
next	1.67;

1.67
date	2007.02.22.16.04.19;	author corinna;	state Exp;
branches;
next	1.66;

1.66
date	2007.02.22.11.17.01;	author corinna;	state Exp;
branches;
next	1.65;

1.65
date	2007.02.22.10.54.47;	author corinna;	state Exp;
branches;
next	1.64;

1.64
date	2007.02.21.15.18.07;	author corinna;	state Exp;
branches;
next	1.63;

1.63
date	2007.02.01.15.54.40;	author corinna;	state Exp;
branches;
next	1.62;

1.62
date	2007.01.21.22.54.04;	author corinna;	state Exp;
branches;
next	1.61;

1.61
date	2007.01.17.19.26.58;	author corinna;	state Exp;
branches;
next	1.60;

1.60
date	2006.12.10.16.43.30;	author corinna;	state Exp;
branches;
next	1.59;

1.59
date	2006.12.06.16.33.03;	author corinna;	state Exp;
branches;
next	1.58;

1.58
date	2006.12.05.13.16.24;	author corinna;	state Exp;
branches;
next	1.57;

1.57
date	2006.12.05.10.59.21;	author corinna;	state Exp;
branches;
next	1.56;

1.56
date	2006.11.27.12.59.59;	author corinna;	state Exp;
branches;
next	1.55;

1.55
date	2006.11.08.11.38.05;	author corinna;	state Exp;
branches;
next	1.54;

1.54
date	2006.10.31.18.41.16;	author corinna;	state Exp;
branches;
next	1.53;

1.53
date	2006.10.23.15.13.55;	author corinna;	state Exp;
branches;
next	1.52;

1.52
date	2006.03.16.02.57.37;	author cgf;	state Exp;
branches
	1.52.4.1;
next	1.51;

1.51
date	2006.03.13.18.29.48;	author cgf;	state Exp;
branches;
next	1.50;

1.50
date	2006.01.29.12.23.44;	author corinna;	state Exp;
branches;
next	1.49;

1.49
date	2006.01.27.21.50.42;	author corinna;	state Exp;
branches;
next	1.48;

1.48
date	2006.01.13.10.18.31;	author corinna;	state Exp;
branches;
next	1.47;

1.47
date	2006.01.12.15.53.51;	author corinna;	state Exp;
branches;
next	1.46;

1.46
date	2006.01.10.18.11.32;	author corinna;	state Exp;
branches;
next	1.45;

1.45
date	2005.11.28.22.32.29;	author corinna;	state Exp;
branches;
next	1.44;

1.44
date	2005.10.18.18.51.33;	author corinna;	state Exp;
branches;
next	1.43;

1.43
date	2005.09.28.19.33.18;	author corinna;	state Exp;
branches;
next	1.42;

1.42
date	2005.09.28.19.22.24;	author corinna;	state Exp;
branches;
next	1.41;

1.41
date	2005.09.28.19.02.52;	author corinna;	state Exp;
branches;
next	1.40;

1.40
date	2005.06.30.02.52.14;	author cgf;	state Exp;
branches;
next	1.39;

1.39
date	2005.06.18.01.36.17;	author cgf;	state Exp;
branches;
next	1.38;

1.38
date	2005.04.11.21.54.54;	author corinna;	state Exp;
branches;
next	1.37;

1.37
date	2005.04.11.20.44.45;	author corinna;	state Exp;
branches;
next	1.36;

1.36
date	2005.02.28.13.11.50;	author corinna;	state Exp;
branches;
next	1.35;

1.35
date	2005.02.20.13.28.23;	author corinna;	state Exp;
branches;
next	1.34;

1.34
date	2005.02.20.04.25.33;	author cgf;	state Exp;
branches;
next	1.33;

1.33
date	2005.01.25.22.45.09;	author corinna;	state Exp;
branches;
next	1.32;

1.32
date	2004.12.28.01.27.26;	author cgf;	state Exp;
branches;
next	1.31;

1.31
date	2004.05.28.19.50.07;	author cgf;	state Exp;
branches;
next	1.30;

1.30
date	2004.03.14.18.01.45;	author corinna;	state Exp;
branches;
next	1.29;

1.29
date	2004.02.09.04.04.24;	author cgf;	state Exp;
branches;
next	1.28;

1.28
date	2004.01.19.23.03.43;	author cgf;	state Exp;
branches;
next	1.27;

1.27
date	2003.12.03.16.35.52;	author corinna;	state Exp;
branches;
next	1.26;

1.26
date	2003.09.27.08.14.56;	author corinna;	state Exp;
branches;
next	1.25;

1.25
date	2003.09.27.03.44.31;	author cgf;	state Exp;
branches;
next	1.24;

1.24
date	2003.08.28.02.04.16;	author cgf;	state Exp;
branches;
next	1.23;

1.23
date	2003.07.26.04.53.59;	author cgf;	state Exp;
branches;
next	1.22;

1.22
date	2003.05.20.15.22.09;	author corinna;	state Exp;
branches;
next	1.21;

1.21
date	2003.04.20.01.36.15;	author cgf;	state Exp;
branches;
next	1.20;

1.20
date	2003.02.20.15.58.55;	author corinna;	state Exp;
branches;
next	1.19;

1.19
date	2003.02.20.10.14.52;	author corinna;	state Exp;
branches;
next	1.18;

1.18
date	2002.10.15.17.04.20;	author cgf;	state Exp;
branches
	1.18.12.1;
next	1.17;

1.17
date	2002.09.22.03.38.57;	author cgf;	state Exp;
branches;
next	1.16;

1.16
date	2002.07.24.11.01.37;	author corinna;	state Exp;
branches;
next	1.15;

1.15
date	2002.07.23.14.47.17;	author corinna;	state Exp;
branches;
next	1.14;

1.14
date	2002.06.10.17.08.09;	author cgf;	state Exp;
branches;
next	1.13;

1.13
date	2002.06.05.04.01.43;	author cgf;	state Exp;
branches;
next	1.12;

1.12
date	2002.05.17.08.32.29;	author corinna;	state Exp;
branches;
next	1.11;

1.11
date	2002.05.12.01.37.48;	author cgf;	state Exp;
branches;
next	1.10;

1.10
date	2002.02.25.17.47.47;	author corinna;	state Exp;
branches;
next	1.9;

1.9
date	2002.01.29.02.02.01;	author cgf;	state Exp;
branches;
next	1.8;

1.8
date	2001.11.05.06.09.09;	author cgf;	state Exp;
branches;
next	1.7;

1.7
date	2001.10.16.14.53.26;	author corinna;	state Exp;
branches;
next	1.6;

1.6
date	2001.10.15.09.41.18;	author corinna;	state Exp;
branches;
next	1.5;

1.5
date	2001.09.20.08.02.00;	author corinna;	state Exp;
branches
	1.5.2.1;
next	1.4;

1.4
date	2001.09.14.04.22.05;	author cgf;	state Exp;
branches;
next	1.3;

1.3
date	2001.09.12.21.07.13;	author corinna;	state Exp;
branches;
next	1.2;

1.2
date	2001.09.12.21.03.53;	author corinna;	state Exp;
branches;
next	1.1;

1.1
date	2001.09.12.17.46.37;	author corinna;	state Exp;
branches;
next	;

1.125.2.1
date	2012.10.23.12.54.27;	author corinna;	state Exp;
branches;
next	1.125.2.2;

1.125.2.2
date	2013.01.21.13.52.11;	author corinna;	state Exp;
branches;
next	1.125.2.3;

1.125.2.3
date	2013.02.25.12.44.29;	author corinna;	state Exp;
branches;
next	1.125.2.4;

1.125.2.4
date	2013.03.01.14.03.01;	author corinna;	state Exp;
branches;
next	1.125.2.5;

1.125.2.5
date	2013.03.01.16.32.33;	author corinna;	state Exp;
branches;
next	1.125.2.6;

1.125.2.6
date	2013.03.14.16.11.42;	author corinna;	state Exp;
branches;
next	1.125.2.7;

1.125.2.7
date	2013.03.27.15.58.29;	author corinna;	state Exp;
branches;
next	1.125.2.8;

1.125.2.8
date	2013.03.29.17.00.58;	author corinna;	state Exp;
branches;
next	;

1.108.2.1
date	2011.03.20.15.37.01;	author corinna;	state Exp;
branches;
next	1.108.2.2;

1.108.2.2
date	2011.03.28.20.16.56;	author corinna;	state Exp;
branches;
next	;

1.52.4.1
date	2006.10.23.15.14.04;	author corinna;	state Exp;
branches;
next	1.52.4.2;

1.52.4.2
date	2006.11.08.10.00.06;	author corinna;	state Exp;
branches;
next	1.52.4.3;

1.52.4.3
date	2006.12.05.11.34.01;	author corinna;	state Exp;
branches;
next	1.52.4.4;

1.52.4.4
date	2006.12.05.13.16.37;	author corinna;	state Exp;
branches;
next	1.52.4.5;

1.52.4.5
date	2008.02.13.09.42.24;	author corinna;	state Exp;
branches;
next	;

1.18.12.1
date	2003.05.10.17.20.54;	author cgf;	state Exp;
branches;
next	1.18.12.2;

1.18.12.2
date	2003.05.26.19.39.07;	author cgf;	state Exp;
branches;
next	1.18.12.3;

1.18.12.3
date	2003.08.06.03.58.58;	author cgf;	state Exp;
branches;
next	1.18.12.4;

1.18.12.4
date	2003.09.02.02.31.09;	author cgf;	state Exp;
branches;
next	;

1.5.2.1
date	2002.01.04.03.56.11;	author rbcollins;	state Exp;
branches;
next	1.5.2.2;

1.5.2.2
date	2002.02.28.12.53.28;	author rbcollins;	state Exp;
branches;
next	1.5.2.3;

1.5.2.3
date	2002.06.13.14.34.14;	author rbcollins;	state Exp;
branches;
next	1.5.2.4;

1.5.2.4
date	2002.07.26.19.03.36;	author scottc;	state Exp;
branches;
next	1.5.2.5;

1.5.2.5
date	2002.09.22.10.01.29;	author scottc;	state Exp;
branches;
next	;


desc
@@


1.134
log
@	* wincap.cc (wincap_minimal): Remove.
	(wincaps): Drop has_physical_mem_access.
	(wincap_10): New global wincaps to support Windows 10.
	(wincapc::init): Use wincap_10 for version >= 6.4 and as default.
	* wincap.h (wincaps::has_physical_mem_access): remove.
@
text
@/* wincap.cc -- figure out on which OS we're running. Set the
		capability class to the appropriate values.

   Copyright 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011,
   2012, 2013, 2014 Red Hat, Inc.

This file is part of Cygwin.

This software is a copyrighted work licensed under the terms of the
Cygwin license.  Please consult the file "CYGWIN_LICENSE" for
details. */

#include "winsup.h"
#include "security.h"
#include "ntdll.h"

/* CV, 2008-10-23: All wincapc's have to be in the .cygwin_dll_common section,
   same as wincap itself.  Otherwise the capability changes made in
   wincapc::init() are not propagated to any subsequently started process
   in the same session.  I'm only writing this longish comment because I'm
   puzzled that this has never been noticed before... */

wincaps wincap_xpsp2 __attribute__((section (".cygwin_dll_common"), shared)) = {
  max_sys_priv:SE_CREATE_GLOBAL_PRIVILEGE,
  is_server:false,
  has_mandatory_integrity_control:false,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_on_link_prefix:false,
  has_gaa_largeaddress_bug:false,
  supports_all_posix_ai_flags:false,
  has_restricted_stack_args:false,
  has_transactions:false,
  has_sendmsg:false,
  has_broken_udf:true,
  has_broken_alloc_console:false,
  has_always_all_codepages:false,
  has_localenames:false,
  has_fast_cwd:false,
  has_restricted_raw_disk_access:false,
  use_dont_resolve_hack:true,
  has_console_logon_sid:false,
  wow64_has_secondary_stack:false,
  has_program_compatibility_assistant:false,
  has_pipe_reject_remote_clients:false,
  terminate_thread_frees_stack:false,
  has_precise_system_time:false,
  has_microsoft_accounts:false,
};

wincaps wincap_2003 __attribute__((section (".cygwin_dll_common"), shared)) = {
  max_sys_priv:SE_CREATE_GLOBAL_PRIVILEGE,
  is_server:false,
  has_mandatory_integrity_control:false,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_on_link_prefix:false,
  has_gaa_largeaddress_bug:false,
  supports_all_posix_ai_flags:false,
  has_restricted_stack_args:true,
  has_transactions:false,
  has_sendmsg:false,
  has_broken_udf:true,
  has_broken_alloc_console:false,
  has_always_all_codepages:false,
  has_localenames:false,
  has_fast_cwd:false,
  has_restricted_raw_disk_access:false,
  use_dont_resolve_hack:true,
  has_console_logon_sid:false,
  wow64_has_secondary_stack:true,
  has_program_compatibility_assistant:false,
  has_pipe_reject_remote_clients:false,
  terminate_thread_frees_stack:false,
  has_precise_system_time:false,
  has_microsoft_accounts:false,
};

wincaps wincap_vista __attribute__((section (".cygwin_dll_common"), shared)) = {
  max_sys_priv:SE_CREATE_SYMBOLIC_LINK_PRIVILEGE,
  is_server:false,
  has_mandatory_integrity_control:true,
  needs_count_in_si_lpres2:true,
  has_recycle_dot_bin:true,
  has_gaa_on_link_prefix:true,
  has_gaa_largeaddress_bug:true,
  supports_all_posix_ai_flags:true,
  has_restricted_stack_args:false,
  has_transactions:true,
  has_sendmsg:true,
  has_broken_udf:false,
  has_broken_alloc_console:false,
  has_always_all_codepages:true,
  has_localenames:true,
  has_fast_cwd:true,
  has_restricted_raw_disk_access:true,
  use_dont_resolve_hack:false,
  has_console_logon_sid:false,
  wow64_has_secondary_stack:false,
  has_program_compatibility_assistant:true,
  has_pipe_reject_remote_clients:true,
  terminate_thread_frees_stack:true,
  has_precise_system_time:false,
  has_microsoft_accounts:false,
};

wincaps wincap_7 __attribute__((section (".cygwin_dll_common"), shared)) = {
  max_sys_priv:SE_CREATE_SYMBOLIC_LINK_PRIVILEGE,
  is_server:false,
  has_mandatory_integrity_control:true,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:true,
  has_gaa_on_link_prefix:true,
  has_gaa_largeaddress_bug:true,
  supports_all_posix_ai_flags:true,
  has_restricted_stack_args:false,
  has_transactions:true,
  has_sendmsg:true,
  has_broken_udf:false,
  has_broken_alloc_console:true,
  has_always_all_codepages:true,
  has_localenames:true,
  has_fast_cwd:true,
  has_restricted_raw_disk_access:true,
  use_dont_resolve_hack:false,
  has_console_logon_sid:true,
  wow64_has_secondary_stack:false,
  has_program_compatibility_assistant:true,
  has_pipe_reject_remote_clients:true,
  terminate_thread_frees_stack:true,
  has_precise_system_time:false,
  has_microsoft_accounts:false,
};

wincaps wincap_8 __attribute__((section (".cygwin_dll_common"), shared)) = {
  max_sys_priv:SE_CREATE_SYMBOLIC_LINK_PRIVILEGE,
  is_server:false,
  has_mandatory_integrity_control:true,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:true,
  has_gaa_on_link_prefix:true,
  has_gaa_largeaddress_bug:false,
  supports_all_posix_ai_flags:true,
  has_restricted_stack_args:false,
  has_transactions:true,
  has_sendmsg:true,
  has_broken_udf:false,
  has_broken_alloc_console:true,
  has_always_all_codepages:true,
  has_localenames:true,
  has_fast_cwd:true,
  has_restricted_raw_disk_access:true,
  use_dont_resolve_hack:false,
  has_console_logon_sid:true,
  wow64_has_secondary_stack:false,
  has_program_compatibility_assistant:true,
  has_pipe_reject_remote_clients:true,
  terminate_thread_frees_stack:true,
  has_precise_system_time:true,
  has_microsoft_accounts:true,
};

wincaps wincap_10 __attribute__((section (".cygwin_dll_common"), shared)) = {
  max_sys_priv:SE_CREATE_SYMBOLIC_LINK_PRIVILEGE,
  is_server:false,
  has_mandatory_integrity_control:true,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:true,
  has_gaa_on_link_prefix:true,
  has_gaa_largeaddress_bug:false,
  supports_all_posix_ai_flags:true,
  has_restricted_stack_args:false,
  has_transactions:true,
  has_sendmsg:true,
  has_broken_udf:false,
  has_broken_alloc_console:true,
  has_always_all_codepages:true,
  has_localenames:true,
  has_fast_cwd:true,
  has_restricted_raw_disk_access:true,
  use_dont_resolve_hack:false,
  has_console_logon_sid:true,
  wow64_has_secondary_stack:false,
  has_program_compatibility_assistant:true,
  has_pipe_reject_remote_clients:true,
  terminate_thread_frees_stack:true,
  has_precise_system_time:true,
  has_microsoft_accounts:true,
};

wincapc wincap __attribute__((section (".cygwin_dll_common"), shared));

void
wincapc::init ()
{
  if (caps)
    return;		// already initialized

  GetSystemInfo (&system_info);
  version.dwOSVersionInfoSize = sizeof (RTL_OSVERSIONINFOEXW);
  RtlGetVersion (&version);

  switch (version.dwMajorVersion)
    {
      case 5:
	switch (version.dwMinorVersion)
	  {
	    case 1:
	      caps = &wincap_xpsp2;
	      break;

	    default:
	      caps = &wincap_2003;
	  }
	break;
      case 6:
	switch (version.dwMinorVersion)
	  {
	    case 0:
	      caps = &wincap_vista;
	      break;
	    case 1:
	      caps = &wincap_7;
	      break;
	    case 2:
	    case 3:
	      caps = &wincap_8;
	      break;
	    default:
	      caps = &wincap_10;
	      break;
	  }
	break;
      case 10:
      default:
	caps = &wincap_10;
	break;
    }

  ((wincaps *)caps)->is_server = (version.wProductType != VER_NT_WORKSTATION);
#ifdef __x86_64__
  wow64 = 0;
#else
  if (NT_SUCCESS (NtQueryInformationProcess (NtCurrentProcess (),
					     ProcessWow64Information,
					     &wow64, sizeof wow64, NULL))
      && !wow64)
#endif
    {
      ((wincaps *)caps)->needs_count_in_si_lpres2 = false;
      ((wincaps *)caps)->has_restricted_stack_args = false;
      ((wincaps *)caps)->wow64_has_secondary_stack = false;
      ((wincaps *)caps)->has_gaa_largeaddress_bug = false;
    }

  __small_sprintf (osnam, "NT-%d.%d", version.dwMajorVersion,
		   version.dwMinorVersion);
}
@


1.133
log
@	* uinfo.cc (cygheap_user::init): Fix formatting in debug output.
	(struct cyg_USER_INFO_24): Define temporarily.  Explain why.
	(pwdgrp::fetch_account_from_windows): Handle sane primary group
	setting for Microsoft Accounts.  Explain why.
	* wincap.h (wincaps::has_microsoft_accounts): New element.
	* wincap.cc: Implement above element throughout.
@
text
@a22 3
/* Minimal set of capabilities required to run Cygwin. */
#define wincap_minimal wincap_xpsp2

a25 1
  has_physical_mem_access:true,
a53 1
  has_physical_mem_access:false,
a81 1
  has_physical_mem_access:false,
a109 1
  has_physical_mem_access:false,
d138 28
a165 1
  has_physical_mem_access:false,
d225 4
d230 1
a230 1
	      caps = &wincap_8;
d234 1
d236 1
a236 1
	caps = &wincap_minimal;
@


1.132
log
@	* ntdll.h (RtlGetVersion): Declare.
	* wincap.cc (wincapc::init): Rather than GetVersionEx, call
	RtlGetVersion which is not crippled by missing Windows 8.1 manifest.
	* wincap.h (wincapc): Change type of version to RTL_OSVERSIONINFOEXW.
	Align formatting of all class members.
@
text
@d5 1
a5 1
   2012, 2013 Red Hat, Inc.
d52 1
d81 1
d110 1
d139 1
d168 1
@


1.131
log
@	* wincap.cc (wincapc::init): Revert previous change.  It's not working.
@
text
@d175 2
a176 2
  version.dwOSVersionInfoSize = sizeof (OSVERSIONINFOEX);
  GetVersionEx (reinterpret_cast<LPOSVERSIONINFO>(&version));
@


1.130
log
@	* wincap.cc (wincapc::init): Fix dwMinorVersion for Windows 8.1 and
	Server 2012.  Explain why this is necessary.
@
text
@a199 9
	    case 2:
	      /* Hack for Windows 8.1 and Server 2012R2:  If the executable is
		 missing a Windows 8.1 mainfest, the OS returns dwMinorVersion
		 2, as if it's running on Windows 8 or Server 2012.  The
		 correct dwMinorVersion is 3 for 8.1/2012R2, though, so we're
		 fixing this up here. */
	      if (version.dwBuildNumber >= 9200)
		version.dwMinorVersion = 3;
	      /*FALLTHRU*/
@


1.129
log
@	* autoload.cc (GetSystemTimePreciseAsFileTime): Define.
	* times.cc (GetSystemTimePreciseAsFileTime): Temporarily declare here
	to workaround missing definition in 32 bit w32api headers.
	(get_system_time): New always inline function to call either
	GetSystemTimePreciseAsFileTime or GetSystemTimeAsFileTime on a per OS
	basis.  Call throughout instead of GetSystemTimeAsFileTime.
	* wincap.h (wincaps::has_precise_system_time): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d200 9
@


1.128
log
@	* Merge in cygwin-64bit-branch.
@
text
@d51 1
d79 1
d107 1
d135 1
d163 1
@


1.127
log
@	* cygthread.cc (cygthread::terminate_thread): Only try to free
	thread stack on systems not freeing it by themselves.
	* wincap.h (wincaps::terminate_thread_frees_stack): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d24 1
a24 145
#define wincap_minimal wincap_2000

wincaps wincap_2000 __attribute__((section (".cygwin_dll_common"), shared)) = {
  max_sys_priv:SE_MANAGE_VOLUME_PRIVILEGE,
  is_server:false,
  has_physical_mem_access:true,
  has_create_global_privilege:false,
  has_ioctl_storage_get_media_types_ex:false,
  has_disk_ex_ioctls:false,
  has_buggy_restart_scan:true,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:true,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  has_gaa_largeaddress_bug:false,
  supports_all_posix_ai_flags:false,
  has_restricted_stack_args:false,
  has_transactions:false,
  has_recvmsg:false,
  has_sendmsg:false,
  has_broken_udf:true,
  has_console_handle_problem:false,
  has_broken_alloc_console:false,
  has_always_all_codepages:false,
  has_localenames:false,
  has_fast_cwd:false,
  has_restricted_raw_disk_access:false,
  use_dont_resolve_hack:false,
  has_stack_size_param_is_a_reservation:false,
  has_console_logon_sid:false,
  wow64_has_secondary_stack:false,
  has_program_compatibility_assistant:false,
  kernel_is_always_casesensitive:true,
  terminate_thread_frees_stack:false,
};

wincaps wincap_2000sp4 __attribute__((section (".cygwin_dll_common"), shared)) = {
  max_sys_priv:SE_CREATE_GLOBAL_PRIVILEGE,
  is_server:false,
  has_physical_mem_access:true,
  has_create_global_privilege:true,
  has_ioctl_storage_get_media_types_ex:false,
  has_disk_ex_ioctls:false,
  has_buggy_restart_scan:true,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:true,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  has_gaa_largeaddress_bug:false,
  supports_all_posix_ai_flags:false,
  has_restricted_stack_args:false,
  has_transactions:false,
  has_recvmsg:false,
  has_sendmsg:false,
  has_broken_udf:true,
  has_console_handle_problem:false,
  has_broken_alloc_console:false,
  has_always_all_codepages:false,
  has_localenames:false,
  has_fast_cwd:false,
  has_restricted_raw_disk_access:false,
  use_dont_resolve_hack:false,
  has_stack_size_param_is_a_reservation:false,
  has_console_logon_sid:false,
  wow64_has_secondary_stack:false,
  has_program_compatibility_assistant:false,
  kernel_is_always_casesensitive:true,
  terminate_thread_frees_stack:false,
};

wincaps wincap_xp __attribute__((section (".cygwin_dll_common"), shared)) = {
  max_sys_priv:SE_MANAGE_VOLUME_PRIVILEGE,
  is_server:false,
  has_physical_mem_access:true,
  has_create_global_privilege:false,
  has_ioctl_storage_get_media_types_ex:true,
  has_disk_ex_ioctls:true,
  has_buggy_restart_scan:false,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:false,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  has_gaa_largeaddress_bug:false,
  supports_all_posix_ai_flags:false,
  has_restricted_stack_args:false,
  has_transactions:false,
  has_recvmsg:true,
  has_sendmsg:false,
  has_broken_udf:true,
  has_console_handle_problem:false,
  has_broken_alloc_console:false,
  has_always_all_codepages:false,
  has_localenames:false,
  has_fast_cwd:false,
  has_restricted_raw_disk_access:false,
  use_dont_resolve_hack:true,
  has_stack_size_param_is_a_reservation:true,
  has_console_logon_sid:false,
  wow64_has_secondary_stack:false,
  has_program_compatibility_assistant:false,
  kernel_is_always_casesensitive:false,
  terminate_thread_frees_stack:false,
};

wincaps wincap_xpsp1 __attribute__((section (".cygwin_dll_common"), shared)) = {
  max_sys_priv:SE_MANAGE_VOLUME_PRIVILEGE,
  is_server:false,
  has_physical_mem_access:true,
  has_create_global_privilege:false,
  has_ioctl_storage_get_media_types_ex:true,
  has_disk_ex_ioctls:true,
  has_buggy_restart_scan:false,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:false,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:true,
  has_gaa_on_link_prefix:false,
  has_gaa_largeaddress_bug:false,
  supports_all_posix_ai_flags:false,
  has_restricted_stack_args:false,
  has_transactions:false,
  has_recvmsg:true,
  has_sendmsg:false,
  has_broken_udf:true,
  has_console_handle_problem:false,
  has_broken_alloc_console:false,
  has_always_all_codepages:false,
  has_localenames:false,
  has_fast_cwd:false,
  has_restricted_raw_disk_access:false,
  use_dont_resolve_hack:true,
  has_stack_size_param_is_a_reservation:true,
  has_console_logon_sid:false,
  wow64_has_secondary_stack:false,
  has_program_compatibility_assistant:false,
  kernel_is_always_casesensitive:false,
  terminate_thread_frees_stack:false,
};
a29 4
  has_create_global_privilege:true,
  has_ioctl_storage_get_media_types_ex:true,
  has_disk_ex_ioctls:true,
  has_buggy_restart_scan:false,
a30 1
  needs_logon_sid_in_sid_list:false,
a32 1
  has_gaa_prefixes:true,
a37 1
  has_recvmsg:true,
a39 1
  has_console_handle_problem:false,
a45 1
  has_stack_size_param_is_a_reservation:true,
d49 1
a49 1
  kernel_is_always_casesensitive:false,
a56 4
  has_create_global_privilege:true,
  has_ioctl_storage_get_media_types_ex:true,
  has_disk_ex_ioctls:true,
  has_buggy_restart_scan:false,
a57 1
  needs_logon_sid_in_sid_list:false,
a59 1
  has_gaa_prefixes:true,
a64 1
  has_recvmsg:true,
a66 1
  has_console_handle_problem:false,
a72 1
  has_stack_size_param_is_a_reservation:true,
d76 1
a76 1
  kernel_is_always_casesensitive:false,
a83 4
  has_create_global_privilege:true,
  has_ioctl_storage_get_media_types_ex:true,
  has_disk_ex_ioctls:true,
  has_buggy_restart_scan:false,
a84 1
  needs_logon_sid_in_sid_list:false,
a86 1
  has_gaa_prefixes:true,
a91 1
  has_recvmsg:true,
a93 1
  has_console_handle_problem:false,
a99 1
  has_stack_size_param_is_a_reservation:true,
d103 1
a103 1
  kernel_is_always_casesensitive:false,
a110 4
  has_create_global_privilege:true,
  has_ioctl_storage_get_media_types_ex:true,
  has_disk_ex_ioctls:true,
  has_buggy_restart_scan:false,
a111 1
  needs_logon_sid_in_sid_list:false,
a113 1
  has_gaa_prefixes:true,
a118 1
  has_recvmsg:true,
a120 1
  has_console_handle_problem:true,
a126 1
  has_stack_size_param_is_a_reservation:true,
d130 1
a130 1
  kernel_is_always_casesensitive:false,
a137 4
  has_create_global_privilege:true,
  has_ioctl_storage_get_media_types_ex:true,
  has_disk_ex_ioctls:true,
  has_buggy_restart_scan:false,
a138 1
  needs_logon_sid_in_sid_list:false,
a140 1
  has_gaa_prefixes:true,
a145 1
  has_recvmsg:true,
a147 1
  has_console_handle_problem:true,
a153 1
  has_stack_size_param_is_a_reservation:true,
d157 1
a157 1
  kernel_is_always_casesensitive:false,
a177 7
	    case 0:
	      if (version.wServicePackMajor < 4)
		caps = &wincap_2000;
	      else
		caps = &wincap_2000sp4;
	      break;

d179 1
a179 10
	      caps = &wincap_xp;
	      switch (version.wServicePackMajor)
		{
		case 0:
		  caps = &wincap_xp;
		case 1:
		  caps = &wincap_xpsp1;
		default:
		  caps = &wincap_xpsp2;
		}
d206 3
d213 1
@


1.126
log
@Throughout, update copyrights to reflect dates which correspond to main-branch
checkins.  Regularize copyright format.
@
text
@d5 1
a5 1
   2012 Red Hat, Inc.
d59 1
d95 1
d131 1
d167 1
d203 1
d239 1
d275 1
d311 1
d347 1
@


1.125
log
@	* wincap.cc (wincapc::init): Drop memset call since it can result in
	a race condition.  Drop all considerations for pre-Windows 2000 systems
	since Cygwin won't start on them anyway.
@
text
@d4 2
a5 2
   Copyright 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008,
   2009, 2010, 2011, 2012 Red Hat, Inc.
@


1.125.2.1
log
@	* cygtls.h (__stack_t): Define as uintptr_t.
	* dcrt0.cc (child_info_fork::alloc_stack): Conditionalize assembler
	code on a per-CPU base.  Rename esp to stackp.
	(get_cygwin_startup_info): Cast pointers to uintptr_t in
	multiple_cygwin_problem call.  Minor formatting change.
	(_dll_crt0): Conditionalize assembler code on a per-CPU base.
	(multiple_cygwin_problem): Change parameters from unsigned to uintptr_t.
	* winsup.h (multiple_cygwin_problem): Change declaration accordingly.
	* pinfo.h (pinfo::reattach): Cast 2nd argument in proc_subproc call
	to uintptr_t.
	(pinfo::remember): Ditto.
	* sigproc.cc (proc_subproc): Change 2nd parameter to uintptr_t to allow
	pointer values.
	* sigproc.h (proc_subproc): Change declaration accordingly.
	* include/sys/cygwin.h (per_process_overwrite): Use offsetof to compute
	value.
@
text
@a401 3
#ifdef __x86_64__
  wow64 = 0;
#else
a405 1
#endif
@


1.125.2.2
log
@Pull in changes from HEAD
@
text
@d4 2
a5 2
   Copyright 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011,
   2012 Red Hat, Inc.
@


1.125.2.3
log
@	* exception.h (class exception): Add handler_installed member.
	Change parameters to handle method to match high-level exception
	handler calls.
	(exception::exception): On x86_64, install exception handler only
	once.  Explain what we do.
	* exceptions.cc (_AFMT): Change to only 11 digits on x86_64.
	(cygwin_exception::dump_exception): Print Rip with only 11 digits.
	Print 64 bit registers with 0-padding.
	(class stack_info): Add members c and hist on x86_64.
	(stack_info::init): Take PCONTEXT rather than bool as third parameter.
	Tweak code accordingly.  Initialize c and hist on x86_64.
	(stack_info::walk): Add implementation for x86_64.  Drop unneeded
	#ifndef in 32 bit code.
	(cygwin_exception::dumpstack): Call thestack.init with context as
	parameter.  Change header output for x86_64.
	(cygwin_stackdump): Prefer RtlCaptureContext over GetThreadContext.
	(CYG_EXC_CONTINUE_EXECUTION): Define generic definition matching all
	platforms.
	(CYG_EXC_CONTINUE_SEARCH): Ditto.
	(exception::handler_installed): Define here.
	(exception::handle): Define according to declaration in exception.h.
	Create 32 bit parameters as local variable on 64 bit.  Change all
	return statements to use generic definitions.  Simplify setting framep
	on x86_64.  Disable setting frame-based exception handler on x86_64.
	Fix formatting of klog output for x86_64.
	(signal_exit): Create context for cygwin_exception creation.
	(sigpacket::process): Prefer RtlCaptureContext over GetThreadContext.
	* wincap.h (wincaps::has_rtl_capture_context): New element.
	* wincap.cc: Implement above element throughout.
@
text
@a58 1
  has_rtl_capture_context:false,
a93 1
  has_rtl_capture_context:true,
a128 1
  has_rtl_capture_context:true,
a163 1
  has_rtl_capture_context:true,
a198 1
  has_rtl_capture_context:true,
a233 1
  has_rtl_capture_context:true,
a268 1
  has_rtl_capture_context:true,
a303 1
  has_rtl_capture_context:true,
a338 1
  has_rtl_capture_context:true,
@


1.125.2.4
log
@	* exceptions.cc (rtl_unwind): Convert to macro doing nothing on x86_64.
	(exception::handle): Drop creating frame variable on x86_64.
	* wincap.cc (wincap_2000sp4): Set has_rtl_capture_context to false.
@
text
@d95 1
a95 1
  has_rtl_capture_context:false,
@


1.125.2.5
log
@	* autoload.cc (AttachConsole): Remove.
	(GetModuleHandleExW): Remove.
	(GetSystemWow64DirectoryW): Remove.
	(GetVolumePathNamesForVolumeNameW): Remove.
	* exceptions.cc (cygwin_stackdump): Always call RtlCaptureContext.
	(exception::handle): Drop accidentally left in debugging statement.
	Always call RtlCaptureContext.
	(sigpacket::process): Always call RtlCaptureContext for current thread.
	* fhandler_disk_file.cc (fstatvfs): Drop code using
	FileFsSizeInformation.
	(struct __DIR_cache): Remove comment.
	(fhandler_disk_file::rewinddir): Drop W2K-only code.
	* fhandler_floppy.cc (fhandler_dev_floppy::get_drive_info): Don't
	check for old OS.  Extend a comment.
	* fhandler_mem.cc (fhandler_dev_mem::open): Drop NT4 and W2K from
	debug output.
	* fhandler_proc.cc (format_proc_partitions): Drop Pre-XP considerations.
	* fhandler_procnet.cc (fhandler_procnet::exists): Ditto.
	(fhandler_procnet::readdir): Ditto.
	(format_procnet_ifinet6): Ditto.
	* fhandler_socket.cc (fhandler_socket::recvmsg): Ditto.
	* fhandler_tape.cc (mtinfo_drive::get_status): Ditto.
	* init.cc (dll_entry): Drop W2K-only code.
	* net.cc (get_ifs): Rename from get_xp_ifs.
	(get_2k_ifs): Remove.
	(getifaddrs): Always call get_ifs.
	(get_ifconf): Ditto.
	(if_nametoindex): Drop Pre-XP considerations.
	(load_ipv6_funcs): Ditto.  Fix preceeding comment.
	* sec_auth.cc (lsaauth): Drop code handling fake_login_sid.
	* sec_helper.cc (fake_logon_sid): Remove.
	(set_cygwin_privileges): Fix uncommented statement to drop pre-XP
	considerations.
	* security.h (fake_logon_sid): Drop declaration.
	* shared.cc (shared_info::init_obcaseinsensitive): Drop W2K-only code.
	* wincap.cc: Throughout, remove setting all deprecated wincapc members.
	(wincap_minimal): Set to wincap_xpsp2.
	(wincap_2000): Remove.
	(wincap_2000sp4): Remove.
	(wincap_xp): Remove.
	(wincap_xpsp1): Remove.
	(wincapc::init): Drop OS 5.0 and pre-SP2 XP.
	* wincap.h (struct wincaps): Remove the following members:
	has_create_global_privilege, has_ioctl_storage_get_media_types_ex,
	has_disk_ex_ioctls, has_buggy_restart_scan, needs_logon_sid_in_sid_list,
	has_gaa_prefixes, has_recvmsg, has_stack_size_param_is_a_reservation,
	kernel_is_always_casesensitive, has_rtl_capture_context.
@
text
@d5 1
a5 1
   2012, 2013 Red Hat, Inc.
d24 145
a168 1
#define wincap_minimal wincap_xpsp2
d174 4
d179 1
d182 1
d188 1
d198 1
d202 2
d210 4
d215 1
d218 1
d224 1
d234 1
d238 2
d246 4
d251 1
d254 1
d260 1
d270 1
d274 2
d282 4
d287 1
d290 1
d296 1
d306 1
d310 2
d318 4
d323 1
d326 1
d332 1
d342 1
d346 2
d367 7
d375 10
a384 1
	      caps = &wincap_xpsp2;
@


1.125.2.6
log
@	* fhandler_tty.cc (fhandler_pty_master::setup): Add
	PIPE_REJECT_REMOTE_CLIENTS to pipe mode on systems supporting it.  Add
	FILE_FLAG_FIRST_PIPE_INSTANCE to pipe open mode.
	* pipe.cc (fhandler_pipe::create): Ditto.  Fix subsequent comment
	accordingly.
	* wincap.h (wincaps::has_pipe_reject_remote_clients): New element.
	* wincap.cc: Implement above element throughout.
	* winlean.h (PIPE_REJECT_REMOTE_CLIENTS): Temporarily define until
	Mingw64 headers define it.
@
text
@a49 1
  has_pipe_reject_remote_clients:false,
a75 1
  has_pipe_reject_remote_clients:false,
a101 1
  has_pipe_reject_remote_clients:true,
a127 1
  has_pipe_reject_remote_clients:true,
a153 1
  has_pipe_reject_remote_clients:true,
@


1.125.2.7
log
@	* fhandler_console.cc
	(fhandler_console::create_invisible_console_workaround): Fix comment.
	* wincap.cc: Throughout, remove unused has_console_handle_problem
	wincapc members.
	* wincap.h (struct wincaps): Remove has_console_handle_problem.
@
text
@d40 1
d67 1
d94 1
d121 1
d148 1
@


1.125.2.8
log
@Pull in changes from HEAD
@
text
@a49 1
  terminate_thread_frees_stack:false,
a75 1
  terminate_thread_frees_stack:false,
a101 1
  terminate_thread_frees_stack:true,
a127 1
  terminate_thread_frees_stack:true,
a153 1
  terminate_thread_frees_stack:true,
@


1.124
log
@	* net.cc (get_adapters_addresses): Only create thread on affected
	systems.  Change comment acordingly.
	* wincap.h (wincaps::has_gaa_largeaddress_bug): New element.
	* wincap.cc: Implement above element throughout.
	(wincap_8): New globale wincaps to support Windows 8.
	(wincapc::init): Take Windows 8 into account.  Set new
	has_gaa_largeaddress_bug member to false on 32 bit systems.
@
text
@a349 1
  memset (&version, 0, sizeof version);
d351 1
a351 2
  if (!GetVersionEx (reinterpret_cast<LPOSVERSIONINFO>(&version)))
    api_fatal ("Cygwin requires at least Windows 2000.");
d353 1
a353 1
  switch (version.dwPlatformId)
d355 2
a356 2
      case VER_PLATFORM_WIN32_NT:
	switch (version.dwMajorVersion)
d358 5
a362 4
	    case 4:
	      /* I'd be very surprised if this code is ever hit, but it doesn't
		 hurt to keep it. */
	      api_fatal ("Cygwin requires at least Windows 2000.");
d364 4
a367 2
	    case 5:
	      switch (version.dwMinorVersion)
d369 8
a376 6
		  case 0:
		    if (version.wServicePackMajor < 4)
		      caps = &wincap_2000;
		    else
		      caps = &wincap_2000sp4;
		    break;
d378 9
a386 16
		  case 1:
		    caps = &wincap_xp;
		    switch (version.wServicePackMajor)
		      {
		      case 0:
			caps = &wincap_xp;
		      case 1:
			caps = &wincap_xpsp1;
		      default:
			caps = &wincap_xpsp2;
		      }
		    break;

		  default:
		    caps = &wincap_2003;
		}
d388 2
a389 13
	    case 6:
	      switch (version.dwMinorVersion)
		{
		  case 0:
		    caps = &wincap_vista;
		    break;
		  case 1:
		    caps = &wincap_7;
		    break;
		  default:
		    caps = &wincap_8;
		    break;
		}
d392 1
a392 1
	      caps = &wincap_minimal;
a395 5
      case VER_PLATFORM_WIN32_WINDOWS:
	/* I'd be very surprised if this code is ever hit, but it doesn't
	   hurt to keep it. */
	api_fatal ("Windows 95/98/Me are not supported.");
	break;
@


1.123
log
@wincap.h: Rename assitant to assistant throughout.  wincap.cc: Ditto.
* devices.in (exists_console): Use fhandler_console::exists () rather than raw
test.
* devices.cc: Regenerate.
* fhandler.h (fhandler_console::exists): Define new function.
* fhandler_console.cc (fhandler_console::need_invisible): Use
fhandler_console::exists () rather than raw test.
* spawn.cc: Rename assitant to assistant throughout.
(child_info_spawn::worker): Simplify test for when to start a non-Cygwin
process in its own process group.  Just do it whenever we start a non-Cygwin
process.
@
text
@d40 1
d75 1
d110 1
d145 1
d180 1
d215 1
d250 1
d285 36
d398 3
d402 1
a402 1
		    caps = &wincap_7;
d430 1
@


1.122
log
@	* shared.cc (shared_info::init_obcaseinsensitive): Check actual state
	of case sensitivity on post-Windows 2000 systems.
	* wincap.h (wincaps::kernel_is_always_casesensitive): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d56 1
a56 1
  has_program_compatibility_assitant:false,
d90 1
a90 1
  has_program_compatibility_assitant:false,
d124 1
a124 1
  has_program_compatibility_assitant:false,
d158 1
a158 1
  has_program_compatibility_assitant:false,
d192 1
a192 1
  has_program_compatibility_assitant:false,
d226 1
a226 1
  has_program_compatibility_assitant:false,
d260 1
a260 1
  has_program_compatibility_assitant:true,
d294 1
a294 1
  has_program_compatibility_assitant:true,
@


1.121
log
@	* ntdll.h (struct _PEB): Add EnvironmentUpdateCount member.
	* spawn.cc (child_info_spawn::worker): Speed up job recognition.  Expand
	comment to explain every little detail and so we never forget.
	* wincap.h (wincaps::has_program_compatibility_assitant): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d57 1
d91 1
d125 1
d159 1
d193 1
d227 1
d261 1
d295 1
@


1.120
log
@	* dcrt0.cc (dll_crt0_0): Check for wincap.wow64_has_secondary_stack
	rather than for wincap.is_wow64.  Accommodate name change from
	wow64_has_64bit_parent to wow64_needs_stack_adjustment.  Align comment.
	(_dll_crt0): Ditto.
	* wincap.h (wincaps::wow64_has_secondary_stack): New element.
	* wincap.cc: Implement above element throughout.
	(wincapc::init): Set wow64_has_secondary_stack to false on non-64 bit
	systems.
	* wow64.cc (wow64_needs_stack_adjustment): Rename (hopefully the last
	time) from wow64_has_64bit_parent.
	(wow64_eval_expected_main_stack): Fix comment to reflect real life.
	(wow64_test_for_64bit_parent): Fix comment.
	* wow64.h (wow64_needs_stack_adjustment): Accommodate new name.
@
text
@d5 1
a5 1
   2009, 2010, 2011 Red Hat, Inc.
d56 1
d89 1
d122 1
d155 1
d188 1
d221 1
d254 1
d287 1
@


1.119
log
@	* sec_auth.cc (get_token_group_sidlist): Add CONSOLE LOGON SID on
	systems supporting it.  Never add SERVICE SID but keep code in for
	future reference.  Explain why.
	(get_priv_list): Add cygpsid pointer parameter.  Point it to the
	mandatory integrity SID which matches account and privileges.
	(create_token): Fetch mandatory integrity SID from call to
	get_priv_list.
	(lsaauth): Call get_priv_list with additional NULL pointer.  Change
	comment accordingly.
	* sec_helper.cc (well_known_console_logon_sid): New static SID.
	(cygpriv): Change to structure containing extra flag to store info
	about required integrity level.
	(privilege_luid): Accommodate changes to cygpriv.  Return integrity
	level in new high_integrity parameter.
	(privilege_name): Accommodate changes to cygpriv.
	(set_privilege): Drop trailing \n from debug output.
	(set_cygwin_privileges): Don't set SE_CREATE_GLOBAL_PRIVILEGE anymore
	since it's just not needed, but keep code in for future reference.
	Change comment accordingly.
	* security.h (well_known_console_logon_sid): Declare.
	(privilege_luid): Align declaration to above change.
	* wincap.h (wincaps::has_console_logon_sid): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d55 1
d87 1
d119 1
d151 1
d183 1
d215 1
d247 1
d279 1
d367 1
@


1.118
log
@* cygthread.cc (cygthread::async_create): Define new function.
* cygthread.h (cygthread::create): Use correct regparm.
(cygthread::standalone): Delete from class and from all constructors.
(cygthread::cygthread): Use three only arguments for detached threads, and
start the thread via QueueUserAPC/async_create.
* dcrt0.cc (dll_crt0_0): Remove handling for wincap.has_buggy_thread_startup.
(dll_crt0_1): Ditto.
* wincap.cc: Ditto throughout.
* wincap.h: Ditto.
@
text
@d54 1
d85 1
d116 1
d147 1
d178 1
d209 1
d240 1
d271 1
@


1.117
log
@	* child_info.h (CURR_CHILD_INFO_MAGIC): Update.
	(class child_info_fork): Remove stacksize, add stackaddr and guardsize
	members.
	* dcrt0.cc (child_info_fork::alloc_stack_hard_way): Partial rewrite
	to regenerate the stack exactly as in the parent.
	(child_info_fork::alloc_stack): Set stackaddr to 0, rather than
	stacksize.
	(dll_crt0_1): Check for stackaddr before changing the stack addresses
	in the TEB.
	* fork.cc (frok::child): Check for stackaddr here.
	(frok::parent): Set ch.stackaddr and ch.guardsize if not called from
	the main thread.
	* init.cc (dll_entry): Replace pointer to NT_TIB with pointer to TEB.
	Fix incorrectly changed address test before removing _my_tls.
	Set StackLimit to NULL on Windows 2000.  Explain why.
	* miscfuncs.cc (struct thread_wrapper_arg): Store stackbase rather
	than stacksize, store commitaddr, remove guardsize.  Store all pointers
	as char * for easier address arithmetic.
	(thread_wrapper): Rewrite to remove OS stack before calling thread
	function.  Add lots of comments to explain what we do.
	(CygwinCreateThread): Reserve our own stack in case we got no
	application stack.  Add comments.
	* ntdll.h (struct _TEB): Extend defintion up to DeallocationStack
	member.
	* thread.cc (pthread_attr::pthread_attr): Use "(size_t) -1"
	rather then 0xffffffff.
	* wincap.h (wincaps::has_stack_size_param_is_a_reservation): New
	element.
	* wincap.cc: Implement above element throughout.
@
text
@a49 1
  has_buggy_thread_startup:false,
a79 1
  has_buggy_thread_startup:false,
a109 1
  has_buggy_thread_startup:false,
a139 1
  has_buggy_thread_startup:false,
a169 1
  has_buggy_thread_startup:false,
a199 1
  has_buggy_thread_startup:false,
a229 1
  has_buggy_thread_startup:true,
a259 1
  has_buggy_thread_startup:false,
a352 2
  if (!wow64)
    ((wincaps *) caps)->has_buggy_thread_startup = false;
@


1.116
log
@	* heap.cc (heap_init): Rewrite initial heap allocation to use addresses
	beyond 0x20000000.  Explain why and how.
	* shared.cc (shared_info::heap_slop_size): Remove.
	* shared_info.h (class shared_info): Remove heap_slop_inited and
	heap_slop members.  Remove heap_slop_size declaration.
	(CURR_SHARED_MAGIC): Update.
	* wincap.cc: Throughout, drop heapslop.
	* wincap.h (struct wincaps): Drop heapslop.
@
text
@d54 1
d85 1
d116 1
d147 1
d178 1
d209 1
d240 1
d271 1
@


1.115
log
@	* fhandler_proc.cc (format_proc_uptime): Don't call GetSystemInfo.
	Fetch CPU count from wincap.
	(format_proc_stat): Ditto.
	* globals.cc (system_info): Move to wincap.
	* heap.cc (heap_init): Fetch page size from wincap.
	* syscalls.cc (getpagesize): Fetch allocation granularity from wincap.
	(getsystempagesize): Fetch page size from wincap.
	* wincap.cc (wincap_2003): Default is_server to false.
	(wincapc::init): Call GetSystemInfo here.  Always set is_server value.
	* wincap.h (class wincapc): Add system_info as private member.
	(wincapc::cpu_count): New public method.
	(wincapc::page_size): Ditto.
	(wincapc::allocation_granularity): Ditto.
@
text
@a26 1
  heapslop:0x0,
a56 1
  heapslop:0x0,
a86 1
  heapslop:0x0,
a116 1
  heapslop:0x0,
a146 1
  heapslop:0x0,
a176 1
  heapslop:0x4,
a206 1
  heapslop:0x4,
a236 1
  heapslop:0x4,
@


1.114
log
@	* environ.cc (set_chunksize): Remove.
	(parse_thing): Remove forkchunk entry.
	* fork.cc (child_copy): Drop handling external chunksize setting.
	* wincap.cc: Througout, drop chunksize.
	(wincapc::set_chunksize): Remove.
	* wincap.h (struct wincaps): Drop chunksize and declaration of
	set_chunksize.
@
text
@d184 1
a184 1
  is_server:true,
d282 1
d351 1
a351 2
  if (version.wProductType != VER_NT_WORKSTATION)
    ((wincaps *)caps)->is_server = true;
@


1.113
log
@	* autoload.cc (GetSecurityInfo): Remove.
	* ntdll.h (RtlConvertToAutoInheritSecurityObject): Declare.
	(RtlDeleteSecurityObject): Declare.
	(RtlGetControlSecurityDescriptor): Declare.
	(RtlLengthSecurityDescriptor): Declare.
	* security.cc (file_mapping): New global variable.
	(get_file_sd): Rewrite.  Clean up code.  Get rid of GetSecurityInfo
	call.
	(alloc_sd): Call RtlSetControlSecurityDescriptor to set
	SE_DACL_PROTECTED flag.
	(check_file_access): Remove mapping.  Use file_mapping instead.
	(check_registry_access): Rename mapping to reg_mapping.
	* wincap.cc: Througout, drop use_get_sec_info_on_dirs,
	* wincap.h (struct wincaps): Drop use_get_sec_info_on_dirs.
@
text
@a26 1
  chunksize:0,
a57 1
  chunksize:0,
a88 1
  chunksize:0,
a119 1
  chunksize:0,
a150 1
  chunksize:0,
a181 1
  chunksize:0,
a212 1
  chunksize:0,
a243 1
  chunksize:0,
a365 6

void
wincapc::set_chunksize (DWORD nchunksize)
{
  ((wincaps *)caps)->chunksize = nchunksize;
}
@


1.112
log
@	Drop NT4 support.
	* autoload.cc (DnsQuery_A): Fatal if not available.
	(DnsRecordListFree): Ditto.
	(DsGetDcNameW): Ditto.
	(NetGetAnyDCName): Remove.
	(NetGetDCName): Remove.
	(EnumProcessModules): Fatal if not available.
	(GetModuleFileNameExW): Ditto.
	(GetModuleInformation): Ditto.
	(GetProcessMemoryInfo): Ditto.
	(QueryWorkingSet): Ditto.
	(LsaRegisterLogonProcess): Ditto.
	* fenv.cc (_feinitialise): Drop supports_sse condition.
	* fhandler_disk_file.cc (path_conv::isgood_inode): Fix comment.
	(fhandler_base::fstat_by_name): Drop has_fileid_dirinfo condition.
	(fhandler_disk_file::opendir): Ditto.
	* fhandler_netdrive.cc (fhandler_netdrive::readdir): Fix comment.
	* fhandler_proc.cc (format_proc_partitions): Drop NT4-only code.
	* fhandler_process.cc (get_process_state): Ditto.
	* kernel32.cc (GetWindowsDirectoryW): Remove.
	(GetWindowsDirectoryA): Remove.
	* miscfuncs.cc (nice_to_winprio): Drop NT4-only code.
	* mount.cc (fs_info::update): Fix comments.
	* net.cc (get_2k_ifs): Drop NT4-only code.
	* sec_auth.cc (get_logon_server): Ditto.
	(lsaauth): Drop NT4-specific error handling.
	* security.cc (alloc_sd): Set SE_DACL_PROTECTED unconditionally.
	* select.cc (select_stuff::wait): Always use MWMO_INPUTAVAILABLE.
	(peek_windows): Drop NT4-only condition in call to PeekMessage.
	* syscalls.cc (gethostid): Remove NT4-only workaround.
	* wincap.cc: Througout, drop has_dacl_protect,
	has_broken_if_oper_status, has_process_io_counters,
	has_terminal_services, has_extended_priority_class, has_guid_volumes,
	has_fileid_dirinfo, has_mwmo_inputavailable and supports_sse from
	wincaps.
	(wincap_nt4sp4): Remove.
	(wincap_minimal): Set to wincap_2000.
	(wincapc::init): Rely on availability of OSVERSIONINFOEX structure.
	Treat error from GetVersionEx as fatal.  Treat NT4 as fatal.
	* wincap.h (struct wincaps): Drop has_dacl_protect,
	has_broken_if_oper_status, has_process_io_counters,
	has_terminal_services, has_extended_priority_class, has_guid_volumes,
	has_fileid_dirinfo, has_mwmo_inputavailable and supports_sse flags
	and methods.
	* winlean.h (GetWindowsDirectoryW) Define as GetSystemWindowsDirectoryW.
	(GetWindowsDirectoryA): Define as GetSystemWindowsDirectoryA.
@
text
@a55 1
  use_get_sec_info_on_dirs:false,
a87 1
  use_get_sec_info_on_dirs:false,
a119 1
  use_get_sec_info_on_dirs:true,
a151 1
  use_get_sec_info_on_dirs:true,
a183 1
  use_get_sec_info_on_dirs:true,
a215 1
  use_get_sec_info_on_dirs:true,
a247 1
  use_get_sec_info_on_dirs:false,
a279 1
  use_get_sec_info_on_dirs:false,
@


1.111
log
@	* autoload.cc (GetExtendedTcpTable): Remove.
	(GetTcpTable): Remove.
	(CharNextExA): Remove.
	(FindWindowA): Remove.
	(ShowWindowAsync): Remove.
	* dcrt0.cc (disable_dep): Remove unused function.
	(dll_crt0_0): Drop comment babbling about TS & DEP.
	* fhandler_socket.cc (address_in_use): Remove unused function.
	* wincap.cc: Throughout, drop ts_has_dep_problem from wincaps.
	(wincapc::init): Drop code setting ts_has_dep_problem flag.
	* wincap.h (struct wincaps): Drop ts_has_dep_problem flags and method.
@
text
@d24 1
a24 43
#define wincap_minimal wincap_nt4sp4

wincaps wincap_nt4sp4 __attribute__((section (".cygwin_dll_common"), shared)) = {
  chunksize:0,
  heapslop:0x0,
  max_sys_priv:SE_CHANGE_NOTIFY_PRIVILEGE,
  is_server:false,
  has_dacl_protect:false,
  has_broken_if_oper_status:true,
  has_physical_mem_access:true,
  has_process_io_counters:false,
  has_terminal_services:false,
  has_create_global_privilege:false,
  has_ioctl_storage_get_media_types_ex:false,
  has_extended_priority_class:false,
  has_guid_volumes:false,
  has_disk_ex_ioctls:false,
  has_fileid_dirinfo:false,
  has_buggy_restart_scan:false,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:true,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  supports_all_posix_ai_flags:false,
  has_restricted_stack_args:false,
  has_transactions:false,
  has_recvmsg:false,
  has_sendmsg:false,
  has_broken_udf:false,
  has_console_handle_problem:false,
  has_broken_alloc_console:false,
  has_always_all_codepages:false,
  has_localenames:false,
  has_mwmo_inputavailable:false,
  has_buggy_thread_startup:false,
  has_fast_cwd:false,
  has_restricted_raw_disk_access:false,
  use_dont_resolve_hack:false,
  use_get_sec_info_on_dirs:false,
  supports_sse:false,
};
a30 2
  has_dacl_protect:true,
  has_broken_if_oper_status:false,
a31 2
  has_process_io_counters:true,
  has_terminal_services:true,
a33 2
  has_extended_priority_class:true,
  has_guid_volumes:true,
a34 1
  has_fileid_dirinfo:true,
a51 1
  has_mwmo_inputavailable:true,
a56 1
  supports_sse:true,
a63 2
  has_dacl_protect:true,
  has_broken_if_oper_status:false,
a64 2
  has_process_io_counters:true,
  has_terminal_services:true,
a66 2
  has_extended_priority_class:true,
  has_guid_volumes:true,
a67 1
  has_fileid_dirinfo:true,
a84 1
  has_mwmo_inputavailable:true,
a89 1
  supports_sse:true,
a96 2
  has_dacl_protect:true,
  has_broken_if_oper_status:false,
a97 2
  has_process_io_counters:true,
  has_terminal_services:true,
a99 2
  has_extended_priority_class:true,
  has_guid_volumes:true,
a100 1
  has_fileid_dirinfo:true,
a117 1
  has_mwmo_inputavailable:true,
a122 1
  supports_sse:true,
a129 2
  has_dacl_protect:true,
  has_broken_if_oper_status:false,
a130 2
  has_process_io_counters:true,
  has_terminal_services:true,
a132 2
  has_extended_priority_class:true,
  has_guid_volumes:true,
a133 1
  has_fileid_dirinfo:true,
a150 1
  has_mwmo_inputavailable:true,
a155 1
  supports_sse:true,
a162 2
  has_dacl_protect:true,
  has_broken_if_oper_status:false,
a163 2
  has_process_io_counters:true,
  has_terminal_services:true,
a165 2
  has_extended_priority_class:true,
  has_guid_volumes:true,
a166 1
  has_fileid_dirinfo:true,
a183 1
  has_mwmo_inputavailable:true,
a188 1
  supports_sse:true,
a195 2
  has_dacl_protect:true,
  has_broken_if_oper_status:false,
a196 2
  has_process_io_counters:true,
  has_terminal_services:true,
a198 2
  has_extended_priority_class:true,
  has_guid_volumes:true,
a199 1
  has_fileid_dirinfo:true,
a216 1
  has_mwmo_inputavailable:true,
a221 1
  supports_sse:true,
a228 2
  has_dacl_protect:true,
  has_broken_if_oper_status:false,
a229 2
  has_process_io_counters:true,
  has_terminal_services:true,
a231 2
  has_extended_priority_class:true,
  has_guid_volumes:true,
a232 1
  has_fileid_dirinfo:true,
a249 1
  has_mwmo_inputavailable:true,
a254 1
  supports_sse:true,
a261 2
  has_dacl_protect:true,
  has_broken_if_oper_status:false,
a262 2
  has_process_io_counters:true,
  has_terminal_services:true,
a264 2
  has_extended_priority_class:true,
  has_guid_volumes:true,
a265 1
  has_fileid_dirinfo:true,
a282 1
  has_mwmo_inputavailable:true,
a287 1
  supports_sse:true,
a294 2
  bool has_osversioninfoex = true;

a298 2
  /* Request versionex info first, which is available on all systems since
     NT4 SP6 anyway.  If that fails, call the simple version. */
d301 1
a301 5
    {
      has_osversioninfoex = false;
      version.dwOSVersionInfoSize = sizeof (OSVERSIONINFO);
      GetVersionEx (reinterpret_cast<LPOSVERSIONINFO>(&version));
    }
d309 3
a311 2
	      /* No mercy.  We require at least NT4 SP4. */
	      caps = &wincap_nt4sp4;
d366 1
a366 1
  if (has_osversioninfoex && version.wProductType != VER_NT_WORKSTATION)
@


1.110
log
@* wincap.cc (wincap_2003): Set use_dont_resolve_hack to true.
@
text
@a51 1
  ts_has_dep_problem:false,
a93 1
  ts_has_dep_problem:false,
a135 1
  ts_has_dep_problem:false,
a177 1
  ts_has_dep_problem:false,
a219 1
  ts_has_dep_problem:false,
a261 1
  ts_has_dep_problem:false,
a303 1
  ts_has_dep_problem:false,
a345 1
  ts_has_dep_problem:false,
a387 1
  ts_has_dep_problem:false,
d488 1
a488 8
    {
      ((wincaps *)caps)->is_server = true;
      if (version.dwMajorVersion >= 6
	  && (version.wSuiteMask
	      & (VER_SUITE_TERMINAL | VER_SUITE_SINGLEUSERTS))
	     == VER_SUITE_TERMINAL)
	((wincaps *)caps)->ts_has_dep_problem = true;
    }
@


1.109
log
@	* fenv.cc (_feinitialise); Don't use SSE instructions on systems not
	supporting them.
	* wincap.h (wincaps::supports_sse): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d322 1
a322 1
  use_dont_resolve_hack:false,
@


1.108
log
@	* fhandler.cc (fhandler_base::open): When creating a file on a
	filesystem supporting ACLs, create the file with WRITE_DAC access.
	Explain why.
	* fhandler_disk_file.cc (fhandler_disk_file::mkdir): Ditto for
	directories.
	* fhandler_socket.cc (fhandler_socket::bind): Ditto for sockets.
	* path.cc (symlink_worker): Ditto for symlinks.
	* security.cc (get_file_sd): Always call GetSecurityInfo for directories
	on XP and Server 2003.  Improve comment to explain why.
	(set_file_attribute): Explicitely cast mode_t value to bool in call to
	get_file_sd.
	* wincap.h (wincaps::use_get_sec_info_on_dirs): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d66 1
d109 1
d152 1
d195 1
d238 1
d281 1
d324 1
d367 1
d410 1
@


1.108.2.1
log
@	* fenv.cc (_feinitialise): Don't use SSE instructions on systems not
	supporting them.
	* wincap.h (wincaps::supports_sse): New element.
	* wincap.cc: Implement above element throughout.
@
text
@a65 1
  supports_sse:false,
a107 1
  supports_sse:true,
a149 1
  supports_sse:true,
a191 1
  supports_sse:true,
a233 1
  supports_sse:true,
a275 1
  supports_sse:true,
a317 1
  supports_sse:true,
a359 1
  supports_sse:true,
a401 1
  supports_sse:true,
@


1.108.2.2
log
@Pull in HEAD changes
@
text
@d322 1
a322 1
  use_dont_resolve_hack:true,
@


1.107
log
@* autoload.cc (dll_load): Only perform DONT_RESOLVE_DLL_REFERENCES hack on
systems which need it.
* wincap.cc (use_dont_resolve_hack): Set as appropriate.
* wincap.h (use_dont_resolve_hack): Define.
@
text
@d65 1
d107 1
d149 1
d191 1
d233 1
d275 1
d317 1
d359 1
d401 1
@


1.106
log
@	* fhandler_socket.cc (address_in_use): Disable.  Add comment.
	(fhandler_socket::bind): Change comment to explain setting the
	SO_EXCLUSIVEADDRUSE socket option.  Remove code which checks for
	address in use.
	* net.cc (cygwin_setsockopt): Never set SO_REUSEADDR option.  Improve
	comment to compensate for the deleted comment in fhandler_socket::bind.
	* wincap.cc: Throughout, drop has_enhanced_socket_security from wincaps.
	* wincap.h (struct wincaps): Drop has_enhanced_socket_security flags
	and method.
@
text
@d64 1
d105 1
d146 1
d187 1
d228 1
d269 1
d310 1
d351 1
d392 1
@


1.105
log
@	* fhandler.h (MAX_PARTITIONS): New definition.
	(class fhandler_dev_floppy): Add partitions array member.  Add close
	method.
	* fhandler_floppy.cc (fhandler_dev_floppy::fhandler_dev_floppy): Zero
	out partitions array.
	(fhandler_dev_floppy::open): Fix "entire disk" condition for call to
	DeviceIoControl (FSCTL_ALLOW_EXTENDED_DASD_IO).
	When opening disks for writing, call DeviceIoControl (FSCTL_LOCK_VOLUME)
	on all affected disk partitions starting with Vista.
	(fhandler_dev_floppy::close): New method.
	(fhandler_dev_floppy::dup): Duplicate handles in partitions, if any.
	* wincap.h (wincaps::has_restricted_raw_disk_access): New element.
	* wincap.cc: Implement above element throughout.
@
text
@a41 1
  has_enhanced_socket_security:false,
a81 1
  has_enhanced_socket_security:false,
a121 1
  has_enhanced_socket_security:false,
a161 1
  has_enhanced_socket_security:false,
a201 1
  has_enhanced_socket_security:false,
a241 1
  has_enhanced_socket_security:false,
a281 1
  has_enhanced_socket_security:true,
a321 1
  has_enhanced_socket_security:true,
a361 1
  has_enhanced_socket_security:true,
@


1.104
log
@	* cygheap.h (cwdstuff::override_win32_cwd): Declare.
	* ntdll.h (struct _PEB): Add members accessed by the fast cwd method
	starting with Vista.
	(struct _KUSER_SHARED_DATA): Define with only the DismountCount.
	(RtlAllocateHeap): Declare.
	(RtlEnterCriticalSection): Declare.
	(RtlFreeHeap): Declare.
	(RtlLeaveCriticalSection): Declare.
	* path.cc (get_user_proc_parms): Remove.
	(struct _FAST_CWD): New structure.
	(fast_cwd_ptr): Define.
	(SharedUserData): Define.
	(peek32): Define.
	(find_fast_cwd_pointers): New function to find the global pointer
	to the current FAST_CWD structure.
	(copy_cwd_str): New helper function.
	(cwdstuff::override_win32_cwd): New method to set the Win32 CWD.
	(cwdstuff::init): Just call override_win32_cwd from here when
	started from native Win32 parent.
	(cwdstuff::set): Access Win32 CWD via PEB reference instead of using
	get_user_proc_parms function.  Memorize old DismountCount before
	opening directory handle.  Call override_win32_cwd to set up Win32 CWD.
	Be more verbose in comments.
	* wincap.h (wincaps::has_fast_cwd): New element.
	* wincap.cc: Implement has_fast_cwd element throughout.
@
text
@d5 1
a5 1
   2009, 2010 Red Hat, Inc.
d64 1
d105 1
d146 1
d187 1
d228 1
d269 1
d310 1
d351 1
d392 1
@


1.103
log
@	* fhandler_socket.cc (fhandler_socket::bind): Drop has_exclusiveaddruse
	condition.  Fix comment about availability.  Move remaining comment to
	the right spot.  Drop has_ip_helper_lib condition.
	* net.cc (cygwin_setsockopt): Drop has_disabled_user_tos_setting
	condition.  Fix comment.
	(get_2k_ifs): Fix comment.
	(get_nt_ifs): Remove.
	(getifaddrs): Drop call to get_nt_ifs.
	(get_ifconf): Ditto.
	* wincap.cc: Throughout, drop has_ip_helper_lib,
	has_disabled_user_tos_setting, and has_exclusiveaddruse settings from
	wincaps.
	(wincap_unknown): Remove.
	(wincap_nt4): Remove.
	(wincap_minimal): New macro, set to wincap_nt4sp4 for now.
	(wincapc::init): Drop test for pre-SP4 NT4.  Just imply at least NT SP4.
	Replace references to wincap_unknown with references to wincap_minimal.
	* wincap.h (struct wincaps): Drop has_ip_helper_lib,
	has_disabled_user_tos_setting, and has_exclusiveaddruse flags and
	methods.
@
text
@d63 1
d103 1
d143 1
d183 1
d223 1
d263 1
d303 1
d343 1
d383 1
@


1.102
log
@* wincap.h (wincaps::has_buggy_thread_startup): Declare.
(wincapc::has_buggy_thread_startup): Ditto.
* wincap.cc::wincap_*): Accommodate has_buggy_thread_startup.
(wincapc::init): Explicitly turn off has_buggy_thread_startup if not WOW64.
* cygthread.h (cygthread::thread_handle): Declare/define new method.
* dcrt0.cc (_dll_crt0): Don't call __sinit here.
(dll_crt0_0): Don't call sigproc_init during initialization if
wincap.has_buggy_thread_startup().
(dll_crt0_1): Defer sigproc_init to here when
wincap.has_buggy_thread_startup().  Call __sinit after we've determined that
we're not forking.
(__main): Rework comments.  Add potential future reminder.
@
text
@d23 2
a24 84
/* Minimal set of capabilities which is equivalent to NT4. */
wincaps wincap_unknown __attribute__((section (".cygwin_dll_common"), shared)) = {
  chunksize:0,
  heapslop:0x0,
  max_sys_priv:SE_CHANGE_NOTIFY_PRIVILEGE,
  is_server:false,
  has_dacl_protect:false,
  has_ip_helper_lib:false,
  has_broken_if_oper_status:false,
  has_physical_mem_access:true,
  has_process_io_counters:false,
  has_terminal_services:false,
  has_create_global_privilege:false,
  has_ioctl_storage_get_media_types_ex:false,
  has_extended_priority_class:false,
  has_guid_volumes:false,
  has_disk_ex_ioctls:false,
  has_disabled_user_tos_setting:false,
  has_fileid_dirinfo:false,
  has_exclusiveaddruse:false,
  has_enhanced_socket_security:false,
  has_buggy_restart_scan:false,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:true,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  supports_all_posix_ai_flags:false,
  has_restricted_stack_args:false,
  has_transactions:false,
  ts_has_dep_problem:false,
  has_recvmsg:false,
  has_sendmsg:false,
  has_broken_udf:false,
  has_console_handle_problem:false,
  has_broken_alloc_console:false,
  has_always_all_codepages:false,
  has_localenames:false,
  has_mwmo_inputavailable:false,
  has_buggy_thread_startup:false,
};

wincaps wincap_nt4 __attribute__((section (".cygwin_dll_common"), shared)) = {
  chunksize:0,
  heapslop:0x0,
  max_sys_priv:SE_CHANGE_NOTIFY_PRIVILEGE,
  is_server:false,
  has_dacl_protect:false,
  has_ip_helper_lib:false,
  has_broken_if_oper_status:false,
  has_physical_mem_access:true,
  has_process_io_counters:false,
  has_terminal_services:false,
  has_create_global_privilege:false,
  has_ioctl_storage_get_media_types_ex:false,
  has_extended_priority_class:false,
  has_guid_volumes:false,
  has_disk_ex_ioctls:false,
  has_disabled_user_tos_setting:false,
  has_fileid_dirinfo:false,
  has_exclusiveaddruse:false,
  has_enhanced_socket_security:false,
  has_buggy_restart_scan:false,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:true,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  supports_all_posix_ai_flags:false,
  has_restricted_stack_args:false,
  has_transactions:false,
  ts_has_dep_problem:false,
  has_recvmsg:false,
  has_sendmsg:false,
  has_broken_udf:false,
  has_console_handle_problem:false,
  has_broken_alloc_console:false,
  has_always_all_codepages:false,
  has_localenames:false,
  has_mwmo_inputavailable:false,
  has_buggy_thread_startup:false,
};
a31 1
  has_ip_helper_lib:true,
a40 1
  has_disabled_user_tos_setting:false,
a41 1
  has_exclusiveaddruse:true,
a70 1
  has_ip_helper_lib:true,
a79 1
  has_disabled_user_tos_setting:true,
a80 1
  has_exclusiveaddruse:true,
a109 1
  has_ip_helper_lib:true,
a118 1
  has_disabled_user_tos_setting:true,
a119 1
  has_exclusiveaddruse:true,
a148 1
  has_ip_helper_lib:true,
a157 1
  has_disabled_user_tos_setting:true,
a158 1
  has_exclusiveaddruse:true,
a187 1
  has_ip_helper_lib:true,
a196 1
  has_disabled_user_tos_setting:true,
a197 1
  has_exclusiveaddruse:true,
a226 1
  has_ip_helper_lib:true,
a235 1
  has_disabled_user_tos_setting:true,
a236 1
  has_exclusiveaddruse:true,
a265 1
  has_ip_helper_lib:true,
a274 1
  has_disabled_user_tos_setting:true,
a275 1
  has_exclusiveaddruse:true,
a304 1
  has_ip_helper_lib:true,
a313 1
  has_disabled_user_tos_setting:true,
a314 1
  has_exclusiveaddruse:true,
a343 1
  has_ip_helper_lib:true,
a352 1
  has_disabled_user_tos_setting:true,
a353 1
  has_exclusiveaddruse:true,
d404 2
a405 5
	      if (!has_osversioninfoex
		  && strcmp (version.szCSDVersion, "Service Pack 4") < 0)
		caps = &wincap_nt4;
	      else
		caps = &wincap_nt4sp4;
d446 1
a446 1
	      caps = &wincap_unknown;
d456 1
a456 1
	caps = &wincap_unknown;
@


1.101
log
@	* autoload.cc (MsgWaitForMultipleObjectsEx): Define.
	(MsgWaitForMultipleObjects): Remove.
	* select.cc (select_stuff::wait): Use MsgWaitForMultipleObjectsEx with
	QS_ALLPOSTMESSAGE and, if possible, MWMO_INPUTAVAILABLE flags.  Explain
	why.  Fix a potential crash due to a NULL pointer in WAIT_FAILED case.
	(peek_windows): Use filter pattern on NT4.  Explain why.
	* wincap.h (wincaps::has_mwmo_inputavailable): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d63 1
d105 1
d147 1
d189 1
d231 1
d273 1
d315 1
d357 1
d399 1
d441 1
d483 1
d590 2
@


1.100
log
@	* wincap.cc (wincap_7): Set needs_count_in_si_lpres2 to false.
@
text
@d62 1
d103 1
d144 1
d185 1
d226 1
d267 1
d308 1
d349 1
d390 1
d431 1
d472 1
@


1.99
log
@	* Makefile.in (DLL_OFILES): Add nlsfunc.o and strfmon.o.
	* autoload.cc (LocaleNameToLCID): Define.
	* cygwin.din (strfmon): Export.
	* nlsfuncs.cc: New file.  Define a lot of internal functions called
	from setlocale.
	(wcscoll): Implement locale-aware here, using CompareStringW function.
	(strcoll): Ditto.
	(wcsxfrm): Implement locale-aware here, usingLCMapStringW function.
	(strxfrm): Ditto.
	(__set_charset_from_locale): Replace __set_charset_from_codepage.
	Return Linux-compatible charset.
	* strfuncs.cc (__set_charset_from_codepage): Remove.
	* wchar.h (__set_charset_from_codepage): Drop definition.
	* wincap.h (wincaps::has_localenames): New element.
	* wincap.cc: Implement above element throughout.
	* libc/strfmon.c: New file.
	* libc/strptime.cc: Remove locale constant strings in favor of
	access to locale-specifc data.
	(strptime): Point _CurrentTimeLocale to locale-specific data.
	Throughout use correct locale-specific format fields for all
	locale-specific formats.
	* include/monetary.h: New file.
	* include/cygwin/version.h (CYGWIN_VERSION_API_MINOR): Bump.
@
text
@d447 1
a447 1
  needs_count_in_si_lpres2:true,
@


1.98
log
@	Throughout, replace hMainProc with GetCurrentProcess/NtCurrentProcess
	according to context.  Throughout, replace hMainThread with
	GetCurrentThread/NtCurrentThread according to context.
	* dcrt0.cc (dll_crt0_0): Drop duplication of GetCurrentProcess to
	hMainProc.  Drop duplication of GetCurrentThread to hMainThread.
	* dtable.cc (dtable::stdio_init): Remove useless comment.
	* globals.cc (hMainProc): Remove.
	(hMainThread): Remove.
	* ntdll.h (NtCurrentProcess): Define.
	(NtCurrentThread: Define.
@
text
@d4 2
a5 1
   Copyright 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008 Red Hat, Inc.
d61 1
d101 1
d141 1
d181 1
d221 1
d261 1
d301 1
d341 1
d381 1
d421 1
d461 1
@


1.97
log
@	* security.cc (alloc_sd): Re-introduce setting the SE_DACL_PROTECTED
	flag.  Remove INHERITED_ACE flag from all inherited ACEs.  Add comment.
	Fix ace_off counter in unrelated ACE loop.
	* wincap.cc: Re-add has_dacl_protect throughout.
	* wincap.h: Ditto.
@
text
@d547 1
a547 1
  if (NT_SUCCESS (NtQueryInformationProcess (GetCurrentProcess (),
@


1.96
log
@	* fhandler.cc (fhandler_base::open): Always create file with default
	security descriptor and fix descriptor afterwards.  Change comment to
	explain why.
	* security.cc (alloc_sd): Drop setting the SE_DACL_PROTECTED flag.
	* wincap.cc: Remove has_dacl_protect throughout.
	* wincap.h: Ditto.
@
text
@d28 1
d67 1
d106 1
d145 1
d184 1
d223 1
d262 1
d301 1
d340 1
d379 1
d418 1
@


1.95
log
@	* dtable.cc (dtable::init_std_file_from_handle): Fix comment to
	document change in the Windows 7 workaround.
	* wincap.cc (wincapc::init): Don't set has_console_handle_problem
	to false on 32 bit systems.
@
text
@a27 1
  has_dacl_protect:false,
a65 1
  has_dacl_protect:false,
a103 1
  has_dacl_protect:false,
a141 1
  has_dacl_protect:true,
a179 1
  has_dacl_protect:true,
a217 1
  has_dacl_protect:true,
a255 1
  has_dacl_protect:true,
a293 1
  has_dacl_protect:true,
a331 1
  has_dacl_protect:true,
a369 1
  has_dacl_protect:true,
a407 1
  has_dacl_protect:true,
@


1.94
log
@	* wincap.h (wincaps::has_always_all_codepages): New element.
	* wincap.cc: Implement above element throughout.
	* wchar.h (__sjis_mbtowc): Declare.
	(__eucjp_mbtowc): Ditto.
	(__gbk_mbtowc): Ditto.
	(__kr_mbtowc): Ditto.
	(__big5_mbtowc): Ditto.
	* syscalls.cc (internal_setlocale): Convert to char * function.
	Return parameter by default.  Return NULL if request to use a
	charset can't be satisfied due to missing codepage support in the
	underlying OS.  Fix comment.
	(setlocale): Store original locale.  Restore to original locale if
	internal_setlocale returns NULL.
@
text
@a553 1
      ((wincaps *)caps)->has_console_handle_problem = false;
@


1.93
log
@	* wincap.h (wincaps::has_broken_alloc_console): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d59 1
d98 1
d137 1
d176 1
d215 1
d254 1
d293 1
d332 1
d371 1
d410 1
d449 1
@


1.92
log
@	* dtable.cc (dtable::init_std_file_from_handle): Add workaround for
	Windows 7 64 bit issue.  Add lengthy comment to explain what happens.
	* wincap.h (wincaps::has_console_handle_problem): New element.
	* wincap.cc: Implement above element throughout.
	(wincap_7): New wincaps structure for NT 6.1 kernels.
	(wincapc::init): Set has_console_handle_problem to false for 32 bit
	systems.

	Fix broken older ChangeLog entry.
@
text
@d58 1
d96 1
d134 1
d172 1
d210 1
d248 1
d286 1
d324 1
d362 1
d400 1
d438 1
@


1.91
log
@	* fhandler_disk_file.cc (fhandler_disk_file::readdir): Fix inode number
	evaluation for faked "." entry.

	* mount.cc (fs_info::update): Move setting of is_cdrom after checking
	for caseinsensitivity.  Recognize UDF in is_cdrom case and set
	caseinsensitive flag according to UDF brokenness determined by OS.
	Add comment to explain why.
	* mount.h (class fs_info): Add is_udf status flag.
	* path.cc (symlink_info::check): Add workaround for UDF bug in
	terms of casesensitivity on certain OSes.
	* wincap.h (wincaps::has_broken_udf): New element.
	(wincaps::has_broken_udf): New element
@
text
@d57 1
d94 1
d131 1
d168 1
d205 1
d242 1
d279 1
d316 1
d353 1
d390 38
d491 9
a499 1
	      caps = &wincap_vista;
d532 1
@


1.90
log
@	* autoload.cc (WSAIoctl): Reintroduce.
	(WSASendMsg): Define.
	* fhandler.h (class fhandler_socket): Change definition of recv_internal
	and send_internal to take WSAMSG pointer as parameter.
	* fhandler_socket.cc (WSAID_WSARECVMSG): Define.
	(LPFN_WSARECVMSG): Define.
	(WSASendMsg): Declare.
	(get_ext_funcptr): New function to fetch address of WSARecvMsg.
	(fhandler_socket::recv_internal): Take just a LPWSAMSG parameter.
	Change code accordingly.  If control information is requested,
	fetch address of WSARecvMsg and use that instead of WSARecvFrom.
	(fhandler_socket::recvfrom): Change return type to ssize_t as
	declared in fhandler.h.  Accommodate changes to recv_internal.
	(fhandler_socket::recvmsg): Ditto.  Make sure that control information
	is only requested if system, address family, and socket type support it.
	(fhandler_socket::send_internal): Take just a LPWSAMSG parameter
	and the flags.  Change code accordingly.  If control information is
	provided, use WSASendMsg instead of WSASendTo.
	(fhandler_socket::sendto): Drop useless comment.  Accommodate changes
	to send_internal.
	(fhandler_socket::sendmsg): Ditto.  Make sure that control information
	is only provided if system, address family, and socket type support it.
	* wincap.h (wincaps::has_recvmsg): New element.
	(wincaps::has_sendmsg): New element
	* wincap.cc: Implement above elements throughout.
	* include/cygwin/socket.h (CMSG_ALIGN): Phrase in terms of alignment
	of type struct cmsghdr.
@
text
@d56 1
d92 1
d128 1
d164 1
d200 1
d236 1
d272 1
d308 1
d344 1
d380 1
@


1.89
log
@	* autoload.cc (GetSystemDEPPolicy): Define.
	(GetProcessDEPPolicy): Ditto.
	(SetProcessDEPPolicy): Ditto.
	* dcrt0.cc (disable_dep): New static function.
	(dll_crt0_0): Call disable_dep on platforms requiring it.  Add longish
	comment to explain the circumstances.
	* wincap.h (wincaps::ts_has_dep_problem): New element.
	* wincap.cc: Implement above element throughout.
	(wincapc::init): Set ts_has_dep_problem to true on 2008 Terminal
	Servers.
	* winsup.h (WINVER): Set to 0x0601.
@
text
@d54 2
d89 2
d124 2
d159 2
d194 2
d229 2
d264 2
d299 2
d334 2
d369 2
@


1.88
log
@	* wincap.cc (all wincaps): Store in .cygwin_dll_common section same as
	wincap.  Add comment to explain why.
@
text
@d53 1
d86 1
d119 1
d152 1
d185 1
d218 1
d251 1
d284 1
d317 1
d350 1
d432 8
a439 2
    ((wincaps *)caps)->is_server = true;

@


1.87
log
@	* fhandler_socket.cc (fhandler_socket::bind): Don't run explicit
	local socket test in SO_REUSEADDR case on systems supporting
	enhanced socket security.  Explain why.  Only call address_in_use
	for AF_INET sockets.
	* net.cc (cygwin_setsockopt): Don't call setsockopt to set SO_REUSEADDR
	on systems supporting enhanced socket security.  Add comment.
	* wincap.h (wincaps::has_enhanced_socket_security): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d16 6
d23 1
a23 1
static NO_COPY wincaps wincap_unknown = {
d55 1
a55 1
static NO_COPY wincaps wincap_nt4 = {
d87 1
a87 1
static NO_COPY wincaps wincap_nt4sp4 = {
d119 1
a119 1
static NO_COPY wincaps wincap_2000 = {
d151 1
a151 1
static NO_COPY wincaps wincap_2000sp4 = {
d183 1
a183 1
static NO_COPY wincaps wincap_xp = {
d215 1
a215 1
static NO_COPY wincaps wincap_xpsp1 = {
d247 1
a247 1
static NO_COPY wincaps wincap_xpsp2 = {
d279 1
a279 1
static NO_COPY wincaps wincap_2003 = {
d311 1
a311 1
static NO_COPY wincaps wincap_vista = {
@


1.86
log
@	* autoload.cc (LoadDLLfuncNt): Re-invent.
	(NtCreateTransaction): Define.
	(NtCommitTransaction): Define.
	(NtRollbackTransaction): Define.
	(RtlGetCurrentTransaction): Define.
	(RtlSetCurrentTransaction): Define.
	* ntdll.h (TRANSACTION_ALL_ACCESS): Define.
	(NtCreateTransaction): Declare.
	(NtCommitTransaction): Declare.
	(NtRollbackTransaction): Declare.
	(RtlGetCurrentTransaction): Declare.
	(RtlSetCurrentTransaction): Declare.
	* syscalls.cc (start_transaction): New static function to start TxF
	transaction.
	(stop_transaction): New static function to end TxF transaction.
	(rename): Call start_transaction and stop_transaction where appropriate
	on systems supporting transactions.
	* wincap.h (wincaps::has_transactions): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d36 1
d68 1
d100 1
d132 1
d164 1
d196 1
d228 1
d260 1
d292 1
d324 1
@


1.85
log
@	* autoload.cc (IsWow64Process): Remove.
	(Wow64DisableWow64FsRedirection): Remove.
	(Wow64RevertWow64FsRedirection): Remove.
	* ntdll.h (enum _PROCESSINFOCLASS): Define ProcessWow64Information.
	* init.cc (respawn_wow64_process): Use NtQueryInformationProcess to
	get WOW64 state.
	* wincap.cc (wincapc::init): Ditto.
	* wincap.h (wincapc::wow64): Change type to ULONG.
@
text
@d45 1
d76 1
d107 1
d138 1
d169 1
d200 1
d231 1
d262 1
d293 1
d324 1
@


1.84
log
@	* wincap.h (wincapc::wow64): Change type to BOOL.
	* wincap.cc: Remove explicit use of this pointer in wincapc methods.
	(wincapc::init): Fix bug in IsWow64Process handling.
@
text
@d14 1
d398 4
a401 1
  if (IsWow64Process (GetCurrentProcess (), &wow64) && !wow64)
@


1.83
log
@	* Fix copyright dates.
@
text
@d395 1
a395 1
    ((wincaps *)this->caps)->is_server = true;
d397 1
a397 4
  BOOL is_wow64_proc = FALSE;
  if (IsWow64Process (GetCurrentProcess (), &is_wow64_proc))
    wow64 = is_wow64_proc;
  else
d399 2
a400 2
      ((wincaps *)this->caps)->needs_count_in_si_lpres2 = false;
      ((wincaps *)this->caps)->has_restricted_stack_args = false;
d410 1
a410 1
  ((wincaps *)this->caps)->chunksize = nchunksize;
@


1.82
log
@        * cygtls.cc (_cygtls::init_exception_handler): Revert patch
        from 2005-12-02.
        * exceptions.cc (stack_info::walk): Add workaround for NT 5.2
        64 bit OSes.
        * wincap.h (wincaps::has_restricted_stack_args): New element.
        * wincap.cc: Implement above element throughout.
        (wincapc::init): Reset has_restricted_stack_args if not running
        under WOW64.
@
text
@d4 1
a4 1
   Copyright 2001, 2002, 2003, 2004, 2005, 2006, 2007 Red Hat, Inc.
@


1.81
log
@	* dcrt0.cc: Include string.h.
	(initial_env): Use small_printf's %P specifier.
	* dll_init.cc (dll_list::alloc): Use PATH_MAX instead of CYG_MAX_PATH
	for path name buffer size.
	* dll_init.h (struct dll): Ditto.
	* environ.cc: Include string.h.
	(win_env::add_cache): Use temporary local buffer for path conversion.
	(posify): Ditto.
	* exceptions.cc (try_to_debug): Use CreateProcessW to allow long path
	names.
	* miscfuncs.cc: Drop unused implementations of strcasematch and
	strncasematch.
	(ch_case_eq): Drop.
	(strcasestr): Drop.
	(cygwin_wcscasecmp): New function.
	(cygwin_wcsncasecmp): New function.
	(cygwin_strcasecmp): New function.
	(cygwin_strncasecmp): New function.
	(cygwin_wcslwr): New function.
	(cygwin_wcsupr): New function.
	(cygwin_strlwr): New function.
	(cygwin_strupr): New function.
	* ntdll.h (RtlDowncaseUnicodeString): Declare.
	(RtlUpcaseUnicodeString): Declare.
	(RtlInt64ToHexUnicodeString): Fix typo in comment.
	* string.h: Disable not NLS aware implementations of strcasematch
	and strncasematch.
	(cygwin_strcasecmp): Declare.
	(strcasecmp): Define as cygwin_strcasecmp.
	(cygwin_strncasecmp): Declare.
	(strncasecmp): Define as cygwin_strncasecmp.
	(strcasematch):Define using cygwin_strcasecmp.
	(strncasematch):Define using cygwin_strncasecmp.
	(cygwin_strlwr): Declare.
	(strlwr): Define as cygwin_strlwr.
	(cygwin_strupr): Declare.
	(strupr): Define as cygwin_strupr.
	* wchar.h: New file.
	* wincap.cc (wincapc::init): Use "NT" as fix OS string.
	* winsup.h (strcasematch): Drop declaration.
	(strncasematch): Ditto.
	(strcasestr): Ditto.
@
text
@d43 1
d73 1
d103 1
d133 1
d163 1
d193 1
d223 1
d253 1
d283 1
d313 1
d401 4
a404 1
    ((wincaps *)this->caps)->needs_count_in_si_lpres2 = false;
@


1.80
log
@	* autoload.cc (SetSecurityDescriptorControl): Drop.
	* security.cc (alloc_sd): Set security descriptor control flag without
	calling SetSecurityDescriptorControl function.
	* wincap.h (wincapc::has_dacl_protect): Rename from
	has_security_descriptor_control.
	* wincap.cc: Ditto throughout.
@
text
@a310 1
  const char *os;
a332 1
	      os = "NT";
a339 1
	      os = "NT";
a366 1
	      os = "NT";
a369 1
	      os = "??";
a379 1
	os = "??";
d393 1
a393 1
  __small_sprintf (osnam, "%s-%d.%d", os, version.dwMajorVersion,
@


1.79
log
@	* cygheap.h (init_cygheap::luid): Remove.
	* mmap.cc (mlock): Accommodate parameter change in call to
	push_thread_privilege.
	(munlock): Ditto.
	* ntdll.h (STATUS_NOT_ALL_ASSIGNED): Define.
	(NtAdjustPrivilegesToken): Declare.
	* sec_helper.cc (cygpriv): Reorder to match numerical privilege order.
	(privilege_luid): Take job of privilege_luid_by_name, using new
	cygpriv.
	(privilege_luid_by_name): Remove.
	(privilege_name): Accommodate new cygpriv array.
	(set_privilege): Call NtAdjustPrivilegesToken to avoid using advapi32.
	Accommodate changes to privilege_name.
	(set_cygwin_privileges): Simplify.  Don't try to set
	SE_CREATE_GLOBAL_PRIVILEGE on systems not supporting it.
	* security.cc (sys_privs): Reorder to match numerical privilege order.
	Use real privilege values as defined in security.h.
	(get_system_priv_list): Drop unused grp_list argument.  Create
	list of privileges according to new wincapc::max_sys_priv value.
	(get_priv_list): Call privilege_luid instead of privilege_luid_by_name.
	Make priv a local value instead of a pointer.
	(create_token): Accommodate parameter change in call to
	push_self_privilege.
	(lsaauth): Ditto.
	(check_access): Use privilege values directly instead of calling
	privilege_luid.
	* security.h: Define real privilege values.
	(cygpriv_idx): Remove.
	(privilege_luid): Change declaration.
	(privilege_luid_by_name): Drop declaration.
	(set_privilege): Change declaration.
	(set_process_privilege): Drop definition.
	(_push_thread_privilege): Accomodate new set_privilege parameters.
	* wincap.h (wincapc::max_sys_priv): New element.
	* wincap.cc: Implement above element throughout.
	(wincap_2000sp4): New wincaps structure.
	(wincap_xpsp1): Ditto.
	(wincap_xpsp2): Ditto.
	(wincapc::init): Use new wincaps.
	(wincapc::max_sys_priv): New element.
@
text
@d21 1
a21 1
  has_security_descriptor_control:false,
d50 1
a50 1
  has_security_descriptor_control:false,
d79 1
a79 1
  has_security_descriptor_control:false,
d108 1
a108 1
  has_security_descriptor_control:true,
d137 1
a137 1
  has_security_descriptor_control:true,
d166 1
a166 1
  has_security_descriptor_control:true,
d195 1
a195 1
  has_security_descriptor_control:true,
d224 1
a224 1
  has_security_descriptor_control:true,
d253 1
a253 1
  has_security_descriptor_control:true,
d282 1
a282 1
  has_security_descriptor_control:true,
@


1.78
log
@	* autoload.cc (WSAIoctl): Remove.
	* cygwin.din: Export freeifaddrs, getifaddrs.
	* fhandler_socket.cc (fhandler_socket::ioctl): Drop SOCKET parameter
	from get_ifconf.
	* net.cc: Include ifaddrs.h.
	(in_are_prefix_equal): Match addresses in network byte order.
	(ip_addr_prefix): Convert address into host byte order before
	testing with IN_LOOPBACK.
	(struct ifall): Define.
	(get_xp_ifs): Replace get_xp_ifconf.  Return struct ifall array.
	(get_2k_ifs): Ditto, replace get_2k_ifconf.
	(get_nt_ifs): Ditto, replace get_nt_ifconf.
	(getifaddrs): New function.
	(freeifaddrs): New function.
	(get_ifconf): Call matching get_XX_ifs function and create
	ifc content from here.  Drop lo fake since it's now in get_nt_ifs.
	* posix.sgml: Add freeifaddrs and getifaddrs to list of implemented
	BSD functions.
	* wincap.h (wincapc::has_broken_if_oper_status): New element.
	* wincap.cc: Implement above element throughout.
	* include/ifaddrs.h: New file.
	* include/cygwin/version.h: Bump API minor number.
@
text
@d13 1
d19 1
d48 1
d77 1
d106 1
d132 29
d164 1
d185 58
d251 1
d280 1
d346 4
a349 1
		    caps = &wincap_2000;
d354 9
a362 2
		    if (version.wServicePackMajor < 1)
		      ((wincaps *)this->caps)->has_gaa_prefixes = false;
@


1.77
log
@	* cygheap.cc (cygheap_init): Fix formatting.  Remove comment.  Set
	shared_prefix depending only on terminal service capability.
	* dcrt0.cc (dll_crt0_1): Don't call set_cygwin_privileges here.
	* fhandler_fifo.cc (fhandler_fifo::open): Create the mutex as global
	object.
	* posix_ipc.cc (ipc_mutex_init): Use cygheap->shared_prefix.
	(ipc_cond_init): Ditto.
	* sec_helper.cc (privilege_name): Make static.  Use LookupPrivilegeName
	directly to be independent of the state of cygheap.
	(set_privilege): Take a LUID as parameter instead of an index value.
	Only print debug output in case of failure.
	(set_cygwin_privileges): Add comment.  Use LookupPrivilegeValue to
	get privilege LUIDs.
	(init_global_security): Call set_cygwin_privileges here.
	* security.h (privilege_name): Drop declaration.
	(set_privilege): Declare according to above change.
	(set_process_privilege): Call privilege_luid to get LUID.
	(_push_thread_privilege): Ditto.
	* shared.cc (open_shared): Add comment.  On systems supporting the
	SeCreateGlobalPrivilege, try to create/open global shared memory first.
	Fall back to local shared memory if that fails.
	* thread.cc (semaphore::semaphore): Use cygheap->shared_prefix.
	* wincap.h (wincapc::has_create_global_privilege): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d21 1
d49 1
d77 1
d105 1
d133 1
d161 1
d189 1
@


1.76
log
@	Throughout remove all usage of wincap.has_security.
	* environ.cc (environ_init): Drop setting allow_ntsec here.
	* grp.cc (initgroups32): Drop usage of label "out".
	* security.cc (allow_ntsec): Set to true by default.
	* syscalls.cc (seteuid32): Remove label success_9x.
	* wincap.cc: Remove has_security throughout.
	* wincap.h: Ditto.
@
text
@d24 1
d51 1
d78 1
d105 1
d132 1
d159 1
d186 1
@


1.75
log
@	* fhandler.h (class fhandler_pipe): Remove members writepipe_exists,
	orig_pid and id.  Make hit_eof inline.
	* fhandler_fifo.cc (fhandler_fifo::open): Drop handling of
	writepipe_exists, orig_pid and id.
	* pipe.cc: Ditto throughout.
	(pipecount): Remove.
	(pipeid_fmt): Remove.
	(fhandler_pipe::hit_eof): Simplify.  Move to fhandler.h.
	(fhandler_pipe::dup): Drop leave label.
	(fhandler_pipe::create): Drop has_unreliable_pipes case.
	* wincap.cc: Remove has_unreliable_pipes throughout.
	* wincap.h: Ditto.
@
text
@a18 1
  has_security:true,
a44 1
  has_security:true,
a70 1
  has_security:true,
a96 1
  has_security:true,
a122 1
  has_security:true,
a148 1
  has_security:true,
a174 1
  has_security:true,
d261 2
a262 1
	/* This is just preliminary. */
@


1.74
log
@	* fhandler_console.cc (fhandler_console::need_invisible): Drop
	pty_needs_alloc_console check.
	* spawn.cc (spawn_guts): Ditto.
	(av::fixup): Remove setting iscui.
	* syscalls.cc (rename): Drop has_move_file_ex checks.  Remove 9x
	specific code.
	* wincap.cc: Remove has_move_file_ex and pty_needs_alloc_console
	throughout.
	* wincap.h: Ditto.
@
text
@a22 1
  has_unreliable_pipes:false,
a49 1
  has_unreliable_pipes:false,
a76 1
  has_unreliable_pipes:false,
a103 1
  has_unreliable_pipes:false,
a130 1
  has_unreliable_pipes:false,
a157 1
  has_unreliable_pipes:false,
a184 1
  has_unreliable_pipes:false,
@


1.73
log
@	* exceptions.cc (dummy_ctrl_c_handler): Remove.
	(init_console_handler): Drop has_null_console_handler_routine checks.
	* fhandler_raw.cc (fhandler_dev_raw::open): Drop has_raw_devices check.
	* fhandler_serial.cc (fhandler_serial::open): Drop
	.supports_reading_modem_output_lines check.
	* miscfuncs.cc (low_priority_sleep): Drop has_switch_to_thread check.
	* shared.cc (open_shared): Drop needs_memory_protection checks.
	* spawn.cc (spawn_guts): Drop start_proc_suspended check.
	* uname.cc (uname): Drop has_valid_processorlevel check.
	* wincap.cc: Remove has_raw_devices, has_valid_processorlevel,
	supports_reading_modem_output_lines, needs_memory_protection,
	has_switch_to_thread, start_proc_suspended and
	has_null_console_handler_routine throughout.
	* wincap.h: Ditto.
@
text
@a22 1
  has_move_file_ex:true,
a24 1
  pty_needs_alloc_console:true,
a50 1
  has_move_file_ex:true,
a52 1
  pty_needs_alloc_console:true,
a78 1
  has_move_file_ex:true,
a80 1
  pty_needs_alloc_console:true,
a106 1
  has_move_file_ex:true,
a108 1
  pty_needs_alloc_console:true,
a134 1
  has_move_file_ex:true,
a136 1
  pty_needs_alloc_console:true,
a162 1
  has_move_file_ex:true,
a164 1
  pty_needs_alloc_console:true,
a190 1
  has_move_file_ex:true,
a192 1
  pty_needs_alloc_console:true,
@


1.72
log
@	* fhandler.cc (fhandler_base::lseek): Drop 9x considerations.
	* fhandler_disk_file.cc (fhandler_disk_file::lock): Ditto.
	* wincap.cc: Remove lock_file_highword and has_64bit_file_access
	throughout.
	* wincap.h: Ditto.
@
text
@a24 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
a25 2
  supports_reading_modem_output_lines:true,
  needs_memory_protection:true,
a27 1
  has_switch_to_thread:true,
a28 1
  start_proc_suspended:false,
a30 1
  has_null_console_handler_routine:true,
a54 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
a55 2
  supports_reading_modem_output_lines:true,
  needs_memory_protection:true,
a57 1
  has_switch_to_thread:true,
a58 1
  start_proc_suspended:false,
a60 1
  has_null_console_handler_routine:true,
a84 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
a85 2
  supports_reading_modem_output_lines:true,
  needs_memory_protection:true,
a87 1
  has_switch_to_thread:true,
a88 1
  start_proc_suspended:false,
a90 1
  has_null_console_handler_routine:true,
a114 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
a115 2
  supports_reading_modem_output_lines:true,
  needs_memory_protection:true,
a117 1
  has_switch_to_thread:true,
a118 1
  start_proc_suspended:false,
a120 1
  has_null_console_handler_routine:true,
a144 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
a145 2
  supports_reading_modem_output_lines:true,
  needs_memory_protection:true,
a147 1
  has_switch_to_thread:true,
a148 1
  start_proc_suspended:false,
a150 1
  has_null_console_handler_routine:true,
a174 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
a175 2
  supports_reading_modem_output_lines:true,
  needs_memory_protection:true,
a177 1
  has_switch_to_thread:true,
a178 1
  start_proc_suspended:false,
a180 1
  has_null_console_handler_routine:true,
a204 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
a205 2
  supports_reading_modem_output_lines:true,
  needs_memory_protection:true,
a207 1
  has_switch_to_thread:true,
a208 1
  start_proc_suspended:false,
a210 1
  has_null_console_handler_routine:true,
@


1.71
log
@	* cygheap.h (struct cwdstuff): Remove sync member and keep_in_sync
	accessors.
	* external.cc (cygwin_internal): Drop call to cygheap->cwd.keep_in_sync.
	* fhandler_disk_file.cc (fhandler_disk_file::link): Always presume
	ability to create hard links.
	* path.cc (cwdstuff::init): Drop 9x considerations.
	(cwdstuff::keep_in_sync): Remove.
	(cwdstuff::set): Take NT for granted.
	* pinfo.h (cygwin_pid): Just return pid.
	* wincap.cc: Remove has_hard_links, can_open_directories,
	has_negative_pids, has_named_pipes, has_try_enter_critical_section,
	cant_debug_dll_entry and detect_win16_exe throughout.
	* wincap.h: Ditto.
@
text
@a15 1
  lock_file_highword:UINT32_MAX,
a26 1
  has_64bit_file_access:true,
a52 1
  lock_file_highword:UINT32_MAX,
a63 1
  has_64bit_file_access:true,
a89 1
  lock_file_highword:UINT32_MAX,
a100 1
  has_64bit_file_access:true,
a126 1
  lock_file_highword:UINT32_MAX,
a137 1
  has_64bit_file_access:true,
a163 1
  lock_file_highword:UINT32_MAX,
a174 1
  has_64bit_file_access:true,
a200 1
  lock_file_highword:UINT32_MAX,
a211 1
  has_64bit_file_access:true,
a237 1
  lock_file_highword:UINT32_MAX,
a248 1
  has_64bit_file_access:true,
@


1.70
log
@	* fhandler_console.cc (fhandler_console::read): Drop 9x specific
	handling of AltGr key.
	* mmap.cc: Take NT for granted throughout.
	* wincap.cc: Remove map_view_of_file_ex_sucks, altgr_is_ctrl_alt,
	has_working_copy_on_write, share_mmaps_only_by_name,
	virtual_protect_works_on_shared_pages, has_mmap_alignment_bug and
	has_working_virtual_lock throughout.
	* wincap.h: Ditto.
@
text
@a23 2
  has_hard_links:true,
  can_open_directories:true,
a24 1
  has_negative_pids:false,
a25 2
  has_named_pipes:true,
  has_try_enter_critical_section:true,
a34 1
  cant_debug_dll_entry:false,
a38 1
  detect_win16_exe:false,
a62 2
  has_hard_links:true,
  can_open_directories:true,
a63 1
  has_negative_pids:false,
a64 2
  has_named_pipes:true,
  has_try_enter_critical_section:true,
a73 1
  cant_debug_dll_entry:false,
a77 1
  detect_win16_exe:false,
a101 2
  has_hard_links:true,
  can_open_directories:true,
a102 1
  has_negative_pids:false,
a103 2
  has_named_pipes:true,
  has_try_enter_critical_section:true,
a112 1
  cant_debug_dll_entry:false,
a116 1
  detect_win16_exe:false,
a140 2
  has_hard_links:true,
  can_open_directories:true,
a141 1
  has_negative_pids:false,
a142 2
  has_named_pipes:true,
  has_try_enter_critical_section:true,
a151 1
  cant_debug_dll_entry:false,
a155 1
  detect_win16_exe:false,
a179 2
  has_hard_links:true,
  can_open_directories:true,
a180 1
  has_negative_pids:false,
a181 2
  has_named_pipes:true,
  has_try_enter_critical_section:true,
a190 1
  cant_debug_dll_entry:false,
a194 1
  detect_win16_exe:false,
a218 2
  has_hard_links:true,
  can_open_directories:true,
a219 1
  has_negative_pids:false,
a220 2
  has_named_pipes:true,
  has_try_enter_critical_section:true,
a229 1
  cant_debug_dll_entry:false,
a233 1
  detect_win16_exe:false,
a257 2
  has_hard_links:true,
  can_open_directories:true,
a258 1
  has_negative_pids:false,
a259 2
  has_named_pipes:true,
  has_try_enter_critical_section:true,
a268 1
  cant_debug_dll_entry:false,
a272 1
  detect_win16_exe:false,
@


1.69
log
@	* fhandler.cc (fhandler_base::set_no_inheritance): Always use
	SetHandleInformation.
	* fhandler_disk_file.cc (fhandler_disk_file::lock): Always use
	UnlockFileEx/LockFileEx functions.
	* net.cc (fdsock): Don't bother to duplicate socket for inheritance.
	* sysconf.cc (get_nproc_values): Take NT for granted.
	(get_avphys): Ditto.
	* syslog.cc (WIN95_EVENT_LOG_PATH): Remove define.
	(get_win95_event_log_path): Remove.
	(vsyslog): Fix formatting.  Take NT for granted.
	* wincap.cc: Remove has_lock_file_ex, has_signal_object_and_wait,
	has_eventlog, has_set_handle_information,
	has_set_handle_information_on_console_handles and supports_smp
	throughout.
	* wincap.h: Ditto.
@
text
@a22 2
  map_view_of_file_ex_sucks:false,
  altgr_is_ctrl_alt:true,
a23 4
  has_working_copy_on_write:true,
  share_mmaps_only_by_name:false,
  virtual_protect_works_on_shared_pages:true,
  has_mmap_alignment_bug:false,
a47 1
  has_working_virtual_lock:true,
a68 2
  map_view_of_file_ex_sucks:false,
  altgr_is_ctrl_alt:true,
a69 4
  has_working_copy_on_write:true,
  share_mmaps_only_by_name:false,
  virtual_protect_works_on_shared_pages:true,
  has_mmap_alignment_bug:false,
a93 1
  has_working_virtual_lock:true,
a114 2
  map_view_of_file_ex_sucks:false,
  altgr_is_ctrl_alt:true,
a115 4
  has_working_copy_on_write:true,
  share_mmaps_only_by_name:false,
  virtual_protect_works_on_shared_pages:true,
  has_mmap_alignment_bug:false,
a139 1
  has_working_virtual_lock:true,
a160 2
  map_view_of_file_ex_sucks:false,
  altgr_is_ctrl_alt:true,
a161 4
  has_working_copy_on_write:true,
  share_mmaps_only_by_name:false,
  virtual_protect_works_on_shared_pages:true,
  has_mmap_alignment_bug:false,
a185 1
  has_working_virtual_lock:true,
a206 2
  map_view_of_file_ex_sucks:false,
  altgr_is_ctrl_alt:true,
a207 4
  has_working_copy_on_write:true,
  share_mmaps_only_by_name:false,
  virtual_protect_works_on_shared_pages:true,
  has_mmap_alignment_bug:false,
a231 1
  has_working_virtual_lock:true,
a252 2
  map_view_of_file_ex_sucks:false,
  altgr_is_ctrl_alt:true,
a253 4
  has_working_copy_on_write:true,
  share_mmaps_only_by_name:false,
  virtual_protect_works_on_shared_pages:true,
  has_mmap_alignment_bug:false,
a277 1
  has_working_virtual_lock:true,
a298 2
  map_view_of_file_ex_sucks:false,
  altgr_is_ctrl_alt:true,
a299 4
  has_working_copy_on_write:true,
  share_mmaps_only_by_name:false,
  virtual_protect_works_on_shared_pages:true,
  has_mmap_alignment_bug:false,
a323 1
  has_working_virtual_lock:true,
@


1.68
log
@	* fhandler.cc (fhandler_base::write): Remove wincap.has_lseek_bug case.
	Simplify seek beyond EOF case.
	* times.cc (times): Remove wincap.has_get_process_times case.
	* wincap.cc: Remove has_delete_on_close, has_page_guard,
	has_get_process_times and has_lseek_bug throughout.
	* wincap.h: Ditto.
@
text
@a21 3
  has_lock_file_ex:true,
  has_signal_object_and_wait:true,
  has_eventlog:true,
a22 3
  has_set_handle_information:true,
  has_set_handle_information_on_console_handles:false,
  supports_smp:true,
a74 3
  has_lock_file_ex:true,
  has_signal_object_and_wait:true,
  has_eventlog:true,
a75 3
  has_set_handle_information:true,
  has_set_handle_information_on_console_handles:false,
  supports_smp:true,
a127 3
  has_lock_file_ex:true,
  has_signal_object_and_wait:true,
  has_eventlog:true,
a128 3
  has_set_handle_information:true,
  has_set_handle_information_on_console_handles:false,
  supports_smp:true,
a180 3
  has_lock_file_ex:true,
  has_signal_object_and_wait:true,
  has_eventlog:true,
a181 3
  has_set_handle_information:true,
  has_set_handle_information_on_console_handles:true,
  supports_smp:true,
a233 3
  has_lock_file_ex:true,
  has_signal_object_and_wait:true,
  has_eventlog:true,
a234 3
  has_set_handle_information:true,
  has_set_handle_information_on_console_handles:true,
  supports_smp:true,
a286 3
  has_lock_file_ex:true,
  has_signal_object_and_wait:true,
  has_eventlog:true,
a287 3
  has_set_handle_information:true,
  has_set_handle_information_on_console_handles:true,
  supports_smp:true,
a339 3
  has_lock_file_ex:true,
  has_signal_object_and_wait:true,
  has_eventlog:true,
a340 3
  has_set_handle_information:true,
  has_set_handle_information_on_console_handles:true,
  supports_smp:true,
@


1.67
log
@	Throughout remove all usage of wincap.access_denied_on_delete.
	* dir.cc (rmdir): Add existance check to be errno-compatible with Linux.
	* fhandler_disk_file.cc (fhandler_disk_file::rmdir): Drop test for
	non-existent dir on 9x share.
	* syscalls.cc (unlink): Add comment.
	* wincap.cc: Remove access_denied_on_delete flag throughout.
	* wincap.h: Ditto.
@
text
@a19 2
  has_delete_on_close:true,
  has_page_guard:true,
a21 2
  has_get_process_times:true,
  has_lseek_bug:false,
a78 2
  has_delete_on_close:true,
  has_page_guard:true,
a80 2
  has_get_process_times:true,
  has_lseek_bug:false,
a137 2
  has_delete_on_close:true,
  has_page_guard:true,
a139 2
  has_get_process_times:true,
  has_lseek_bug:false,
a196 2
  has_delete_on_close:true,
  has_page_guard:true,
a198 2
  has_get_process_times:true,
  has_lseek_bug:false,
a255 2
  has_delete_on_close:true,
  has_page_guard:true,
a257 2
  has_get_process_times:true,
  has_lseek_bug:false,
a314 2
  has_delete_on_close:true,
  has_page_guard:true,
a316 2
  has_get_process_times:true,
  has_lseek_bug:false,
a373 2
  has_delete_on_close:true,
  has_page_guard:true,
a375 2
  has_get_process_times:true,
  has_lseek_bug:false,
@


1.66
log
@	Throughout replace all usage of wincap.shared with the constant
	FILE_SHARE_VALID_FLAGS.
	* fhandler.cc (fhandler_base::open_9x): Drop local variable shared.
	* wincap.cc: Remove shared member throughout.
	* wincap.h: Ditto.
@
text
@a19 1
  access_denied_on_delete:false,
a82 1
  access_denied_on_delete:false,
a145 1
  access_denied_on_delete:false,
a208 1
  access_denied_on_delete:false,
a271 1
  access_denied_on_delete:false,
a334 1
  access_denied_on_delete:false,
a397 1
  access_denied_on_delete:false,
@


1.65
log
@	* Makefile.in (DLL_IMPORTS): Add libntdll.a.
	* autoload.cc: Remove all symbols from advapi32.dll, kernel32.dll and
	ntdll.dll available on all platforms since NT4.

	Throughout remove all usage of wincap.is_winnt.
	* dcrt0.cc (dll_crt0_0): Remove call to mmap_init.
	* fhandler.h (class fhandler_base): Remove has_changed flag.
	(fhandler_disk_file::touch_ctime): Remove declaration.
	(fhandler_disk_file::readdir_9x): Ditto.
	(fhandler_disk_file::touch_ctime): Remove.
	(fhandler_disk_file::readdir_9x): Remove.
	(fhandler_disk_file::closedir): Call NtClose instead of CloseHandle.
	* mmap.cc: Throughout call CreateMapping and MapView directly.
	(VirtualProt9x): Remove.
	(VirtualProtNT): Remove.
	(VirtualProtEx9x): Remove.
	(VirtualProtExNT): Remove.
	(VirtualProtect): Remove define.
	(VirtualProtectEx): Remove define.
	(CreateMapping9x): Remove.
	(CreateMappingNT): Rename to CreateMapping.
	(MapView9x): Remove.
	(MapViewNT): Rename to MapView.
	(struct mmap_func_t): Remove definition.
	(mmap_funcs_9x): Remove.
	(mmap_funcs_nt): Remove.
	(mmap_func): Remove.
	(mmap_init): Remove.
	* net.cc (getdomainname): Drop comment. Use NT4 registry key only.
	(get_95_ifconf): Remove.
	* pinfo.cc (winpids::enumNT): Rename to winpids::enum_processes.
	(winpids::enum9x): Remove.
	(winpids::set): Just call enum_processes directly.
	(winpids::enum_init): Ditto.
	* pinfo.h (class winpids): Drop enum_processes pointer.  Rename
	enumNT to enum_processes.  Drop enum9x declaration.  Drop initialization
	of enum_processes throughout.
	* registry.cc (get_registry_hive_path): Just create NT key.
	(load_registry_hive): Only load NT specific file.
	* syscalls.cc (unlink_9x): Remove.
	(unlink): Just call unlink_nt.
	* wincap.cc: Remove is_winnt flag throughout.
	* wincap.h: Ditto.
	* winsup.h: Remove mmap_init declaration.
@
text
@a18 1
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
a82 1
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
a146 1
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
a210 1
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
a274 1
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
a338 1
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
a402 1
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
@


1.64
log
@	* wincap.cc (wincap_unknown): Change settings for unknown to reflect
	the capabilities of NT4.
	(wincap_95): Remove.
	(wincap_95osr2): Remove.
	(wincap_98): Remove.
	(wincap_98se): Remove.
	(wincap_me): Remove.
	(wincap_nt3): Remove.
	(wincapc::init): Temporarily bail out on any 9x system.
@
text
@a19 1
  is_winnt:true,
a84 1
  is_winnt:true,
a149 1
  is_winnt:true,
a214 1
  is_winnt:true,
a279 1
  is_winnt:true,
a344 1
  is_winnt:true,
a409 1
  is_winnt:true,
@


1.63
log
@	* net.cc (ga_dup): New function, taken from ga_clone with v4-in-v6
	mapping addition.
	(ga_clone): Just call ga_dup from here.
	(ga_duplist): New function to duplicate list of struct addrinfo.
	(ga_echeck): Don't check a_flags, it already happened in
	cygwin_getaddrinfo.
	(cygwin_freeaddrinfo): Always call ipv4_freeaddrinfo.
	(cygwin_getaddrinfo): Use new wincap.supports_all_posix_ai_flags
	flag rather than wincap.has_gaa_on_link_prefix.  Always duplicate
	WinSock's addrinfo list to a self-allocated list.  Handle AI_V4MAPPED
	for pre-Vista platforms supporting getaddrinfo.
	* wincap.h (wincapc::supports_all_posix_ai_flags): New element.
	* wincap.cc: Implement above element throughout.
	* include/netdb.h: Note how AI_ADDRCONFIG is not supported pre-Vista.
	Remove superfluous comment.
@
text
@d14 1
a15 396
  lock_file_highword:0x0,
  chunksize:0x0,
  heapslop:0x0,
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE,
  is_winnt:false,
  is_server:false,
  access_denied_on_delete:false,
  has_delete_on_close:false,
  has_page_guard:false,
  has_security:false,
  has_security_descriptor_control:false,
  has_get_process_times:false,
  has_lseek_bug:false,
  has_lock_file_ex:false,
  has_signal_object_and_wait:false,
  has_eventlog:false,
  has_ip_helper_lib:false,
  has_set_handle_information:false,
  has_set_handle_information_on_console_handles:false,
  supports_smp:false,
  map_view_of_file_ex_sucks:false,
  altgr_is_ctrl_alt:false,
  has_physical_mem_access:false,
  has_working_copy_on_write:false,
  share_mmaps_only_by_name:false,
  virtual_protect_works_on_shared_pages:false,
  has_mmap_alignment_bug:false,
  has_hard_links:false,
  can_open_directories:false,
  has_move_file_ex:false,
  has_negative_pids:false,
  has_unreliable_pipes:false,
  has_named_pipes:false,
  has_try_enter_critical_section:false,
  has_raw_devices:false,
  has_valid_processorlevel:false,
  has_64bit_file_access:false,
  has_process_io_counters:false,
  supports_reading_modem_output_lines:false,
  needs_memory_protection:false,
  pty_needs_alloc_console:false,
  has_terminal_services:false,
  has_switch_to_thread:false,
  cant_debug_dll_entry:false,
  has_ioctl_storage_get_media_types_ex:false,
  start_proc_suspended:true,
  has_extended_priority_class:false,
  has_guid_volumes:false,
  detect_win16_exe:true,
  has_null_console_handler_routine:false,
  has_disk_ex_ioctls:false,
  has_working_virtual_lock:false,
  has_disabled_user_tos_setting:false,
  has_fileid_dirinfo:false,
  has_exclusiveaddruse:false,
  has_buggy_restart_scan:false,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:false,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  supports_all_posix_ai_flags:false,
};

static NO_COPY wincaps wincap_95 = {
  lock_file_highword:0x0,
  chunksize:32 * 1024 * 1024,
  heapslop:0x0,
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE,
  is_winnt:false,
  is_server:false,
  access_denied_on_delete:true,
  has_delete_on_close:false,
  has_page_guard:false,
  has_security:false,
  has_security_descriptor_control:false,
  has_get_process_times:false,
  has_lseek_bug:true,
  has_lock_file_ex:false,
  has_signal_object_and_wait:false,
  has_eventlog:false,
  has_ip_helper_lib:false,
  has_set_handle_information:false,
  has_set_handle_information_on_console_handles:false,
  supports_smp:false,
  map_view_of_file_ex_sucks:true,
  altgr_is_ctrl_alt:false,
  has_physical_mem_access:false,
  has_working_copy_on_write:false,
  share_mmaps_only_by_name:true,
  virtual_protect_works_on_shared_pages:false,
  has_mmap_alignment_bug:false,
  has_hard_links:false,
  can_open_directories:false,
  has_move_file_ex:false,
  has_negative_pids:true,
  has_unreliable_pipes:true,
  has_named_pipes:false,
  has_try_enter_critical_section:false,
  has_raw_devices:false,
  has_valid_processorlevel:false,
  has_64bit_file_access:false,
  has_process_io_counters:false,
  supports_reading_modem_output_lines:false,
  needs_memory_protection:false,
  pty_needs_alloc_console:false,
  has_terminal_services:false,
  has_switch_to_thread:false,
  cant_debug_dll_entry:true,
  has_ioctl_storage_get_media_types_ex:false,
  start_proc_suspended:true,
  has_extended_priority_class:false,
  has_guid_volumes:false,
  detect_win16_exe:true,
  has_null_console_handler_routine:false,
  has_disk_ex_ioctls:false,
  has_working_virtual_lock:false,
  has_disabled_user_tos_setting:false,
  has_fileid_dirinfo:false,
  has_exclusiveaddruse:false,
  has_buggy_restart_scan:false,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:false,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  supports_all_posix_ai_flags:false,
};

static NO_COPY wincaps wincap_95osr2 = {
  lock_file_highword:0x0,
  chunksize:32 * 1024 * 1024,
  heapslop:0x0,
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE,
  is_winnt:false,
  is_server:false,
  access_denied_on_delete:true,
  has_delete_on_close:false,
  has_page_guard:false,
  has_security:false,
  has_security_descriptor_control:false,
  has_get_process_times:false,
  has_lseek_bug:true,
  has_lock_file_ex:false,
  has_signal_object_and_wait:false,
  has_eventlog:false,
  has_ip_helper_lib:false,
  has_set_handle_information:false,
  has_set_handle_information_on_console_handles:false,
  supports_smp:false,
  map_view_of_file_ex_sucks:true,
  altgr_is_ctrl_alt:false,
  has_physical_mem_access:false,
  has_working_copy_on_write:false,
  share_mmaps_only_by_name:true,
  virtual_protect_works_on_shared_pages:false,
  has_mmap_alignment_bug:false,
  has_hard_links:false,
  can_open_directories:false,
  has_move_file_ex:false,
  has_negative_pids:true,
  has_unreliable_pipes:true,
  has_named_pipes:false,
  has_try_enter_critical_section:false,
  has_raw_devices:false,
  has_valid_processorlevel:false,
  has_64bit_file_access:false,
  has_process_io_counters:false,
  supports_reading_modem_output_lines:false,
  needs_memory_protection:false,
  pty_needs_alloc_console:false,
  has_terminal_services:false,
  has_switch_to_thread:false,
  cant_debug_dll_entry:true,
  has_ioctl_storage_get_media_types_ex:false,
  start_proc_suspended:true,
  has_extended_priority_class:false,
  has_guid_volumes:false,
  detect_win16_exe:true,
  has_null_console_handler_routine:false,
  has_disk_ex_ioctls:false,
  has_working_virtual_lock:false,
  has_disabled_user_tos_setting:false,
  has_fileid_dirinfo:false,
  has_exclusiveaddruse:false,
  has_buggy_restart_scan:false,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:false,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  supports_all_posix_ai_flags:false,
};

static NO_COPY wincaps wincap_98 = {
  lock_file_highword:0x0,
  chunksize:32 * 1024 * 1024,
  heapslop:0x0,
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE,
  is_winnt:false,
  is_server:false,
  access_denied_on_delete:true,
  has_delete_on_close:false,
  has_page_guard:false,
  has_security:false,
  has_security_descriptor_control:false,
  has_get_process_times:false,
  has_lseek_bug:true,
  has_lock_file_ex:false,
  has_signal_object_and_wait:false,
  has_eventlog:false,
  has_ip_helper_lib:true,
  has_set_handle_information:false,
  has_set_handle_information_on_console_handles:false,
  supports_smp:false,
  map_view_of_file_ex_sucks:true,
  altgr_is_ctrl_alt:false,
  has_physical_mem_access:false,
  has_working_copy_on_write:false,
  share_mmaps_only_by_name:true,
  virtual_protect_works_on_shared_pages:false,
  has_mmap_alignment_bug:true,
  has_hard_links:false,
  can_open_directories:false,
  has_move_file_ex:false,
  has_negative_pids:true,
  has_unreliable_pipes:true,
  has_named_pipes:false,
  has_try_enter_critical_section:false,
  has_raw_devices:false,
  has_valid_processorlevel:true,
  has_64bit_file_access:false,
  has_process_io_counters:false,
  supports_reading_modem_output_lines:false,
  needs_memory_protection:false,
  pty_needs_alloc_console:false,
  has_terminal_services:false,
  has_switch_to_thread:false,
  cant_debug_dll_entry:true,
  has_ioctl_storage_get_media_types_ex:false,
  start_proc_suspended:true,
  has_extended_priority_class:false,
  has_guid_volumes:false,
  detect_win16_exe:true,
  has_null_console_handler_routine:false,
  has_disk_ex_ioctls:false,
  has_working_virtual_lock:false,
  has_disabled_user_tos_setting:false,
  has_fileid_dirinfo:false,
  has_exclusiveaddruse:false,
  has_buggy_restart_scan:false,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:false,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  supports_all_posix_ai_flags:false,
};

static NO_COPY wincaps wincap_98se = {
  lock_file_highword:0x0,
  chunksize:32 * 1024 * 1024,
  heapslop:0x0,
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE,
  is_winnt:false,
  is_server:false,
  access_denied_on_delete:true,
  has_delete_on_close:false,
  has_page_guard:false,
  has_security:false,
  has_security_descriptor_control:false,
  has_get_process_times:false,
  has_lseek_bug:true,
  has_lock_file_ex:false,
  has_signal_object_and_wait:false,
  has_eventlog:false,
  has_ip_helper_lib:true,
  has_set_handle_information:false,
  has_set_handle_information_on_console_handles:false,
  supports_smp:false,
  map_view_of_file_ex_sucks:true,
  altgr_is_ctrl_alt:false,
  has_physical_mem_access:false,
  has_working_copy_on_write:false,
  share_mmaps_only_by_name:true,
  virtual_protect_works_on_shared_pages:false,
  has_mmap_alignment_bug:true,
  has_hard_links:false,
  can_open_directories:false,
  has_move_file_ex:false,
  has_negative_pids:true,
  has_unreliable_pipes:true,
  has_named_pipes:false,
  has_try_enter_critical_section:false,
  has_raw_devices:false,
  has_valid_processorlevel:true,
  has_64bit_file_access:false,
  has_process_io_counters:false,
  supports_reading_modem_output_lines:false,
  needs_memory_protection:false,
  pty_needs_alloc_console:false,
  has_terminal_services:false,
  has_switch_to_thread:false,
  cant_debug_dll_entry:true,
  has_ioctl_storage_get_media_types_ex:false,
  start_proc_suspended:true,
  has_extended_priority_class:false,
  has_guid_volumes:false,
  detect_win16_exe:true,
  has_null_console_handler_routine:false,
  has_disk_ex_ioctls:false,
  has_working_virtual_lock:false,
  has_disabled_user_tos_setting:false,
  has_fileid_dirinfo:false,
  has_exclusiveaddruse:false,
  has_buggy_restart_scan:false,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:false,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  supports_all_posix_ai_flags:false,
};

static NO_COPY wincaps wincap_me = {
  lock_file_highword:0x0,
  chunksize:32 * 1024 * 1024,
  heapslop:0x0,
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE,
  is_winnt:false,
  is_server:false,
  access_denied_on_delete:true,
  has_delete_on_close:false,
  has_page_guard:false,
  has_security:false,
  has_security_descriptor_control:false,
  has_get_process_times:false,
  has_lseek_bug:true,
  has_lock_file_ex:false,
  has_signal_object_and_wait:false,
  has_eventlog:false,
  has_ip_helper_lib:true,
  has_set_handle_information:false,
  has_set_handle_information_on_console_handles:false,
  supports_smp:false,
  map_view_of_file_ex_sucks:true,
  altgr_is_ctrl_alt:false,
  has_physical_mem_access:false,
  has_working_copy_on_write:false,
  share_mmaps_only_by_name:true,
  virtual_protect_works_on_shared_pages:false,
  has_mmap_alignment_bug:false,
  has_hard_links:false,
  can_open_directories:false,
  has_move_file_ex:false,
  has_negative_pids:true,
  has_unreliable_pipes:true,
  has_named_pipes:false,
  has_try_enter_critical_section:false,
  has_raw_devices:false,
  has_valid_processorlevel:true,
  has_64bit_file_access:false,
  has_process_io_counters:false,
  supports_reading_modem_output_lines:false,
  needs_memory_protection:false,
  pty_needs_alloc_console:false,
  has_terminal_services:false,
  has_switch_to_thread:false,
  cant_debug_dll_entry:true,
  has_ioctl_storage_get_media_types_ex:false,
  start_proc_suspended:true,
  has_extended_priority_class:false,
  has_guid_volumes:false,
  detect_win16_exe:true,
  has_null_console_handler_routine:false,
  has_disk_ex_ioctls:false,
  has_working_virtual_lock:false,
  has_disabled_user_tos_setting:false,
  has_fileid_dirinfo:false,
  has_exclusiveaddruse:false,
  has_buggy_restart_scan:false,
  has_mandatory_integrity_control:false,
  needs_logon_sid_in_sid_list:false,
  needs_count_in_si_lpres2:false,
  has_recycle_dot_bin:false,
  has_gaa_prefixes:false,
  has_gaa_on_link_prefix:false,
  supports_all_posix_ai_flags:false,
};

static NO_COPY wincaps wincap_nt3 = {
d30 1
a30 1
  has_signal_object_and_wait:false,
d35 1
a35 1
  supports_smp:false,
d49 1
a49 1
  has_try_enter_critical_section:false,
d58 1
a58 1
  has_switch_to_thread:false,
a503 4
	    case 3:
	      os = "NT";
	      caps = &wincap_nt3;
	      break;
d541 2
a542 25
	switch (version.dwMinorVersion)
	  {
	    case 0:
	      os = "95";
	      if (strchr (version.szCSDVersion, 'C'))
		caps = &wincap_95osr2;
	      else
		caps = &wincap_95;
	      break;
	    case 10:
	      os = "98";
	      if (strchr (version.szCSDVersion, 'A'))
		caps = &wincap_98se;
	      else
		caps = &wincap_98;
	      break;
	    case 90:
	      os = "ME";
	      caps = &wincap_me;
	      break;
	    default:
	      os = "??";
	      caps = &wincap_unknown;
	      break;
	  }
@


1.62
log
@	* autoload.cc (WSAIoctl): Define.
	(SendARP): Define.
	* cygwin.din: Export if_freenameindex, if_indextoname, if_nameindex and
	if_nametoindex.
	* fhandler_procnet.cc: Drop including wchar.h.  Drop definitions of
	GAA_FLAG_INCLUDE_ALL_INTERFACES, IP_ADAPTER_UNICAST_ADDRESS_VISTA.
	(fhandler_procnet::exists): Check for has_gaa_prefixes.  Call
	get_adapters_addresses here.
	(fhandler_procnet::readdir): Ditto.
	(prefix): Move to net.cc.
	(fhandler_procnet::fill_filebuf): Call get_adapters_addresses here.
	Simplify allocation.  Use AdapterName rather than FriendlyName as
	interface name.  Use IfIndex if available, Ipv6IfIndex otherwise.
	(in6_are_prefix_equal): Move to net.cc.
	* fhandler_socket.cc: Define old SIOCGxxx values.
	(CONV_OLD_TO_NEW_SIO): Convert old SIOCGxxx value to new one.
	(struct __old_ifreq): Define old struct ifreq.
	(fhandler_socket::ioctl): Handle old SIOCGxxx values.  Handle new
	SIOCGIFFRNDLYNAM command.  Simplify copying ifreq data to user space.
	Call get_ifconf with additional SOCKET parameter.
	* net.cc (IP_ADAPTER_UNICAST_ADDRESS_LH): Define.
	(IP_ADAPTER_ADDRESSES_LH): Define.
	(SIO_GET_INTERFACE_LIST): Define.
	(sockaddr_in6_old): Define.
	(sockaddr_gen): Define.
	(INTERFACE_INFO): Define.
	(IN_LOOPBACK): Define.
	(in_are_prefix_equal): New static function.
	(ip_addr_prefix): New function, replaces prefix function, add AF_INET
	handling.
	(GAA_FLAG_INCLUDE_ALL_INTERFACES): Define.
	(get_adapters_addresses): New function.
	(WS_IFF_xxx): Define Winsock interface flag values.
	(convert_ifr_flags): New function to convert Winsock interface flag
	values to Cygwin interface flag values.
	(get_xp_ifconf): New get_ifconf implementation for XP SP1 and above.
	(get_2k_ifconf): Fix interface index.  Fix formatting.
	(get_nt_ifconf): Fix formatting.
	(get_95_ifconf): Ditto.
	(get_ifconf): Take additional SOCKET parameter.  Call get_xp_ifconf
	on XP SP1 and above.
	(if_nametoindex): New function.
	(if_indextoname): New function.
	(if_nameindex): New function.
	(if_freenameindex): New function.
	(in6_are_prefix_equal): Moved here from fhandler_procnet.cc.
	* wincap.cc (wincap_xp): Define has_gaa_prefixes as true by default.
	(wincapc::init): Assume has_osversioninfoex by default.  Call
	GetVersionEx with OSVERSIONINFOEX first.  Call with OSVERSIONINFO only
	if that fails.  Simplify NT4 case and try to avoid strcmp.  Check XP
	Service Pack using version.wServicePackMajor to avoid strcmp.
	* include/asm/socket.h (SIOCGIFFRNDLYNAM): Define.
	* include/cygwin/if.h: Fix formatting.
	(IFF_POINTTOPOINT): Define.
	(IFF_NOARP): Define.
	(IFF_LOWER_UP): Define.
	(IFF_DORMANT): Define.
	(struct if_nameindex): Define.
	(IFRF_FRIENDLYNAMESIZ): Define.
	(struct ifreq_frndlyname): Define.
	(IFNAMSIZ): Redefine as 44.
	(IF_NAMESIZE): Define.
	(struct ifreq): Redefine ifru_flags as int.  Define ifru_data.  Pad size
	to sizeof sockaddr_in6 for further extensions.
	(ifr_data): Define.
	(ifr_frndlyname): Define.
	(if_nametoindex): Declare.
	(if_indextoname): Declare.
	(if_nameindex): Declare.
	(if_freenameindex): Declare.
	* include/cygwin/version.h: Bump API minor number.
	(CYGWIN_VERSION_CHECK_FOR_OLD_IFREQ): Define check for old vs. new
	ifreq structure.
@
text
@d77 1
d143 1
d209 1
d275 1
d341 1
d407 1
d473 1
d539 1
d605 1
d671 1
d737 1
d803 1
d869 1
@


1.61
log
@	* Makefile.in (DLL_OFILES): Add fhandler_procnet.o.
	* autoload.cc (GetAdaptersAddresses): Define.
	* devices.h (FH_PROCNET): Define new device.
	* devices.in (dev_procnet_storage): Add "/proc/net" entry.
	* devices.cc: Regenerate.
	* dir.cc (readdir_worker): Use isproc_dev macro.
	* dtable.cc (build_fh_pc): Add FH_PROCNET.
	* fhandler.h (class fhandler_procnet): New class.
	* fhandler_proc.cc: Add "net" subdirectory handling.
	* fhandler_procnet.cc: New file handling "/proc/net" directory.
	* path.cc (isvirtual_dev): Move to path.h.
	* path.h (isproc_dev): New macro to identify /proc files by device.
	(isvirtual_dev): Moved here.  Define using isproc_dev.
	* syscalls.cc (unlink): Use isproc_dev macro.
	* wincap.h (wincapc::has_gaa_prefixes): New element.
	(wincapc::has_gaa_on_link_prefix): New element.
	* wincap.cc: Implement above elements throughout.
	(wincapc::init): Check XP for service pack and set has_gaa_prefixes
	appropriately.
	* include/cygwin/in6.h: Include asm/byteorder.h.
@
text
@d725 1
a725 1
  has_gaa_prefixes:false,
d865 1
a865 1
  bool has_osversioninfoex = false;
d871 9
a879 3
  /* Request simple version info first. */
  version.dwOSVersionInfoSize = sizeof (OSVERSIONINFO);
  GetVersionEx (reinterpret_cast<LPOSVERSIONINFO>(&version));
d892 2
a893 1
	      if (strcmp (version.szCSDVersion, "Service Pack 4") < 0)
d896 1
a896 5
		{
		  caps = &wincap_nt4sp4;
		  if (strcmp (version.szCSDVersion, "Service Pack 6") >= 0)
		    has_osversioninfoex = true;
		}
a899 1
	      has_osversioninfoex = true;
d908 2
a909 2
		    if (strcmp (version.szCSDVersion, "Service Pack 1") >= 0)
		      ((wincaps *)this->caps)->has_gaa_prefixes = true;
a917 1
	      has_osversioninfoex = true;
d959 2
a960 9
  if (has_osversioninfoex)
    {
      /* Request extended version to get server info.
	 Available since NT4 SP6. */
      version.dwOSVersionInfoSize = sizeof (OSVERSIONINFOEX);
      GetVersionEx (reinterpret_cast<LPOSVERSIONINFO>(&version));
      if (version.wProductType != VER_NT_WORKSTATION)
	((wincaps *)this->caps)->is_server = true;
    }
@


1.60
log
@	* autoload.cc (SHFileOperationA): Drop definition.
	* ntdll.h (struct _FILE_RENAME_INFORMATION): Define.
	* path.cc (fs_info::update): Note length of rootdir prefix in
	root_len.
	(get_nt_native_path): New function, taking over functionality of
	path_conv::get_nt_native_path.
	(path_conv::get_nt_native_path): Just call get_nt_native_path.
	* path.h (get_nt_native_path): Declare.
	(struct fs_info): New member root_len.
	(fs_info::length): New inline method returning root_len.
	(path_conv::rootdir): New inline method returning rootdir prefix.
	* syscalls.cc (try_to_bin): Rewrite using only system calls.
	(unlink_nt): Call try_to_bin with additional handle to open file
	parameter.
	(statvfs): Use path_conv::rootdir method.
	* wincap.h: Define has_recycle_dot_bin throughout.
	* wincap.cc: Ditto.
@
text
@d4 1
a4 1
   Copyright 2001, 2002, 2003, 2004, 2005, 2006 Red Hat, Inc.
d75 2
d140 2
d205 2
d270 2
d335 2
d400 2
d465 2
d530 2
d595 2
d660 2
d725 2
d790 2
d800 1
a800 1
  is_server:true,
d855 2
d906 2
@


1.59
log
@	* fhandler_mem.cc (fhandler_dev_mem::open): Fix comment.
	* wincap.cc (has_physical_mem_access): Reflect the fact that physical
	memory access has been made a protected operation beginning with
	2003 Server.
@
text
@d74 1
d137 1
d200 1
d263 1
d326 1
d389 1
d452 1
d515 1
d578 1
d641 1
d704 1
d767 1
d830 1
@


1.58
log
@	* dcrt0.cc (get_cygwin_startup_info): Fix comment.
	* wincap.cc (wincapc::init): Always reset needs_count_in_si_lpres2 to
	false on non 64-bit systems.
@
text
@d719 1
a719 1
  has_physical_mem_access:true,
d781 1
a781 1
  has_physical_mem_access:true,
@


1.57
log
@	* dcrt0.cc (get_cygwin_startup_info): Change zeros to DWORD array.
	Expect first DWORD in child_info struct being set to non-zero if
	wincap.needs_count_in_si_lpres2 is set.  Add comment to explain why.
	* fork.cc (frok::parent): Set ch.zero[0] to a sensible count value
	if wincap.needs_count_in_si_lpres2 is set.
	* spawn.cc (spawn_guts): Ditto.  Add filler bytes after ch on stack
	to accomodate needs_count_in_si_lpres2.
	* wincap.h: Define needs_count_in_si_lpres2 throughout.
	* wincap.cc: Ditto.
@
text
@d930 2
@


1.56
log
@	* cyglsa.h: New header file.
	* environ.cc: Disable subauth settings.
	* grp.cc: Accomodate cygsidlist's count now being a method.
	* sec_helper.cc (SECURITY_MANDATORY_INTEGRITY_AUTHORITY): Remove.
	(mandatory_medium_integrity_sid): Remove.
	(mandatory_high_integrity_sid): Remove.
	(mandatory_system_integrity_sid): Remove.
	(fake_logon_sid): Add.
	(cygsid::get_sid): Add well_known parameter.  Set well_known_sid
	accordingly.
	(cygsid::getfromstr): Ditto.
	(cygsidlist::alloc_sids): Move here from security.cc.
	(cygsidlist::free_sids): Ditto.
	(cygsidlist::add): Move here from security.h.  Add well_known parameter.
	Set well_known_sid accordingly.  Don't allow duplicate SIDs.
	* security.cc: Include cyglsa.h and cygwin/version.h.  Throughout
	accomodate cygsidlist's count now being a method.  Throughout drop
	redundant "contains" tests.
	(get_user_local_groups): Add local groups as well known SIDs.
	(get_token_group_sidlist): Add well known groups as well known SIDs.
	(get_server_groups): Ditto.  Only call get_unix_group_sidlist after
	get_user_local_groups to maintain "well_known_sid" attribute.
	(get_initgroups_sidlist): Add well known groups as well known SIDs.
	(get_setgroups_sidlist): Add usersid and struct passwd parameter to
	allow calling get_server_groups from here.
	(get_system_priv_list): Make static.  Return size of TOKEN_PRIVILEGES
	structure.
	(get_priv_list): Ditto.
	(create_token): Accomodate above changes.  Drop misguided attempt to
	add MIC SIDs to created user token.  Print returned token as hex value.
	(subauth): Disable.
	(lsaauth): New function implementing client side of LSA authentication.
	* security.h (class cygsid): Add well_known_sid attribute.  Accomodate
	throughout.  Add *= operator to create a well known SID.
	(class cygsidlist): Rename count to cnt.  Make count a method.
	(cygsidlist::add): Move to sec_helper.cc.
	(cygsidlist::operator *=): New method to add well known SID.
	(cygsidlist::non_well_known_count): New method returning number of
	non well known SIDs in list.
	(cygsidlist::next_non_well_known_sid): New method returning next non
	well known SID by index.
	(mandatory_medium_integrity_sid): Drop declaration.
	(mandatory_high_integrity_sid): Drop declaration.
	(mandatory_system_integrity_sid): Drop declaration.
	(fake_logon_sid): Add declaration.
	(subauth): Disable declaration.
	(lsaauth): Add declaration.
	* syscalls.cc (seteuid32): Disable subauthentication.  Add LSA
	authentication.
	* wincap.h: Define needs_logon_sid_in_sid_list throughout.
	* wincap.cc: Ditto.
@
text
@d73 1
d135 1
d197 1
d259 1
d321 1
d383 1
d445 1
d507 1
d569 1
d631 1
d693 1
d755 1
d817 1
@


1.55
log
@	* sec_helper.cc (sid_auth): Remove.
	(well_known_this_org_sid): New well known sid.
	(SECURITY_MANDATORY_INTEGRITY_AUTHORITY): Define.
	(mandatory_medium_integrity_sid): New well known sid.
	(mandatory_high_integrity_sid): Ditto.
	(mandatory_system_integrity_sid): Ditto.
	(cygsid::get_sid): Use local SID_IDENTIFIER_AUTHORITY.  Allow all
	authorities fitting in a UCHAR.
	* security.cc (get_token_group_sidlist): Always add the local
	group to the token.  Add comment.  Add "This Organization" group
	if available in incoming group list.
	(get_server_groups): Only add world and authenticated users groups
	if not already in list.
	(create_token): Add matching mandatory integrity SID to group list
	on systems supporting Mandatory Integrity Control.
	* security.h (well_known_this_org_sid): Define.
	(mandatory_medium_integrity_sid): Define.
	(mandatory_high_integrity_sid): Define.
	(mandatory_system_integrity_sid): Define.
	* wincap.h: Define has_mandatory_integrity_control throughout.
	* wincap.cc: Ditto.
@
text
@d72 1
d133 1
d194 1
d255 1
d316 1
d377 1
d438 1
d499 1
d560 1
d621 1
d682 1
d743 1
d804 1
@


1.54
log
@	* cygheap.h (struct user_heap_info): Add slop member.
	* heap.cc (heap_init): Add slop factor to heap allocation.  Add
	comment.
	* mmap.cc (MapViewNT): Allocate memory maps top down.
	(fhandler_dev_zero::mmap): Ditto.
	* shared.cc (shared_info::heap_slop_size): New method.
	(shared_info::heap_chunk_size): Don't use debug_printf at early stage.
	* shared_info.h (SHARED_INFO_CB): Accomodate change to shared_info.
	(CURR_SHARED_MAGIC): Ditto.
	(class shared_info): Add heap_slop member.  Declare heap_slop_size.
	* wincap.h: Define heapslop throughout.
	* wincap.cc: Ditto.
@
text
@d71 1
d131 1
d191 1
d251 1
d311 1
d371 1
d431 1
d491 1
d551 1
d611 1
d671 1
d731 1
d791 1
@


1.53
log
@	* fhandler_disk_file.cc (fhandler_disk_file::rewinddir): Accomodate
	buggy RestartScan behaviour of Windows 2000.
	* wincap.h: Define has_buggy_restart_scan throughout.
	* wincap.cc: Ditto.
@
text
@d17 1
d76 1
d135 1
d194 1
d253 1
d312 1
d371 1
d430 1
d489 1
d548 1
d607 1
d666 1
d725 1
@


1.52
log
@* cygheap.cc (init_cygheap::manage_console_count): Turn console control handler
on/off depending on whether we have allocated a console or not.
* dcrt0.cc (child_info_fork::fork_retry): Add more potential retry statuses.
(dll_crt0_0): Turn on/off console control depending on whether we have a
controlling tty or not.
* exceptions.cc (init_console_handler): Change BOOL to bool.
* fhandler_console.cc (fhandler_console::need_invisible): Cosmetic change.
* winsup.h (init_console_handler): Reflect argument type change.
* wincap.h (supports_setconsolectrlhandler_null): Remove duplicate capability
throughout.
* wincap.cc: Ditto.
@
text
@d69 1
d127 1
d185 1
d243 1
d301 1
d359 1
d417 1
d475 1
d532 2
a533 1
  has_exclusiveaddruse:true
d590 2
a591 1
  has_exclusiveaddruse:true
d648 2
a649 1
  has_exclusiveaddruse:true
d706 2
a707 1
  has_exclusiveaddruse:true
d764 2
a765 1
  has_exclusiveaddruse:true
@


1.52.4.1
log
@	* fhandler_disk_file.cc (fhandler_disk_file::rewinddir): Accomodate
	buggy RestartScan behaviour of Windows 2000.
	* wincap.h: Define has_buggy_restart_scan throughout.
	* wincap.cc: Ditto.
@
text
@a68 1
  has_buggy_restart_scan:false,
a125 1
  has_buggy_restart_scan:false,
a182 1
  has_buggy_restart_scan:false,
a239 1
  has_buggy_restart_scan:false,
a296 1
  has_buggy_restart_scan:false,
a353 1
  has_buggy_restart_scan:false,
a410 1
  has_buggy_restart_scan:false,
a467 1
  has_buggy_restart_scan:false,
d524 1
a524 2
  has_exclusiveaddruse:true,
  has_buggy_restart_scan:false,
d581 1
a581 2
  has_exclusiveaddruse:true,
  has_buggy_restart_scan:true,
d638 1
a638 2
  has_exclusiveaddruse:true,
  has_buggy_restart_scan:false,
d695 1
a695 2
  has_exclusiveaddruse:true,
  has_buggy_restart_scan:false,
d752 1
a752 2
  has_exclusiveaddruse:true,
  has_buggy_restart_scan:false,
@


1.52.4.2
log
@	* dtable.cc (build_fh_pc): Add missing DEV_SD1_MAJOR case (Thanks to
	Joe Loh for noticing).

	* cygheap.h (struct user_heap_info): Add slop member.
	* heap.cc (heap_init): Add slop factor to heap allocation.  Add
	comment.
	* mmap.cc (MapViewNT): Allocate memory maps top down.
	(fhandler_dev_zero::mmap): Ditto.
	* shared.cc (shared_info::heap_slop_size): New method.
	(shared_info::heap_chunk_size): Don't use debug_printf at early stage.
	* shared_info.h (SHARED_INFO_CB): Accomodate change to shared_info.
	(CURR_SHARED_MAGIC): Ditto.
	(class shared_info): Add heap_slop member.  Declare heap_slop_size.
	* wincap.h: Define heapslop throughout.
	* wincap.cc: Ditto.
@
text
@a16 1
  heapslop:0x0,
a74 1
  heapslop:0x0,
a132 1
  heapslop:0x0,
a190 1
  heapslop:0x0,
a248 1
  heapslop:0x0,
a306 1
  heapslop:0x0,
a364 1
  heapslop:0x0,
a422 1
  heapslop:0x0,
a480 1
  heapslop:0x0,
a538 1
  heapslop:0x0,
a596 1
  heapslop:0x0,
a654 1
  heapslop:0x4,
a712 1
  heapslop:0x4,
@


1.52.4.3
log
@	* dcrt0.cc (get_cygwin_startup_info): Change zeros to DWORD array.
	Expect first DWORD in child_info struct being set to non-zero if
	wincap.needs_count_in_si_lpres2 is set.  Add comment to explain why.
	* fork.cc (frok::parent): Set ch.zero[0] to a sensible count value
	if wincap.needs_count_in_si_lpres2 is set.
	* spawn.cc (spawn_guts): Ditto.  Add filler bytes after ch on stack
	to accomodate needs_count_in_si_lpres2.
	* wincap.h: Define needs_count_in_si_lpres2 throughout.
	* wincap.cc: Ditto.
@
text
@a70 1
  needs_count_in_si_lpres2:false,
a129 1
  needs_count_in_si_lpres2:false,
a188 1
  needs_count_in_si_lpres2:false,
a247 1
  needs_count_in_si_lpres2:false,
a306 1
  needs_count_in_si_lpres2:false,
a365 1
  needs_count_in_si_lpres2:false,
a424 1
  needs_count_in_si_lpres2:false,
a483 1
  needs_count_in_si_lpres2:false,
a542 1
  needs_count_in_si_lpres2:false,
a601 1
  needs_count_in_si_lpres2:false,
a660 1
  needs_count_in_si_lpres2:false,
a719 1
  needs_count_in_si_lpres2:false,
a778 1
  needs_count_in_si_lpres2:true,
@


1.52.4.4
log
@	* dcrt0.cc (get_cygwin_startup_info): Fix comment.
	* wincap.cc (wincapc::init): Always reset needs_count_in_si_lpres2 to
	false on non 64-bit systems.
@
text
@a903 2
  else
    ((wincaps *)this->caps)->needs_count_in_si_lpres2 = false;
@


1.52.4.5
log
@        * cygtls.cc (_cygtls::init_exception_handler): Revert patch
        from 2005-12-02.
        * exceptions.cc (stack_info::walk): Add workaround for NT 5.2
        64 bit OSes.
        * wincap.h (wincaps::has_restricted_stack_args): New element.
        * wincap.cc: Implement above element throughout.
        (wincapc::init): Reset has_restricted_stack_args if not running
        under WOW64.
@
text
@a71 1
  has_restricted_stack_args:false,
a131 1
  has_restricted_stack_args:false,
a191 1
  has_restricted_stack_args:false,
a251 1
  has_restricted_stack_args:false,
a311 1
  has_restricted_stack_args:false,
a371 1
  has_restricted_stack_args:false,
a431 1
  has_restricted_stack_args:false,
a491 1
  has_restricted_stack_args:false,
a551 1
  has_restricted_stack_args:false,
a611 1
  has_restricted_stack_args:false,
a671 1
  has_restricted_stack_args:false,
a731 1
  has_restricted_stack_args:true,
a791 1
  has_restricted_stack_args:false,
d905 1
a905 4
    {
      ((wincaps *)this->caps)->needs_count_in_si_lpres2 = false;
      ((wincaps *)this->caps)->has_restricted_stack_args = false;
    }
@


1.51
log
@* dcrt0.cc (dll_crt0_0): Reorganize so that sigproc_init is called a little
later.  Add a comment.
* fork.cc (resume_child): Make void.
(frok::parent): Only zero pi when necessary.  Explicitly zero si.  Set
this_errno when child_copy fails.  Accommodate change to resume_child.
* sigproc.cc (sigalloc): Move global_sigs initialization here.
(sigproc_init): Move global_sigs.
(sig_send): Just check for flush signals once.
* wincap.h: Define supports_setconsolectrlhandler_null throughout.
* wincap.cc: Ditto.
@
text
@a68 1
  supports_setconsolectrlhandler_null:false
a125 1
  supports_setconsolectrlhandler_null:false
a182 1
  supports_setconsolectrlhandler_null:false
a239 1
  supports_setconsolectrlhandler_null:false
a296 1
  supports_setconsolectrlhandler_null:false
a353 1
  supports_setconsolectrlhandler_null:false
a410 1
  supports_setconsolectrlhandler_null:true
a467 1
  supports_setconsolectrlhandler_null:true
d524 1
a524 2
  has_exclusiveaddruse:true,
  supports_setconsolectrlhandler_null:true
d581 1
a581 2
  has_exclusiveaddruse:true,
  supports_setconsolectrlhandler_null:true
d638 1
a638 2
  has_exclusiveaddruse:true,
  supports_setconsolectrlhandler_null:true
d695 1
a695 2
  has_exclusiveaddruse:true,
  supports_setconsolectrlhandler_null:true
d752 1
a752 2
  has_exclusiveaddruse:true,
  supports_setconsolectrlhandler_null:true
@


1.50
log
@	* fhandler.h (class fhandler_socket): Add saw_reuseaddr status flag.
	* fhandler_socket.cc (fhandler_socket::bind): Set socket to
	SO_EXCLUSIVEADDRUSE if application didn't explicitely set SO_REUSEADDR
	socket option, on systems supporting SO_EXCLUSIVEADDRUSE.
	* net.cc (cygwin_setsockopt): Set fhandler's saw_reuseaddr status flag
	if SO_REUSEADDR socket option has been successsfully set.
	* wincap.h (wincaps::has_exclusiveaddruse): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d68 2
a69 1
  has_exclusiveaddruse:false
d126 2
a127 1
  has_exclusiveaddruse:false
d184 2
a185 1
  has_exclusiveaddruse:false
d242 2
a243 1
  has_exclusiveaddruse:false
d300 2
a301 1
  has_exclusiveaddruse:false
d358 2
a359 1
  has_exclusiveaddruse:false
d416 2
a417 1
  has_exclusiveaddruse:false
d474 2
a475 1
  has_exclusiveaddruse:false
d532 2
a533 1
  has_exclusiveaddruse:true
d590 2
a591 1
  has_exclusiveaddruse:true
d648 2
a649 1
  has_exclusiveaddruse:true
d706 2
a707 1
  has_exclusiveaddruse:true
d764 2
a765 1
  has_exclusiveaddruse:true
@


1.49
log
@	* autoload.cc (NtQueryDirectoryFile): Define.
	* dir.cc (__opendir_with_d_ino): Just call opendir.
	(opendir): Remove CYGWIN_VERSION_CHECK_FOR_NEEDS_D_INO handling.
	(readdir_worker): Only try generating d_ino if it's 0.
	Utilize namehash of directories fhandler.  Call readdir_get_ino to
	generate d_ino for "..".
	(seekdir64): Keep dirent_set_d_ino flag.
	* fhandler.h (enum dirent_states): Add dirent_get_d_ino.
	(class fhandler_disk_file): Declare new private methods readdir_helper
	and readdir_9x.
	* fhandler_disk_file.cc (path_conv::hasgood_inode): New method to
	evaluate if a filesystem has reliable inode numbers.
	(fhandler_base::fstat_by_handle): Accomodate structure member name
	change from IndexNumber to FileId.
	(fhandler_base::fstat_helper): Call hasgood_inode here.
	(fhandler_disk_file::opendir): Call fhaccess only for real files.
	Don't append '*' to __d_dirname here, move to readdir_9x.  On NT,
	open directory handle here.  Set dirent_get_d_ino and dirent_set_d_ino
	flags according to wincap and filesystem.
	(fhandler_disk_file::readdir_helper): New method to implement readdir
	postprocessing only once.
	(readdir_get_ino_by_handle): New static function.
	(readdir_get_ino): New function to centralize inode number evaluation
	in case inode number hasn't been returned by NtQueryDirectoryFile.
	(fhandler_disk_file::readdir): Move old functionality to readdir_9x.
	Call readdir_9x when on 9x/Me.  Implement NT specific readdir here.
	(fhandler_disk_file::readdir_9x): Move 9x specific readdir here.
	(fhandler_disk_file::seekdir): Accomodate new NT readdir method.
	(fhandler_disk_file::closedir): Ditto.
	(fhandler_cygdrive::fstat): Set d_ino to namehash. Add comment.
	(fhandler_cygdrive::opendir): Call get_namehash to prepare later
	correct evaluation of d_ino.
	(fhandler_cygdrive::readdir): Replace recursion with loop. Evaluate
	drive's d_ino by calling readdir_get_ino.
	* fhandler_proc.cc (fhandler_proc::readdir): Set dirent_saw_dot and
	dirent_saw_dot_dot to avoid seeing . and .. entries twice.
	* fhandler_process.cc (fhandler_process::readdir): Ditto.
	* fhandler_registry.cc (fhandler_registry::readdir): Ditto.
	* ntdll.h (STATUS_INVALID_PARAMETER): New define.
	(STATUS_INVALID_LEVEL): New define.
	(struct _FILE_INTERNAL_INFORMATION): Rename member IndexNumber to
	FileId (as in Nebbitt).
	* path.h (path_conv::hasgood_inode): Now implemented in
	fhandler_disk_file.cc.
	* wincap.h (wincaps::has_fileid_dirinfo): New element.
	* wincap.cc: Implement above element throughout.
	* winsup.h (readdir_get_ino): Add declaration.
	* include/sys/dirent.h (struct dirent): Slightly rename structure
	members to accomodate changes.
	Remove __USE_EXPENSIVE_CYGWIN_D_INO handling and declaration of
	__opendir_with_d_ino.
@
text
@d67 2
a68 1
  has_fileid_dirinfo:false
d124 2
a125 1
  has_fileid_dirinfo:false
d181 2
a182 1
  has_fileid_dirinfo:false
d238 2
a239 1
  has_fileid_dirinfo:false
d295 2
a296 1
  has_fileid_dirinfo:false
d352 2
a353 1
  has_fileid_dirinfo:false
d409 2
a410 1
  has_fileid_dirinfo:false
d466 2
a467 1
  has_fileid_dirinfo:false
d523 2
a524 1
  has_fileid_dirinfo:false
d580 2
a581 1
  has_fileid_dirinfo:true
d637 2
a638 1
  has_fileid_dirinfo:true
d694 2
a695 1
  has_fileid_dirinfo:true
d751 2
a752 1
  has_fileid_dirinfo:true
@


1.48
log
@	* net.cc (cygwin_setsockopt): Ignore errors when setting IP_TOS on
	Windows 2000 and above. Clarify the comment about IP_TOS and move
	to the place where the magic happens.
	(get_ifconf): Remove unused code.
	* wincap.h (wincaps::has_disabled_user_tos_setting): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d66 2
a67 1
  has_disabled_user_tos_setting:false
d122 2
a123 1
  has_disabled_user_tos_setting:false
d178 2
a179 1
  has_disabled_user_tos_setting:false
d234 2
a235 1
  has_disabled_user_tos_setting:false
d290 2
a291 1
  has_disabled_user_tos_setting:false
d346 2
a347 1
  has_disabled_user_tos_setting:false
d402 2
a403 1
  has_disabled_user_tos_setting:false
d458 2
a459 1
  has_disabled_user_tos_setting:false
d514 2
a515 1
  has_disabled_user_tos_setting:false
d570 2
a571 1
  has_disabled_user_tos_setting:true
d626 2
a627 1
  has_disabled_user_tos_setting:true
d682 2
a683 1
  has_disabled_user_tos_setting:true
d738 2
a739 1
  has_disabled_user_tos_setting:true
@


1.47
log
@	* Update copyrights.
@
text
@d65 2
a66 1
  has_working_virtual_lock:false
d120 2
a121 1
  has_working_virtual_lock:false
d175 2
a176 1
  has_working_virtual_lock:false
d230 2
a231 1
  has_working_virtual_lock:false
d285 2
a286 1
  has_working_virtual_lock:false
d340 2
a341 1
  has_working_virtual_lock:false
d395 2
a396 1
  has_working_virtual_lock:true
d450 2
a451 1
  has_working_virtual_lock:true
d505 2
a506 1
  has_working_virtual_lock:true
d560 2
a561 1
  has_working_virtual_lock:true
d615 2
a616 1
  has_working_virtual_lock:true
d670 2
a671 1
  has_working_virtual_lock:true
d725 2
a726 1
  has_working_virtual_lock:true
@


1.46
log
@	* dcrt0.cc (dll_crt0_0): Remove call to wincap.init.
	* init.cc (dll_entry): Rename is_wow64_proc to wow64_test_stack_marker.
	Call wincap.init here before doing anything else.  Use wincap.is_wow64
	to determine if we're running in a WOW64 emulator.
	* mmap.cc (MapViewNT): Don't use AT_ROUND_TO_PAGE in WOW64, it's
	apparently not supported.
	(mmap64): Don't create mappings beyond EOF, which would need to use
	AT_ROUND_TO_PAGE, on WOW64.
	* wincap.cc (wincap): Throw into the .cygwin_dll_common section.
	(wincapc::init): Determine if running in WOW64 and set wow_64 flag.
	* wincap.h (class wincapc): Add wow64 member.
	(wincapc::is_wow64): New method.
@
text
@d4 1
a4 1
   Copyright 2001, 2002, 2003, 2004, 2005 Red Hat, Inc.
@


1.45
log
@	* autoload.cc (NtCreateSection): Define.
	* cygheap.cc (_csbrk): Call getpagesize instead of getshmlba.
	* dcrt0.cc (dll_crt0_0): Call mmap_init.
	* external.cc (cygwin_internal): Call getpagesize instead of getshmlba.
	* fhandler.h (fhandler_base::mmap): Change access to prot parameter.
	(fhandler_base::fixup_mmap_after_fork): Ditto.
	(fhandler_disk_file::mmap): Ditto.
	(fhandler_disk_file::fixup_mmap_after_fork): Ditto.
	(fhandler_dev_mem::mmap): Ditto.
	(fhandler_dev_mem::fixup_mmap_after_fork): Ditto.
	* fhandler_mem.cc (fhandler_dev_mem::write): Call getsystempagesize
	instead of getpagesize.
	(fhandler_dev_mem::read): Ditto.
	(fhandler_dev_mem::fstat): Ditto.
	(fhandler_dev_mem::mmap): Move to mmap.cc.
	(fhandler_dev_mem::munmap): Ditto.
	(fhandler_dev_mem::msync): Ditto.
	(fhandler_dev_mem::fixup_mmap_after_fork): Ditto.
	* fhandler_proc.cc (format_proc_meminfo): Call getsystempagesize
	instead of getpagesize.
	* fhandler_process.cc (format_process_stat): Ditto.
	(format_process_status): Ditto.
	(get_mem_values): Ditto.
	* mmap.cc: Fix formatting.  Try to make more readable and modular.
	Take advantage of pagesize==granularity.
	(gen_protect): New static function to evaluate Windows
	protection bits from POSIX protection and flags.
	(gen_access): Ditto for Windows access mode.
	(VirtualProt9x): Wrapper function to call VirtualProtect on 9x.
	(VirtualProtNT): Ditto for NT.
	(VirtualProtEx9x): Ditto for VirtualProtectEx on 9x.
	(VirtualProtExNT): Ditto for NT.
	(CreateMapping9x): Wrapper function for creating a mapping handle on 9x.
	(CreateMappingNT): Ditto for NT.
	(MapView9x): Wrapper function to map a view on 9x.
	(MapViewNT): Ditto for NT.
	(mmap_funcs_9x): Structure containing function pointers to wrapper
	functions for 9x.
	(mmap_funcs_nt): Ditto for NT.
	(mmap_func): Pointer to wrapper functions used in subsequent code.
	(mmap_init): Initialize mmap_func depending on OS.
	(class mmap_record): Use sensible member names.  Add POSIX protection
	member. Drop Windows access flags member.  Constify more methods.
	Use accessors instead of direct member access inside of own methods.
	(mmap_record::gen_protect): Class wrapper to evaluate matching
	Windows protection bits.
	(mmap_record::gen_access): Ditto for Windows access flags.
	(mmap_record::compatible_flags): New function to check if flags are
	compatible with flags of existing map.
	(list::add_record): Drop offset and length arguments.
	(class map): Change counters to unsigned.  Match usage throughout.
	(mmapped_areas): Convert from pointer to global struct.
	(mmap_record::alloc_page_map): Simplify.
	(mmap_record::map_pages): Ditto.
	(mmap_record::fixup_page_map): Delete.
	(mmap64): Simplify.  Add workaround for Windows 98 bug.  Fix bug on
	NT that existing anonymous mappings weren't searched for a match.
	(munmap): Add workaround for Windows 98 bug.
	(msync): Simplify.
	(mprotect): Handle existing maps correctly.
	(mlock): Add local pagesize variable and enlightening comment.
	(fhandler_disk_file::mmap): Main functionality now in CreateMapping/
	MapView wrapper functions.
	(fhandler_disk_file::fixup_mmap_after_fork): Call MapView wrapper.
	(fhandler_dev_mem::mmap): Moved from fhandler_mem.cc.  Simplify by
	calling MapViewNT.
	(fhandler_dev_mem::munmap): Moved from fhandler_mem.cc.
	(fhandler_dev_mem::msync): Ditto.
	(fhandler_dev_mem::fixup_mmap_after_fork): Ditto.  Call MapViewNT.
	(fixup_mmaps_after_fork): Restructure and hopefully speed up loop for
	setting protection and memory content on MAP_PRIVATE maps.
	* ntdll.h (AT_ROUND_TO_PAGE): Remove define.
	(AT_EXTENDABLE_FILE): Add define.
	(NtCreateSection): Add prototype.
	* syscalls.cc (getpagesize): Return granularity as pagesize now.
	(getsystempagesize): New function to retrieve "real" pagesize.
	(getshmlba): Delete since it's replaced by getpagesize now.
	* wincap.h (wincaps::has_mmap_alignment_bug): New element.
	* wincap.cc: Implement above element throughout.
	* winsup.h (getshmlba): Drop prototype.
	(getsystempagesize): Add prototype.
	(mmap_init): Ditto.
	* include/sys/mman.h: (Not yet) define MAP_NORESERVE.
@
text
@d716 1
a716 1
wincapc wincap;
d823 4
@


1.44
log
@	* autoload.cc (NtLockVirtualMemory): Import.
	(NtUnlockVirtualMemory): Import.
	(GetProcessWorkingSetSize): Import.
	(SetProcessWorkingSetSize): Import.
	* cygwin.din (mlock): Export.
	(munlock): Export.
	* mmap.cc (mlock): New function.
	(munlock): Ditto.
	* ntdll.h (STATUS_WORKING_SET_QUOTA): Define.
	(LOCK_VM_IN_WSL): Define.
	(LOCK_VM_IN_RAM): Define.
	(NtLockVirtualMemory): Declare.
	(NtUnlockVirtualMemory): Declare.
	* sysconf.cc (sysconf): Implement _SC_MEMLOCK_RANGE.
	* wincap.h: Implement has_working_virtual_lock throughout.
	* wincap.cc: Ditto.
	* include/cygwin/version.h: Bump API minor version.
	* include/sys/mman.h (mlock): Declare,
	(munlock): Declare.
@
text
@d40 1
d94 1
d148 1
d202 1
d256 1
d310 1
d364 1
d418 1
d472 1
d526 1
d580 1
d634 1
d688 1
@


1.43
log
@	* fhandler.h (class fhandler_dev_raw): Delete current_position and
	eof_detected status flag.  Delete is_eom and is_eof methods.
	Move drive_size, bytes_per_sector, eom_detected status flag, as well
	as the methods read_file, write_file, raw_read and raw_write to ...
	(class fhandler_dev_floppy): ... here. Remove is_eom and is_eof
	methods.  Add dup method.
	* fhandler_floppy.cc (IS_EOM): New macro.
	(fhandler_dev_floppy::is_eom): Remove.
	(fhandler_dev_floppy::is_eof): Remove.
	(fhandler_dev_floppy::fhandler_dev_floppy): Initialize status flags.
	(fhandler_dev_floppy::get_drive_info): Only call EX functions on
	systems supporting them and stop suffering strange delays.
	(fhandler_dev_floppy::read_file): Move here, drop setting
	current_position.
	(fhandler_dev_floppy::write_file): Move here, drop setting
	current_position.
	(fhandler_dev_floppy::open): Rearrange comment.
	(fhandler_dev_floppy::dup): New method.
	(fhandler_dev_floppy::get_current_position): New inline method.  Use
	instead of former current_position were appropriate.
	(fhandler_dev_floppy::raw_read): Move here.  Drop EOF handling.
	(fhandler_dev_floppy::raw_write): Move here.  Drop EOF handling.
	(fhandler_dev_floppy::lseek): Remove useless conditions.  Convert
	sector_aligned_offset to LARGE_INTEGER to improve SetFilePointer call.
	(fhandler_dev_floppy::ioctl): Move blocksize check in RDSETBLK case
	to here.
	* fhandler_raw.cc (fhandler_dev_raw::is_eom): Remove.
	(fhandler_dev_raw::is_eof): Remove.
	(fhandler_dev_raw::write_file): Remove.
	(fhandler_dev_raw::read_file): Remove.
	(fhandler_dev_raw::raw_read): Remove.
	(fhandler_dev_raw::raw_write): Remove.
	(fhandler_dev_raw::dup): Drop copying removed members.
	(fhandler_dev_raw::ioctl): Drop blocksize testing.
	* wincap.h: Implement has_disk_ex_ioctls throughout.
	* wincap.cc: Ditto.
	(wincap_vista): Preliminary wincaps for Windows Vista/Longhorn.
	(wincapc::init): Add Vista/Longhorn handling.
@
text
@d63 2
a64 1
  has_disk_ex_ioctls:false
d116 2
a117 1
  has_disk_ex_ioctls:false
d169 2
a170 1
  has_disk_ex_ioctls:false
d222 2
a223 1
  has_disk_ex_ioctls:false
d275 2
a276 1
  has_disk_ex_ioctls:false
d328 2
a329 1
  has_disk_ex_ioctls:false
d381 2
a382 1
  has_disk_ex_ioctls:false
d434 2
a435 1
  has_disk_ex_ioctls:false
d487 2
a488 1
  has_disk_ex_ioctls:false
d540 2
a541 1
  has_disk_ex_ioctls:false
d593 2
a594 1
  has_disk_ex_ioctls:true
d646 2
a647 1
  has_disk_ex_ioctls:true
d699 2
a700 1
  has_disk_ex_ioctls:true
@


1.42
log
@	Revert erroneous checkin.
@
text
@d62 2
a63 1
  has_null_console_handler_routine:false
d114 2
a115 1
  has_null_console_handler_routine:false
d166 2
a167 1
  has_null_console_handler_routine:false
d218 2
a219 1
  has_null_console_handler_routine:false
d270 2
a271 1
  has_null_console_handler_routine:false
d322 2
a323 1
  has_null_console_handler_routine:false
d374 2
a375 1
  has_null_console_handler_routine:true
d426 2
a427 1
  has_null_console_handler_routine:true
d478 2
a479 1
  has_null_console_handler_routine:true
d530 2
a531 1
  has_null_console_handler_routine:true
d582 2
a583 1
  has_null_console_handler_routine:true
d634 54
a687 1
  has_null_console_handler_routine:true
d743 5
@


1.41
log
@	* fhandler.h (class fhandler_dev_raw): Delete current_position and
	eof_detected status flag.  Delete is_eom and is_eof methods.
	Move drive_size, bytes_per_sector, eom_detected status flag, as well
	as the methods read_file, write_file, raw_read and raw_write to ...
	(class fhandler_dev_floppy): ... here. Remove is_eom and is_eof
	methods.  Add dup method.
	* fhandler_floppy.cc (IS_EOM): New macro.
	(fhandler_dev_floppy::is_eom): Remove.
	(fhandler_dev_floppy::is_eof): Remove.
	(fhandler_dev_floppy::fhandler_dev_floppy): Initialize status flags.
	(fhandler_dev_floppy::get_drive_info): Only call EX functions on
	systems supporting them and stop suffering strange delays.
	(fhandler_dev_floppy::read_file): Move here, drop setting
	current_position.
	(fhandler_dev_floppy::write_file): Move here, drop setting
	current_position.
	(fhandler_dev_floppy::open): Rearrange comment.
	(fhandler_dev_floppy::dup): New method.
	(fhandler_dev_floppy::get_current_position): New inline method.  Use
	instead of former current_position were appropriate.
	(fhandler_dev_floppy::raw_read): Move here.  Drop EOF handling.
	(fhandler_dev_floppy::raw_write): Move here.  Drop EOF handling.
	(fhandler_dev_floppy::lseek): Remove useless conditions.  Convert
	sector_aligned_offset to LARGE_INTEGER to improve SetFilePointer call.
	(fhandler_dev_floppy::ioctl): Move blocksize check in RDSETBLK case
	to here.
	* fhandler_raw.cc (fhandler_dev_raw::is_eom): Remove.
	(fhandler_dev_raw::is_eof): Remove.
	(fhandler_dev_raw::write_file): Remove.
	(fhandler_dev_raw::read_file): Remove.
	(fhandler_dev_raw::raw_read): Remove.
	(fhandler_dev_raw::raw_write): Remove.
	(fhandler_dev_raw::dup): Drop copying removed members.
	(fhandler_dev_raw::ioctl): Drop blocksize testing.
	* wincap.h: Implement has_disk_ex_ioctls throughout.
	* wincap.cc: Ditto.
	(wincap_vista): Preliminary wincaps for Windows Vista/Longhorn.
	(wincapc::init): Add Vista/Longhorn handling.
@
text
@a625 51
static NO_COPY wincaps wincap_vista = {
  lock_file_highword:UINT32_MAX,
  chunksize:0,
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
  is_winnt:true,
  is_server:false,
  access_denied_on_delete:false,
  has_delete_on_close:true,
  has_page_guard:true,
  has_security:true,
  has_security_descriptor_control:true,
  has_get_process_times:true,
  has_lseek_bug:false,
  has_lock_file_ex:true,
  has_signal_object_and_wait:true,
  has_eventlog:true,
  has_ip_helper_lib:true,
  has_set_handle_information:true,
  has_set_handle_information_on_console_handles:true,
  supports_smp:true,
  map_view_of_file_ex_sucks:false,
  altgr_is_ctrl_alt:true,
  has_physical_mem_access:true,
  has_working_copy_on_write:true,
  share_mmaps_only_by_name:false,
  virtual_protect_works_on_shared_pages:true,
  has_hard_links:true,
  can_open_directories:true,
  has_move_file_ex:true,
  has_negative_pids:false,
  has_unreliable_pipes:false,
  has_named_pipes:true,
  has_try_enter_critical_section:true,
  has_raw_devices:true,
  has_valid_processorlevel:true,
  has_64bit_file_access:true,
  has_process_io_counters:true,
  supports_reading_modem_output_lines:true,
  needs_memory_protection:true,
  pty_needs_alloc_console:true,
  has_terminal_services:true,
  has_switch_to_thread:true,
  cant_debug_dll_entry:false,
  has_ioctl_storage_get_media_types_ex:true,
  start_proc_suspended:false,
  has_extended_priority_class:true,
  has_guid_volumes:true,
  detect_win16_exe:false,
  has_null_console_handler_routine:true
};

a678 5
	    case 6:
	      os = "NT";
	      has_osversioninfoex = true;
	      caps = &wincap_vista;
	      break;
@


1.40
log
@* cygerrno.h: Make multi-inclusion safe.
* fhandler_termios.cc (fhandler_termios::tcsetpgrp): Deal with EINTR.
* dcrt0.cc (dll_crt0_0): Accommodate init_console_handler argument change.
* winsup.h: Ditto.
* fhandler_tty.cc (fhandler_tty_slave::open): Ditto.
* exceptions.cc (init_console_handler): Ditto.  Ignore console events if we're
not attached to a terminal.
* fhandler_tty.cc (fhandler_tty_slave::open): Ditto.
* wincap.cc: Implement has_null_console_handler_routine throughout.
* wincap.h: Ditto.
@
text
@d626 51
d730 5
@


1.39
log
@* wincap.h (wincaps::detect_win16_exe): Declare.
(wincapc::detect_win16_exe): Implement.
* wincap.cc: Populate detect_win16_exe where appropriate.
* spawn.cc (spawn_guts): Only go out of the way to detect 16-bit apps on
systems which are flummoxed by them.
@
text
@d61 2
a62 1
  detect_win16_exe:true
d112 2
a113 1
  detect_win16_exe:true
d163 2
a164 1
  detect_win16_exe:true
d214 2
a215 1
  detect_win16_exe:true
d265 2
a266 1
  detect_win16_exe:true
d316 2
a317 1
  detect_win16_exe:true
d367 2
a368 1
  detect_win16_exe:false
d418 2
a419 1
  detect_win16_exe:false
d469 2
a470 1
  detect_win16_exe:false
d520 2
a521 1
  detect_win16_exe:false
d571 2
a572 1
  detect_win16_exe:false
d622 2
a623 1
  detect_win16_exe:false
@


1.38
log
@	Revert previous patch.
	* autoload.cc (GetVolumePathNamesForVolumeNameA): Remove.
	* autoload.cc (GetVolumeNameForVolumeMountPointA): Add.
	* syscalls.cc (sync): Rewrite guid case to skip floppies also on
	Windows 2000.
@
text
@d60 2
a61 1
  has_guid_volumes:false
d110 2
a111 1
  has_guid_volumes:false
d160 2
a161 1
  has_guid_volumes:false
d210 2
a211 1
  has_guid_volumes:false
d260 2
a261 1
  has_guid_volumes:false
d310 2
a311 1
  has_guid_volumes:false
d360 2
a361 1
  has_guid_volumes:false
d410 2
a411 1
  has_guid_volumes:false
d460 2
a461 1
  has_guid_volumes:false
d510 2
a511 1
  has_guid_volumes:true
d560 2
a561 1
  has_guid_volumes:true
d610 2
a611 1
  has_guid_volumes:true
@


1.37
log
@	* syscalls.cc (sync): Use renamed has_get_volume_pathnames wincap.
	* wincap.h (wincaps::has_get_volume_pathnames): Rename from
	has_guid_volumes
	* wincap.cc: Accomodate above rename throughout.  Set to false on
	Windows 2000.
@
text
@d60 1
a60 1
  has_get_volume_pathnames:false
d109 1
a109 1
  has_get_volume_pathnames:false
d158 1
a158 1
  has_get_volume_pathnames:false
d207 1
a207 1
  has_get_volume_pathnames:false
d256 1
a256 1
  has_get_volume_pathnames:false
d305 1
a305 1
  has_get_volume_pathnames:false
d354 1
a354 1
  has_get_volume_pathnames:false
d403 1
a403 1
  has_get_volume_pathnames:false
d452 1
a452 1
  has_get_volume_pathnames:false
d501 1
a501 1
  has_get_volume_pathnames:false
d550 1
a550 1
  has_get_volume_pathnames:true
d599 1
a599 1
  has_get_volume_pathnames:true
@


1.36
log
@	* fhandler.h (class fhandler_socket): Declare new method
	set_socketpair_eids.
	* fhandler_socket.cc (fhandler_socket::set_socketpair_eids): New method.
	(fhandler_socket::dup): Duplicate sec_pipe if necessary.
	(fhandler_socket::listen): Only create sec_pipe if named pipes are
	available. Initialized sec_peer_pid to 0 as on Linux.
	(fhandler_socket::connect): Only run eid credential transaction if
	named pipes are available.  Fake otherwise. Initialized sec_peer_pid
	to 0 as on Linux.
	(fhandler_socket::accept): Ditto.
	(fhandler_socket::close): Move closing sec_pipe handle from here...
	(fhandler_socket::~fhandler_socket): ... to here.
	* net.cc (socketpair): Set eid credentials by calling
	fhandler_socket::set_socketpair_eids() on both socket ends.
	* wincap.h (wincaps::has_named_pipes): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d60 1
a60 1
  has_guid_volumes:false
d109 1
a109 1
  has_guid_volumes:false
d158 1
a158 1
  has_guid_volumes:false
d207 1
a207 1
  has_guid_volumes:false
d256 1
a256 1
  has_guid_volumes:false
d305 1
a305 1
  has_guid_volumes:false
d354 1
a354 1
  has_guid_volumes:false
d403 1
a403 1
  has_guid_volumes:false
d452 1
a452 1
  has_guid_volumes:false
d501 1
a501 1
  has_guid_volumes:true
d550 1
a550 1
  has_guid_volumes:true
d599 1
a599 1
  has_guid_volumes:true
@


1.35
log
@	* autoload.cc (FindFirstVolumeA): Add.
	(FindNextVolumeA): Add.
	(FindVolumeClose): Add.
	(GetVolumePathNamesForVolumeNameA): Add.
	* fhandler.h (class fhandler_base): Declare new method fsync.
	* fhandler.cc (fhandler_base::fsync): New method.
	* syscalls.cc (fsync): Move functionality into fhandler method fsync.
	Just call this method from here.
	(sync_worker): New static function.
	(sync): Fill with life for NT systems.
	* wincap.h (wincaps::has_guid_volumes): New element.
	* wincap.cc: Implement above element throughout.
@
text
@d45 1
d94 1
d143 1
d192 1
d241 1
d290 1
d339 1
d388 1
d437 1
d486 1
d535 1
d584 1
@


1.34
log
@copyright
@
text
@d58 2
a59 1
  has_extended_priority_class:false
d106 2
a107 1
  has_extended_priority_class:false
d154 2
a155 1
  has_extended_priority_class:false
d202 2
a203 1
  has_extended_priority_class:false
d250 2
a251 1
  has_extended_priority_class:false
d298 2
a299 1
  has_extended_priority_class:false
d346 2
a347 1
  has_extended_priority_class:false
d394 2
a395 1
  has_extended_priority_class:false
d442 2
a443 1
  has_extended_priority_class:false
d490 2
a491 1
  has_extended_priority_class:true
d538 2
a539 1
  has_extended_priority_class:true
d586 2
a587 1
  has_extended_priority_class:true
@


1.33
log
@	* cygwin.din: Export getpriority and setpriority.
	* fork.cc (fork_parent): Copy parent's nice value into child.
	* spawn.cc (spawn_guts): Ditto.
	* miscfuncs.cc (winprio_to_nice): New function.
	(nice_to_winprio): Ditto.
	* pinfo.cc (pinfo_init): If parent is not a Cygwin process, set
	default nice value according to current Win32 priority class.
	* pinfo.h (class _pinfo): Add nice member.
	* syscalls.cc (setpriority): New function, only implementing
	PRIO_PROCESS for now.
	(getpriority): Ditto.
	(nice): Just call setpriority.
	* wincap.h (wincaps::has_extended_priority_class): New element.
	* wincap.cc: Implement above element throughout.
	* winsup.h: Add prototypes for winprio_to_nice and nice_to_winprio.
	* include/limits.h (NZERO): New define.
	* include/cygwin/types.h (id_t): New datatype.
	* include/cygwin/version.h: Bump API minor version.
	* include/sys/resource.h: Add PRIO_XXX defines and prototypes for
	getpriority and setpriority.
@
text
@d4 1
a4 1
   Copyright 2001, 2002, 2003, 2004 Red Hat, Inc.
@


1.32
log
@* cygthread.cc (cygthread::stub): Add better debug output.
(cygthread::cygthread): Ditto.
(cygthread::terminate_thread): Ditto.  Move inuse test earlier or suffer
infinite loop.
* pinfo.cc (_pinfo::dup_proc_pipe): Close handle if DuplicateHandle fails and
process no longer exists.
* spawn.cc (spawn_guts): Create process in suspended state if OS demands it.
* wincap.cc: Add "start_proc_suspended" throughout.
* wincap.h (wincaps): Ditto.
(wincapc): Ditto.
@
text
@d57 2
a58 1
  start_proc_suspended:true
d104 2
a105 1
  start_proc_suspended:true
d151 2
a152 1
  start_proc_suspended:true
d198 2
a199 1
  start_proc_suspended:true
d245 2
a246 1
  start_proc_suspended:true
d292 2
a293 1
  start_proc_suspended:true
d339 2
a340 1
  start_proc_suspended:false
d386 2
a387 1
  start_proc_suspended:false
d433 2
a434 1
  start_proc_suspended:false
d480 2
a481 1
  start_proc_suspended:false
d527 2
a528 1
  start_proc_suspended:false
d574 2
a575 1
  start_proc_suspended:false
@


1.31
log
@* path.cc (chdir): Always use the normalized_path as posix_cwd, except if it
starts with a drive.

Also perform whitespace cleanup.
@
text
@d56 2
a57 1
  has_ioctl_storage_get_media_types_ex:false
d102 2
a103 1
  has_ioctl_storage_get_media_types_ex:false
d148 2
a149 1
  has_ioctl_storage_get_media_types_ex:false
d194 2
a195 1
  has_ioctl_storage_get_media_types_ex:false
d240 2
a241 1
  has_ioctl_storage_get_media_types_ex:false
d286 2
a287 1
  has_ioctl_storage_get_media_types_ex:false
d332 2
a333 1
  has_ioctl_storage_get_media_types_ex:false
d378 2
a379 1
  has_ioctl_storage_get_media_types_ex:false
d424 2
a425 1
  has_ioctl_storage_get_media_types_ex:false
d470 2
a471 1
  has_ioctl_storage_get_media_types_ex:false
d516 2
a517 1
  has_ioctl_storage_get_media_types_ex:true
d562 2
a563 1
  has_ioctl_storage_get_media_types_ex:true
@


1.30
log
@	* errno.cc (errmap): Map ERROR_BEGINNING_OF_MEDIA and
	ERROR_SETMARK_DETECTED to EIO instead of ESPIPE.
	Handle ERROR_FILEMARK_DETECTED.
	* fhandler_tape.cc (TAPE_FUNC): Add comment that ERROR_BUS_RESET
	has still to be handled correctly.
	(fhandler_dev_tape::open): Accomodate fact that get.mt_dsreg
	also contains density code.
	(fhandler_dev_tape::ioctl): Rearrange slightly.  Reset devbuf also on
	MTNOP, MTWSM, MTSETBLK, MTSETDRVBUFFER, MTSETPART and MTMKPART.
	(fhandler_dev_tape::tape_set_pos): Rearrange.  Match behaviour to
	the Linux tape driver.
	(fhandler_dev_tape::tape_status): Call IOCTL_STORAGE_GET_MEDIA_TYPES_EX
	if available.  Return device type and density code in appropriate
	mtget members.
	* wincap.h (wincaps::has_ioctl_storage_get_media_types_ex): New element.
	* wincap.cc: Implement above element throughout.
	* include/cygwin/mtio.h: Add tape device types as returned by
	IOCTL_STORAGE_GET_MEDIA_TYPES_EX.
	(MT_TAPE_INFO): Use above type codes.
	(struct mtget): Change mt_dsreg comment.
@
text
@d584 1
a584 1
	        {
d594 1
a594 1
	        {
@


1.29
log
@* debug.h (console_printf): Define for non-debugging condition.
* cygtls.h (_threadinfo::lock): Remove wait argument.
(_threadinfo::interrupt_setup): Remove retaddr argument.
* exceptions.cc (_threadinfo::interrupt_setup): Ditto.
(_threadinfo::interrupt_now): Accommodate change to interrupt_setup argument.
(setup_handler): Ditto.  Always lock sig stack prior to determining interrupt
method.
* gendef (_sigfe): Correct thinko regarding cmpxchg.
(_sigbe): Ditto.
(_threadinfo::lock): Ditto.
(_threadinfo::pop): Eliminate left-over stack unlock.
* sigproc.cc (proc_subproc): Chnage debugging output to printed warning.
@
text
@d55 2
a56 1
  cant_debug_dll_entry:false
d100 2
a101 1
  cant_debug_dll_entry:true
d145 2
a146 1
  cant_debug_dll_entry:true
d190 2
a191 1
  cant_debug_dll_entry:true
d235 2
a236 1
  cant_debug_dll_entry:true
d280 2
a281 1
  cant_debug_dll_entry:true
d325 2
a326 1
  cant_debug_dll_entry:false
d370 2
a371 1
  cant_debug_dll_entry:false
d415 2
a416 1
  cant_debug_dll_entry:false
d460 2
a461 1
  cant_debug_dll_entry:false
d505 2
a506 1
  cant_debug_dll_entry:false
d550 2
a551 1
  cant_debug_dll_entry:false
@


1.28
log
@* sigproc.cc (sigproc_terminate): Don't close sendsig handle when execing since
we're not closing what we think we're closing.
(sig_send): Improve debugging when exiting due to no_signals_available.
* wincap.h (wincaps::cant_debug_dll_entry): New element.
* wincap.cc: Implement above element throughout.
* dcrt0.cc (initial_env): Accommodate changes necessary to allow initial
debugging for systems which do not allow debugging in dll_entry.
(dll_crt0_0): Add initial_env call back here.
* Makefile.in (install-man): Use mandir as target for installation.
* include/cygwin/version.h: Bump DLL minor number to 7 (should have been done
earlier).
@
text
@d4 1
a4 1
   Copyright 2001, 2002 Red Hat, Inc.
@


1.27
log
@	Substitute 0x7fffffff and 0xffffffff by INT32_MAX and UINT32_MAX
	throughout, except in assembler code.
@
text
@d54 2
a55 1
  has_switch_to_thread:false
d98 2
a99 1
  has_switch_to_thread:false
d142 2
a143 1
  has_switch_to_thread:false
d186 2
a187 1
  has_switch_to_thread:false
d230 2
a231 1
  has_switch_to_thread:false
d274 2
a275 1
  has_switch_to_thread:false
d318 2
a319 1
  has_switch_to_thread:false
d362 2
a363 1
  has_switch_to_thread:true
d406 2
a407 1
  has_switch_to_thread:true
d450 2
a451 1
  has_switch_to_thread:true
d494 2
a495 1
  has_switch_to_thread:true
d538 2
a539 1
  has_switch_to_thread:true
@


1.26
log
@	* wincap.cc (wincapc::init): Allow requesting server info for NT4 SP6.
@
text
@d273 1
a273 1
  lock_file_highword:0xffffffff,
d316 1
a316 1
  lock_file_highword:0xffffffff,
d359 1
a359 1
  lock_file_highword:0xffffffff,
d402 1
a402 1
  lock_file_highword:0xffffffff,
d445 1
a445 1
  lock_file_highword:0xffffffff,
d488 1
a488 1
  lock_file_highword:0xffffffff,
@


1.25
log
@* Makefile.in: Add libusr32.a to DLL_IMPORTS.
* wincap.h (wincaps::is_server): New flag.
(wincapc::version): Change type to OSVERSIONINFOEX.
(wincapc::is_server): New function.
* wincap.cc (wincap_unknown::is_server): New initializer.
(wincap_95): Ditto.
(wincap_95osr2): Ditto.
(wincap_98): Ditto.
(wincap_me): Ditto.
(wincap_nt3): Ditto.
(wincap_nt4): Ditto.
(wincap_nt4sp4): Ditto.
(wincap_2000): Ditto.
(wincap_xp): Ditto.
(wincapc::init): Adapt to OSVERSIONINFOEX.  Add detection of NT server systems.
* sched.cc: Include windows.h and registry.h.
(sched_rr_get_interval): Re-implement for NT systems.
@
text
@d536 1
d542 1
d544 1
a544 1
  GetVersionEx (reinterpret_cast<LPOSVERSIONINFO> (&version));
d560 5
a564 1
		caps = &wincap_nt4sp4;
d568 1
d622 1
a622 1
  if (((wincaps *)this->caps)->is_winnt && version.dwMajorVersion > 4)
d624 3
a626 1
      version.dwOSVersionInfoSize = sizeof version;
@


1.24
log
@* syscalls.cc (mount): Don't check win32_path when doing cygdrive mount.
@
text
@d19 1
d62 1
d105 1
d148 1
d191 1
d234 1
d277 1
d320 1
d363 1
d406 1
d449 1
d492 1
d541 2
a542 2
  version.dwOSVersionInfoSize = sizeof version;
  GetVersionEx (&version);
d614 9
@


1.23
log
@* exceptions.cc (ctrl_c_handler): Send SIGHUP when events occur only if there
is a tty associated with the process.  Send SIGHUP on CTRL_LOGOFF_EVENT.
* fhandler_tty.cc (fhandler_tty_slave::open): Adjust console open handle
counter regardless of whether this is a pty or tty.
(fhandler_tty_slave::open): Ditto.
(fhandler_tty_slave::dup): Ditto.
(fhandler_tty_common::set_close_on_exec): Ditto.
(fhandler_tty_master::init_console): Decrement console open handle counter
after init since it will now be handled by all tty open.
* syscalls.cc (setsid): Rework debugging output slightly.
@
text
@d52 2
a53 1
  has_terminal_services:false
d94 2
a95 1
  has_terminal_services:false
d136 2
a137 1
  has_terminal_services:false
d178 2
a179 1
  has_terminal_services:false
d220 2
a221 1
  has_terminal_services:false
d262 2
a263 1
  has_terminal_services:false
d304 2
a305 1
  has_terminal_services:false
d346 2
a347 1
  has_terminal_services:false
d388 2
a389 1
  has_terminal_services:false
d430 2
a431 1
  has_terminal_services:true
d472 2
a473 1
  has_terminal_services:true
d514 2
a515 1
  has_terminal_services:true
@


1.22
log
@	* fhandler_socket.cc (SECRET_EVENT_NAME): Remove.
	(ENTROPY_SOURCE_NAME): Ditto.
	(secret_event_name): New static function.  Create shared event name
	with "Global\" prefix on systems supporting terminal services.
	(fhandler_socket::set_connect_secret): Fix conditional.
	(fhandler_socket::create_secret_event): Create secret event using
	secret_event_name().
	(fhandler_socket::close_secret_event): Ditto.
	* shared.cc (shared_name): Create shared object name with "Global\"
	prefix on systems supporting terminal services.
	* wincap.cc: Set has_terminal_services capability throughout.
	(wincap_2003): New global object representing Windows 2003 Server
	capabilities.
	(wincapc::init): Accomodate Windows 2003 Server.
	* wincap.h (struct wincaps): Add has_terminal_services capability.
@
text
@d543 1
a543 1
		  
@


1.21
log
@* wincap.h (wincaps:pty_needs_alloc_console): New element.
(wincapc:pty_needs_alloc_console): New function.
* wincap.cc: Add pty_needs_alloc_console throughout.
* fhandler_tty.cc (fhandler_tty_slave::open): Open an "invisible" console on
first pty allocation.
@
text
@d51 2
a52 1
  pty_needs_alloc_console:false
d92 2
a93 1
  pty_needs_alloc_console:false
d133 2
a134 1
  pty_needs_alloc_console:false
d174 2
a175 1
  pty_needs_alloc_console:false
d215 2
a216 1
  pty_needs_alloc_console:false
d256 2
a257 1
  pty_needs_alloc_console:false
d297 2
a298 1
  pty_needs_alloc_console:true
d338 2
a339 1
  pty_needs_alloc_console:true
d379 2
a380 1
  pty_needs_alloc_console:true
d420 2
a421 1
  pty_needs_alloc_console:true
d461 43
a503 1
  pty_needs_alloc_console:true
d538 13
a550 4
	      if (version.dwMinorVersion == 0)
		caps = &wincap_2000;
	      else
		caps = &wincap_xp;
@


1.20
log
@	* wincap.h (wincap): Remove unnecessary definition of
	supports_sparse_files.
	* wincap.cc: Ditto.
@
text
@d50 2
a51 1
  needs_memory_protection:false
d90 2
a91 1
  needs_memory_protection:false
d130 2
a131 1
  needs_memory_protection:false
d170 2
a171 1
  needs_memory_protection:false
d210 2
a211 1
  needs_memory_protection:false
d250 2
a251 1
  needs_memory_protection:false
d290 2
a291 1
  needs_memory_protection:true
d330 2
a331 1
  needs_memory_protection:true
d370 2
a371 1
  needs_memory_protection:true
d410 2
a411 1
  needs_memory_protection:true
d450 2
a451 1
  needs_memory_protection:true
@


1.19
log
@w32api:

        * include/winioctl.h (FSCTL_SET_SPARSE): Define.

cygwin:

        * wincap.h (wincaps::supports_sparse_files): New flag.
        (wincapc::supports_sparse_files): New method.
        * wincap.cc (wincap_unknown): Define value for the new flag.
        (wincap_95): Ditto.
        (wincap_95osr2): Ditto.
        (wincap_98): Ditto.
        (wincap_98se): Ditto.
        (wincap_me): Ditto.
        (wincap_nt3): Ditto.
        (wincap_nt4): Ditto.
        (wincap_nt4sp4): Ditto.
        (wincap_2000): Ditto.
        (wincap_xp): Ditto.
        * path.h (path_conv::fs_flags): New method.
        * fhandler_disk_file.cc: Include winioctl.h for DeviceIoControl.
        (fhandler_disk_file::open): Set newly created and truncated files as
        sparse on platforms that support it.
@
text
@d50 1
a50 2
  needs_memory_protection:false,
  supports_sparse_files:false
d89 1
a89 2
  needs_memory_protection:false,
  supports_sparse_files:false
d128 1
a128 2
  needs_memory_protection:false,
  supports_sparse_files:false
d167 1
a167 2
  needs_memory_protection:false,
  supports_sparse_files:false
d206 1
a206 2
  needs_memory_protection:false,
  supports_sparse_files:false
d245 1
a245 2
  needs_memory_protection:false,
  supports_sparse_files:false
d284 1
a284 2
  needs_memory_protection:true,
  supports_sparse_files:false
d323 1
a323 2
  needs_memory_protection:true,
  supports_sparse_files:false
d362 1
a362 2
  needs_memory_protection:true,
  supports_sparse_files:false
d401 1
a401 2
  needs_memory_protection:true,
  supports_sparse_files:true
d440 1
a440 2
  needs_memory_protection:true,
  supports_sparse_files:true
@


1.18
log
@* shared.cc (open_shared): Revert to "old" method for shared memory location if
!wincap.needs_memory_protection.
* wincap.cc: Implement needs_memory_protection throughout.
* wincap.h: Ditto.
@
text
@d50 2
a51 1
  needs_memory_protection:false
d90 2
a91 1
  needs_memory_protection:false
d130 2
a131 1
  needs_memory_protection:false
d170 2
a171 1
  needs_memory_protection:false
d210 2
a211 1
  needs_memory_protection:false
d250 2
a251 1
  needs_memory_protection:false
d290 2
a291 1
  needs_memory_protection:true
d330 2
a331 1
  needs_memory_protection:true
d370 2
a371 1
  needs_memory_protection:true
d410 2
a411 1
  needs_memory_protection:true
d450 2
a451 1
  needs_memory_protection:true
@


1.18.12.1
log
@merge from trunk
@
text
@d50 1
a50 2
  needs_memory_protection:false,
  pty_needs_alloc_console:false
d89 1
a89 2
  needs_memory_protection:false,
  pty_needs_alloc_console:false
d128 1
a128 2
  needs_memory_protection:false,
  pty_needs_alloc_console:false
d167 1
a167 2
  needs_memory_protection:false,
  pty_needs_alloc_console:false
d206 1
a206 2
  needs_memory_protection:false,
  pty_needs_alloc_console:false
d245 1
a245 2
  needs_memory_protection:false,
  pty_needs_alloc_console:false
d284 1
a284 2
  needs_memory_protection:true,
  pty_needs_alloc_console:true
d323 1
a323 2
  needs_memory_protection:true,
  pty_needs_alloc_console:true
d362 1
a362 2
  needs_memory_protection:true,
  pty_needs_alloc_console:true
d401 1
a401 2
  needs_memory_protection:true,
  pty_needs_alloc_console:true
d440 1
a440 2
  needs_memory_protection:true,
  pty_needs_alloc_console:true
@


1.18.12.2
log
@merge from trunk
@
text
@d51 1
a51 2
  pty_needs_alloc_console:false,
  has_terminal_services:false
d91 1
a91 2
  pty_needs_alloc_console:false,
  has_terminal_services:false
d131 1
a131 2
  pty_needs_alloc_console:false,
  has_terminal_services:false
d171 1
a171 2
  pty_needs_alloc_console:false,
  has_terminal_services:false
d211 1
a211 2
  pty_needs_alloc_console:false,
  has_terminal_services:false
d251 1
a251 2
  pty_needs_alloc_console:false,
  has_terminal_services:false
d291 1
a291 2
  pty_needs_alloc_console:true,
  has_terminal_services:false
d331 1
a331 2
  pty_needs_alloc_console:true,
  has_terminal_services:false
d371 1
a371 2
  pty_needs_alloc_console:true,
  has_terminal_services:false
d411 1
a411 2
  pty_needs_alloc_console:true,
  has_terminal_services:true
d451 1
a451 43
  pty_needs_alloc_console:true,
  has_terminal_services:true
};

static NO_COPY wincaps wincap_2003 = {
  lock_file_highword:0xffffffff,
  chunksize:0,
  shared:FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
  is_winnt:true,
  access_denied_on_delete:false,
  has_delete_on_close:true,
  has_page_guard:true,
  has_security:true,
  has_security_descriptor_control:true,
  has_get_process_times:true,
  has_lseek_bug:false,
  has_lock_file_ex:true,
  has_signal_object_and_wait:true,
  has_eventlog:true,
  has_ip_helper_lib:true,
  has_set_handle_information:true,
  has_set_handle_information_on_console_handles:true,
  supports_smp:true,
  map_view_of_file_ex_sucks:false,
  altgr_is_ctrl_alt:true,
  has_physical_mem_access:true,
  has_working_copy_on_write:true,
  share_mmaps_only_by_name:false,
  virtual_protect_works_on_shared_pages:true,
  has_hard_links:true,
  can_open_directories:true,
  has_move_file_ex:true,
  has_negative_pids:false,
  has_unreliable_pipes:false,
  has_try_enter_critical_section:true,
  has_raw_devices:true,
  has_valid_processorlevel:true,
  has_64bit_file_access:true,
  has_process_io_counters:true,
  supports_reading_modem_output_lines:true,
  needs_memory_protection:true,
  pty_needs_alloc_console:true,
  has_terminal_services:true
d486 4
a489 13
	      switch (version.dwMinorVersion)
	        {
		  case 0:
		    caps = &wincap_2000;
		    break;
		  
		  case 1:
		    caps = &wincap_xp;
		    break;

		  default:
		    caps = &wincap_2003;
		}
@


1.18.12.3
log
@merge from trunk
@
text
@d543 1
a543 1

@


1.18.12.4
log
@merge from trunk
@
text
@d52 1
a52 2
  has_terminal_services:false,
  has_switch_to_thread:false
d93 1
a93 2
  has_terminal_services:false,
  has_switch_to_thread:false
d134 1
a134 2
  has_terminal_services:false,
  has_switch_to_thread:false
d175 1
a175 2
  has_terminal_services:false,
  has_switch_to_thread:false
d216 1
a216 2
  has_terminal_services:false,
  has_switch_to_thread:false
d257 1
a257 2
  has_terminal_services:false,
  has_switch_to_thread:false
d298 1
a298 2
  has_terminal_services:false,
  has_switch_to_thread:false
d339 1
a339 2
  has_terminal_services:false,
  has_switch_to_thread:true
d380 1
a380 2
  has_terminal_services:false,
  has_switch_to_thread:true
d421 1
a421 2
  has_terminal_services:true,
  has_switch_to_thread:true
d462 1
a462 2
  has_terminal_services:true,
  has_switch_to_thread:true
d503 1
a503 2
  has_terminal_services:true,
  has_switch_to_thread:true
@


1.17
log
@* fhandler.cc (fhandler_base::dup): Don't set handle on failure.  Caller has
already taken care of that.
* fhandler_console.cc (fhandler_console::open): Initialize handles to NULL.
(fhandler_console::close): Ditto.  GNUify non-GNU formatted functions calls
throughout.
@
text
@d50 1
d89 1
d128 1
d167 1
d206 1
d245 1
d284 1
d323 1
d362 1
d401 1
d440 1
@


1.16
log
@	* fhandler_serial.cc: Change 'must_init_serial_line capability'
	to 'supports_reading_modem_output_lines' throughout (negated meaning).
	* wincap.cc: Ditto.
	* wincap.h: Ditto.
@
text
@d480 1
a480 1
	      if (strchr(version.szCSDVersion, 'C'))
d487 1
a487 1
	      if (strchr(version.szCSDVersion, 'A'))
@


1.15
log
@	* fhandler_serial.cc: Use must_init_serial_line capability throughout.
	* wincap.cc: Set flag must_init_serial_line appropriately.
	* wincap.h: Add flag must_init_serial_line.
@
text
@d49 1
a49 1
  must_init_serial_line:true,
d87 1
a87 1
  must_init_serial_line:true,
d125 1
a125 1
  must_init_serial_line:true,
d163 1
a163 1
  must_init_serial_line:true,
d201 1
a201 1
  must_init_serial_line:true,
d239 1
a239 1
  must_init_serial_line:true,
d277 1
a277 1
  must_init_serial_line:false,
d315 1
a315 1
  must_init_serial_line:false,
d353 1
a353 1
  must_init_serial_line:false,
d391 1
a391 1
  must_init_serial_line:false,
d429 1
a429 1
  must_init_serial_line:false,
@


1.14
log
@* dcrt0.cc (dll_crt0_1): Initialize wincap and check for sanity before running
global ctors.
* wincap.h (wincap): Eliminate constructor.  Default is to zero memory, anyway.
* wincap.cc (wincap): Copy this on fork to avoid initialization in forked
processes.
@
text
@d49 1
d87 1
d125 1
d163 1
d201 1
d239 1
d277 1
d315 1
d353 1
d391 1
d429 1
@


1.13
log
@* dtable.cc (handle_to_fn): Attempt to handle "raw" accesses to remote shares.
* path.cc (mount_info::conv_to_win32_path): Set flags to binary when mount
entry is not found.
(mount_info::set_flags_from_win32_path): Ditto.
@
text
@d421 1
a421 1
wincapc NO_COPY wincap;
@


1.12
log
@	* times.cc (utimes): Use FILE_WRITE_ATTRIBUTES even on 9x/Me when
	opening file for writing timestamp.
	* wincap.cc: Remove flag has_specific_access_rights.
	* wincap.h: Ditto.
@
text
@d4 1
a4 1
   Copyright 2001 Red Hat, Inc.
@


1.11
log
@* autoload.cc: Add dynamic load statements for 'ZwQueryInformationProcess' and
'ZwQueryVirtualMemory'.
* fhandler.h: Change type of bufalloc and filesize members of fhandler_virtual
from int to size_t.  Change type of position member from __off32_t to
__off64_t.  Add new fileid member to fhandler_virtual class.  Make seekdir take
an __off64_t argument.  Make lseek take an __off64_t argument.  Add
fill_filebuf method to fhandler_virtual.  Add fill_filebuf method to
fhandler_proc.  Add fill_filebuf method to fhandler_registry.  Add fill_filebuf
method to fhandler_process.  Add saved_pid and saved_p members to
fhandler_process.
* fhandler_proc.cc (proc_listing_array): Add 'loadavg', 'meminfo', and 'stat'.
(proc_fhandlers array): Ditto.
(fhandler_proc::open): Use fill_filebuf to flesh out the file contents.
(fhandler_proc::fill_filebuf): New method.
(fhandler_proc::format_proc_meminfo): Ditto.
(fhandler_proc::format_proc_stat): Ditto.
(fhandler_proc::format_proc_uptime): Ditto.
* fhandler_process.cc (process_listing): Add 'stat' and 'statm'.
(fhandler_process::fstat): Find the _pinfo structure for the process named in
the filename.  Return ENOENT if the process is no longer around.  Set the gid
and uid fields of the stat structure.
(fhandler_process::open): Store pid and pointer to _pinfo structure in
saved_pid and saved_p respectively.  Use fill_filebuf to flesh out file
contents.
(fhandler_proc::fill_filebuf): New method.
(format_process_stat): New function.
(format_process_status): Ditto.
(format_process_statm): Ditto.
(get_process_state): Ditto.
(get_mem_values): Ditto.
* fhandler_registry.cc (fhandler_registry::seekdir): Change argument type from
__off32_t to __off64_t.
(fhandler_registry::fill_filebuf): New method.
* fhandler_virtual.cc (fhandler_virtual::seekdir): Change argument type from
__off32_t to __off64_t.
(fhandler_virtual::lseek): Ditto.
(fhandler_virtual::fill_filebuf): New method.
(fhandler_virtual::fhandler_virtual): Initialise fileid to -1.
* wincap.cc: Set flag has_process_io_counters appropriately.
* wincap.h: Add flag has_process_io_counters.
@
text
@a24 1
  has_specific_access_rights:false,
a61 1
  has_specific_access_rights:false,
a98 1
  has_specific_access_rights:false,
a135 1
  has_specific_access_rights:false,
a172 1
  has_specific_access_rights:false,
a209 1
  has_specific_access_rights:false,
a246 1
  has_specific_access_rights:true,
a283 1
  has_specific_access_rights:true,
a320 1
  has_specific_access_rights:true,
a357 1
  has_specific_access_rights:true,
a394 1
  has_specific_access_rights:true,
@


1.10
log
@	* cygwin.din (fstat64): New symbol.
	(ftruncate64): Ditto.
	(lseek64): Ditto.
	(lstat64): Ditto.
	(mmap64): Ditto.
	(seekdir64): Ditto.
	(stat64): Ditto.
	(telldir64): Ditto.
	(truncate64): Ditto.
	* dir.cc (telldir64): New function.
	(telldir): Call telldir64().
	(seekdir64): New function.
	(seekdir): Call seekdir64().
	* fhandler.h: Redefine all methods using __off32_t to use __off64_t.
	* fhandler.cc: Use __off64_t and struct __stat64 throughout.
	* fhandler_clipboard.cc: Ditto.
	* fhandler_disk_file.cc: Ditto.
	* fhandler_dsp.cc: Ditto.
	* fhandler_floppy.cc: Ditto.
	* fhandler_mem.cc: Ditto.
	* fhandler_random.cc: Ditto.
	* fhandler_socket.cc: Ditto.
	* fhandler_tape.cc: Ditto.
	* fhandler_zero.cc: Ditto.
	* pipe.cc: Ditto.
	* glob.c: Ditto, call lstat64 and stat64 in Cygwin.
	* mmap.cc: Use __off64_t throughout.
	(mmap64): New function.
	* sec_acl.cc (acl_worker): Use struct __stat64, call stat64 and lstat64.
	* syscalls.cc (lseek64): New function.
	(stat64_to_stat32): Ditto.
	(fstat64): Ditto.
	(stat64): Ditto.
	(lstat64): Ditto.
	(ftruncate64): Ditto.
	(truncate64): Ditto.
	(_fstat): Call fstat64.
	(_stat): Call stat64.
	(cygwin_lstat): Rename to avoid declaration problem.  Call lstat64.
	(stat_worker): Use struct __stat64.
	(access): Ditto.
	(ftruncate): Call ftruncate64.
	(truncate): Call truncate64.
	* wincap.cc: Set flag has_64bit_file_access appropriately.
	* wincap.h: Add flag has_64bit_file_access.
	* winsup.h (ILLEGAL_SEEK): Define as __off64_t.
	(stat_dev): Declare using struct __stat64.
	(stat_worker): Ditto.
	* include/cygwin/stat.h (struct __stat32): Define if compiling Cygwin.
	(struct __stat64): Ditto.
	(struct stat): Revert definition with explicitly sized datatypes.
	Eliminate sized field names.
	* include/cygwin/types.h (blksize_t): New type.
	(__blkcnt32_t): Ditto.
	(__blkcnt64_t): Ditto.
	(blkcnt_t): Ditto.
@
text
@d49 1
d87 1
d125 1
d163 1
d201 1
d239 1
d277 1
d315 1
d353 1
d391 1
d429 1
@


1.9
log
@* external.cc (cygwin_internal): Initialize various internal settings if
required to allow use of some things from user loaded DLL.
(CW_STRACE_ON): Add new feature.
(CW_CYGWIN_PID_TO_WINPID): Ditto.
* pinfo.cc (set_myself): Call "strace.hello" to initiate possible strace
session.
(pinfo::init): Guard against dereferencing uninitialized myself.
* sigproc.cc (wait_sig): Call strace.hello() when __SIGTRACE "signal" received.
* strace.cc (strace::hello): New method.
* wincap.cc (wincapc::init): Avoid initializing if already initialized.
* wincap.h (wincapc::wincapc): New method.
* include/sys/cygwin.h: Add new CW_ enums.  Kludge typedefs of {g,u}id_t if
required.
* strace.h (strace::hello): Declare new method.
@
text
@d48 1
d85 1
d122 1
d159 1
d196 1
d233 1
d270 1
d307 1
d344 1
d381 1
d418 1
@


1.8
log
@Eliminate excess whitespace.
@
text
@d417 3
@


1.7
log
@	* autoload.cc: Add load statement for `NtOpenFile'.
	* fhandler.h (fhandler_dev_raw::get_unit): New method.
	(fhandler_dev_tape::norewind): Eliminate.
	(fhandler_dev_tape::is_rewind_device): New method.
	* fhandler_raw.cc (fhandler_dev_raw::open): Open new
	fixed device name devices using NT internal method.
	Keep calling fhandler_base::open() for old mount table
	device mapping compatibility devices.
	(fhandler_dev_raw::fstat): Eliminate.  Settings are done
	by fhandler_base::fstat() already.
	* fhandler_tape.cc: Remove `norewind' usage throughout.
	* ntdll.h: Define FILE_SYNCHRONOUS_IO_NONALERT.
	Define struct _IO_STATUS_BLOCK.
	Declare NtOpenFile().
	* path.cc (get_raw_device_number): Add new approach for
	using fixed device names.
	(win32_device_name): Ditto.
	(get_device_number): Ditto.  Require POSIX path to begin
	with "/dev/".
	(mount_info::conv_to_win32_path): Call win32_device_name()
	instead of get_device_number() after evaluating mount points
	to allow changing the win32 destination path again.
	* security.cc (str2buf2uni): Remove `static' to be able to
	call function from fhandler_dev_raw::open().
	* wincap.cc: Set flag has_raw_devices appropriately.
	* wincap.h: Add flag has_raw_devices.
@
text
@d433 1
a433 1
	        caps = &wincap_nt4;
d435 1
a435 1
	        caps = &wincap_nt4sp4;
d449 1
a449 1
        break;
d463 1
a463 1
	        caps = &wincap_98se;
d465 1
a465 1
	        caps = &wincap_98;
d476 1
a476 1
        break;
d478 1
a478 1
        os = "??";
@


1.6
log
@        * uname.cc (uname):  Use `wProcessorLevel' unless OS sets it wrong.
        Use `dwProcessorType' then instead.
        * wincap.cc: Set flag has_valid_processorlevel appropriately.
        * wincap.h: Add flag has_valid_processorlevel.
@
text
@d46 1
d82 1
d118 1
d154 1
d190 1
d226 1
d262 1
d298 1
d334 1
d370 1
d406 1
@


1.5
log
@        * fhandler.cc (fhandler_base::set_inheritance): If available,
        use SetHandleInformation() to set inheritance.
        * wincap.cc: Set flag has_set_handle_information_on_console_handles
        appropriately.
        * wincap.h: Add flag has_set_handle_information_on_console_handles.
@
text
@d46 1
d81 1
d116 1
d151 1
d186 1
d221 1
d256 1
d291 1
d326 1
d361 1
d396 1
@


1.5.2.1
log
@Merged changes from HEAD
@
text
@a45 2
  has_raw_devices:false,
  has_valid_processorlevel:false,
a79 2
  has_raw_devices:false,
  has_valid_processorlevel:false,
a113 2
  has_raw_devices:false,
  has_valid_processorlevel:false,
a147 2
  has_raw_devices:false,
  has_valid_processorlevel:true,
a181 2
  has_raw_devices:false,
  has_valid_processorlevel:true,
a215 2
  has_raw_devices:false,
  has_valid_processorlevel:true,
a249 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
a283 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
a317 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
a351 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
a385 2
  has_raw_devices:true,
  has_valid_processorlevel:true,
d411 1
a411 1
		caps = &wincap_nt4;
d413 1
a413 1
		caps = &wincap_nt4sp4;
d427 1
a427 1
	break;
d441 1
a441 1
		caps = &wincap_98se;
d443 1
a443 1
		caps = &wincap_98;
d454 1
a454 1
	break;
d456 1
a456 1
	os = "??";
@


1.5.2.2
log
@Merged changes from HEAD
@
text
@a47 1
  has_64bit_file_access:false,
a83 1
  has_64bit_file_access:false,
a119 1
  has_64bit_file_access:false,
a155 1
  has_64bit_file_access:false,
a191 1
  has_64bit_file_access:false,
a227 1
  has_64bit_file_access:false,
a263 1
  has_64bit_file_access:true,
a299 1
  has_64bit_file_access:true,
a335 1
  has_64bit_file_access:true,
a371 1
  has_64bit_file_access:true,
a407 1
  has_64bit_file_access:true,
a415 3

  if (caps)
    return;		// already initialized
@


1.5.2.3
log
@Merged changes from HEAD
@
text
@d4 1
a4 1
   Copyright 2001, 2002 Red Hat, Inc.
d25 1
a48 1
  has_process_io_counters:false,
d62 1
a85 1
  has_process_io_counters:false,
d99 1
a122 1
  has_process_io_counters:false,
d136 1
a159 1
  has_process_io_counters:false,
d173 1
a196 1
  has_process_io_counters:false,
d210 1
a233 1
  has_process_io_counters:false,
d247 1
a270 1
  has_process_io_counters:false,
d284 1
a307 1
  has_process_io_counters:false,
d321 1
a344 1
  has_process_io_counters:false,
d358 1
a381 1
  has_process_io_counters:true,
d395 1
a418 1
  has_process_io_counters:true,
d421 1
a421 1
wincapc wincap;
@


1.5.2.4
log
@Merged changes from HEAD
@
text
@a48 1
  supports_reading_modem_output_lines:false,
a85 1
  supports_reading_modem_output_lines:false,
a122 1
  supports_reading_modem_output_lines:false,
a159 1
  supports_reading_modem_output_lines:false,
a196 1
  supports_reading_modem_output_lines:false,
a233 1
  supports_reading_modem_output_lines:false,
a270 1
  supports_reading_modem_output_lines:true,
a307 1
  supports_reading_modem_output_lines:true,
a344 1
  supports_reading_modem_output_lines:true,
a381 1
  supports_reading_modem_output_lines:true,
a418 1
  supports_reading_modem_output_lines:true,
@


1.5.2.5
log
@Merged changes from HEAD
@
text
@d480 1
a480 1
	      if (strchr (version.szCSDVersion, 'C'))
d487 1
a487 1
	      if (strchr (version.szCSDVersion, 'A'))
@


1.4
log
@* fhandler.h (fhandler_pipe::is_slow): Return true only if pipes are reliable
(i.e., not Win9x).
* wincap.cc: Make statics NO_COPY to avoid fork overhead.
@
text
@d32 1
d66 1
d100 1
d134 1
d168 1
d202 1
d236 1
d270 1
d304 1
d338 1
d372 1
@


1.3
log
@        * wincap.cc (wincapc::init): Simplify W2K/XP case.
@
text
@d14 1
a14 1
static wincaps wincap_unknown = {
d47 1
a47 1
static wincaps wincap_95 = {
d80 1
a80 1
static wincaps wincap_95osr2 = {
d113 1
a113 1
static wincaps wincap_98 = {
d146 1
a146 1
static wincaps wincap_98se = {
d179 1
a179 1
static wincaps wincap_me = {
d212 1
a212 1
static wincaps wincap_nt3 = {
d245 1
a245 1
static wincaps wincap_nt4 = {
d278 1
a278 1
static wincaps wincap_nt4sp4 = {
d311 1
a311 1
static wincaps wincap_2000 = {
d344 1
a344 1
static wincaps wincap_xp = {
@


1.2
log
@        * wincap.cc (wincapc::init): Set os name to "NT" on XP, too.
@
text
@d405 1
d407 1
a407 4
	        {
		  os = "NT";
		  caps = &wincap_2000;
		}
d409 1
a409 4
	        {
		  os = "NT";
		  caps = &wincap_xp;
		}
@


1.1
log
@        * Makefile.in: Build wincap.o.
        * wincap.cc: New file.
        * wincap.h: Ditto.
        * autoload.cc: Add dynamic load statement for `CreateHardLinkA'.
        * dcrt0.cc (os_being_run): Eliminated.
        (osname): Ditto.
        (iswinnt): Ditto.
        (set_os_type): Ditto.
        (dll_crt0_1): Call wincap.init() instead of set_os_type().
        (_dll_crt0): Ditto.
        * environ.cc (set_chunksize): New function.
        (parse_thing): `forkchunk' setting now invokes function `set_chunksize'.
        * fork.cc (chunksize): Eliminated. Moved to be member of wincap.
        * host_dependent.h: Removed.
        * syscalls.cc (_link): Try using `CreateHardLinkA' first, if available.
        * cygheap.cc, dcrt0.cc, delqueue.cc, dir.cc,
        environ.cc, fhandler.cc, fhandler.h, fhandler_console.cc,
        fhandler_mem.cc, fork.cc, mmap.cc, net.cc, pinfo.cc, pinfo.h,
        security.cc, syscalls.cc, sysconf.cc, syslog.cc, thread.cc,
        times.cc, tty.cc, uinfo.cc, uname.cc, winsup.h: Use new wincap
        capability check throughout.
        * winsup.h: Include wincap.h. Eliminate extern declarations of
        `os_being_run' and `iswinnt'. Eliminate `os_type" definition.
        * include/cygwin/version.h: Bump version to 1.3.4.
@
text
@d412 1
a412 1
		  os = "XP";
@

