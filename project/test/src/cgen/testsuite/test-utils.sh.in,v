head	1.3;
access;
symbols
	sid-snapshot-20180601:1.3
	cgen-snapshot-20180601:1.3
	sid-snapshot-20180501:1.3
	cgen-snapshot-20180501:1.3
	sid-snapshot-20180401:1.3
	cgen-snapshot-20180401:1.3
	sid-snapshot-20180301:1.3
	cgen-snapshot-20180301:1.3
	sid-snapshot-20180201:1.3
	cgen-snapshot-20180201:1.3
	sid-snapshot-20180101:1.3
	cgen-snapshot-20180101:1.3
	sid-snapshot-20171201:1.3
	cgen-snapshot-20171201:1.3
	sid-snapshot-20171101:1.3
	cgen-snapshot-20171101:1.3
	sid-snapshot-20171001:1.3
	cgen-snapshot-20171001:1.3
	sid-snapshot-20170901:1.3
	cgen-snapshot-20170901:1.3
	sid-snapshot-20170801:1.3
	cgen-snapshot-20170801:1.3
	sid-snapshot-20170701:1.3
	cgen-snapshot-20170701:1.3
	sid-snapshot-20170601:1.3
	cgen-snapshot-20170601:1.3
	sid-snapshot-20170501:1.3
	cgen-snapshot-20170501:1.3
	sid-snapshot-20170401:1.3
	cgen-snapshot-20170401:1.3
	sid-snapshot-20170301:1.3
	cgen-snapshot-20170301:1.3
	sid-snapshot-20170201:1.3
	cgen-snapshot-20170201:1.3
	sid-snapshot-20170101:1.3
	cgen-snapshot-20170101:1.3
	sid-snapshot-20161201:1.3
	cgen-snapshot-20161201:1.3
	sid-snapshot-20161101:1.3
	cgen-snapshot-20161101:1.3
	sid-snapshot-20160901:1.3
	cgen-snapshot-20160901:1.3
	sid-snapshot-20160801:1.3
	cgen-snapshot-20160801:1.3
	sid-snapshot-20160701:1.3
	cgen-snapshot-20160701:1.3
	sid-snapshot-20160601:1.3
	cgen-snapshot-20160601:1.3
	sid-snapshot-20160501:1.3
	cgen-snapshot-20160501:1.3
	sid-snapshot-20160401:1.3
	cgen-snapshot-20160401:1.3
	sid-snapshot-20160301:1.3
	cgen-snapshot-20160301:1.3
	sid-snapshot-20160201:1.3
	cgen-snapshot-20160201:1.3
	sid-snapshot-20160101:1.3
	cgen-snapshot-20160101:1.3
	sid-snapshot-20151201:1.3
	cgen-snapshot-20151201:1.3
	sid-snapshot-20151101:1.3
	cgen-snapshot-20151101:1.3
	sid-snapshot-20151001:1.3
	cgen-snapshot-20151001:1.3
	sid-snapshot-20150901:1.3
	cgen-snapshot-20150901:1.3
	sid-snapshot-20150801:1.3
	cgen-snapshot-20150801:1.3
	sid-snapshot-20150701:1.3
	cgen-snapshot-20150701:1.3
	sid-snapshot-20150601:1.3
	cgen-snapshot-20150601:1.3
	sid-snapshot-20150501:1.3
	cgen-snapshot-20150501:1.3
	sid-snapshot-20150401:1.3
	cgen-snapshot-20150401:1.3
	sid-snapshot-20150301:1.3
	cgen-snapshot-20150301:1.3
	sid-snapshot-20150201:1.3
	cgen-snapshot-20150201:1.3
	sid-snapshot-20150101:1.3
	cgen-snapshot-20150101:1.3
	sid-snapshot-20141201:1.3
	cgen-snapshot-20141201:1.3
	sid-snapshot-20141101:1.3
	cgen-snapshot-20141101:1.3
	sid-snapshot-20141001:1.3
	cgen-snapshot-20141001:1.3
	sid-snapshot-20140901:1.3
	cgen-snapshot-20140901:1.3
	sid-snapshot-20140801:1.3
	cgen-snapshot-20140801:1.3
	sid-snapshot-20140701:1.3
	cgen-snapshot-20140701:1.3
	sid-snapshot-20140601:1.3
	cgen-snapshot-20140601:1.3
	sid-snapshot-20140501:1.3
	cgen-snapshot-20140501:1.3
	sid-snapshot-20140401:1.3
	cgen-snapshot-20140401:1.3
	sid-snapshot-20140301:1.3
	cgen-snapshot-20140301:1.3
	sid-snapshot-20140201:1.3
	cgen-snapshot-20140201:1.3
	sid-snapshot-20140101:1.3
	cgen-snapshot-20140101:1.3
	sid-snapshot-20131201:1.3
	cgen-snapshot-20131201:1.3
	sid-snapshot-20131101:1.3
	cgen-snapshot-20131101:1.3
	sid-snapshot-20131001:1.3
	cgen-snapshot-20131001:1.3
	sid-snapshot-20130901:1.3
	cgen-snapshot-20130901:1.3
	sid-snapshot-20130801:1.3
	cgen-snapshot-20130801:1.3
	sid-snapshot-20130701:1.3
	cgen-snapshot-20130701:1.3
	sid-snapshot-20130601:1.3
	cgen-snapshot-20130601:1.3
	sid-snapshot-20130501:1.3
	cgen-snapshot-20130501:1.3
	sid-snapshot-20130401:1.3
	cgen-snapshot-20130401:1.3
	sid-snapshot-20130301:1.3
	cgen-snapshot-20130301:1.3
	sid-snapshot-20130201:1.3
	cgen-snapshot-20130201:1.3
	sid-snapshot-20130101:1.3
	cgen-snapshot-20130101:1.3
	sid-snapshot-20121201:1.3
	cgen-snapshot-20121201:1.3
	sid-snapshot-20121101:1.3
	cgen-snapshot-20121101:1.3
	sid-snapshot-20121001:1.3
	cgen-snapshot-20121001:1.3
	sid-snapshot-20120901:1.3
	cgen-snapshot-20120901:1.3
	sid-snapshot-20120801:1.3
	cgen-snapshot-20120801:1.3
	sid-snapshot-20120701:1.3
	cgen-snapshot-20120701:1.3
	sid-snapshot-20120601:1.3
	cgen-snapshot-20120601:1.3
	sid-snapshot-20120501:1.3
	cgen-snapshot-20120501:1.3
	sid-snapshot-20120401:1.3
	cgen-snapshot-20120401:1.3
	sid-snapshot-20120301:1.3
	cgen-snapshot-20120301:1.3
	sid-snapshot-20120201:1.3
	cgen-snapshot-20120201:1.3
	sid-snapshot-20120101:1.3
	cgen-snapshot-20120101:1.3
	sid-snapshot-20111201:1.3
	cgen-snapshot-20111201:1.3
	sid-snapshot-20111101:1.3
	cgen-snapshot-20111101:1.3
	sid-snapshot-20111001:1.3
	cgen-snapshot-20111001:1.3
	sid-snapshot-20110901:1.3
	cgen-snapshot-20110901:1.3
	sid-snapshot-20110801:1.3
	cgen-snapshot-20110801:1.3
	sid-snapshot-20110701:1.3
	cgen-snapshot-20110701:1.3
	sid-snapshot-20110601:1.3
	cgen-snapshot-20110601:1.3
	sid-snapshot-20110501:1.3
	cgen-snapshot-20110501:1.3
	sid-snapshot-20110401:1.3
	cgen-snapshot-20110401:1.3
	sid-snapshot-20110301:1.3
	cgen-snapshot-20110301:1.3
	sid-snapshot-20110201:1.3
	cgen-snapshot-20110201:1.3
	sid-snapshot-20110101:1.3
	cgen-snapshot-20110101:1.3
	sid-snapshot-20101201:1.3
	cgen-snapshot-20101201:1.3
	sid-snapshot-20101101:1.3
	cgen-snapshot-20101101:1.3
	sid-snapshot-20101001:1.3
	cgen-snapshot-20101001:1.3
	sid-snapshot-20100901:1.3
	cgen-snapshot-20100901:1.3
	sid-snapshot-20100801:1.3
	cgen-snapshot-20100801:1.3
	sid-snapshot-20100701:1.3
	cgen-snapshot-20100701:1.3
	sid-snapshot-20100601:1.3
	cgen-snapshot-20100601:1.3
	sid-snapshot-20100501:1.3
	cgen-snapshot-20100501:1.3
	sid-snapshot-20100401:1.3
	cgen-snapshot-20100401:1.3
	sid-snapshot-20100301:1.3
	cgen-snapshot-20100301:1.3
	sid-snapshot-20100201:1.3
	cgen-snapshot-20100201:1.3
	sid-snapshot-20100101:1.3
	cgen-snapshot-20100101:1.3
	sid-snapshot-20091201:1.3
	cgen-snapshot-20091201:1.3
	sid-snapshot-20091101:1.3
	cgen-snapshot-20091101:1.3
	sid-snapshot-20091001:1.3
	cgen-snapshot-20091001:1.3
	sid-snapshot-20090901:1.3
	cgen-snapshot-20090901:1.3
	sid-snapshot-20090801:1.1
	cgen-snapshot-20090801:1.1
	dje-cgen-play1-branch:1.1.0.2;
locks; strict;
comment	@# @;


1.3
date	2009.08.18.01.40.57;	author devans;	state Exp;
branches;
next	1.2;

1.2
date	2009.08.06.16.40.44;	author devans;	state Exp;
branches;
next	1.1;

1.1
date	2009.07.13.20.55.21;	author devans;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2009.07.14.16.08.51;	author devans;	state Exp;
branches;
next	;


desc
@@


1.3
log
@	* pmacros.scm (-pmacro-builtin-internal-test): New function.
	(pmacros-init!): Add .internal-test.
	* testsuite/test-utils.sh.in (post_process): Tweak FAIL output.
	* testsuite/testsuite.cpu (internal-verify): New pmacro.
	* doc/pmacros.text: Document .internal-test.

	* utils-cgen.scm (parse-name): Handle (add 3) -> add3.
	(parse-comment): Allow numbers.
	* doc/porting.texi: Document that names and comments may be lists.

	* insn.scm (-insn-parse): Fix typo.
@
text
@# Define various parameters for use in test runs.
# Requires $test to be defined before sourcing.

if [ "${test}" == "" ]
then
    echo "\$test not defined" >&2
    exit 1
fi

if [ "${test}" != "driver" ]
then
    echo "Running ${test} ..."
fi

srcdir=@@srcdir@@

cgendir=${srcdir}/..

GUILE=`if test -f ../../guile/libguile/guile ; then echo ../../guile/libguile/guile; else echo guile ; fi`
GUILEFLAGS="-l ${cgendir}/guile.scm -s"

CGENFLAGS=

cgen_output_file=${test}.cgen.out
test_output_file=${test}.test.out
rm -f ${cgen_output_file} ${test_output_file}

tmp_match=match-${test}.tmp
tmp_expr=expr-${test}.tmp
rm -f ${tmp_match} ${tmp_expr}

exit_code=0

# Invoke this to run cgen.
# Usage: run_cgen [-f] cpu-file-path
# -f: cgen is expected to fail (useful for testing error handling)

run_cgen() {
    expect_fail=false
    [ "$1" == "-f" ] && { expect_fail=true ; shift ; }

    [ $# -ne 1 ] && { echo "missing cpu_file" >&2 ; exit 1 ; }
    cpu_file=$1

    if ${GUILE} ${GUILEFLAGS} ${cgendir}/cgen-testsuite.scm \
	-s ${cgendir} \
	-b ${CGENFLAGS} \
	-a ${cpu_file} \
	-T ${cgen_output_file} >& ${test_output_file}
    then
	${expect_fail} && { fail "${test} run of cgen expected to fail" ; }
    else
	${expect_fail} || { fail "${test} run of cgen" ; }
    fi
}

post_process() {
    file=${test_output_file}

    if grep -q FAIL $file
    then
	fail "In test output:"
	grep FAIL $file
    fi

    grep "^MATCH: " $file | sed -e 's/^MATCH://' > ${tmp_match}
    grep "^EXPR: " $file | sed -e 's/^EXPR://' > ${tmp_expr}

    if ! cmp -s ${tmp_match} ${tmp_expr}
    then
	fail "Differences from expected output:"
	diff ${tmp_match} ${tmp_expr}
    fi
}

fail() {
    echo "FAIL: $*"
    exit_code=1
}

finish() {
    exit ${exit_code}
}
@


1.2
log
@	Track source location better, for better error messages.
	* pmacros.scm (-pmacro-eval): Delete, unused.
	(pmacro-expand, -pmacro-expand): New arg `loc', all callers updated.
	(-pmacro-expand-expr-list, -smacro-apply): Ditto.
	(scan-list, scan): Ditto.
	(-pmacro-builtin-pmacro, -pmacro-builtin-let, -pmacro-builtin-if,
	-pmacro-builtin-case, -pmacro-builtin-cond, -pmacro-builtin-begin,
	-pmacro-builtin-andif, -pmacro-builtin-orif): Ditto.
	(scan-list1): New function.
	(-pmacro-build-lambda): New arg `loc', all callers updated.  Rewrite.
	* read.scm (<reader>): New member `location'.
	(-reader-lookup-command): Renamed from reader-lookup-command,
	all callers updated.
	(reader-error): Rewrite to produce better source location info.
	(current-reader-location): New function.
	(-reader-process-expanded-1!): Renamed from -reader-process-expanded-1.
	All callers updated.  Record source location of expression.
	(reader-process-expanded!): Renamed from reader-process-expanded.
	All callers updated.
	(-reader-process!): Renamed from reader-process.  New arg `loc'.
	All callers updated.  Record source location of define-pmacro.
	* utils-cgen.scm (<location>): New class.
	(single-location): New (pseudo) class.
	(pretty-print-single-location, pretty-print-location): New functions.
	(location-top, location-push-single, location-push): New functions.
	(unspecified-location, current-input-location): New functions.
	(location-property): New object property.
	(location-property-set!): New function.
	(<source-ident>): Renamed from <ordered-ident>.  New member `location'.
	All uses updated.
	* testsuite/location-1.test: New testcase.
	* testsuite/run-tests.sh: Fix fail count handling.
	* testsuite/test-utils.sh.in (run_cgen): New option `-f'.  Allow tests
	to expect cgen to fail.

	* pmacros.scm (*): Use "pmacro" instead of "macro" more consistently.

	* read.scm (-cmd-include): Renamed from include.  All callers updated.
	(-cmd-if): Renamed from cmd-if.  All callers updated.
	Use reader-process-expanded! on then/else clauses instead of eval1.
@
text
@d62 1
a62 1
	fail "FAIL found in test output:"
@


1.1
log
@	Extend pmacro language, add testsuite.
	* Makefile.am (SUBDIRS): Add testsuite.
	* Makefile.in: Regenerate.
	* configure.in (AC_OUTPUT): Create testsuite/Makefile,
	testsuite/test-utils.sh.
	* configure: Regenerate.
	* dev.scm (cload): Handle testsuite app.
	(load-testsuite): New function.
	* pmacros.scm: (-pmacro-debug?): New global.
	(-smacro-table): New global.
	(-smacro-lookup, -smacro-set!): New functions.
	(-pmacro-make): New argument `syntactic-form?', all callers updated.
	(-pmacro-syntactic-form?): New function.
	(-pmacro-expected-number, -pmacro-verify-number): New functions.
	(-pmacro-expected-integer, -pmacro-verify-integer): New functions.
	(-pmacro-expected-non-negative-integer): New function.
	(-pmacro-verify-non-negative-integer): New function.
	(-pmacro-expand-expr-list): New function.
	(-pmacro-process-args-1): Renamed from -pmacro-process-args.
	(-pmacro-process-args): Renamed from -pmacro-invoke.
	(-pmacro-apply, -smacro-apply): New functions.
	(-pmacro-expand): Rewrite syntactic form processing.
	(-pmacro-build-lambda): Reformat.
	(define-pmacro): Watch for more errors in definition.
	(pmacro-debug): New function.
	(pmacro-trace): Set/reset -pmacro-debug?.
	(all existing builtin pmacro helpers): Rename to -pmacro-builtin-foo.
	(-pmacro-builtin-substring): Fix.  Add support for `end' marker.
	(-pmacro-builtin-for-each, et.al.): New helpers for .for-each, .let,
	.if, .case, .cond, .begin, .print, .dump, .error, .list, .ref,
	.length, .replicate, .equals, .and, .or, .not, .eq, .ne, .lt, .gt,
	.le, .ge, .add, .sub, .mul, .div, .rem, .sll, .srl, .sra, .bitand,
	.bitor, .bitxor, bitinv, .car, .cdr, .caar, .cadr, .cdar, .cddr.
	(pmacros-init!): Initialize -smacro-table.
	Rewrite pmacro initialization.
	* read.scm (reader-process-expanded): Renamed from
	-reader-process-expanded.  All callers updated.
	Recognize () as a no-op.
	(cpu-load): Tweak logging messages.
	* utils.scm (message): Add comment.
	* cpu/play.cpu: Add some instructions to play with .let.
	* doc/cgenint.texi: Move some debugging related docs to here from
	cgen.texi.
	* doc/pmacros.texi: Reorganize.  Add docs for new builtin pmacros.
	* testsuite/Makefile.am: New file.
	* testsuite/Makefile.in: New file.
	* testsuite/test-utils.sh.in: New file.
	* testsuite/run-tests.sh: New file.
	* testsuite/testsuite.cpu: New file.
	* testsuite/pmacros-1.test: New file.
@
text
@d34 4
d39 4
a42 1
    [ $# == 1 ] || { echo "missing cpu_file" >&2 ; exit 1 ; }
d45 1
a45 1
    if ! ${GUILE} ${GUILEFLAGS} ${cgendir}/cgen-testsuite.scm \
d51 3
a53 1
	fail "${test} run of cgen"
@


1.1.2.1
log
@Copy over from trunk.
	Extend pmacro language, add testsuite.
	* Makefile.am (SUBDIRS): Add testsuite.
	* Makefile.in: Regenerate.
	* configure.in (AC_OUTPUT): Create testsuite/Makefile,
	testsuite/test-utils.sh.
	* configure: Regenerate.
	* dev.scm (cload): Handle testsuite app.
	(load-testsuite): New function.
	* pmacros.scm: (-pmacro-debug?): New global.
	(-smacro-table): New global.
	(-smacro-lookup, -smacro-set!): New functions.
	(-pmacro-make): New argument `syntactic-form?', all callers updated.
	(-pmacro-syntactic-form?): New function.
	(-pmacro-expected-number, -pmacro-verify-number): New functions.
	(-pmacro-expected-integer, -pmacro-verify-integer): New functions.
	(-pmacro-expected-non-negative-integer): New function.
	(-pmacro-verify-non-negative-integer): New function.
	(-pmacro-expand-expr-list): New function.
	(-pmacro-process-args-1): Renamed from -pmacro-process-args.
	(-pmacro-process-args): Renamed from -pmacro-invoke.
	(-pmacro-apply, -smacro-apply): New functions.
	(-pmacro-expand): Rewrite syntactic form processing.
	(-pmacro-build-lambda): Reformat.
	(define-pmacro): Watch for more errors in definition.
	(pmacro-debug): New function.
	(pmacro-trace): Set/reset -pmacro-debug?.
	(all existing builtin pmacro helpers): Rename to -pmacro-builtin-foo.
	(-pmacro-builtin-substring): Fix.  Add support for `end' marker.
	(-pmacro-builtin-for-each, et.al.): New helpers for .for-each, .let,
	.if, .case, .cond, .begin, .print, .dump, .error, .list, .ref,
	.length, .replicate, .equals, .and, .or, .not, .eq, .ne, .lt, .gt,
	.le, .ge, .add, .sub, .mul, .div, .rem, .sll, .srl, .sra, .bitand,
	.bitor, .bitxor, bitinv, .car, .cdr, .caar, .cadr, .cdar, .cddr.
	(pmacros-init!): Initialize -smacro-table.
	Rewrite pmacro initialization.
	* read.scm (reader-process-expanded): Renamed from
	-reader-process-expanded.  All callers updated.
	Recognize () as a no-op.
	(cpu-load): Tweak logging messages.
	* utils.scm (message): Add comment.
	* cpu/play.cpu: Add some instructions to play with .let.
	* doc/cgenint.texi: Move some debugging related docs to here from
	cgen.texi.
	* doc/pmacros.texi: Reorganize.  Add docs for new builtin pmacros.
	* testsuite/Makefile.am: New file.
	* testsuite/Makefile.in: New file.
	* testsuite/test-utils.sh.in: New file.
	* testsuite/run-tests.sh: New file.
	* testsuite/testsuite.cpu: New file.
	* testsuite/pmacros-1.test: New file.
@
text
@@

