head	1.3;
access;
symbols
	sid-snapshot-20180601:1.3
	cgen-snapshot-20180601:1.3
	sid-snapshot-20180501:1.3
	cgen-snapshot-20180501:1.3
	sid-snapshot-20180401:1.3
	cgen-snapshot-20180401:1.3
	sid-snapshot-20180301:1.3
	cgen-snapshot-20180301:1.3
	sid-snapshot-20180201:1.3
	cgen-snapshot-20180201:1.3
	sid-snapshot-20180101:1.3
	cgen-snapshot-20180101:1.3
	sid-snapshot-20171201:1.3
	cgen-snapshot-20171201:1.3
	sid-snapshot-20171101:1.3
	cgen-snapshot-20171101:1.3
	sid-snapshot-20171001:1.3
	cgen-snapshot-20171001:1.3
	sid-snapshot-20170901:1.3
	cgen-snapshot-20170901:1.3
	sid-snapshot-20170801:1.3
	cgen-snapshot-20170801:1.3
	sid-snapshot-20170701:1.3
	cgen-snapshot-20170701:1.3
	sid-snapshot-20170601:1.3
	cgen-snapshot-20170601:1.3
	sid-snapshot-20170501:1.3
	cgen-snapshot-20170501:1.3
	sid-snapshot-20170401:1.3
	cgen-snapshot-20170401:1.3
	sid-snapshot-20170301:1.3
	cgen-snapshot-20170301:1.3
	sid-snapshot-20170201:1.3
	cgen-snapshot-20170201:1.3
	sid-snapshot-20170101:1.3
	cgen-snapshot-20170101:1.3
	sid-snapshot-20161201:1.3
	cgen-snapshot-20161201:1.3
	sid-snapshot-20161101:1.3
	cgen-snapshot-20161101:1.3
	sid-snapshot-20160901:1.3
	cgen-snapshot-20160901:1.3
	sid-snapshot-20160801:1.3
	cgen-snapshot-20160801:1.3
	sid-snapshot-20160701:1.3
	cgen-snapshot-20160701:1.3
	sid-snapshot-20160601:1.3
	cgen-snapshot-20160601:1.3
	sid-snapshot-20160501:1.3
	cgen-snapshot-20160501:1.3
	sid-snapshot-20160401:1.3
	cgen-snapshot-20160401:1.3
	sid-snapshot-20160301:1.3
	cgen-snapshot-20160301:1.3
	sid-snapshot-20160201:1.3
	cgen-snapshot-20160201:1.3
	sid-snapshot-20160101:1.3
	cgen-snapshot-20160101:1.3
	sid-snapshot-20151201:1.3
	cgen-snapshot-20151201:1.3
	sid-snapshot-20151101:1.3
	cgen-snapshot-20151101:1.3
	sid-snapshot-20151001:1.3
	cgen-snapshot-20151001:1.3
	sid-snapshot-20150901:1.3
	cgen-snapshot-20150901:1.3
	sid-snapshot-20150801:1.3
	cgen-snapshot-20150801:1.3
	sid-snapshot-20150701:1.3
	cgen-snapshot-20150701:1.3
	sid-snapshot-20150601:1.3
	cgen-snapshot-20150601:1.3
	sid-snapshot-20150501:1.3
	cgen-snapshot-20150501:1.3
	sid-snapshot-20150401:1.3
	cgen-snapshot-20150401:1.3
	sid-snapshot-20150301:1.3
	cgen-snapshot-20150301:1.3
	sid-snapshot-20150201:1.3
	cgen-snapshot-20150201:1.3
	sid-snapshot-20150101:1.3
	cgen-snapshot-20150101:1.3
	sid-snapshot-20141201:1.3
	cgen-snapshot-20141201:1.3
	sid-snapshot-20141101:1.3
	cgen-snapshot-20141101:1.3
	sid-snapshot-20141001:1.3
	cgen-snapshot-20141001:1.3
	sid-snapshot-20140901:1.3
	cgen-snapshot-20140901:1.3
	sid-snapshot-20140801:1.3
	cgen-snapshot-20140801:1.3
	sid-snapshot-20140701:1.3
	cgen-snapshot-20140701:1.3
	sid-snapshot-20140601:1.3
	cgen-snapshot-20140601:1.3
	sid-snapshot-20140501:1.3
	cgen-snapshot-20140501:1.3
	sid-snapshot-20140401:1.3
	cgen-snapshot-20140401:1.3
	sid-snapshot-20140301:1.3
	cgen-snapshot-20140301:1.3
	sid-snapshot-20140201:1.3
	cgen-snapshot-20140201:1.3
	sid-snapshot-20140101:1.3
	cgen-snapshot-20140101:1.3
	sid-snapshot-20131201:1.3
	cgen-snapshot-20131201:1.3
	sid-snapshot-20131101:1.3
	cgen-snapshot-20131101:1.3
	sid-snapshot-20131001:1.3
	cgen-snapshot-20131001:1.3
	sid-snapshot-20130901:1.3
	cgen-snapshot-20130901:1.3
	sid-snapshot-20130801:1.3
	cgen-snapshot-20130801:1.3
	sid-snapshot-20130701:1.3
	cgen-snapshot-20130701:1.3
	sid-snapshot-20130601:1.3
	cgen-snapshot-20130601:1.3
	sid-snapshot-20130501:1.3
	cgen-snapshot-20130501:1.3
	sid-snapshot-20130401:1.3
	cgen-snapshot-20130401:1.3
	sid-snapshot-20130301:1.3
	cgen-snapshot-20130301:1.3
	sid-snapshot-20130201:1.3
	cgen-snapshot-20130201:1.3
	sid-snapshot-20130101:1.3
	cgen-snapshot-20130101:1.3
	sid-snapshot-20121201:1.3
	cgen-snapshot-20121201:1.3
	sid-snapshot-20121101:1.3
	cgen-snapshot-20121101:1.3
	sid-snapshot-20121001:1.3
	cgen-snapshot-20121001:1.3
	sid-snapshot-20120901:1.3
	cgen-snapshot-20120901:1.3
	sid-snapshot-20120801:1.3
	cgen-snapshot-20120801:1.3
	sid-snapshot-20120701:1.3
	cgen-snapshot-20120701:1.3
	sid-snapshot-20120601:1.3
	cgen-snapshot-20120601:1.3
	sid-snapshot-20120501:1.3
	cgen-snapshot-20120501:1.3
	sid-snapshot-20120401:1.3
	cgen-snapshot-20120401:1.3
	sid-snapshot-20120301:1.3
	cgen-snapshot-20120301:1.3
	sid-snapshot-20120201:1.3
	cgen-snapshot-20120201:1.3
	sid-snapshot-20120101:1.3
	cgen-snapshot-20120101:1.3
	sid-snapshot-20111201:1.3
	cgen-snapshot-20111201:1.3
	sid-snapshot-20111101:1.3
	cgen-snapshot-20111101:1.3
	sid-snapshot-20111001:1.3
	cgen-snapshot-20111001:1.3
	sid-snapshot-20110901:1.3
	cgen-snapshot-20110901:1.3
	sid-snapshot-20110801:1.3
	cgen-snapshot-20110801:1.3
	sid-snapshot-20110701:1.3
	cgen-snapshot-20110701:1.3
	sid-snapshot-20110601:1.3
	cgen-snapshot-20110601:1.3
	sid-snapshot-20110501:1.3
	cgen-snapshot-20110501:1.3
	sid-snapshot-20110401:1.3
	cgen-snapshot-20110401:1.3
	sid-snapshot-20110301:1.3
	cgen-snapshot-20110301:1.3
	sid-snapshot-20110201:1.3
	cgen-snapshot-20110201:1.3
	sid-snapshot-20110101:1.3
	cgen-snapshot-20110101:1.3
	sid-snapshot-20101201:1.3
	cgen-snapshot-20101201:1.3
	sid-snapshot-20101101:1.3
	cgen-snapshot-20101101:1.3
	sid-snapshot-20101001:1.3
	cgen-snapshot-20101001:1.3
	sid-snapshot-20100901:1.3
	cgen-snapshot-20100901:1.3
	sid-snapshot-20100801:1.3
	cgen-snapshot-20100801:1.3
	sid-snapshot-20100701:1.3
	cgen-snapshot-20100701:1.3
	sid-snapshot-20100601:1.3
	cgen-snapshot-20100601:1.3
	sid-snapshot-20100501:1.3
	cgen-snapshot-20100501:1.3
	sid-snapshot-20100401:1.3
	cgen-snapshot-20100401:1.3
	sid-snapshot-20100301:1.3
	cgen-snapshot-20100301:1.3
	sid-snapshot-20100201:1.3
	cgen-snapshot-20100201:1.3
	sid-snapshot-20100101:1.2
	cgen-snapshot-20100101:1.2
	sid-snapshot-20091201:1.2
	cgen-snapshot-20091201:1.2
	sid-snapshot-20091101:1.2
	cgen-snapshot-20091101:1.2
	sid-snapshot-20091001:1.2
	cgen-snapshot-20091001:1.2
	sid-snapshot-20090901:1.2
	cgen-snapshot-20090901:1.2
	sid-snapshot-20090801:1.1
	cgen-snapshot-20090801:1.1
	dje-cgen-play1-branch:1.1.0.2;
locks; strict;
comment	@# @;


1.3
date	2010.01.29.02.59.02;	author devans;	state Exp;
branches;
next	1.2;

1.2
date	2009.08.18.01.40.57;	author devans;	state Exp;
branches;
next	1.1;

1.1
date	2009.07.13.20.55.21;	author devans;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2009.07.14.16.08.51;	author devans;	state Exp;
branches;
next	;


desc
@@


1.3
log
@	* pmacros.scm (pmacros-init!): New arg rtl-version, all callers
	updated.  Use %-prefix if rtl-version >= 0.9.
	* read.scm (/supported-rtl-versions): Add (0 9).
	(/rtl-version-valid?): New function.
	(/cmd-define-rtl-version): If new rtl version, reinvoke pmacros-init!.
	(/reader-expr): New function.
	(reader-process): New function.
	(/reader-process-with-loc!): Renamed from /reader-process!.
	Don't pre-expand `if' commands.
	(/cmd-if): Simplify.  Pmacro-expand test, then, else clauses here.
	Handle rtl-version-equal?, rtl-version-at-least?.
	* testsuite/Makefile.am (clean-test-files): Remove *.test.cpu*.
	* testsuite/Makefile.in: Regenerate.
	* testsuite/pmacros-1.test: Test both . and % as prefixes.
	* testsuite/testsuite.cpu (/begin, /print, /dump): New pmacros.
	(newline, print-match, print-expr, print-thunk): Use them.
	(internal-verify): Update definition.
	* doc/rtl.texi (define-rtl-version): Document rtl version 0.9.
	(Top level conditionals): New node.
@
text
@;; CPU to use for the testsuite. -*- Scheme -*-

(define-arch
  (name testsuite) ; name of cpu
  (comment ".cpu file for the testsuite")
  (insn-lsb0? #t)
  (machs testb)
  (isas test)
)

(define-isa
  (name test)
  (base-insn-bitsize 16)
  (decode-assist (0 1 2 3))
)
  
(define-cpu
  (name testf)
  (comment "experimental cpu family")
  (endian little)
  (word-bitsize 32)
)

(define-mach
  (name testb)
  (comment "mach for testsuite")
  (cpu testf)
)

(define-model
  (name test) (comment "test") (attrs)
  (mach testb)
  ;(pipeline all "" () ((fetch) (decode) (execute) (writeback)))
  (unit u-exec "Execution Unit" () 1 1 () () () ())
)

;; Some useful pmacros for testcases.

(if (rtl-version-at-least? 0 9)
    (begin
      (define-pmacro /begin %begin)
      (define-pmacro /print %print)
      (define-pmacro /dump %dump))
    (begin
      (define-pmacro /begin .begin)
      (define-pmacro /print .print)
      (define-pmacro /dump .dump)))

(define-pmacro (newline) (/print "\n"))

;; Record name of test for debugging purposes.

(define-pmacro (test-name name)
  (/print "TEST: " name "\n")
)

;; Print TEXT as the expected output.

(define-pmacro (print-match text)
  (/begin
   (/print "MATCH: ")
   (/print text)
   (newline))
)

;; Print EXPR as the text to be verified.

(define-pmacro (print-expr expr)
  (/begin
   (/print "EXPR: ")
   (/dump expr)
   (newline))
)

;; THUNK is invoked to exercise whatever is being tested.

(define-pmacro (print-thunk thunk)
  (/begin
   (/print "EXPR: ")
   (thunk)
   (newline))
)

;; Wrapper around .internal-test to include pass/fail messages.

(if (rtl-version-at-least? 0 9)
    (define-pmacro (internal-verify test-name expr)
      (%if (%internal-test expr)
	   (%print "PASS: " test-name "\n")
	   (%print "FAIL: " test-name "\n")))
    (define-pmacro (internal-verify test-name expr)
      (.if (.internal-test expr)
	   (.print "PASS: " test-name "\n")
	   (.print "FAIL: " test-name "\n")))
)
@


1.2
log
@	* pmacros.scm (-pmacro-builtin-internal-test): New function.
	(pmacros-init!): Add .internal-test.
	* testsuite/test-utils.sh.in (post_process): Tweak FAIL output.
	* testsuite/testsuite.cpu (internal-verify): New pmacro.
	* doc/pmacros.text: Document .internal-test.

	* utils-cgen.scm (parse-name): Handle (add 3) -> add3.
	(parse-comment): Allow numbers.
	* doc/porting.texi: Document that names and comments may be lists.

	* insn.scm (-insn-parse): Fix typo.
@
text
@d39 11
a49 1
(define-pmacro (newline) (.print "\n"))
d54 1
a54 1
  (.print "TEST: " name "\n")
d60 3
a62 3
  (.begin
   (.print "MATCH: ")
   (.print text)
d69 3
a71 3
  (.begin
   (.print "EXPR: ")
   (.dump expr)
d78 2
a79 2
  (.begin
   (.print "EXPR: ")
d85 10
a94 4
(define-pmacro (internal-verify test-name expr)
  (.if (.internal-test expr)
       (.print "PASS: " test-name "\n")
       (.print "FAIL: " test-name "\n"))
@


1.1
log
@	Extend pmacro language, add testsuite.
	* Makefile.am (SUBDIRS): Add testsuite.
	* Makefile.in: Regenerate.
	* configure.in (AC_OUTPUT): Create testsuite/Makefile,
	testsuite/test-utils.sh.
	* configure: Regenerate.
	* dev.scm (cload): Handle testsuite app.
	(load-testsuite): New function.
	* pmacros.scm: (-pmacro-debug?): New global.
	(-smacro-table): New global.
	(-smacro-lookup, -smacro-set!): New functions.
	(-pmacro-make): New argument `syntactic-form?', all callers updated.
	(-pmacro-syntactic-form?): New function.
	(-pmacro-expected-number, -pmacro-verify-number): New functions.
	(-pmacro-expected-integer, -pmacro-verify-integer): New functions.
	(-pmacro-expected-non-negative-integer): New function.
	(-pmacro-verify-non-negative-integer): New function.
	(-pmacro-expand-expr-list): New function.
	(-pmacro-process-args-1): Renamed from -pmacro-process-args.
	(-pmacro-process-args): Renamed from -pmacro-invoke.
	(-pmacro-apply, -smacro-apply): New functions.
	(-pmacro-expand): Rewrite syntactic form processing.
	(-pmacro-build-lambda): Reformat.
	(define-pmacro): Watch for more errors in definition.
	(pmacro-debug): New function.
	(pmacro-trace): Set/reset -pmacro-debug?.
	(all existing builtin pmacro helpers): Rename to -pmacro-builtin-foo.
	(-pmacro-builtin-substring): Fix.  Add support for `end' marker.
	(-pmacro-builtin-for-each, et.al.): New helpers for .for-each, .let,
	.if, .case, .cond, .begin, .print, .dump, .error, .list, .ref,
	.length, .replicate, .equals, .and, .or, .not, .eq, .ne, .lt, .gt,
	.le, .ge, .add, .sub, .mul, .div, .rem, .sll, .srl, .sra, .bitand,
	.bitor, .bitxor, bitinv, .car, .cdr, .caar, .cadr, .cdar, .cddr.
	(pmacros-init!): Initialize -smacro-table.
	Rewrite pmacro initialization.
	* read.scm (reader-process-expanded): Renamed from
	-reader-process-expanded.  All callers updated.
	Recognize () as a no-op.
	(cpu-load): Tweak logging messages.
	* utils.scm (message): Add comment.
	* cpu/play.cpu: Add some instructions to play with .let.
	* doc/cgenint.texi: Move some debugging related docs to here from
	cgen.texi.
	* doc/pmacros.texi: Reorganize.  Add docs for new builtin pmacros.
	* testsuite/Makefile.am: New file.
	* testsuite/Makefile.in: New file.
	* testsuite/test-utils.sh.in: New file.
	* testsuite/run-tests.sh: New file.
	* testsuite/testsuite.cpu: New file.
	* testsuite/pmacros-1.test: New file.
@
text
@d73 7
@


1.1.2.1
log
@Copy over from trunk.
	Extend pmacro language, add testsuite.
	* Makefile.am (SUBDIRS): Add testsuite.
	* Makefile.in: Regenerate.
	* configure.in (AC_OUTPUT): Create testsuite/Makefile,
	testsuite/test-utils.sh.
	* configure: Regenerate.
	* dev.scm (cload): Handle testsuite app.
	(load-testsuite): New function.
	* pmacros.scm: (-pmacro-debug?): New global.
	(-smacro-table): New global.
	(-smacro-lookup, -smacro-set!): New functions.
	(-pmacro-make): New argument `syntactic-form?', all callers updated.
	(-pmacro-syntactic-form?): New function.
	(-pmacro-expected-number, -pmacro-verify-number): New functions.
	(-pmacro-expected-integer, -pmacro-verify-integer): New functions.
	(-pmacro-expected-non-negative-integer): New function.
	(-pmacro-verify-non-negative-integer): New function.
	(-pmacro-expand-expr-list): New function.
	(-pmacro-process-args-1): Renamed from -pmacro-process-args.
	(-pmacro-process-args): Renamed from -pmacro-invoke.
	(-pmacro-apply, -smacro-apply): New functions.
	(-pmacro-expand): Rewrite syntactic form processing.
	(-pmacro-build-lambda): Reformat.
	(define-pmacro): Watch for more errors in definition.
	(pmacro-debug): New function.
	(pmacro-trace): Set/reset -pmacro-debug?.
	(all existing builtin pmacro helpers): Rename to -pmacro-builtin-foo.
	(-pmacro-builtin-substring): Fix.  Add support for `end' marker.
	(-pmacro-builtin-for-each, et.al.): New helpers for .for-each, .let,
	.if, .case, .cond, .begin, .print, .dump, .error, .list, .ref,
	.length, .replicate, .equals, .and, .or, .not, .eq, .ne, .lt, .gt,
	.le, .ge, .add, .sub, .mul, .div, .rem, .sll, .srl, .sra, .bitand,
	.bitor, .bitxor, bitinv, .car, .cdr, .caar, .cadr, .cdar, .cddr.
	(pmacros-init!): Initialize -smacro-table.
	Rewrite pmacro initialization.
	* read.scm (reader-process-expanded): Renamed from
	-reader-process-expanded.  All callers updated.
	Recognize () as a no-op.
	(cpu-load): Tweak logging messages.
	* utils.scm (message): Add comment.
	* cpu/play.cpu: Add some instructions to play with .let.
	* doc/cgenint.texi: Move some debugging related docs to here from
	cgen.texi.
	* doc/pmacros.texi: Reorganize.  Add docs for new builtin pmacros.
	* testsuite/Makefile.am: New file.
	* testsuite/Makefile.in: New file.
	* testsuite/test-utils.sh.in: New file.
	* testsuite/run-tests.sh: New file.
	* testsuite/testsuite.cpu: New file.
	* testsuite/pmacros-1.test: New file.
@
text
@@

