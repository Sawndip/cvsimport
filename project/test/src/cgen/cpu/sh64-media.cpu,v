head	1.6;
access;
symbols
	sid-snapshot-20180601:1.6
	cgen-snapshot-20180601:1.6
	sid-snapshot-20180501:1.6
	cgen-snapshot-20180501:1.6
	sid-snapshot-20180401:1.6
	cgen-snapshot-20180401:1.6
	sid-snapshot-20180301:1.6
	cgen-snapshot-20180301:1.6
	sid-snapshot-20180201:1.6
	cgen-snapshot-20180201:1.6
	sid-snapshot-20180101:1.6
	cgen-snapshot-20180101:1.6
	sid-snapshot-20171201:1.6
	cgen-snapshot-20171201:1.6
	sid-snapshot-20171101:1.6
	cgen-snapshot-20171101:1.6
	sid-snapshot-20171001:1.6
	cgen-snapshot-20171001:1.6
	sid-snapshot-20170901:1.6
	cgen-snapshot-20170901:1.6
	sid-snapshot-20170801:1.6
	cgen-snapshot-20170801:1.6
	sid-snapshot-20170701:1.6
	cgen-snapshot-20170701:1.6
	sid-snapshot-20170601:1.6
	cgen-snapshot-20170601:1.6
	sid-snapshot-20170501:1.6
	cgen-snapshot-20170501:1.6
	sid-snapshot-20170401:1.6
	cgen-snapshot-20170401:1.6
	sid-snapshot-20170301:1.6
	cgen-snapshot-20170301:1.6
	sid-snapshot-20170201:1.6
	cgen-snapshot-20170201:1.6
	sid-snapshot-20170101:1.6
	cgen-snapshot-20170101:1.6
	sid-snapshot-20161201:1.6
	cgen-snapshot-20161201:1.6
	sid-snapshot-20161101:1.6
	cgen-snapshot-20161101:1.6
	sid-snapshot-20160901:1.6
	cgen-snapshot-20160901:1.6
	sid-snapshot-20160801:1.6
	cgen-snapshot-20160801:1.6
	sid-snapshot-20160701:1.6
	cgen-snapshot-20160701:1.6
	sid-snapshot-20160601:1.6
	cgen-snapshot-20160601:1.6
	sid-snapshot-20160501:1.6
	cgen-snapshot-20160501:1.6
	sid-snapshot-20160401:1.6
	cgen-snapshot-20160401:1.6
	sid-snapshot-20160301:1.6
	cgen-snapshot-20160301:1.6
	sid-snapshot-20160201:1.6
	cgen-snapshot-20160201:1.6
	sid-snapshot-20160101:1.6
	cgen-snapshot-20160101:1.6
	sid-snapshot-20151201:1.6
	cgen-snapshot-20151201:1.6
	sid-snapshot-20151101:1.6
	cgen-snapshot-20151101:1.6
	sid-snapshot-20151001:1.6
	cgen-snapshot-20151001:1.6
	sid-snapshot-20150901:1.6
	cgen-snapshot-20150901:1.6
	sid-snapshot-20150801:1.6
	cgen-snapshot-20150801:1.6
	sid-snapshot-20150701:1.6
	cgen-snapshot-20150701:1.6
	sid-snapshot-20150601:1.6
	cgen-snapshot-20150601:1.6
	sid-snapshot-20150501:1.6
	cgen-snapshot-20150501:1.6
	sid-snapshot-20150401:1.6
	cgen-snapshot-20150401:1.6
	sid-snapshot-20150301:1.6
	cgen-snapshot-20150301:1.6
	sid-snapshot-20150201:1.6
	cgen-snapshot-20150201:1.6
	sid-snapshot-20150101:1.6
	cgen-snapshot-20150101:1.6
	sid-snapshot-20141201:1.6
	cgen-snapshot-20141201:1.6
	sid-snapshot-20141101:1.6
	cgen-snapshot-20141101:1.6
	sid-snapshot-20141001:1.6
	cgen-snapshot-20141001:1.6
	sid-snapshot-20140901:1.6
	cgen-snapshot-20140901:1.6
	sid-snapshot-20140801:1.6
	cgen-snapshot-20140801:1.6
	sid-snapshot-20140701:1.6
	cgen-snapshot-20140701:1.6
	sid-snapshot-20140601:1.6
	cgen-snapshot-20140601:1.6
	sid-snapshot-20140501:1.6
	cgen-snapshot-20140501:1.6
	sid-snapshot-20140401:1.6
	cgen-snapshot-20140401:1.6
	sid-snapshot-20140301:1.6
	cgen-snapshot-20140301:1.6
	sid-snapshot-20140201:1.6
	cgen-snapshot-20140201:1.6
	sid-snapshot-20140101:1.6
	cgen-snapshot-20140101:1.6
	sid-snapshot-20131201:1.6
	cgen-snapshot-20131201:1.6
	sid-snapshot-20131101:1.6
	cgen-snapshot-20131101:1.6
	sid-snapshot-20131001:1.6
	cgen-snapshot-20131001:1.6
	sid-snapshot-20130901:1.6
	cgen-snapshot-20130901:1.6
	sid-snapshot-20130801:1.6
	cgen-snapshot-20130801:1.6
	sid-snapshot-20130701:1.6
	cgen-snapshot-20130701:1.6
	sid-snapshot-20130601:1.6
	cgen-snapshot-20130601:1.6
	sid-snapshot-20130501:1.6
	cgen-snapshot-20130501:1.6
	sid-snapshot-20130401:1.6
	cgen-snapshot-20130401:1.6
	sid-snapshot-20130301:1.6
	cgen-snapshot-20130301:1.6
	sid-snapshot-20130201:1.6
	cgen-snapshot-20130201:1.6
	sid-snapshot-20130101:1.6
	cgen-snapshot-20130101:1.6
	sid-snapshot-20121201:1.6
	cgen-snapshot-20121201:1.6
	sid-snapshot-20121101:1.6
	cgen-snapshot-20121101:1.6
	sid-snapshot-20121001:1.6
	cgen-snapshot-20121001:1.6
	sid-snapshot-20120901:1.6
	cgen-snapshot-20120901:1.6
	sid-snapshot-20120801:1.6
	cgen-snapshot-20120801:1.6
	sid-snapshot-20120701:1.6
	cgen-snapshot-20120701:1.6
	sid-snapshot-20120601:1.6
	cgen-snapshot-20120601:1.6
	sid-snapshot-20120501:1.6
	cgen-snapshot-20120501:1.6
	sid-snapshot-20120401:1.6
	cgen-snapshot-20120401:1.6
	sid-snapshot-20120301:1.6
	cgen-snapshot-20120301:1.6
	sid-snapshot-20120201:1.6
	cgen-snapshot-20120201:1.6
	sid-snapshot-20120101:1.6
	cgen-snapshot-20120101:1.6
	sid-snapshot-20111201:1.6
	cgen-snapshot-20111201:1.6
	sid-snapshot-20111101:1.6
	cgen-snapshot-20111101:1.6
	sid-snapshot-20111001:1.6
	cgen-snapshot-20111001:1.6
	gdb_7_3-branch:1.6.0.8
	sid-snapshot-20110901:1.6
	cgen-snapshot-20110901:1.6
	sid-snapshot-20110801:1.6
	cgen-snapshot-20110801:1.6
	sid-snapshot-20110701:1.6
	cgen-snapshot-20110701:1.6
	sid-snapshot-20110601:1.6
	cgen-snapshot-20110601:1.6
	sid-snapshot-20110501:1.6
	cgen-snapshot-20110501:1.6
	sid-snapshot-20110401:1.6
	cgen-snapshot-20110401:1.6
	sid-snapshot-20110301:1.6
	cgen-snapshot-20110301:1.6
	sid-snapshot-20110201:1.6
	cgen-snapshot-20110201:1.6
	sid-snapshot-20110101:1.6
	cgen-snapshot-20110101:1.6
	sid-snapshot-20101201:1.6
	cgen-snapshot-20101201:1.6
	sid-snapshot-20101101:1.6
	cgen-snapshot-20101101:1.6
	sid-snapshot-20101001:1.6
	cgen-snapshot-20101001:1.6
	sid-snapshot-20100901:1.6
	cgen-snapshot-20100901:1.6
	sid-snapshot-20100801:1.6
	cgen-snapshot-20100801:1.6
	sid-snapshot-20100701:1.6
	cgen-snapshot-20100701:1.6
	sid-snapshot-20100601:1.6
	cgen-snapshot-20100601:1.6
	sid-snapshot-20100501:1.6
	cgen-snapshot-20100501:1.6
	sid-snapshot-20100401:1.6
	cgen-snapshot-20100401:1.6
	sid-snapshot-20100301:1.6
	cgen-snapshot-20100301:1.6
	sid-snapshot-20100201:1.6
	cgen-snapshot-20100201:1.6
	sid-snapshot-20100101:1.6
	cgen-snapshot-20100101:1.6
	sid-snapshot-20091201:1.6
	cgen-snapshot-20091201:1.6
	sid-snapshot-20091101:1.6
	cgen-snapshot-20091101:1.6
	sid-snapshot-20091001:1.6
	cgen-snapshot-20091001:1.6
	arc-sim-20090309:1.6
	sid-snapshot-20090901:1.6
	cgen-snapshot-20090901:1.6
	sid-snapshot-20090801:1.6
	cgen-snapshot-20090801:1.6
	sid-snapshot-20090701:1.6
	cgen-snapshot-20090701:1.6
	dje-cgen-play1-branch:1.6.0.6
	dje-cgen-play1-branchpoint:1.6
	cgen-1_1-branch:1.6.0.4
	cgen-1_1-branchpoint:1.6
	sid-snapshot-20090601:1.6
	cgen-snapshot-20090601:1.6
	sid-snapshot-20090501:1.6
	cgen-snapshot-20090501:1.6
	sid-snapshot-20090401:1.6
	cgen-snapshot-20090401:1.6
	arc-insight_6_8-branch:1.6.0.2
	arc-insight_6_8-branchpoint:1.6
	sid-snapshot-20090301:1.6
	cgen-snapshot-20090301:1.6
	sid-snapshot-20090201:1.6
	cgen-snapshot-20090201:1.6
	sid-snapshot-20090101:1.6
	cgen-snapshot-20090101:1.6
	sid-snapshot-20081201:1.6
	cgen-snapshot-20081201:1.6
	sid-snapshot-20081101:1.6
	cgen-snapshot-20081101:1.6
	sid-snapshot-20081001:1.6
	cgen-snapshot-20081001:1.6
	sid-snapshot-20080901:1.6
	cgen-snapshot-20080901:1.6
	sid-snapshot-20080801:1.6
	cgen-snapshot-20080801:1.6
	sid-snapshot-20080701:1.6
	cgen-snapshot-20080701:1.6
	sid-snapshot-20080601:1.6
	cgen-snapshot-20080601:1.6
	sid-snapshot-20080501:1.6
	cgen-snapshot-20080501:1.6
	sid-snapshot-20080403:1.6
	sid-snapshot-20080401:1.6
	cgen-snapshot-20080401:1.6
	sid-snapshot-20080301:1.6
	cgen-snapshot-20080301:1.6
	sid-snapshot-20080201:1.6
	cgen-snapshot-20080201:1.6
	sid-snapshot-20080101:1.6
	cgen-snapshot-20080101:1.6
	sid-snapshot-20071201:1.6
	cgen-snapshot-20071201:1.6
	sid-snapshot-20071101:1.6
	cgen-snapshot-20071101:1.6
	sid-snapshot-20071001:1.6
	cgen-snapshot-20071001:1.6
	msnyder-fork-checkpoint-branch:1.5.0.36
	msnyder-fork-checkpoint-branchpoint:1.5
	gdb-csl-arm-20051020-branch:1.5.0.32
	gdb-csl-arm-20051020-branchpoint:1.5
	drow_intercu-merge-20040921:1.5
	drow_intercu-merge-20040915:1.5
	jimb-gdb_6_2-e500-branch:1.5.0.34
	jimb-gdb_6_2-e500-branchpoint:1.5
	gdb_6_2-20040730-release:1.5
	gdb_6_2-branch:1.5.0.30
	gdb_6_2-2004-07-10-gmt-branchpoint:1.5
	gdb_6_1_1-20040616-release:1.5
	gdb_6_1-2004-04-05-release:1.5
	drow_intercu-merge-20040402:1.5
	drow_intercu-merge-20040327:1.5
	ezannoni_pie-20040323-branch:1.5.0.28
	ezannoni_pie-20040323-branchpoint:1.5
	cagney_tramp-20040321-mergepoint:1.5
	cagney_tramp-20040309-branch:1.5.0.26
	cagney_tramp-20040309-branchpoint:1.5
	gdb_6_1-branch:1.5.0.24
	gdb_6_1-2004-03-01-gmt-branchpoint:1.5
	drow_intercu-20040221-branch:1.5.0.22
	drow_intercu-20040221-branchpoint:1.5
	cagney_bfdfile-20040213-branch:1.5.0.20
	cagney_bfdfile-20040213-branchpoint:1.5
	drow-cplus-merge-20040208:1.5
	carlton_dictionary-20040126-merge:1.5
	cagney_bigcore-20040122-branch:1.5.0.18
	cagney_bigcore-20040122-branchpoint:1.5
	drow-cplus-merge-20040113:1.5
	drow-cplus-merge-20031224:1.5
	drow-cplus-merge-20031220:1.5
	carlton_dictionary-20031215-merge:1.5
	drow-cplus-merge-20031214:1.5
	carlton-dictionary-20031111-merge:1.5
	gdb_6_0-2003-10-04-release:1.5
	kettenis_sparc-20030918-branch:1.5.0.16
	kettenis_sparc-20030918-branchpoint:1.5
	carlton_dictionary-20030917-merge:1.5
	ezannoni_pie-20030916-branchpoint:1.5
	ezannoni_pie-20030916-branch:1.5.0.14
	cagney_x86i386-20030821-branch:1.5.0.12
	cagney_x86i386-20030821-branchpoint:1.5
	carlton_dictionary-20030805-merge:1.5
	carlton_dictionary-20030627-merge:1.5
	gdb_6_0-branch:1.5.0.10
	gdb_6_0-2003-06-23-branchpoint:1.5
	jimb-ppc64-linux-20030613-branch:1.5.0.8
	jimb-ppc64-linux-20030613-branchpoint:1.5
	cagney_convert-20030606-branch:1.5.0.6
	cagney_convert-20030606-branchpoint:1.5
	cagney_writestrings-20030508-branch:1.4.0.6
	cagney_writestrings-20030508-branchpoint:1.4
	jimb-ppc64-linux-20030528-branch:1.5.0.4
	jimb-ppc64-linux-20030528-branchpoint:1.5
	carlton_dictionary-20030523-merge:1.5
	cagney_fileio-20030521-branch:1.5.0.2
	cagney_fileio-20030521-branchpoint:1.5
	kettenis_i386newframe-20030517-mergepoint:1.4
	jimb-ppc64-linux-20030509-branch:1.4.0.4
	jimb-ppc64-linux-20030509-branchpoint:1.4
	kettenis_i386newframe-20030504-mergepoint:1.4
	carlton_dictionary-20030430-merge:1.4
	kettenis_i386newframe-20030419-branch:1.4.0.2
	kettenis_i386newframe-20030419-branchpoint:1.4
	carlton_dictionary-20030416-merge:1.4
	cagney_frameaddr-20030409-mergepoint:1.3
	kettenis_i386newframe-20030406-branch:1.3.0.14
	kettenis_i386newframe-20030406-branchpoint:1.3
	cagney_frameaddr-20030403-branchpoint:1.3
	cagney_frameaddr-20030403-branch:1.3.0.12
	cagney_framebase-20030330-mergepoint:1.3
	cagney_framebase-20030326-branch:1.3.0.10
	cagney_framebase-20030326-branchpoint:1.3
	cagney_lazyid-20030317-branch:1.3.0.8
	cagney_lazyid-20030317-branchpoint:1.3
	kettenis-i386newframe-20030316-mergepoint:1.3
	offbyone-20030313-branch:1.3.0.6
	offbyone-20030313-branchpoint:1.3
	kettenis-i386newframe-20030308-branch:1.3.0.4
	kettenis-i386newframe-20030308-branchpoint:1.3
	carlton_dictionary-20030305-merge:1.3
	cagney_offbyone-20030303-branch:1.3.0.2
	cagney_offbyone-20030303-branchpoint:1.3
	carlton_dictionary-20030207-merge:1.2
	interps-20030202-branch:1.2.0.16
	interps-20030202-branchpoint:1.2
	cagney-unwind-20030108-branch:1.2.0.14
	cagney-unwind-20030108-branchpoint:1.2
	carlton_dictionary-20021223-merge:1.2
	gdb_5_3-2002-12-12-release:1.2
	carlton_dictionary-20021115-merge:1.2
	kseitz_interps-20021105-merge:1.2
	kseitz_interps-20021103-merge:1.2
	drow-cplus-merge-20021020:1.2
	drow-cplus-merge-20021025:1.2
	carlton_dictionary-20021025-merge:1.2
	carlton_dictionary-20021011-merge:1.2
	drow-cplus-branch:1.2.0.12
	drow-cplus-branchpoint:1.2
	kseitz_interps-20020930-merge:1.2
	carlton_dictionary-20020927-merge:1.2
	carlton_dictionary-branch:1.2.0.10
	carlton_dictionary-20020920-branchpoint:1.2
	sid-20020905-branchpoint:1.2
	sid-20020905-branch:1.2.0.8
	gdb_5_3-branch:1.2.0.6
	gdb_5_3-2002-09-04-branchpoint:1.2
	kseitz_interps-20020829-merge:1.2
	cagney_sysregs-20020825-branch:1.2.0.4
	cagney_sysregs-20020825-branchpoint:1.2
	readline_4_3-import-branch:1.2.0.2
	readline_4_3-import-branchpoint:1.2
	gdb_5_2_1-2002-07-23-release:1.1
	kseitz_interps-20020528-branch:1.1.0.8
	kseitz_interps-20020528-branchpoint:1.1
	cagney_regbuf-20020515-branch:1.1.0.6
	cagney_regbuf-20020515-branchpoint:1.1
	jimb-macro-020506-branch:1.1.0.4
	jimb-macro-020506-branchpoint:1.1
	gdb_5_2-2002-04-29-release:1.1
	gdb_5_2-branch:1.1.0.2
	gdb_5_2-2002-03-03-branchpoint:1.1;
locks; strict;
comment	@# @;


1.6
date	2006.10.18.18.04.40;	author brolley;	state Exp;
branches
	1.6.8.1;
next	1.5;

1.5
date	2003.05.21.14.10.46;	author amylaar;	state Exp;
branches;
next	1.4;

1.4
date	2003.04.15.08.51.52;	author nickc;	state Exp;
branches;
next	1.3;

1.3
date	2003.02.21.20.05.41;	author amylaar;	state Exp;
branches;
next	1.2;

1.2
date	2002.06.25.17.17.45;	author bje;	state Exp;
branches
	1.2.10.1
	1.2.12.1;
next	1.1;

1.1
date	2002.02.01.11.32.02;	author bje;	state Exp;
branches
	1.1.8.1;
next	;

1.6.8.1
date	2011.09.04.17.03.15;	author brobecke;	state Exp;
branches;
next	;

1.2.10.1
date	2003.03.06.00.56.19;	author carlton;	state Exp;
branches;
next	1.2.10.2;

1.2.10.2
date	2003.04.16.19.56.47;	author carlton;	state Exp;
branches;
next	1.2.10.3;

1.2.10.3
date	2003.05.23.18.40.30;	author carlton;	state Exp;
branches;
next	;

1.2.12.1
date	2003.12.14.20.26.56;	author drow;	state Exp;
branches;
next	;

1.1.8.1
date	2002.07.22.21.46.52;	author kseitz;	state Exp;
branches;
next	;


desc
@@


1.6
log
@2006-10-18  Dave Brolley  <brolley@@redhat.com>

        * Contribute the following changes:

        2006-07-11  Dave Brolley  <brolley@@redhat.com>

        * cpu/sh64-compact.cpu (movual, movual2): New insns.
        (movcol): New insn.
        * cpu/sh.cpu (sh4a-nofpu-models): New pmacro.
        * sid.scm (-op-gen-delayed-set-maybe-trace): If delay used, note the
        hardware or memory mode which was used.
        * sid-cpu.scm (hw-need-write-stack?): New function.
        (-gen-hw-stream-and-destream-fns): Compute stack-regs. Use it to
        identify hardware which uses write stacks.
        (useful-mode-names): Renamed to write-stack-memory-mode-names.
        Initialized to an empty list.
        (-gen-writestacks, -gen-reset-fn, -gen-unified-write-fn): Use
        hw-need-write-stack?.
        * hardware.scm (used-in-delay-rtl?): New member of <hardware-base>.
        (define-getters <hardware-base>): Define used-in-delay-rtl?.
        (used-in-delay-rtl?): New method of <hardware-base>.
        (hw-used-in-delay-rtl?): New function.

        2006-06-20  Dave Brolley  <brolley@@redhat.com>

        * sid.scm (gen-attr-type): Removed.
        * cpu/sh.cpu (SH2a-nofpu-MACH): Add sh5.
        (SH2a-MACH): Add sh5.
        (sh2a-nofpu-models): Add units for sh5.
        (sh2a-fpu-models): Likewise.

        2006-06-15  Dave Brolley  <brolley@@redhat.com>

        * cpu/sh-sim.cpu: New file.
        * cpu/sh-sid.cpu: New file.
        * cpu/sh64-media.cpu (dshci): Add xtiming argument and splice it in.
        (All fields): Remap for (insn-lsb0? #f)
        (All insns): Add timing specs.
        * cpu/sh64-compact.cpu (dshcf,dshcop): Replace 'ignored' argument with
        'xattrs' and .splice it in.
        (32-BIT-INSN,SH4-GROUP,SH4A-GROUP): New insn attributes.
        (h-frc,h-drc): Add PROFILE attribute.
        (h-fpccr): Removed.
        (h-vbr): New hardware.
        (All fields): Remap for (insn-lsb0? #f)
        (f-imm20-hi,f-imm20-lo,f-imm20): New fields.
        (fr0,fmovm,fmovn,imm20,imm12x4,imm12x8,vbr): New operands.
        (fpscr): Use h-fpscr.
        (fsdm,fsdn): Use h-fsd.
        (dshci): Add xtiming argument and splice it in.
        (dr,xd): pmacros removed.
        (All insns): Add timing specs, *-MACH attribibutes,
        SH4{A}-GROUP attributes.
        (divu,mulr,ldc-vbr,ldc-sr,ldcl-vbr,movl12,movl13,stcl-vbr): New insns.
        * cpu/sh.cpu): Include sh-sid.cpu or sh-sim.cpu depending on whether
        we're being processed for sim or sid.
        (define-arch): Change insn-lsb0? for #f. Add machs sh2e, sh2a-fpu,
        sh2a-nofpu, sh4-nofpu, sh4a-nofpu, sh4a, sh4al.
        (define-isa compact): Add (isa-parallel-insns 2).
        (define-isa media): Add (isa-parallel-insns 2). Add
        (default-insn-word-bitsize 32). Change base-insn-bitsize to 32.
        (define-mach): Add sh2e, sh2a-fpu, sh2a-nofpu, sh4-nofpu, sh4a-nofpu,
        sh4a, sh4al
        (SH2-MACH, SH2e-MACH, SH2a-nofpu-MACH, SH2a-MACH, SH3-MACH)
        (SH3e-MACH, SH4-nofpu-MACH, SH4-MACH, SH4a-nofpu-MACH, SH4a-MACH)
        (SH4al-MACH, SH5-MACH): New pmacros.
        (common-units, common-fp-units, sh2a-nofpu-units, sh2a-fpu-units)
        (sh4-nofpu-units, sh4-common-fp-units, sh5-media-units)
        (sh5-media-fp-units, common-model, common-model-with-fp)
        (sh3-model, sh3e-model): New pmacros.
        (define-model sh2): New model.
        (define-model sh2e): New model.
        (define-model sh3): New model.
        (define-model sh3e): New model.
        (define-model sh2a-nofpu): New model.
        (define-model sh2a-fpu): New model.
        (define-model sh4-nofpu): New model.
        (define-model sh4): New model.
        (define-model sh4a-nofpu): New model.
        (define-model sh4a): New model.
        (define-model sh4al): New model.
        (define-model sh5-media): New model.
        (define-model sh5): Add all units.
        (all-models, sh2e-models, sh2a-nofpu-models, sh2a-fpu-models)
        (sh3-models, sh3e-models, sh4-nofpu-models, sh4-models)
        (sh5-media-models, shad-models, fsqrt-models): New pmacros.
        (h-pc): Add PROFILE attribute.
        (h-fr): Likewise.
        (h-tr): Likewise.
        (h-gr,h-grc): Likewise.
        (h-cr): Set h-sr in setter.
        (h-frbit): Get/Set h-fpscr.
        (h-szbit,h-prbit): Likewise.
        (h-fp): Add PROFILE attribute. Now indexed by even indices 0-62.
        Add getter and setter.
        (h-fc): Add PROFILE attribute. Now indexed by quad indices 0-60.
        Adjust getter and setter.
        (h-fmtx): Add PROFILE attribute. Now indexed by 0, 16, 32 and 48.
        Adjust getter and setter.
        (h-dr): Add PROFILE attribute. Now indexed by even indices 0-62.
        (h-fsd,h-fmov): New hardware.
@
text
@; SuperH SHmedia instruction set description.  -*- Scheme -*-
; Copyright (C) 2000, 2001, 2006 Red Hat, Inc.
; Copyright (C) 2002 SuperH Ltd
; This file is part of CGEN.
; See file COPYING.CGEN for details.

; dshmf -- define-normal-sh-media-field

(define-pmacro (dshmf xname xcomment ignored xstart xlength)
  (dnf xname xcomment ((ISA media)) xstart xlength))

; dshmop -- define-normal-sh-media-operand

(define-pmacro (dshmop xname xcomment ignored xhardware xfield)
  (dnop xname xcomment ((ISA media)) xhardware xfield))

; dnshmi -- define-normal-sh-media-insn

(define-pmacro (dshmi xname xcomment xattrs xsyntax xformat xsemantics xtiming)
  (define-insn
    (name xname)
    (comment xcomment)
    (.splice attrs (.unsplice xattrs) (ISA media))
    (syntax xsyntax)
    (format xformat)
    (semantics xsemantics)
    (.splice timing (.unsplice xtiming))))


; Saturation functions.
; Force a value `i' into words `n' bits wide.
; See SuperH (SH) 64 bit RISC Series / SH-5 CPU Core, Volume 2,
; page 11 for details.  (page number refers to 05-CC-10002 V1.0).

; saturate -- signed saturatation function

(define-pmacro (saturate mode n i)
  (if mode (lt i (neg DI (sll DI 1 (sub n 1))))
      (neg (sll mode 1 (sub n 1)))
      (if mode (lt i (sll DI 1 (sub n 1)))
	  i
 	  (sub mode (sll mode 1 (sub n 1)) 1))))

; usaturate -- unsigned saturation function

(define-pmacro (usaturate mode n i)
  (if mode (lt i (const DI 0))
      (const mode 0)
      (if mode (lt i (sll DI 1 n))
	  i
	  (sub mode (sll mode 1 n) 1))))


; Ifields.

(dshmf f-op          "Opcode"                       ()   0  6)
(dshmf f-ext         "Extension opcode"             ()  12  4)
(dshmf f-rsvd        "Reserved"		    (RESERVED)  28  4)

(dshmf f-left        "Left register"                ()   6  6)
(dshmf f-right       "Right register"               ()  16  6)
(dshmf f-dest        "Destination register"         ()  22  6)

(define-multi-ifield
  (name f-left-right)
  (comment "Left and right matched register pair")
  (attrs (ISA media))
  (mode UINT)
  (subfields f-left f-right)
  (insert (sequence ()
		    (set (ifield f-left)
			 (and (ifield f-left-right) 63))
		    (set (ifield f-right)
			 (and (ifield f-left-right) 63))))
  (extract (set (ifield f-left-right) (ifield f-left)))
)

(dshmf f-tra         "Target register"              ()  25  3)
(dshmf f-trb         "Target register"              ()   9  3)
(dshmf f-likely      "Likely bit"                   ()  22  1)
(dshmf f-6-3           "Three unused bits at bit 25"  ()   6  3)
(dshmf f-23-2        "Two unused bits at bit 25"    ()  23  2)

(df f-imm6   "Immediate value (6 bits)"      ((ISA media)) 16 6 INT #f #f)
(df f-imm10  "Immediate value (10 bits)"     ((ISA media)) 12 10 INT #f #f)
(df f-imm16  "Immediate value (16 bits)"     ((ISA media))  6 16 INT #f #f)

(dshmf f-uimm6       "Immediate value (6 bits)"     ()  16  6)
(dshmf f-uimm16      "Immediate value (16 bits)"    ()   6 16)

; Various displacement fields.
; The 10 bit field, for example, has different scaling for displacements.

(df f-disp6	     "Displacement (6 bits)"        ((ISA media)) 16 6 INT #f #f)

(df f-disp6x32       "Displacement (6 bits)"        ((ISA media)) 16 6 INT
    ((value pc) (sra SI value 5))
    ((value pc) (sll SI value 5)))

(df f-disp10         "Displacement (10 bits)"       ((ISA media)) 12 10 INT #f #f)

(df f-disp10x8       "Displacement (10 bits)"       ((ISA media)) 12 10 INT
    ((value pc) (sra SI value 3))
    ((value pc) (sll SI value 3)))

(df f-disp10x4       "Displacement (10 bits)"       ((ISA media)) 12 10 INT
    ((value pc) (sra SI value 2))
    ((value pc) (sll SI value 2)))

(df f-disp10x2       "Displacement (10 bits)"       ((ISA media)) 12 10 INT
    ((value pc) (sra SI value 1))
    ((value pc) (sll SI value 1)))

(df f-disp16         "Displacement (16 bits)"       ((ISA media) PCREL-ADDR)  6 16 INT
    ((value pc) (sra DI value 2))
    ((value pc) (add DI (sll DI value 2) pc)))


; Operands.

(dshmop rm        "Left general purpose reg"            ()  h-gr    f-left)
(dshmop rn        "Right general purpose reg"           ()  h-gr    f-right)
(dshmop rd        "Destination general purpose reg"     ()  h-gr    f-dest)

(dshmop frg       "Left single precision register"      ()  h-fr    f-left)
(dshmop frh       "Right single precision register"     ()  h-fr    f-right)
(dshmop frf       "Destination single precision reg"    ()  h-fr    f-dest)
(dshmop frgh      "Single precision register pair"      ()  h-fr    f-left-right)

(dshmop fpf       "Pair of single precision registers"  ()  h-fp    f-dest)

(dshmop fvg       "Left single precision vector"        ()  h-fv    f-left)
(dshmop fvh       "Right single precision vector"       ()  h-fv    f-right)
(dshmop fvf       "Destination single precision vector" ()  h-fv    f-dest)
(dshmop mtrxg     "Left single precision matrix"        ()  h-fmtx  f-left)

(dshmop drg       "Left double precision register"      ()  h-dr    f-left)
(dshmop drh       "Right double precision register"     ()  h-dr    f-right)
(dshmop drf       "Destination double precision reg"    ()  h-dr    f-dest)
(dshmop drgh      "Double precision register pair"      ()  h-dr    f-left-right)

(dshmop fpscr     "Floating point status register"      ()  h-fpscr f-nil)
(dshmop crj       "Control register j"                  ()  h-cr    f-dest)
(dshmop crk       "Control register k"			()  h-cr    f-left)

(dshmop tra       "Target register a"                   ()  h-tr    f-tra)
(dshmop trb       "Target register b"                   ()  h-tr    f-trb)

(dshmop disp6     "Displacement (6 bits)"		()  h-sint  f-disp6)
(dshmop disp6x32  "Displacement (6 bits, scale 32)"     ()  h-sint  f-disp6x32)
(dshmop disp10    "Displacement (10 bits)"              ()  h-sint  f-disp10)
(dshmop disp10x2  "Displacement (10 bits, scale 2)"     ()  h-sint  f-disp10x2)
(dshmop disp10x4  "Displacement (10 bits, scale 4)"     ()  h-sint  f-disp10x4)
(dshmop disp10x8  "Displacement (10 bits, scale 8)"     ()  h-sint  f-disp10x8)
(dshmop disp16    "Displacement (16 bits)"              ()  h-sint  f-disp16)

(dshmop imm6      "Immediate (6 bits)"                  ()  h-sint  f-imm6)
(dshmop imm10     "Immediate (10 bits)"                 ()  h-sint  f-imm10)
(dshmop imm16     "Immediate (16 bits)"                 ()  h-sint  f-imm16)
(dshmop uimm6     "Immediate (6 bits)"                  ()  h-uint  f-uimm6)
(dshmop uimm16    "Unsigned immediate (16 bits)"        ()  h-uint  f-uimm16)

; FIXME: provide these parse/print functions in `sh-media.opc'.

(define-operand (name likely) (comment "Likely branch?") (attrs (ISA media))
  (type h-uint) (index f-likely) (handlers (parse "likely") (print "likely")))


; Instructions.

(dshmi add "Add"
       ()
       "add $rm, $rn, $rd"
       (+ (f-op 0) rm (f-ext 9) rn rd (f-rsvd 0))
       (set rd (add rm rn))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi addl "Add long"
       ()
       "add.l $rm, $rn, $rd"
       (+ (f-op 0) rm (f-ext 8) rn rd (f-rsvd 0))
       (set rd (add (subword SI rm 1) (subword SI rn 1)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi addi "Add immediate"
       ()
       "addi $rm, $disp10, $rd"
       (+ (f-op 52) rm disp10 rd (f-rsvd 0))
       (set rd (add rm (ext DI disp10)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi addil "Add immediate long"
       ()
       "addi.l $rm, $disp10, $rd"
       (+ (f-op 53) rm disp10 rd (f-rsvd 0))
       (set rd (ext DI (add (ext SI disp10) (subword SI rm 1))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi addzl "Add zero extended long"
       ()
       "addz.l $rm, $rn, $rd"
       (+ (f-op 0) rm (f-ext 12) rn rd (f-rsvd 0))
       (set rd (zext DI (add (subword SI rm 1) (subword SI rn 1))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi alloco "Allocate operand cache block"
       ()
       "alloco $rm, $disp6x32"
       (+ (f-op 56) rm (f-ext 4) disp6x32 (f-dest 63) (f-rsvd 0))
       (sequence ()
		 (set rm rm) ; for now to allow profiling
		 (unimp "alloco"))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi and "AND"
       ()
       "and $rm, $rn, $rd"
       (+ (f-op 1) rm (f-ext 11) rn rd (f-rsvd 0))
       (set rd (and rm rn))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi andc "AND complement"
       ()
       "andc $rm, $rn, $rd"
       (+ (f-op 1) rm (f-ext 15) rn rd (f-rsvd 0))
       (set rd (and rm (inv rn)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi andi "AND immediate"
       ()
       "andi $rm, $disp10, $rd"
       (+ (f-op 54) rm disp10 rd (f-rsvd 0))
       (set rd (and rm (ext DI disp10)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi beq "Branch if equal"
       ()
       "beq$likely $rm, $rn, $tra"
       (+ (f-op 25) rm (f-ext 1) rn likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-optimization likely)
		 (if (eq rm rn)
		     (set pc tra)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-cond-branch (in targetreg tra)))))

(dshmi beqi "Branch if equal immediate"
       ()
       "beqi$likely $rm, $imm6, $tra"
       (+ (f-op 57) rm (f-ext 1) imm6 likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-optimization likely)
		 (if (eq rm (ext DI imm6))
		     (set pc tra)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-cond-branch (in targetreg tra)))))

(dshmi bge "Branch if greater than or equal"
       ()
       "bge$likely $rm, $rn, $tra"
       (+ (f-op 25) rm (f-ext 3) rn likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-optimization likely)
		 (if (ge rm rn)
		     (set pc tra)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-cond-branch (in targetreg tra)))))

(dshmi bgeu "Branch if greater than or equal (unsigned comparison)"
       ()
       "bgeu$likely $rm, $rn, $tra"
       (+ (f-op 25) rm (f-ext 11) rn likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-optimization likely)
		 (if (geu rm rn)
		     (set pc tra)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-cond-branch (in targetreg tra)))))

(dshmi bgt "Branch greater than"
       ()
       "bgt$likely $rm, $rn, $tra"
       (+ (f-op 25) rm (f-ext 7) rn likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-optimization likely)
		 (if (gt rm rn)
		     (set pc tra)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-cond-branch (in targetreg tra)))))

(dshmi bgtu "Branch greater than (unsigned comparison)"
       ()
       "bgtu$likely $rm, $rn, $tra"
       (+ (f-op 25) rm (f-ext 15) rn likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-optimization likely)
		 (if (gtu rm rn)
		     (set pc tra)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-cond-branch (in targetreg tra)))))

(dshmi blink "Branch and link"
       ()
       "blink $trb, $rd"
       (+ (f-op 17) (f-6-3 0) trb (f-ext 1) (f-right 63) rd (f-rsvd 0))
       (sequence ()
		 (set rd (or (add pc 4) 1))
		 (set pc trb)
		 (if (eq (index-of rd) 63)
		     (cg-profile-jump pc trb) ; rd==r63 is used for local branches and returns
		     (cg-profile pc trb)))
       (sh5-media-models ((unit u-blink (in targetreg trb)))))

(dshmi bne "Branch if not equal"
       ()
       "bne$likely $rm, $rn, $tra"
       (+ (f-op 25) rm (f-ext 5) rn likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-optimization likely)
		 (if (ne rm rn)
		     (set pc tra)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-cond-branch (in targetreg tra)))))

(dshmi bnei "Branch if not equal immediate"
       ()
       "bnei$likely $rm, $imm6, $tra"
       (+ (f-op 57) rm (f-ext 5) rn likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-optimization likely)
		 (if (ne rm (ext DI imm6))
		     (set pc tra)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-cond-branch (in targetreg tra)))))

(dshmi brk "Breakpoint instruction"
       ()
       "brk"
       (+ (f-op 27) (f-left 63) (f-ext 5) (f-right 63) (f-dest 63) (f-rsvd 0))
       (c-call "sh64_break" pc)
       (sh5-media-models ((unit u-exec (cycles 10)))))

(define-pmacro (-byterev-step)
  (sequence ()
    (set result (or (sll result 8) (and source 255)))
    (set source (srl source 8)))
)

(dshmi byterev "Byte reverse"
       ()
       "byterev $rm, $rd"
       (+ (f-op 0) rm (f-ext 15) (f-right 63) rd (f-rsvd 0))
       (sequence ((DI source) (DI result))
		 (set source rm)
		 (set result 0)
		 (-byterev-step)
		 (-byterev-step)
		 (-byterev-step)
		 (-byterev-step)
		 (-byterev-step)
		 (-byterev-step)
		 (-byterev-step)
		 (-byterev-step)
		 (set rd result))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi cmpeq "Compare equal"
       ()
       "cmpeq $rm, $rn, $rd"
       (+ (f-op 0) rm (f-ext 1) rn rd (f-rsvd 0))
       (set rd (if DI (eq rm rn) 1 0))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi cmpgt "Compare greater than"
       ()
       "cmpgt $rm, $rn, $rd"
       (+ (f-op 0) rm (f-ext 3) rn rd (f-rsvd 0))
       (set rd (if DI (gt rm rn) 1 0))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi cmpgtu "Compare greater than (unsigned comparison)"
       ()
       "cmpgtu $rm,$rn, $rd"
       (+ (f-op 0) rm (f-ext 7) rn rd (f-rsvd 0))
       (set rd (if DI (gtu rm rn) 1 0))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi cmveq "Conditional move if equal to zero"
       ()
       "cmveq $rm, $rn, $rd"
       (+ (f-op 8) rm (f-ext 1) rn rd (f-rsvd 0))
       (if (eq rm 0)
	   (set rd rn))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi cmvne "Conditional move if not equal to zero"
       ()
       "cmvne $rm, $rn, $rd"
       (+ (f-op 8) rm (f-ext 5) rn rd (f-rsvd 0))
       (if (ne rm 0)
	   (set rd rn))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi fabsd "Floating point absolute (double)"
       ()
       "fabs.d $drgh, $drf"
       (+ (f-op 6) drgh (f-ext 1) drf (f-rsvd 0))
       (set drf (c-call DF "sh64_fabsd" drgh))
       (sh5-media-models ((unit u-use-dr (in usereg drgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg drf) (cycles 7))
			  (unit u-set-dr (out loadreg drf) (cycles 4))
			  (unit u-set-fp (out loadreg drf) (cycles 4))
			  (unit u-set-fv (out loadreg drf) (cycles 7))
			  (unit u-set-mtrx (out loadreg drf) (cycles 7)))))

(dshmi fabss "Floating point absolute (single)"
       ()
       "fabs.s $frgh, $frf"
       (+ (f-op 6) frgh (f-ext 0) frf (f-rsvd 0))
       (set frf (c-call SF "sh64_fabss" frgh))
       (sh5-media-models ((unit u-use-fr (in usereg frgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 4))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi faddd "Floating point add (double)"
       ()
       "fadd.d $drg, $drh, $drf"
       (+ (f-op 13) drg (f-ext 1) drh drf (f-rsvd 0))
       (set drf (c-call DF "sh64_faddd" drg drh))
       (sh5-media-models ((unit u-use-dr (in usereg drg))
			  (unit u-use-dr (in usereg drh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg drf) (cycles 7))
			  (unit u-set-dr (out loadreg drf) (cycles 6))
			  (unit u-set-fp (out loadreg drf) (cycles 6))
			  (unit u-set-fv (out loadreg drf) (cycles 7))
			  (unit u-set-mtrx (out loadreg drf) (cycles 7)))))

(dshmi fadds "Floating point add (single)"
       ()
       "fadd.s $frg, $frh, $frf"
       (+ (f-op 13) frg (f-ext 0) frh frf (f-rsvd 0))
       (set frf (c-call SF "sh64_fadds" frg frh))
       (sh5-media-models ((unit u-use-fr (in usereg frg))
			  (unit u-use-fr (in usereg frh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 6))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi fcmpeqd "Floating point compare if equal (double)"
       ()
       "fcmpeq.d $drg, $drh, $rd"
       (+ (f-op 12) drg (f-ext 9) drh rd (f-rsvd 0))
       (set rd (zext DI (c-call BI "sh64_fcmpeqd" drg drh)))
       (sh5-media-models ((unit u-fpu (cycles 1))
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi fcmpeqs "Floating point compare if equal (single)"
       ()
       "fcmpeq.s $frg, $frh, $rd"
       (+ (f-op 12) frg (f-ext 8) frh rd (f-rsvd 0))
       (set rd (zext DI (c-call BI "sh64_fcmpeqs" frg frh)))
       (sh5-media-models ((unit u-fpu (cycles 1))
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi fcmpged "Floating compare compare if greater than or equal (double)"
       ()
       "fcmpge.d $drg, $drh, $rd"
       (+ (f-op 12) drg (f-ext 15) drh rd (f-rsvd 0))
       (set rd (zext DI (c-call BI "sh64_fcmpged" drg drh)))
       (sh5-media-models ((unit u-fpu (cycles 1))
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi fcmpges "Floating point compare if greater than or equal (single)"
       ()
       "fcmpge.s $frg, $frh, $rd"
       (+ (f-op 12) frg (f-ext 14) frh rd (f-rsvd 0))
       (set rd (zext DI (c-call BI "sh64_fcmpges" frg frh)))
       (sh5-media-models ((unit u-fpu (cycles 1))
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi fcmpgtd "Floating point compare if greater than (double)"
       ()
       "fcmpgt.d $drg, $drh, $rd"
       (+ (f-op 12) drg (f-ext 13) drh rd (f-rsvd 0))
       (set rd (zext DI (c-call BI "sh64_fcmpgtd" drg drh)))
       (sh5-media-models ((unit u-fpu (cycles 1))
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi fcmpgts "Floating point compare if greater than (single)"
       ()
       "fcmpgt.s $frg, $frh, $rd"
       (+ (f-op 12) frg (f-ext 12) frh rd (f-rsvd 0))
       (set rd (zext DI (c-call BI "sh64_fcmpgts" frg frh)))
       (sh5-media-models ((unit u-fpu (cycles 1))
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi fcmpund "Floating point unordered comparison (double)"
       ()
       "fcmpun.d $drg, $drh, $rd"
       (+ (f-op 12) drg (f-ext 11) drh rd (f-rsvd 0))
       (set rd (zext DI (c-call BI "sh64_fcmpund" drg drh)))
       (sh5-media-models ((unit u-fpu (cycles 1))
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi fcmpuns "Floating point unordered comparison (single)"
       ()
       "fcmpun.s $frg, $frh, $rd"
       (+ (f-op 12) frg (f-ext 10) frh rd (f-rsvd 0))
       (set rd (zext DI (c-call BI "sh64_fcmpuns" frg frh)))
       (sh5-media-models ((unit u-fpu (cycles 1))
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi fcnvds "Floating point coversion (double to single)"
       ()
       "fcnv.ds $drgh, $frf"
       (+ (f-op 14) drgh (f-ext 7) frf (f-rsvd 0))
       (set frf (c-call SF "sh64_fcnvds" drgh))
       (sh5-media-models ((unit u-use-dr (in usereg drgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 6))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi fcnvsd "Floating point conversion (single to double)"
       ()
       "fcnv.sd $frgh, $drf"
       (+ (f-op 14) frgh (f-ext 6) drf (f-rsvd 0))
       (set drf (c-call DF "sh64_fcnvsd" frgh))
       (sh5-media-models ((unit u-use-fr (in usereg frgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg drf) (cycles 7))
			  (unit u-set-dr (out loadreg drf) (cycles 6))
			  (unit u-set-fp (out loadreg drf) (cycles 6))
			  (unit u-set-fv (out loadreg drf) (cycles 7))
			  (unit u-set-mtrx (out loadreg drf) (cycles 7)))))

(dshmi fdivd "Floating point divide (double)"
       ()
       "fdiv.d $drg, $drh, $drf"
       (+ (f-op 13) drg (f-ext 5) drh drf (f-rsvd 0))
       (set drf (c-call DF "sh64_fdivd" drg drh))
       (sh5-media-models ((unit u-use-dr (in usereg drg))
			  (unit u-use-dr (in usereg drh))
			  (unit u-fdivd (out loadreg drf))
			  (unit u-set-fr (out loadreg drf) (cycles 36))
			  (unit u-set-dr (out loadreg drf) (cycles 35))
			  (unit u-set-fp (out loadreg drf) (cycles 35))
			  (unit u-set-fv (out loadreg drf) (cycles 36))
			  (unit u-set-mtrx (out loadreg drf) (cycles 36)))))

(dshmi fdivs "Floating point divide (single)"
       ()
       "fdiv.s $frg, $frh, $frf"
       (+ (f-op 13) frg (f-ext 4) frh frf (f-rsvd 0))
       (set frf (c-call SF "sh64_fdivs" frg frh))
       (sh5-media-models ((unit u-use-fr (in usereg frg))
			  (unit u-use-fr (in usereg frh))
			  (unit u-fdiv (out loadreg frf))
			  (unit u-set-fr (out loadreg frf) (cycles 19))
			  (unit u-set-dr (out loadreg frf) (cycles 20))
			  (unit u-set-fp (out loadreg frf) (cycles 20))
			  (unit u-set-fv (out loadreg frf) (cycles 20))
			  (unit u-set-mtrx (out loadreg frf) (cycles 20)))))

(dshmi fgetscr "Floating point get from FPSCR"
       ()
       "fgetscr $frf"
       (+ (f-op 7) (f-left 63) (f-ext 2) (f-right 63) frf (f-rsvd 0))
       (set frf (subword SF fpscr 0))
       (sh5-media-models ((unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 6))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi fiprs "Floating point inner product (single)"
       ()
       "fipr.s $fvg, $fvh, $frf"
       (+ (f-op 5) fvg (f-ext 6) fvh frf (f-rsvd 0))
       (sequence ()
		 (set fvg fvg) ; to allow profiling
		 (set fvh fvh) ; to allow profiling
		 (set frf (c-call SF "sh64_fiprs" (index-of fvg) (index-of fvh))))
       (sh5-media-models ((unit u-use-fv (in usereg fvg))
			  (unit u-use-fv (in usereg fvh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 6))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi fldd "Floating point load (double)"
       ()
       "fld.d $rm, $disp10x8, $drf"
       (+ (f-op 39) rm disp10x8 drf (f-rsvd 0))
       (set drf (mem DF (add rm disp10x8)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-fr (out loadreg drf) (cycles 6))
			  (unit u-load-dr (out loadreg drf) (cycles 3))
			  (unit u-load-fp (out loadreg drf) (cycles 3))
			  (unit u-load-fv (out loadreg drf) (cycles 6))
			  (unit u-load-mtrx (out loadreg drf) (cycles 6)))))

(dshmi fldp "Floating point load (pair of singles)"
       ()
       "fld.p $rm, $disp10x8, $fpf"
       (+ (f-op 38) rm disp10x8 fpf (f-rsvd 0))
       (sequence ()
		 (set fpf fpf) ; to allow profiling
		 (c-call VOID "sh64_fldp" pc rm disp10x8 (index-of fpf)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-fr (out loadreg fpf) (cycles 6))
			  (unit u-load-dr (out loadreg fpf) (cycles 3))
			  (unit u-load-fp (out loadreg fpf) (cycles 3))
			  (unit u-load-fv (out loadreg fpf) (cycles 6))
			  (unit u-load-mtrx (out loadreg fpf) (cycles 6)))))

(dshmi flds "Floating point load (single)"
       ()
       "fld.s $rm, $disp10x4, $frf"
       (+ (f-op 37) rm disp10x4 frf (f-rsvd 0))
       (set frf (mem SF (add rm disp10x4)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-fr (out loadreg frf) (cycles 3))
			  (unit u-load-dr (out loadreg frf) (cycles 6))
			  (unit u-load-fp (out loadreg frf) (cycles 6))
			  (unit u-load-fv (out loadreg frf) (cycles 6))
			  (unit u-load-mtrx (out loadreg frf) (cycles 6)))))

(dshmi fldxd "Floating point extended load (double)"
       ()
       "fldx.d $rm, $rn, $drf"
       (+ (f-op 7) rm (f-ext 9) rn frf (f-rsvd 0))
       (set drf (mem DF (add rm rn)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-fr (out loadreg drf) (cycles 6))
			  (unit u-load-dr (out loadreg drf) (cycles 3))
			  (unit u-load-fp (out loadreg drf) (cycles 3))
			  (unit u-load-fv (out loadreg drf) (cycles 6))
			  (unit u-load-mtrx (out loadreg drf) (cycles 6)))))

(dshmi fldxp "Floating point extended load (pair of singles)"
       ()
       "fldx.p $rm, $rn, $fpf"
       (+ (f-op 7) rm (f-ext 13) rn fpf (f-rsvd 0))
       (sequence ()
		 (set fpf fpf) ; Allows profiling
		 (c-call VOID "sh64_fldp" pc rm rn (index-of fpf)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-fr (out loadreg fpf) (cycles 6))
			  (unit u-load-dr (out loadreg fpf) (cycles 3))
			  (unit u-load-fp (out loadreg fpf) (cycles 3))
			  (unit u-load-fv (out loadreg fpf) (cycles 6))
			  (unit u-load-mtrx (out loadreg fpf) (cycles 6)))))

(dshmi fldxs "Floating point extended load (single)"
       ()
       "fldx.s $rm, $rn, $frf"
       (+ (f-op 7) rm (f-ext 8) rn frf (f-rsvd 0))
       (set frf (mem SF (add rm rn)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-fr (out loadreg frf) (cycles 3))
			  (unit u-load-dr (out loadreg frf) (cycles 6))
			  (unit u-load-fp (out loadreg frf) (cycles 6))
			  (unit u-load-fv (out loadreg frf) (cycles 6))
			  (unit u-load-mtrx (out loadreg frf) (cycles 6)))))

(dshmi floatld "Floating point conversion (long to double)"
       ()
       "float.ld $frgh, $drf"
       (+ (f-op 14) frgh (f-ext 14) drf (f-rsvd 0))
       (set drf (c-call DF "sh64_floatld" frgh))
       (sh5-media-models ((unit u-use-fr (in usereg frgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg drf) (cycles 7))
			  (unit u-set-dr (out loadreg drf) (cycles 6))
			  (unit u-set-fp (out loadreg drf) (cycles 6))
			  (unit u-set-fv (out loadreg drf) (cycles 7))
			  (unit u-set-mtrx (out loadreg drf) (cycles 7)))))

(dshmi floatls "Floating point conversion (long to single)"
       ()
       "float.ls $frgh, $frf"
       (+ (f-op 14) frgh (f-ext 12) frf (f-rsvd 0))
       (set frf (c-call SF "sh64_floatls" frgh))
       (sh5-media-models ((unit u-use-fr (in usereg frgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 6))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi floatqd "Floating point conversion (quad to double)"
       ()
       "float.qd $drgh, $drf"
       (+ (f-op 14) drgh (f-ext 13) drf (f-rsvd 0))
       (set drf (c-call DF "sh64_floatqd" drgh))
       (sh5-media-models ((unit u-use-dr (in usereg drgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg drf) (cycles 7))
			  (unit u-set-dr (out loadreg drf) (cycles 6))
			  (unit u-set-fp (out loadreg drf) (cycles 6))
			  (unit u-set-fv (out loadreg drf) (cycles 7))
			  (unit u-set-mtrx (out loadreg drf) (cycles 7)))))

(dshmi floatqs "Floating point conversion (quad to single)"
       ()
       "float.qs $drgh, $frf"
       (+ (f-op 14) drgh (f-ext 15) frf (f-rsvd 0))
       (set frf (c-call SF "sh64_floatqs" drgh))
       (sh5-media-models ((unit u-use-dr (in usereg drgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 6))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi fmacs "Floating point multiply and accumulate (single)"
       ()
       "fmac.s $frg, $frh, $frf"
       (+ (f-op 13) frg (f-ext 14) frh frf (f-rsvd 0))
       (set frf (c-call SF "sh64_fadds" frf (c-call SF "sh64_fmuls" frg frh)))
       (sh5-media-models ((unit u-use-fr (in usereg frg))
			  (unit u-use-fr (in usereg frh))
			  (unit u-use-fr (in usereg frf))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 6))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi fmovd "Floating point move double"
       ()
       "fmov.d $drgh, $drf"
       (+ (f-op 14) drgh (f-ext 1) drf (f-rsvd 0))
       (set drf drgh)
       (sh5-media-models ((unit u-use-dr (in usereg drgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg drf) (cycles 7))
			  (unit u-set-dr (out loadreg drf) (cycles 4))
			  (unit u-set-fp (out loadreg drf) (cycles 4))
			  (unit u-set-fv (out loadreg drf) (cycles 7))
			  (unit u-set-mtrx (out loadreg drf) (cycles 7)))))

(dshmi fmovdq "Floating point move (double to quad integer)"
       ()
       "fmov.dq $drgh, $rd"
       (+ (f-op 12) drgh (f-ext 1) rd (f-rsvd 0))
       (set rd (subword DI drgh 0))
       (sh5-media-models ((unit u-fpu (cycles 1))
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi fmovls "Floating point move (lower to single)"
       ()
       "fmov.ls $rm, $frf"
       (+ (f-op 7) rm (f-ext 0) (f-right 63) frf (f-rsvd 0))
       (set frf (subword SF (subword SI rm 1) 0))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 4))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi fmovqd "Floating point move (quad to double)"
       ()
       "fmov.qd $rm, $drf"
       (+ (f-op 7) rm (f-ext 1) (f-right 63) frf (f-rsvd 0))
       (set drf (subword DF rm 0))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg drf) (cycles 7))
			  (unit u-set-dr (out loadreg drf) (cycles 4))
			  (unit u-set-fp (out loadreg drf) (cycles 4))
			  (unit u-set-fv (out loadreg drf) (cycles 7))
			  (unit u-set-mtrx (out loadreg drf) (cycles 7)))))

(dshmi fmovs "Floating point move (single)"
       ()
       "fmov.s $frgh, $frf"
       (+ (f-op 14) frgh (f-ext 0) frf (f-rsvd 0))
       (set frf frgh)
       (sh5-media-models ((unit u-use-fr (in usereg frgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 4))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi fmovsl "Floating point move (single to lower)"
       ()
       "fmov.sl $frgh, $rd"
       (+ (f-op 12) frgh (f-ext 0) rd (f-rsvd 0))
       (set rd (ext DI (subword SI frgh 1)))
       (sh5-media-models ((unit u-use-fr (in usereg frgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi fmuld "Floating point multiply (double)"
       ()
       "fmul.d $drg, $drh, $drf"
       (+ (f-op 13) drg (f-ext 7) drh drf (f-rsvd 0))
       (set drf (c-call DF "sh64_fmuld" drg drh))
       (sh5-media-models ((unit u-use-dr (in usereg drg))
			  (unit u-use-dr (in usereg drh))
			  (unit u-fpu (cycles 4))
			  (unit u-set-fr (out loadreg drf) (cycles 10))
			  (unit u-set-dr (out loadreg drf) (cycles 9))
			  (unit u-set-fp (out loadreg drf) (cycles 9))
			  (unit u-set-fv (out loadreg drf) (cycles 10))
			  (unit u-set-mtrx (out loadreg drf) (cycles 10)))))

(dshmi fmuls "Floating point multiply (single)"
       ()
       "fmul.s $frg, $frh, $frf"
       (+ (f-op 13) frg (f-ext 6) frh frf (f-rsvd 0))
       (set frf (c-call SF "sh64_fmuls" frg frh))
       (sh5-media-models ((unit u-use-fr (in usereg frg))
			  (unit u-use-fr (in usereg frh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 6))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi fnegd "Floating point negate (double)"
       ()
       "fneg.d $drgh, $drf"
       (+ (f-op 6) drgh (f-ext 3) drf (f-rsvd 0))
       (set drf (c-call DF "sh64_fnegd" drgh))
       (sh5-media-models ((unit u-use-dr (in usereg drgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg drf) (cycles 7))
			  (unit u-set-dr (out loadreg drf) (cycles 4))
			  (unit u-set-fp (out loadreg drf) (cycles 4))
			  (unit u-set-fv (out loadreg drf) (cycles 7))
			  (unit u-set-mtrx (out loadreg drf) (cycles 7)))))

(dshmi fnegs "Floating point negate (single)"
       ()
       "fneg.s $frgh, $frf"
       (+ (f-op 6) frgh (f-ext 2) frf (f-rsvd 0))
       (set frf (c-call SF "sh64_fnegs" frgh))
       (sh5-media-models ((unit u-use-fr (in usereg frgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 4))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi fputscr "Floating point put to FPSCR"
       ()
       "fputscr $frgh"
       (+ (f-op 12) frgh (f-ext 2) (f-dest 63) (f-rsvd 0))
       (set fpscr (subword SI frgh 0))
       (sh5-media-models ((unit u-exec (cycles 8)))))

(dshmi fsqrtd "Floating point square root (double)"
       ()
       "fsqrt.d $drgh, $drf"
       (+ (f-op 14) drgh (f-ext 5) drf (f-rsvd 0))
       (set drf (c-call DF "sh64_fsqrtd" drgh))
       (sh5-media-models ((unit u-use-dr (in usereg drgh))
			  (unit u-fsqrtd (out loadreg drf))
			  (unit u-set-fr (out loadreg drf) (cycles 36))
			  (unit u-set-dr (out loadreg drf) (cycles 35))
			  (unit u-set-fp (out loadreg drf) (cycles 35))
			  (unit u-set-fv (out loadreg drf) (cycles 36))
			  (unit u-set-mtrx (out loadreg drf) (cycles 36)))))

(dshmi fsqrts "Floating point squart root (single)"
       ()
       "fsqrt.s $frgh, $frf"
       (+ (f-op 14) frgh (f-ext 4) frf (f-rsvd 0))
       (set frf (c-call SF "sh64_fsqrts" frgh))
       (sh5-media-models ((unit u-use-fr (in usereg frgh))
			  (unit u-fsqrt (out loadreg frf))
			  (unit u-set-fr (out loadreg frf) (cycles 19))
			  (unit u-set-dr (out loadreg frf) (cycles 20))
			  (unit u-set-fp (out loadreg frf) (cycles 20))
			  (unit u-set-fv (out loadreg frf) (cycles 20))
			  (unit u-set-mtrx (out loadreg frf) (cycles 20)))))

(dshmi fstd "Floating point store (double)"
       ()
       "fst.d $rm, $disp10x8, $drf"
       (+ (f-op 47) rm disp10x8 drf (f-rsvd 0))
       (set (mem DF (add rm disp10x8)) drf)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-dr (in usereg drf))
			  (unit u-exec))))

(dshmi fstp "Floating point store (pair of singles)"
       ()
       "fst.p $rm, $disp10x8, $fpf"
       (+ (f-op 46) rm disp10x8 fpf (f-rsvd 0))
       (sequence ()
		 (set fpf fpf) ; Allows profiling
		 (c-call VOID "sh64_fstp" pc rm disp10x8 (index-of fpf)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-fp (in usereg fpf))
			  (unit u-exec))))

(dshmi fsts "Floating point store (single)"
       ()
       "fst.s $rm, $disp10x4, $frf"
       (+ (f-op 45) rm disp10x4 frf (f-rsvd 0))
       (set (mem SF (add rm disp10x4)) frf)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-fr (in usereg frf))
			  (unit u-exec))))

(dshmi fstxd "Floating point extended store (double)"
       ()
       "fstx.d $rm, $rn, $drf"
       (+ (f-op 15) rm (f-ext 9) rn drf (f-rsvd 0))
       (set (mem DF (add rm rn)) drf)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-use-dr (in usereg drf))
			  (unit u-exec))))

(dshmi fstxp "Floating point extended store (pair of singles)"
       ()
       "fstx.p $rm, $rn, $fpf"
       (+ (f-op 15) rm (f-ext 13) rn fpf (f-rsvd 0))
       (sequence ()
		 (set fpf fpf) ; Allows profiling
		 (c-call VOID "sh64_fstp" pc rm rn (index-of fpf)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-use-fp (in usereg fpf))
			  (unit u-exec))))

(dshmi fstxs "Floating point extended store (single)"
       ()
       "fstx.s $rm, $rn, $frf"
       (+ (f-op 15) rm (f-ext 8) rn frf (f-rsvd 0))
       (set (mem SF (add rm rn)) frf)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-use-fr (in usereg frf))
			  (unit u-exec))))

(dshmi fsubd "Floating point subtract (double)"
       ()
       "fsub.d $drg, $drh, $drf"
       (+ (f-op 13) frg (f-ext 3) frh frf (f-rsvd 0))
       (set drf (c-call DF "sh64_fsubd" drg drh))
       (sh5-media-models ((unit u-use-dr (in usereg drg))
			  (unit u-use-dr (in usereg drh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg drf) (cycles 7))
			  (unit u-set-dr (out loadreg drf) (cycles 6))
			  (unit u-set-fp (out loadreg drf) (cycles 6))
			  (unit u-set-fv (out loadreg drf) (cycles 7))
			  (unit u-set-mtrx (out loadreg drf) (cycles 7)))))

(dshmi fsubs "Floating point subtract (single)"
       ()
       "fsub.s $frg, $frh, $frf"
       (+ (f-op 13) frg (f-ext 2) frh frf (f-rsvd 0))
       (set frf (c-call SF "sh64_fsubs" frg frh))
       (sh5-media-models ((unit u-use-fr (in usereg frg))
			  (unit u-use-fr (in usereg frh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 6))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi ftrcdl "Floating point conversion (double to long)"
       ()
       "ftrc.dl $drgh, $frf"
       (+ (f-op 14) drgh (f-ext 11) frf (f-rsvd 0))
       (set frf (c-call SF "sh64_ftrcdl" drgh))
       (sh5-media-models ((unit u-use-dr (in usereg drgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 6))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi ftrcsl "Floating point conversion (single to long)"
       ()
       "ftrc.sl $frgh, $frf"
       (+ (f-op 14) frgh (f-ext 8) frf (f-rsvd 0))
       (set frf (c-call SF "sh64_ftrcsl" frgh))
       (sh5-media-models ((unit u-use-fr (in usereg frgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg frf) (cycles 6))
			  (unit u-set-dr (out loadreg frf) (cycles 7))
			  (unit u-set-fp (out loadreg frf) (cycles 7))
			  (unit u-set-fv (out loadreg frf) (cycles 7))
			  (unit u-set-mtrx (out loadreg frf) (cycles 7)))))

(dshmi ftrcdq "Floating point conversion (double to quad)"
       ()
       "ftrc.dq $drgh, $drf"
       (+ (f-op 14) drgh (f-ext 9) frf (f-rsvd 0))
       (set drf (c-call DF "sh64_ftrcdq" drgh))
       (sh5-media-models ((unit u-use-dr (in usereg drgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg drf) (cycles 7))
			  (unit u-set-dr (out loadreg drf) (cycles 6))
			  (unit u-set-fp (out loadreg drf) (cycles 6))
			  (unit u-set-fv (out loadreg drf) (cycles 7))
			  (unit u-set-mtrx (out loadreg drf) (cycles 7)))))

(dshmi ftrcsq "Floating point conversion (single to quad)"
       ()
       "ftrc.sq $frgh, $drf"
       (+ (f-op 14) frgh (f-ext 10) drf (f-rsvd 0))
       (set drf (c-call DF "sh64_ftrcsq" frgh))
       (sh5-media-models ((unit u-use-fr (in usereg frgh))
			  (unit u-fpu (cycles 1))
			  (unit u-set-fr (out loadreg drf) (cycles 7))
			  (unit u-set-dr (out loadreg drf) (cycles 6))
			  (unit u-set-fp (out loadreg drf) (cycles 6))
			  (unit u-set-fv (out loadreg drf) (cycles 7))
			  (unit u-set-mtrx (out loadreg drf) (cycles 7)))))

(dshmi ftrvs "Floating point matrix multiply"
       ()
       "ftrv.s $mtrxg, $fvh, $fvf"
       (+ (f-op 5) mtrxg (f-ext 14) fvh fvf (f-rsvd 0))
       (sequence ()
		 (set mtrxg mtrxg) ; to allow profiling
		 (set fvh fvh) ; to allow profiling
		 (set fvf fvf) ; to allow profiling
		 (c-call "sh64_ftrvs" (index-of mtrxg) (index-of fvh) (index-of fvf)))
       (sh5-media-models ((unit u-use-mtrx (in usereg mtrxg))
			  (unit u-use-fv (in usereg fvh))
			  (unit u-fpu (cycles 4))
			  (unit u-ftrvs (out loadreg fvf)))))

(dshmi getcfg "Get configuration register"
       ()
       "getcfg $rm, $disp6, $rd"
       (+ (f-op 48) rm (f-ext 15) disp6 rd (f-rsvd 0))
       (sequence ((SI address))
		 (set address (add rm disp6))
		 (save-cfg-address address)
		 (set rd (mem SI address)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-getcfg))))

(dshmi getcon "Get control register"
       ()
       "getcon $crk, $rd"
       (+ (f-op 9) crk (f-ext 15) (f-right 63) rd (f-rsvd 0))
       (set rd crk)
       (sh5-media-models ((unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(dshmi gettr "Get target register"
       ()
       "gettr $trb, $rd"
       (+ (f-op 17) (f-6-3 0) trb (f-ext 5) (f-right 63) rd (f-rsvd 0))
       (set rd trb)
       (sh5-media-models ((unit u-use-tr (in usereg trb))
			  (unit u-exec))))

(dshmi icbi "Invalidate instruction cache block"
       ()
       "icbi $rm, $disp6x32"
       (+ (f-op 56) rm (f-ext 5) disp6x32 (f-dest 63) (f-rsvd 0))
       (sequence ()
		 (set rm rm) ; for now to allow profiling
		 (unimp "icbi"))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi ldb "Load byte"
       ()
       "ld.b $rm, $disp10, $rd"
       (+ (f-op 32) rm disp10 rd (f-rsvd 0))
       (set rd (ext DI (mem QI (add rm (ext DI disp10)))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldl "Load long word"
       ()
       "ld.l $rm, $disp10x4, $rd"
       (+ (f-op 34) rm disp10x4 rd (f-rsvd 0))
       (set rd (ext DI (mem SI (add rm (ext DI disp10x4)))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldq "Load quad word"
       ()
       "ld.q $rm, $disp10x8, $rd"
       (+ (f-op 35) rm disp10x8 rd (f-rsvd 0))
       (set rd (mem DI (add rm (ext DI disp10x8))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldub "Load unsigned byte"
       ()
       "ld.ub $rm, $disp10, $rd"
       (+ (f-op 36) rm disp10 rd (f-rsvd 0))
       (set rd (zext DI (mem QI (add rm (ext DI disp10)))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi lduw "Load unsigned word"
       ()
       "ld.uw $rm, $disp10x2, $rd"
       (+ (f-op 44) rm disp10 rd (f-rsvd 0))
       (set rd (zext DI (mem HI (add rm (ext DI disp10x2)))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldw "Load word"
       ()
       "ld.w $rm, $disp10x2, $rd"
       (+ (f-op 33) rm disp10 rd (f-rsvd 0))
       (set rd (ext DI (mem HI (add rm (ext DI disp10x2)))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(define-pmacro (-ldhi-byte)
  (if (and bytecount 1)
      (set val (add (sll val 8) (zext DI (mem QI addr))))))

(define-pmacro (-ldhi-word)
  (if (and bytecount 2)
      (set val (add (sll val 16) (zext DI (mem HI (and addr -4)))))))

(define-pmacro (-ldhi-long)
  (if (and bytecount 4)
      (set val (add (sll val 32) (zext DI (mem SI (and addr -8)))))))

(dshmi ldhil "Load high part (long word)"
       ()
       "ldhi.l $rm, $disp6, $rd"
       (+ (f-op 48) rm (f-ext 6) disp6 rd (f-rsvd 0))
       (sequence ((DI addr) (QI bytecount) (SI val))
		 (set addr (add rm disp6))
		 (set bytecount (add (and addr 3) 1))
		 (set val 0)
		 (if (and bytecount 4)
		     (set rd (ext DI (mem SI (and addr -4))))
		     (if endian
			 (sequence () ; Big endian.
				   (-ldhi-word)
				   (-ldhi-byte)
				   (set rd (ext DI val)))
			 (sequence () ; Little endian.
				   (-ldhi-byte)
				   (-ldhi-word)
				   (set rd
					(ext DI
					 (sll SI val
					      (sub 32 (mul 8 bytecount)))))))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldhiq "Load high part (quad word)"
       ()
       "ldhi.q $rm, $disp6, $rd"
       (+ (f-op 48) rm (f-ext 7) disp6 rd (f-rsvd 0))
       (sequence ((DI addr) (QI bytecount) (DI val))
		 (set addr (add rm disp6))
		 (set bytecount (add (and addr 7) 1))
		 (set val 0)
		 (if (and bytecount 8)
		     (set rd (mem DI (and addr -8)))
		     (if endian
			 (sequence () ; Big endian.
				   (-ldhi-long)
				   (-ldhi-word)
				   (-ldhi-byte)
				   (set rd val))
			 (sequence () ; Little endian.
				   (-ldhi-byte)
				   (-ldhi-word)
				   (-ldhi-long)
				   (set rd
					(sll val
					     (sub 64 (mul 8 bytecount))))))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(define-pmacro (-ldlo-byte)
  (if (and bytecount 1)
      (set val (add (sll val 8) (zext DI (mem QI addr))))))

(define-pmacro (-ldlo-word)
  (if (and bytecount 2)
      (set val (add (sll val 16) (zext DI (mem HI (and (add addr 1) -2)))))))

(define-pmacro (-ldlo-long)
  (if (and bytecount 4)
      (set val (add (sll val 32) (zext DI (mem SI (and (add addr 3) -4)))))))

(dshmi ldlol "Load low part (long word)"
       ()
       "ldlo.l $rm, $disp6, $rd"
       (+ (f-op 48) rm (f-ext 2) disp6 rd (f-rsvd 0))
       (sequence ((DI addr) (QI bytecount) (SI val))
		 (set addr (add rm disp6))
		 (set bytecount (sub 4 (and addr 3)))
		 (set val 0)
		 (if (and bytecount 4)
		     (set rd (ext DI (mem SI addr)))
		     (if endian
			 (sequence () ; Big endian.
				   (-ldlo-byte)
				   (-ldlo-word)
				   (set rd
					(ext DI
					 (sll SI val
					      (sub 32 (mul 8 bytecount))))))
			 (sequence () ; Little endian.
				   (-ldlo-word)
				   (-ldlo-byte)
				   (set rd (ext DI val))))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldloq "Load low part (quad word)"
       ()
       "ldlo.q $rm, $disp6, $rd"
       (+ (f-op 48) rm (f-ext 3) disp6 rd (f-rsvd 0))
       (sequence ((DI addr) (QI bytecount) (DI val))
		 (set addr (add rm disp6))
		 (set bytecount (sub 8 (and addr 7)))
		 (set val 0)
		 (if (and bytecount 8)
		     (set rd (mem DI addr))
		     (if endian
			 (sequence () ; Big endian.
				   (-ldlo-byte)
				   (-ldlo-word)
				   (-ldlo-long)
				   (set rd
					(sll val (sub 64 (mul 8 bytecount)))))
			 (sequence () ; Little endian.
				   (-ldlo-long)
				   (-ldlo-word)
				   (-ldlo-byte)
				   (set rd val)))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldxb "Load byte (extended displacement)"
       ()
       "ldx.b $rm, $rn, $rd"
       (+ (f-op 16) rm (f-ext 0) rn rd (f-rsvd 0))
       (set rd (ext DI (mem QI (add rm rn))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldxl "Load long word (extended displacement)"
       ()
       "ldx.l $rm, $rn, $rd"
       (+ (f-op 16) rm (f-ext 2) rn rd (f-rsvd 0))
       (set rd (ext DI (mem SI (add rm rn))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldxq "Load quad word (extended displacement)"
       ()
       "ldx.q $rm, $rn, $rd"
       (+ (f-op 16) rm (f-ext 3) rn rd (f-rsvd 0))
       (set rd (mem DI (add rm rn)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldxub "Load unsigned byte (extended displacement)"
       ()
       "ldx.ub $rm, $rn, $rd"
       (+ (f-op 16) rm (f-ext 4) rn rd (f-rsvd 0))
       (set rd (zext DI (mem UQI (add rm rn))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldxuw "Load unsigned word (extended displacement)"
       ()
       "ldx.uw $rm, $rn, $rd"
       (+ (f-op 16) rm (f-ext 5) rn rd (f-rsvd 0))
       (set rd (zext DI (mem UHI (add rm rn))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))

(dshmi ldxw "Load word (extended displacement)"
       ()
       "ldx.w $rm, $rn, $rd"
       (+ (f-op 16) rm (f-ext 1) rn rd (f-rsvd 0))
       (set rd (ext DI (mem HI (add rm rn))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-memory-access)
			  (unit u-load-gr (out loadreg rd)))))


; Macros to facilitate multimedia instructions.

(define-pmacro (slice-byte expr)
  (sequence ((QI result7) (QI result6) (QI result5) (QI result4)
	     (QI result3) (QI result2) (QI result1) (QI result0))
	    (set result0 (expr (subword QI rm 7) (subword QI rn 7)))
	    (set result1 (expr (subword QI rm 6) (subword QI rn 6)))
	    (set result2 (expr (subword QI rm 5) (subword QI rn 5)))
	    (set result3 (expr (subword QI rm 4) (subword QI rn 4)))
	    (set result4 (expr (subword QI rm 3) (subword QI rn 3)))
	    (set result5 (expr (subword QI rm 2) (subword QI rn 2)))
	    (set result6 (expr (subword QI rm 1) (subword QI rn 1)))
	    (set result7 (expr (subword QI rm 0) (subword QI rn 0)))
	    (set rd (-join-qi result7 result6 result5 result4 result3 result2
			   result1 result0))))

(define-pmacro (slice-word expr)
  (sequence ((HI result3) (HI result2) (HI result1) (HI result0))
	    (set result0 (expr (subword HI rm 3) (subword HI rn 3)))
	    (set result1 (expr (subword HI rm 2) (subword HI rn 2)))
	    (set result2 (expr (subword HI rm 1) (subword HI rn 1)))
	    (set result3 (expr (subword HI rm 0) (subword HI rn 0)))
	    (set rd (-join-hi result3 result2 result1 result0))))

(define-pmacro (slice-word-unop expr)
  (sequence ((HI result3) (HI result2) (HI result1) (HI result0))
	    (set result0 (expr (subword HI rm 3)))
	    (set result1 (expr (subword HI rm 2)))
	    (set result2 (expr (subword HI rm 1)))
	    (set result3 (expr (subword HI rm 0)))
	    (set rd (-join-hi result3 result2 result1 result0))))

(define-pmacro (slice-long expr)
  (sequence ((SI result1) (SI result0))
	    (set result0 (expr (subword SI rm 1) (subword SI rn 1)))
	    (set result1 (expr (subword SI rm 0) (subword SI rn 0)))
	    (set rd (-join-si result1 result0))))

(define-pmacro (slice-long-unop expr)
  (sequence ((SI result1) (SI result0))
	    (set result0 (expr (subword SI rm 1)))
	    (set result1 (expr (subword SI rm 0)))
	    (set rd (-join-si result1 result0))))

; Multimedia instructions.

(dshmi mabsl "Multimedia absolute value (long word)"
       ()
       "mabs.l $rm, $rd"
       (+ (f-op 10) rm (f-ext 10) (f-right 63) rd (f-rsvd 0))
       (slice-long-unop abs)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(dshmi mabsw "Multimedia absolute value (word)"
       ()
       "mabs.w $rm, $rd"
       (+ (f-op 10) rm (f-ext 9) (f-right 63) rd (f-rsvd 0))
       (slice-word-unop abs)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(dshmi maddl "Multimedia add (long word)"
       ()
       "madd.l $rm, $rn, $rd"
       (+ (f-op 2) rm (f-ext 2) rn rd (f-rsvd 0))
       (slice-long add)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi maddw "Multimedia add (word)"
       ()
       "madd.w $rm, $rn, $rd"
       (+ (f-op 2) rm (f-ext 1) rn rd (f-rsvd 0))
       (slice-word add)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(define-pmacro (-maddsl arg1 arg2) (saturate SI 32 (add (ext DI arg1)
							(ext DI arg2))))
(dshmi maddsl "Multimedia add (saturating, long word)"
       ()
       "madds.l $rm, $rn, $rd"
       (+ (f-op 2) rm (f-ext 6) rn rd (f-rsvd 0))
       (slice-long -maddsl)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-maddsub arg1 arg2) (usaturate QI 8 (add (zext DI arg1)
							 (zext DI arg2))))
(dshmi maddsub "Multimedia add (saturating, unsigned byte)"
       ()
       "madds.ub $rm, $rn, $rd"
       (+ (f-op 2) rm (f-ext 4) rn rd (f-rsvd 0))
       (slice-byte -maddsub)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-maddsw arg1 arg2) (saturate HI 16 (add (ext DI arg1)
							(ext DI arg2))))
(dshmi maddsw "Multimedia add (saturating, word)"
       ()
       "madds.w $rm, $rn, $rd"
       (+ (f-op 2) rm (f-ext 5) rn rd (f-rsvd 0))
       (slice-word -maddsw)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-mcmpeq mode arg1 arg2)
  (if mode (eq arg1 arg2) (inv mode 0) (const mode 0)))

(define-pmacro (-mcmpeqb arg1 arg2) (-mcmpeq QI arg1 arg2))
(dshmi mcmpeqb "Multimedia compare equal (byte)"
       ()
       "mcmpeq.b $rm, $rn, $rd"
       (+ (f-op 10) rm (f-ext 0) rn rd (f-rsvd 0))
       (slice-byte -mcmpeqb)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-mcmpeql arg1 arg2) (-mcmpeq SI arg1 arg2))
(dshmi mcmpeql "Multimedia compare equal (long word)"
       ()
       "mcmpeq.l $rm, $rn, $rd"
       (+ (f-op 10) rm (f-ext 2) rn rd (f-rsvd 0))
       (slice-long -mcmpeql)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-mcmpeqw arg1 arg2) (-mcmpeq HI arg1 arg2))
(dshmi mcmpeqw "Multimedia compare equal (word)"
       ()
       "mcmpeq.w $rm, $rn, $rd"
       (+ (f-op 10) rm (f-ext 1) rn rd (f-rsvd 0))
       (slice-word -mcmpeqw)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-mcmpgt mode arg1 arg2)
  (if mode (gt arg1 arg2) (inv mode 0) (const mode 0)))
(define-pmacro (-mcmpgtu mode arg1 arg2)
  (if mode (gtu arg1 arg2) (inv mode 0) (const mode 0)))

(define-pmacro (-mcmpgtl arg1 arg2) (-mcmpgt SI arg1 arg2))
(dshmi mcmpgtl "Multimedia compare greater than (long word)"
       ()
       "mcmpgt.l $rm, $rn, $rd"
       (+ (f-op 10) rm (f-ext 6) rn rd (f-rsvd 0))
       (slice-long -mcmpgtl)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-mcmpgtub arg1 arg2) (-mcmpgtu QI arg1 arg2))
(dshmi mcmpgtub "Multimediate compare unsigned greater than (byte)"
       ()
       "mcmpgt.ub $rm, $rn, $rd"
       (+ (f-op 10) rm (f-ext 4) rn rd (f-rsvd 0))
       (slice-byte -mcmpgtub)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-mcmpgtw arg1 arg2) (-mcmpgt HI arg1 arg2))
(dshmi mcmpgtw "Multimedia compare greater than (word)"
       ()
       "mcmpgt.w $rm, $rn, $rd"
       (+ (f-op 10) rm (f-ext 5) rn rd (f-rsvd 0))
       (slice-word -mcmpgtw)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(dshmi mcmv "Multimedia conditional move"
       ()
       "mcmv $rm, $rn, $rd"
       (+ (f-op 18) rm (f-ext 3) rn rd (f-rsvd 0))
       (set rd (or (and rm rn) (and rd (inv rn))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi mcnvslw "Multimedia convert/saturate (long to word)"
       ()
       "mcnvs.lw $rm, $rn, $rd"
       (+ (f-op 19) rm (f-ext 13) rn rd (f-rsvd 0))
       (sequence ((HI result3) (HI result2) (HI result1) (HI result0))
		 (set result0 (saturate HI 16 (subword SI rm 1)))
		 (set result1 (saturate HI 16 (subword SI rm 0)))
		 (set result2 (saturate HI 16 (subword SI rn 1)))
		 (set result3 (saturate HI 16 (subword SI rn 0)))
		 (set rd (-join-hi result3 result2 result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(dshmi mcnvswb "Multimedia convert/saturate (word to byte)"
       ()
       "mcnvs.wb $rm, $rn, $rd"
       (+ (f-op 19) rm (f-ext 8) rn rd (f-rsvd 0))
       (sequence ((QI result7) (QI result6) (QI result5) (QI result4) 
		  (QI result3) (QI result2) (QI result1) (QI result0))
		 (set result0 (saturate QI 8 (subword HI rm 3)))
		 (set result1 (saturate QI 8 (subword HI rm 2)))
		 (set result2 (saturate QI 8 (subword HI rm 1)))
		 (set result3 (saturate QI 8 (subword HI rm 0)))
		 (set result4 (saturate QI 8 (subword HI rn 3)))
		 (set result5 (saturate QI 8 (subword HI rn 2)))
		 (set result6 (saturate QI 8 (subword HI rn 1)))
		 (set result7 (saturate QI 8 (subword HI rn 0)))
		 (set rd (-join-qi result7 result6 result5 result4
				 result3 result2 result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(dshmi mcnvswub "Multimedia convert/saturate (word to unsigned byte)"
       ()
       "mcnvs.wub $rm, $rn, $rd"
       (+ (f-op 19) rm (f-ext 12) rn rd (f-rsvd 0))
       (sequence ((QI result7) (QI result6) (QI result5) (QI result4)
			       (QI result3) (QI result2) (QI result1) (QI result0))
		 (set result0 (usaturate QI 8 (subword HI rm 3)))
		 (set result1 (usaturate QI 8 (subword HI rm 2)))
		 (set result2 (usaturate QI 8 (subword HI rm 1)))
		 (set result3 (usaturate QI 8 (subword HI rm 0)))
		 (set result4 (usaturate QI 8 (subword HI rn 3)))
		 (set result5 (usaturate QI 8 (subword HI rn 2)))
		 (set result6 (usaturate QI 8 (subword HI rn 1)))
		 (set result7 (usaturate QI 8 (subword HI rn 0)))
		 (set rd (-join-qi result7 result6 result5 result4 result3
				 result2 result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

; mexter -- generate an mexterN instruction, where:
;   op = primary opcode
;   extop = extended opcode

(define-pmacro (make-mextr n op extop)
  (dshmi (.sym mextr n)
	 (.str "Multimedia extract 64-bit slice (from byte " n ")")
	 ()
	 (.str "mextr" n " $rm, $rn, $rd")
	 (+ (f-op op) rm (f-ext extop) rn rd (f-rsvd 0))
	 (sequence ((QI count) (DI mask) (DI rhs))
		   (set count (mul QI 8 n))
		   (set mask (sll DI (inv 0) count))
		   (set rhs (srl (and rm mask) count))
		   (set count (mul QI 8 (sub QI 8 n)))
		   (set mask (srl DI (inv 0) count))
		   (set rd (or DI rhs (sll DI (and rn mask) count))))
	 (sh5-media-models ((unit u-use-gr (in usereg rm))
			    (unit u-use-gr (in usereg rn))
			    (unit u-exec)))))

(make-mextr 1 10  7)
(make-mextr 2 10 11)
(make-mextr 3 10 15)
(make-mextr 4 11  3)
(make-mextr 5 11  7)
(make-mextr 6 11 11)
(make-mextr 7 11 15)

(dshmi mmacfxwl "Multimedia fractional multiply (word to long)"
       ()
       "mmacfx.wl $rm, $rn, $rd"
       (+ (f-op 18) rm (f-ext 1) rn rd (f-rsvd 0))
       (sequence ((SI temp) (SI result1) (SI result0))
		 (set result0 (subword SI rd 1))
		 (set result1 (subword SI rd 0))
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
		 (set temp (saturate SI 32 (sll DI temp 1)))
		 (set result0 (saturate SI 32 (add (ext DI result0)
						   (ext DI temp))))
		 (set temp (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
		 (set temp (saturate SI 32 (sll DI temp 1)))
		 (set result1 (saturate SI 32 (add (ext DI result1)
						   (ext DI temp))))
		 (set rd (-join-si result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi mmacnfx.wl "Multimedia fractional multiple (word to long)"
       ()
       "mmacnfx.wl $rm, $rn, $rd"
       (+ (f-op 18) rn (f-ext 5) rn rd (f-rsvd 0))
       (sequence ((SI temp) (SI result1) (SI result0))
		 (set result0 (subword SI rd 1))
		 (set result1 (subword SI rd 0))
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
		 (set temp (saturate SI 32 (sll DI temp 1)))
		 (set result0 (saturate SI 32 (sub (ext DI result0)
						   (ext DI temp))))
		 (set temp (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
		 (set temp (saturate SI 32 (sll DI temp 1)))
		 (set result1 (saturate SI 32 (sub (ext DI result1)
						   (ext DI temp))))
		 (set rd (-join-si result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi mmull "Multimedia multiply (long word)"
       ()
       "mmul.l $rm, $rn, $rd"
       (+ (f-op 19) rm (f-ext 2) rn rd (f-rsvd 0))
       (slice-long mul)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec (cycles 2))
			  (unit u-set-gr (cycles 4) (out loadreg rd)))))

(dshmi mmulw "Multimedia multiply (word)"
       ()
       "mmul.w $rm, $rn, $rd"
       (+ (f-op 19) rm (f-ext 1) rn rd (f-rsvd 0))
       (slice-word mul)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi mmulfxl "Multimedia fractional multiply (long word)"
       ()
       "mmulfx.l $rm, $rn, $rd"
       (+ (f-op 19) rm (f-ext 6) rn rd (f-rsvd 0))
       (sequence ((DI temp) (SI result0) (SI result1))
		 (set temp (mul (zext DI (subword SI rm 1)) (zext DI (subword SI rn 1))))
		 (set result0 (saturate SI 32 (sra temp 31)))
		 (set temp (mul (zext DI (subword SI rm 0)) (zext DI (subword SI rn 0))))
		 (set result1 (saturate SI 32 (sra temp 31)))
		 (set rd (-join-si result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec (cycles 2))
			  (unit u-set-gr (cycles 4) (out loadreg rd)))))

(dshmi mmulfxw "Multimedia fractional multiply (word)"
       ()
       "mmulfx.w $rm, $rn, $rd"
       (+ (f-op 19) rm (f-ext 5) rn rd (f-rsvd 0))
       (sequence ((SI temp) (HI result0) (HI result1) (HI result2) (HI result3))
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
		 (set result0 (saturate HI 16 (sra temp 15)))
		 (set temp (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
		 (set result1 (saturate HI 16 (sra temp 15)))
		 (set temp (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
		 (set result2 (saturate HI 16 (sra temp 15)))
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
		 (set result3 (saturate HI 16 (sra temp 15)))
		 (set rd (-join-hi result3 result2 result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi mmulfxrpw "Multimedia fractional multiply round positive (word op)"
       ()
       "mmulfxrp.w $rm, $rn, $rd"
       (+ (f-op 19) rm (f-ext 9) rn rd (f-rsvd 0))
       (sequence ((SI temp) (HI result0) (HI result1) (HI result2) (HI result3) (HI c))
		 (set c (sll 1 14))
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
		 (set result0 (saturate HI 16 (sra (add temp c) 15)))
		 (set temp (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
		 (set result1 (saturate HI 16 (sra (add temp c) 15)))
		 (set temp (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
		 (set result2 (saturate HI 16 (sra (add temp c) 15)))
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
		 (set result3 (saturate HI 16 (sra (add temp c) 15)))
		 (set rd (-join-hi result3 result2 result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi mmulhiwl "Multimedia multiply higher halves (word to long)"
       ()
       "mmulhi.wl $rm, $rn, $rd"
       (+ (f-op 19) rm (f-ext 14) rn rd (f-rsvd 0))
       (sequence ((SI result1) (SI result0))
		 (set result0 (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
		 (set result1 (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
		 (set rd (-join-si result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi mmullowl "Multimedia multiply lower halves (word to long)"
       ()
       "mmullo.wl $rm, $rn, $rd"
       (+ (f-op 19) rm (f-ext 10) rn rd (f-rsvd 0))
       (sequence ((SI result1) (SI result0))
		 (set result0 (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
		 (set result1 (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
		 (set rd (-join-si result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi mmulsumwq "Multimedia multiply and accumulate (word to quad)"
       ()
       "mmulsum.wq $rm, $rn, $rd"
       (+ (f-op 18) rm (f-ext 9) rn rd (f-rsvd 0))
       (sequence ((DI acc))
		 (set acc (mul SI (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
		 (set acc (add acc (mul SI (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1)))))
		 (set acc (add acc (mul SI (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2)))))
		 (set acc (add acc (mul SI (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3)))))
		 (set rd (add rd acc)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi movi "Move immediate"
       ()
       "movi $imm16, $rd"
       (+ (f-op 51) imm16 rd (f-rsvd 0))
       (set rd (ext DI imm16))
       ())

(dshmi mpermw "Multimedia permutate word"
       ()
       "mperm.w $rm, $rn, $rd"
       (+ (f-op 10) rm (f-ext 13) rn rd (f-rsvd 0))
       (sequence ((QI control) (HI result3) (HI result2) (HI result1) (HI result0))
		 (set control (and QI rn #xff))
		 (set result0 (subword HI rm (sub 3 (and control 3))))
		 (set result1 (subword HI rm (sub 3 (and (srl control 2) 3))))
		 (set result2 (subword HI rm (sub 3 (and (srl control 4) 3))))
		 (set result3 (subword HI rm (sub 3 (and (srl control 6) 3))))
		 (set rd (-join-hi result3 result2 result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi msadubq "Multimedia absolute difference (byte)"
       ()
       "msad.ubq $rm, $rn, $rd"
       (+ (f-op 18) rm (f-ext 0) rn rd (f-rsvd 0))
       (sequence ((DI acc))
		 (set acc (abs DI (sub (subword QI rm 0) (subword QI rn 0))))
		 (set acc (add DI acc (abs (sub (subword QI rm 1) (subword QI rn 1)))))
		 (set acc (add DI acc (abs (sub (subword QI rm 2) (subword QI rn 2)))))
		 (set acc (add DI acc (abs (sub (subword QI rm 3) (subword QI rn 3)))))
		 (set acc (add DI acc (abs (sub (subword QI rm 4) (subword QI rn 4)))))
		 (set acc (add DI acc (abs (sub (subword QI rm 5) (subword QI rn 5)))))
		 (set acc (add DI acc (abs (sub (subword QI rm 6) (subword QI rn 6)))))
		 (set acc (add DI acc (abs (sub (subword QI rm 7) (subword QI rn 7)))))
		 (set rd (add rd acc)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(define-pmacro (-mshaldsl arg) (saturate SI 32 (sll DI arg (and rn 31))))
(dshmi mshaldsl "Multimedia saturating arithmetic left shift (long word)"
       ()
       "mshalds.l $rm, $rn, $rd"
       (+ (f-op 3) rm (f-ext 6) rn rd (f-rsvd 0))
       (slice-long-unop -mshaldsl)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-mshaldsw arg) (saturate HI 16 (sll DI arg (and rn 15))))
(dshmi mshaldsw "Multimedia saturating arithmetic left shift (word)"
       ()
       "mshalds.w $rm, $rn, $rd"
       (+ (f-op 3) rm (f-ext 5) rn rd (f-rsvd 0))
       (slice-word-unop -mshaldsw)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-mshardl arg) (sra arg (and rn 31)))
(dshmi mshardl "Multimedia arithmetic right shift (long)"
       ()
       "mshard.l $rm, $rn, $rd"
       (+ (f-op 3) rm (f-ext 10) rn rd (f-rsvd 0))
       (slice-long-unop -mshardl)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(define-pmacro (-mshardw arg) (sra arg (and rn 15)))
(dshmi mshardw "Multimedia arithmetic right shift (word)"
       ()
       "mshard.w $rm, $rn, $rd"
       (+ (f-op 3) rm (f-ext 9) rn rd (f-rsvd 0))
       (slice-word-unop -mshardw)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi mshardsq "Multimedia saturating arithmetic right shift (quad word)"
       ()
       "mshards.q $rm, $rn, $rd"
       (+ (f-op 3) rm (f-ext 11) rn rd (f-rsvd 0))
       (set rd (saturate DI 16 (sra rm (and rn 63))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(dshmi mshfhib "Multimedia shuffle higher-half (byte)"
       ()
       "mshfhi.b $rm, $rn, $rd"
       (+ (f-op 11) rm (f-ext 4) rn rd (f-rsvd 0))
       (sequence ((QI result7) (QI result6) (QI result5) (QI result4)
		  (QI result3) (QI result2) (QI result1) (QI result0))
		 (set result0 (subword QI rm 3))
		 (set result1 (subword QI rn 3))
		 (set result2 (subword QI rm 2))
		 (set result3 (subword QI rn 2))
		 (set result4 (subword QI rm 1))
		 (set result5 (subword QI rn 1))
		 (set result6 (subword QI rm 0))
		 (set result7 (subword QI rn 0))
		 (set rd (-join-qi result7 result6 result5 result4 result3
				 result2 result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi mshfhil "Multimedia shuffle higher-half (long)"
       ()
       "mshfhi.l $rm, $rn, $rd"
       (+ (f-op 11) rm (f-ext 6) rn rd (f-rsvd 0))
       (sequence ((SI result1) (SI result0))
		 (set result0 (subword SI rm 0))
		 (set result1 (subword SI rn 0))
		 (set rd (-join-si result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi mshfhiw "Multimedia shuffle higher-half (word)"
       ()
       "mshfhi.w $rm, $rn, $rd"
       (+ (f-op 11) rm (f-ext 5) rn rd (f-rsvd 0))
       (sequence ((HI result3) (HI result2) (HI result1) (HI result0))
		 (set result0 (subword HI rm 1))
		 (set result1 (subword HI rn 1))
		 (set result2 (subword HI rm 0))
		 (set result3 (subword HI rn 0))
		 (set rd (-join-hi result3 result2 result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi mshflob "Multimedia shuffle lower-half (byte)"
       ()
       "mshflo.b $rm, $rn, $rd"
       (+ (f-op 11) rm (f-ext 0) rn rd (f-rsvd 0))
       (sequence ((QI result7) (QI result6) (QI result5) (QI result4)
		  (QI result3) (QI result2) (QI result1) (QI result0))
		 (set result0 (subword QI rm 7))
		 (set result1 (subword QI rn 7))
		 (set result2 (subword QI rm 6))
		 (set result3 (subword QI rn 6))
		 (set result4 (subword QI rm 5))
		 (set result5 (subword QI rn 5))
		 (set result6 (subword QI rm 4))
		 (set result7 (subword QI rn 4))
		 (set rd (-join-qi result7 result6 result5 result4 result3
				 result2 result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi mshflol "Multimedia shuffle lower-half (long)"
       ()
       "mshflo.l $rm, $rn, $rd"
       (+ (f-op 11) rm (f-ext 2) rn rd (f-rsvd 0))
       (sequence ((SI result1) (SI result0))
		 (set result0 (subword SI rm 1))
		 (set result1 (subword SI rn 1))
		 (set rd (-join-si result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi mshflow "Multimedia shuffle lower-half (word)"
       ()
       "mshflo.w $rm, $rn, $rd"
       (+ (f-op 11) rm (f-ext 1) rn rd (f-rsvd 0))
       (sequence ((HI result3) (HI result2) (HI result1) (HI result0))
		 (set result0 (subword HI rm 3))
		 (set result1 (subword HI rn 3))
		 (set result2 (subword HI rm 2))
		 (set result3 (subword HI rn 2))
		 (set rd (-join-hi result3 result2 result1 result0)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(define-pmacro (-mshlldl arg) (sll arg (and rn 31)))
(dshmi mshlldl "Multimedia logical left shift (long word)"
       ()
       "mshlld.l $rm, $rn, $rd"
       (+ (f-op 3) rm (f-ext 2) rn rd (f-rsvd 0))
       (slice-long-unop -mshlldl)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(define-pmacro (-mshlldw arg) (sll arg (and rn 15)))
(dshmi mshlldw "Multimedia logical left shift (word)"
       ()
       "mshlld.w $rm, $rn, $rd"
       (+ (f-op 3) rm (f-ext 1) rn rd (f-rsvd 0))
       (slice-word-unop -mshlldw)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(define-pmacro (-mshlrdl arg) (srl arg (and rn 31)))
(dshmi mshlrdl "Multimedia logical right shift (long word)"
       ()
       "mshlrd.l $rm, $rn, $rd"
       (+ (f-op 3) rm (f-ext 14) rn rd (f-rsvd 0))
       (slice-long-unop -mshlrdl)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(define-pmacro (-mshlrdw arg) (srl arg (and rn 15)))
(dshmi mshlrdw "Multimedia logical right shift (word)"
       ()
       "mshlrd.w $rm, $rn, $rd"
       (+ (f-op 3) rm (f-ext 13) rn rd (f-rsvd 0))
       (slice-word-unop -mshlrdw)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi msubl "Multimedia subtract (long word)"
       ()
       "msub.l $rm, $rn, $rd"
       (+ (f-op 2) rm (f-ext 10) rn rd (f-rsvd 0))
       (slice-long sub)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi msubw "Multimedia add (word)"
       ()
       "msub.w $rm, $rn, $rd"
       (+ (f-op 2) rm (f-ext 9) rn rd (f-rsvd 0))
       (slice-word sub)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(define-pmacro (-msubsl arg1 arg2) (saturate SI 32 (sub (ext DI arg1)
							(ext DI arg2))))
(dshmi msubsl "Multimedia subtract (saturating long)"
       ()
       "msubs.l $rm, $rn, $rd"
       (+ (f-op 2) rm (f-ext 14) rn rd (f-rsvd 0))
       (slice-long -msubsl)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-msubsub arg1 arg2) (usaturate QI 8 (sub (zext DI arg1)
							 (zext DI arg2))))
(dshmi msubsub "Multimedia subtract (saturating byte)"
       ()
       "msubs.ub $rm, $rn, $rd"
       (+ (f-op 2) rm (f-ext 12) rn rd (f-rsvd 0))
       (slice-byte -msubsub)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(define-pmacro (-msubsw arg1 arg2) (saturate HI 16 (sub (ext DI arg1)
							(ext DI arg2))))
(dshmi msubsw "Multimedia subtract (saturating word)"
       ()
       "msubs.w $rm, $rn, $rd"
       (+ (f-op 2) rm (f-ext 13) rn rd (f-rsvd 0))
       (slice-byte -msubsw)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 2) (out loadreg rd)))))

(dshmi mulsl "Multiply signed long"
       ()
       "muls.l $rm, $rn, $rd"
       (+ (f-op 1) rm (f-ext 14) rn rd (f-rsvd 0))
       (set rd (mul (ext DI (subword SI rm 1)) (ext DI (subword SI rn 1))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi mulul "Multiply unsigned long"
       ()
       "mulu.l $rm, $rn, $rd"
       (+ (f-op 0) rm (f-ext 14) rn rd (f-rsvd 0))
       (set rd (mul (zext DI (subword SI rm 1)) (zext DI (subword SI rn 1))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-set-gr (cycles 3) (out loadreg rd)))))

(dshmi nop "No operation"
       ()
       "nop"
       (+ (f-op 27) (f-left 63) (f-ext 0) (f-right 63) (f-dest 63) (f-rsvd 0))
       (nop)
       ())

(dshmi nsb "Number of consecutive sign bits"
       ()
       "nsb $rm, $rd"
       (+ (f-op 0) rm (f-ext 13) (f-right 63) rd (f-rsvd 0))
       ; Semantics requires a loop construct, so punt to C.
       (set rd (c-call DI "sh64_nsb" rm))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi ocbi "Invalidate operand cache block"
       ()
       "ocbi $rm, $disp6x32"
       (+ (f-op 56) rm (f-ext 9) disp6x32 (f-dest 63) (f-rsvd 0))
       (sequence ()
		 (set rm rm) ; for now to allow profiling
		 (unimp "ocbi"))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi ocbp "Purge operand cache block"
       ()
       "ocbp $rm, $disp6x32"
       (+ (f-op 56) rm (f-ext 8) disp6x32 (f-dest 63) (f-rsvd 0))
       (sequence ()
		 (set rm rm) ; for now to allow profiling
		 (unimp "ocbp"))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi ocbwb "Write-back operand cache block"
       ()
       "ocbwb $rm, $disp6x32"
       (+ (f-op 56) rm (f-ext 12) disp6x32 (f-dest 63) (f-rsvd 0))
       (sequence ()
		 (set rm rm) ; for now to allow profiling
		 (unimp "ocbwb"))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi or "OR"
       ()
       "or $rm, $rn, $rd"
       (+ (f-op 1) rm (f-ext 9) rn rd (f-rsvd 0))
       (set rd (or rm rn))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi ori "OR immediate"
       ()
       "ori $rm, $imm10, $rd"
       (+ (f-op 55) rm imm10 rd (f-rsvd 0))
       (set rd (or rm (ext DI imm10)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi prefi "Prefetch instruction"
       ()
       "prefi $rm, $disp6x32"
       (+ (f-op 56) rm (f-ext 1) disp6x32 (f-right 63) (f-rsvd 0))
       (sequence ()
		 (set rm rm) ; for now to allow profiling
		 (unimp "prefi"))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi pta "Prepare target register for SHmedia target"
       ()
       "pta$likely $disp16, $tra"
       (+ (f-op 58) disp16 likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-prediction (index-of tra) likely)
		 (set tra (add disp16 1)))
       (sh5-media-models ((unit u-exec)
			  (unit u-pt (out targetreg tra)))))

(dshmi ptabs "Prepare target register with absolute value from register"
       ()
       "ptabs$likely $rn, $tra"
       (+ (f-op 26) (f-left 63) (f-ext 1) rn likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-prediction (index-of tra) likely)
		 (set tra rn))
       (sh5-media-models ((unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-pt (out targetreg tra)))))

(dshmi ptb "Prepare target register for SHcompact target"
       ()
       "ptb$likely $disp16, $tra"
       (+ (f-op 59) disp16 likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-prediction (index-of tra) likely)
		 (set tra disp16))
       (sh5-media-models ((unit u-exec)
			  (unit u-pt (out targetreg tra)))))

(dshmi ptrel "Prepare target register with relative value from register"
       ()
       "ptrel$likely $rn, $tra"
       (+ (f-op 26) (f-left 63) (f-ext 5) rn likely (f-23-2 0) tra (f-rsvd 0))
       (sequence ()
		 (save-branch-prediction (index-of tra) likely)
		 (set tra (add pc rn)))
       (sh5-media-models ((unit u-use-gr (in usereg rn))
			  (unit u-exec)
			  (unit u-pt (out targetreg tra)))))

(dshmi putcfg "Put configuration register"
       ()
       "putcfg $rm, $disp6, $rd"
       (+ (f-op 56) rm (f-ext 15) disp6 rd (f-rsvd 0))
       (sequence ((SI address))
		 (set address (add rm disp6))
		 (save-cfg-address address)
		 (set (mem SI address) rd))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-putcfg))))

(dshmi putcon "Put control register"
       ()
       "putcon $rm, $crj"
       (+ (f-op 27) rm (f-ext 15) (f-right 63) crj (f-rsvd 0))
       (set crj rm)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec (cycles 5)))))

(dshmi rte "Return from exception"
       ()
       "rte"
       (+ (f-op 27) (f-left 63) (f-ext 3) (f-right 63) (f-dest 63) (f-rsvd 0))
       (unimp "rte")
       (sh5-media-models ((unit u-exec (cycles 8)))))

(dshmi shard "Arithmetic right shift"
       ()
       "shard $rm, $rn, $rd"
       (+ (f-op 1) rm (f-ext 7) rn rd (f-rsvd 0))
       (set rd (sra rm (and rn 63)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi shardl "Arithmetic right shift (long word)"
       ()
       "shard.l $rm, $rn, $rd"
       (+ (f-op 1) rm (f-ext 6) rn rd (f-rsvd 0))
       (set rd (ext DI (sra (subword SI rm 1) (and rn 63))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi shari "Arithmetic right shift (immediate count)"
       ()
       "shari $rm, $uimm6, $rd"
       (+ (f-op 49) rm (f-ext 7) uimm6 rd (f-rsvd 0))
       (set rd (sra rm uimm6))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi sharil "Arithmetic right shift (long word, immediate count)"
       ()
       "shari.l $rm, $uimm6, $rd"
       (+ (f-op 49) rm (f-ext 6) uimm6 rd (f-rsvd 0))
       (set rd (ext DI (sra (subword SI rm 1) (and uimm6 63))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi shlld "Logical left shift"
       ()
       "shlld $rm, $rn, $rd"
       (+ (f-op 1) rm (f-ext 1) rn rd (f-rsvd 0))
       (set rd (sll rm (and rn 63)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi shlldl "Logical left shift (long word)"
       ()
       "shlld.l $rm, $rn, $rd"
       (+ (f-op 1) rm (f-ext 0) rn rd (f-rsvd 0))
       (set rd (ext DI (sll (subword SI rm 1) (and rn 63))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi shlli "Logical left shift (immediate count)"
       ()
       "shlli $rm, $uimm6, $rd"
       (+ (f-op 49) rm (f-ext 1) uimm6 rd (f-rsvd 0))
       (set rd (sll rm uimm6))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi shllil "Logical left shift (long word, immediate count)"
       ()
       "shlli.l $rm, $uimm6, $rd"
       (+ (f-op 49) rm (f-ext 0) uimm6 rd (f-rsvd 0))
       (set rd (ext DI (sll (subword SI rm 1) (and uimm6 63))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi shlrd "Logical right shift"
       ()
       "shlrd $rm, $rn, $rd"
       (+ (f-op 1) rm (f-ext 3) rn rd (f-rsvd 0))
       (set rd (srl rm (and rn 63)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi shlrdl "Logical right shift (long word)"
       ()
       "shlrd.l $rm, $rn, $rd"
       (+ (f-op 1) rm (f-ext 2) rn rd (f-rsvd 0))
       (set rd (ext DI (srl (subword SI rm 1) (and rn 63))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi shlri "Logical right shift (immediate count)"
       ()
       "shlri $rm, $uimm6, $rd"
       (+ (f-op 49) rm (f-ext 3) uimm6 rd (f-rsvd 0))
       (set rd (srl rm uimm6))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi shlril "Logical right shift (long word, immediate count)"
       ()
       "shlri.l $rm, $uimm6, $rd"
       (+ (f-op 49) rm (f-ext 2) uimm6 rd (f-rsvd 0))
       (set rd (ext DI (srl (subword SI rm 1) (and uimm6 63))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi shori "Shift-or immediate"
       ()
       "shori $uimm16, $rd"
       (+ (f-op 50) uimm16 rd (f-rsvd 0))
       (set rd (or (sll rd 16) (zext DI uimm16)))
       (sh5-media-models ((unit u-use-gr (in usereg rd))
			  (unit u-exec))))

(dshmi sleep "Sleep"
       ()
       "sleep"
       (+ (f-op 27) (f-left 63) (f-ext 7) (f-right 63) (f-dest 63) (f-rsvd 0))
       (unimp "sleep")
       ())

(dshmi stb "Store byte"
       ()
       "st.b $rm, $disp10, $rd"
       (+ (f-op 40) rm disp10 rd (f-rsvd 0))
       (set (mem UQI (add rm (ext DI disp10))) (and QI rd #xff))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi stl "Store long word"
       ()
       "st.l $rm, $disp10x4, $rd"
       (+ (f-op 42) rm disp10x4 rd (f-rsvd 0))
       (set (mem SI (add rm (ext DI disp10x4))) (and SI rd #xffffffff))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi stq "Store quad word"
       ()
       "st.q $rm, $disp10x8, $rd"
       (+ (f-op 43) rm disp10x8 rd (f-rsvd 0))
       (set (mem DI (add rm (ext DI disp10x8))) rd)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi stw "Store word"
       ()
       "st.w $rm, $disp10x2, $rd"
       (+ (f-op 41) rm disp10x2 rd (f-rsvd 0))
       (set (mem HI (add rm (ext DI disp10x2))) (and HI rd #xffff))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(define-pmacro (-sthi-byte)
  (if (and bytecount 1)
      (sequence ()
		(set (mem UQI addr) (and QI val #xff))
		(set val (srl val 8)))))

(define-pmacro (-sthi-word)
  (if (and bytecount 2)
      (sequence ()
		(set (mem HI (and addr -4)) (and HI val #xffff))
		(set val (srl val 16)))))

(define-pmacro (-sthi-long)
  (if (and bytecount 4)
      (sequence ()
		(set (mem SI (and addr -8)) (and SI val #xffffffff))
		(set val (srl val 32)))))

(dshmi sthil "Store high part (long word)"
      ()
       "sthi.l $rm, $disp6, $rd"
       (+ (f-op 56) rm (f-ext 6) disp6 rd (f-rsvd 0))
       (sequence ((DI addr) (QI bytecount) (DI val))
		 (set addr (add rm disp6))
		 (set bytecount (add (and addr 3) 1))
		 (if (and bytecount 4)
		     (set (mem SI (and addr -4)) rd)
		     (if endian
			 (sequence ()
				   ; Big endian.
				   (set val rd)
				   (-sthi-byte)
				   (-sthi-word))
			 (sequence ()
				   (set val (srl rd (sub 32 (mul 8 bytecount))))
				   (-sthi-word)
				   (-sthi-byte)))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi sthiq "Store high part (quad word)"
       ()
       "sthi.q $rm, $disp6, $rd"
       (+ (f-op 56) rm (f-ext 7) disp6 rd (f-rsvd 0))
       (sequence ((DI addr) (QI bytecount) (DI val))
		 (set addr (add rm disp6))
		 (set bytecount (add (and addr 7) 1))
		 (if (and bytecount 8)
		     (set (mem DI (and addr -8)) rd)
		     (if endian
			 (sequence ()
				   (set val rd)
				   (-sthi-byte)
				   (-sthi-word)
				   (-sthi-long))
			 (sequence ()
				   (set val (srl rd (sub 64 (mul 8 bytecount))))
				   (-sthi-long)
				   (-sthi-word)
				   (-sthi-byte)))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(define-pmacro (-stlo-byte)
  (if (and bytecount 1)
      (sequence ()
		(set (mem UQI addr) (and QI val #xff))
		(set val (srl val 8)))))

(define-pmacro (-stlo-word)
  (if (and bytecount 2)
      (sequence ()
		(set (mem UHI (and (add addr 1) -2)) (and HI val #xffff))
		(set val (srl val 16)))))

(define-pmacro (-stlo-long)
  (if (and bytecount 4)
      (sequence ()
		(set (mem USI (and (add addr  3) -4)) (and SI val #xffffffff))
		(set val (srl val 32)))))

(dshmi stlol "Store low part (long word)"
       ()
       "stlo.l $rm, $disp6, $rd"
       (+ (f-op 56) rm (f-ext 2) disp6 rd (f-rsvd 0))
       (sequence ((DI addr) (QI bytecount) (DI val))
		 (set addr (add rm disp6))
		 (set bytecount (sub 4 (and addr 3)))
		 (if (and bytecount 4)
		     (set (mem USI addr) rd)
		     (if endian
			 (sequence ()
				   (set val (srl rd (sub 32 (mul 8 bytecount))))
				   (-stlo-word)
				   (-stlo-byte))
			 (sequence ()
				   (set val rd)
				   (-stlo-byte)
				   (-stlo-word)))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi stloq "Store low part (quad word)"
       ()
       "stlo.q $rm, $disp6, $rd"
       (+ (f-op 56) rm (f-ext 3) disp6 rd (f-rsvd 0))
       (sequence ((DI addr) (QI bytecount) (DI val))
		 (set addr (add rm disp6))
		 (set bytecount (sub 8 (and addr 7)))
		 (if (and bytecount 8)
		     (set (mem UDI addr) rd)
		     (if endian
			 (sequence ()
				   (set val (srl rd (sub 64 (mul 8 bytecount))))
				   (-stlo-long)
				   (-stlo-word)
				   (-stlo-byte))
			 (sequence ()
				   (set val rd)
				   (-stlo-byte)
				   (-stlo-word)
				   (-stlo-long)))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))

(dshmi stxb "Store byte (extended displacement)"
       ()
       "stx.b $rm, $rn, $rd"
       (+ (f-op 24) rm (f-ext 0) rn rd (f-rsvd 0))
       (set (mem UQI (add rm rn)) (subword QI rd 7))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi stxl "Store long (extended displacement)"
       ()
       "stx.l $rm, $rn, $rd"
       (+ (f-op 24) rm (f-ext 2) rn rd (f-rsvd 0))
       (set (mem SI (add rm rn)) (subword SI rd 1))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi stxq "Store quad word (extended displacement)"
       ()
       "stx.q $rm, $rn, $rd"
       (+ (f-op 24) rm (f-ext 3) rn rd (f-rsvd 0))
       (set (mem DI (add rm rn)) rd)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi stxw "Store word (extended displacement)"
       ()
       "stx.w $rm, $rn, $rd"
       (+ (f-op 24) rm (f-ext 1) rn rd (f-rsvd 0))
       (set (mem HI (add rm rn)) (subword HI rd 3))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi sub "Subtract"
       ()
       "sub $rm, $rn, $rd"
       (+ (f-op 0) rm (f-ext 11) rn rd (f-rsvd 0))
       (set rd (sub rm rn))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi subl "Subtract long"
       ()
       "sub.l $rm, $rn, $rd"
       (+ (f-op 0) rm (f-ext 10) rn rd (f-rsvd 0))
       (set rd (ext DI (sub (subword SI rm 1) (subword SI rn 1))))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi swapq "Swap quad words"
       ()
       "swap.q $rm, $rn, $rd"
       (+ (f-op 8) rm (f-ext 3) rn rd (f-rsvd 0))
       (sequence ((DI addr) (DI temp))
		 (set addr (add rm rn))
		 (set temp (mem DI addr))
		 (set (mem DI addr) rd)
		 (set rd temp))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi synci "Synchronise instruction fetch"
       ()
       "synci"
       (+ (f-op 27) (f-left 63) (f-ext 2) (f-right 63) (f-dest 63) (f-rsvd 0))
       (unimp "synci")
       ())

(dshmi synco "Synchronise data operations"
       ()
       "synco"
       (+ (f-op 27) (f-left 63) (f-ext 6) (f-right 63) (f-dest 63) (f-rsvd 0))
       (unimp "synco")
       ())

(dshmi trapa "Trap"
       ()
       "trapa $rm"
       (+ (f-op 27) rm (f-ext 1) (f-right 63) (f-dest 63) (f-rsvd 0))
       (c-call "sh64_trapa" rm pc)
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec (cycles 10)))))

(dshmi xor "Exclusive OR"
       ()
       "xor $rm, $rn, $rd"
       (+ (f-op 1) rm (f-ext 13) rn rd (f-rsvd 0))
       (set rd (xor rm rn))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-use-gr (in usereg rn))
			  (unit u-exec))))

(dshmi xori "Exclusive OR immediate"
       ()
       "xori $rm, $imm6, $rd"
       (+ (f-op 49) rm (f-ext 13) rn rd (f-rsvd 0))
       (set rd (xor rm (ext DI imm6)))
       (sh5-media-models ((unit u-use-gr (in usereg rm))
			  (unit u-exec))))
@


1.6.8.1
log
@Import sources from cgen/cpu directory

cgen/cpu/ChangeLog:

 	* cris.cpu, frv.cpu, iq10.cpu, iq2000.cpu, iq2000m.cpu, lm32.cpu,
 	m32c.cpu, m32r.cpu, mt.cpu, sh.cpu, sh64-compact.cpu,
 	sh64-media.cpu, xc16x.cpu: New file, copied from cgen/cpu.
@
text
@d1 5
a5 24
; Hitachi SHmedia instruction set description.  -*- Scheme -*-
;
; Copyright 2000, 2001, 2007, 2009 Free Software Foundation, Inc.
;
; Contributed by Red Hat Inc; developed under contract from Hitachi
; Semiconductor (America) Inc.
;
; This file is part of the GNU Binutils.
;
; This program is free software; you can redistribute it and/or modify
; it under the terms of the GNU General Public License as published by
; the Free Software Foundation; either version 3 of the License, or
; (at your option) any later version.
;
; This program is distributed in the hope that it will be useful,
; but WITHOUT ANY WARRANTY; without even the implied warranty of
; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
; GNU General Public License for more details.
;
; You should have received a copy of the GNU General Public License
; along with this program; if not, write to the Free Software
; Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston,
; MA 02110-1301, USA.

d19 1
a19 1
(define-pmacro (dshmi xname xcomment xattrs xsyntax xformat xsemantics)
d26 3
a28 1
    (semantics xsemantics)))
d32 2
a33 1
; See Hitachi SH-5 CPU core, volume 2, p. 25 for details.
d38 1
a38 1
  (if mode (lt i (neg mode (sll mode 1 (sub n 1))))
d40 1
a40 1
      (if mode (lt i (sll mode 1 (sub n 1)))
d47 1
a47 1
  (if mode (lt i (const mode 0))
d49 1
a49 1
      (if mode (lt i (sll mode 1 n))
d56 7
a62 7
(dshmf f-op          "Opcode"                       ()  31  6)
(dshmf f-ext         "Extension opcode"             ()  19  4)
(dshmf f-rsvd        "Reserved"		    (RESERVED)   3  4)

(dshmf f-left        "Left register"                ()  25  6)
(dshmf f-right       "Right register"               ()  15  6)
(dshmf f-dest        "Destination register"         ()   9  6)
d78 9
a86 9
(dshmf f-tra         "Target register"              ()   6  3)
(dshmf f-trb         "Target register"              ()  22  3)
(dshmf f-likely      "Likely bit"                   ()   9  1)
(dshmf f-25          "Three unused bits at bit 25"  ()  25  3)
(dshmf f-8-2         "Two unused bits at bit 8"     ()   8  2)

(df f-imm6   "Immediate value (6 bits)"      ((ISA media)) 15 6 INT #f #f)
(df f-imm10  "Immediate value (10 bits)"     ((ISA media)) 19 10 INT #f #f)
(df f-imm16  "Immediate value (16 bits)"     ((ISA media)) 25 16 INT #f #f)
d88 2
a89 2
(dshmf f-uimm6       "Immediate value (6 bits)"     ()  15  6)
(dshmf f-uimm16      "Immediate value (16 bits)"    ()  25 16)
d94 1
a94 1
(df f-disp6	     "Displacement (6 bits)"        ((ISA media)) 15 6 INT #f #f)
d96 1
a96 1
(df f-disp6x32       "Displacement (6 bits)"        ((ISA media)) 15 6 INT
d100 1
a100 1
(df f-disp10         "Displacement (10 bits)"       ((ISA media)) 19 10 INT #f #f)
d102 1
a102 1
(df f-disp10x8       "Displacement (10 bits)"       ((ISA media)) 19 10 INT
d106 1
a106 1
(df f-disp10x4       "Displacement (10 bits)"       ((ISA media)) 19 10 INT
d110 1
a110 1
(df f-disp10x2       "Displacement (10 bits)"       ((ISA media)) 19 10 INT
d114 1
a114 1
(df f-disp16         "Displacement (16 bits)"       ((ISA media) PCREL-ADDR) 25 16 INT
d175 4
a178 1
       (set rd (add rm rn)))
d184 4
a187 1
       (set rd (add (subword SI rm 1) (subword SI rn 1))))
d193 3
a195 1
       (set rd (add rm (ext DI disp10))))
d201 3
a203 1
       (set rd (ext DI (add (ext SI disp10) (subword SI rm 1)))))
d209 4
a212 1
       (set rd (zext DI (add (subword SI rm 1) (subword SI rn 1)))))
d218 5
a222 1
       (unimp "alloco"))
d228 4
a231 1
       (set rd (and rm rn)))
d237 4
a240 1
       (set rd (and rm (inv rn))))
d246 3
a248 1
       (set rd (and rm (ext DI disp10))))
d253 9
a261 3
       (+ (f-op 25) rm (f-ext 1) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (eq rm rn)
	   (set pc tra)))
d266 8
a273 3
       (+ (f-op 57) rm (f-ext 1) imm6 likely (f-8-2 0) tra (f-rsvd 0))
       (if (eq rm (ext DI imm6))
	   (set pc tra)))
d278 9
a286 3
       (+ (f-op 25) rm (f-ext 3) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (ge rm rn)
	   (set pc tra)))
d291 9
a299 3
       (+ (f-op 25) rm (f-ext 11) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (geu rm rn)
	   (set pc tra)))
d304 9
a312 3
       (+ (f-op 25) rm (f-ext 7) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (gt rm rn)
	   (set pc tra)))
d317 9
a325 3
       (+ (f-op 25) rm (f-ext 15) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (gtu rm rn)
	   (set pc tra)))
d330 1
a330 1
       (+ (f-op 17) (f-25 0) trb (f-ext 1) (f-right 63) rd (f-rsvd 0))
d333 5
a337 1
		 (set pc trb)))
d342 9
a350 3
       (+ (f-op 25) rm (f-ext 5) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (ne rm rn)
	   (set pc tra)))
d355 8
a362 3
       (+ (f-op 57) rm (f-ext 5) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (ne rm (ext DI imm6))
	   (set pc tra)))
d368 2
a369 1
       (c-call "sh64_break" pc))
d392 3
a394 1
		 (set rd result)))
d400 4
a403 1
       (set rd (if DI (eq rm rn) 1 0)))
d409 4
a412 1
       (set rd (if DI (gt rm rn) 1 0)))
d418 4
a421 1
       (set rd (if DI (gtu rm rn) 1 0)))
d428 4
a431 1
	   (set rd rn)))
d438 4
a441 1
	   (set rd rn)))
d447 8
a454 1
       (set drf (c-call DF "sh64_fabsd" drgh)))
d460 8
a467 1
       (set frf (c-call SF "sh64_fabss" frgh)))
d473 9
a481 1
       (set drf (c-call DF "sh64_faddd" drg drh)))
d487 9
a495 1
       (set frf (c-call SF "sh64_fadds" frg frh)))
d501 3
a503 1
       (set rd (zext DI (c-call BI "sh64_fcmpeqd" drg drh))))
d509 3
a511 1
       (set rd (zext DI (c-call BI "sh64_fcmpeqs" frg frh))))
d517 3
a519 1
       (set rd (zext DI (c-call BI "sh64_fcmpged" drg drh))))
d525 3
a527 1
       (set rd (zext DI (c-call BI "sh64_fcmpges" frg frh))))
d533 3
a535 1
       (set rd (zext DI (c-call BI "sh64_fcmpgtd" drg drh))))
d541 3
a543 1
       (set rd (zext DI (c-call BI "sh64_fcmpgts" frg frh))))
d549 3
a551 1
       (set rd (zext DI (c-call BI "sh64_fcmpund" drg drh))))
d557 3
a559 1
       (set rd (zext DI (c-call BI "sh64_fcmpuns" frg frh))))
d565 8
a572 1
       (set frf (c-call SF "sh64_fcnvds" drgh)))
d578 8
a585 1
       (set drf (c-call DF "sh64_fcnvsd" frgh)))
d591 9
a599 1
       (set drf (c-call DF "sh64_fdivd" drg drh)))
d605 9
a613 1
       (set frf (c-call SF "sh64_fdivs" frg frh)))
d619 7
a625 3
       (unimp "fputscr"))
       ; FIXME: this should work!
       ; (set frf fpscr))
d631 12
a642 11
       (sequence ((UQI g) (UQI h) (SF temp))
		 (set g (index-of fvg))
		 (set h (index-of fvh))
		 (set temp (c-call SF "sh64_fmuls" (reg h-fr g) (reg h-fr h)))
		 (set temp (c-call SF "sh64_fadds" temp
		   (c-call SF "sh64_fmuls" (reg h-fr (add g 1)) (reg h-fr (add h 1)))))
		 (set temp (c-call SF "sh64_fadds" temp
		   (c-call SF "sh64_fmuls" (reg h-fr (add g 2)) (reg h-fr (add h 2)))))
		 (set temp (c-call SF "sh64_fadds" temp
		   (c-call SF "sh64_fmuls" (reg h-fr (add g 3)) (reg h-fr (add h 3)))))
		 (set frf temp)))
d648 9
a656 1
       (set drf (mem DF (add rm disp10x8))))
d662 11
a672 4
       (sequence ((QI f))
		 (set f (index-of fpf))
		 (set (reg h-fr f) (mem SF (add rm disp10x8)))
		 (set (reg h-fr (add f 1)) (mem SF (add rm (add disp10x8 4))))))
d678 9
a686 1
       (set frf (mem SF (add rm disp10x4))))
d692 10
a701 1
       (set drf (mem DF (add rm rn))))
d707 12
a718 4
       (sequence ((QI f))
		 (set f (index-of fpf))
		 (set (reg h-fr f) (mem SF (add rm rn)))
		 (set (reg h-fr (add f 1)) (mem SF (add rm (add rn 4))))))
d724 10
a733 1
       (set frf (mem SF (add rm rn))))
d739 8
a746 1
       (set drf (c-call DF "sh64_floatld" frgh)))
d752 8
a759 1
       (set frf (c-call SF "sh64_floatls" frgh)))
d765 8
a772 1
       (set drf (c-call DF "sh64_floatqd" drgh)))
d778 8
a785 1
       (set frf (c-call SF "sh64_floatqs" drgh)))
d791 10
a800 1
       (set frf (c-call SF "sh64_fadds" frf (c-call SF "sh64_fmuls" frg frh))))
d806 8
a813 1
       (set drf drgh))
d819 3
a821 1
       (set rd (subword DI drgh 0)))
d827 8
a834 1
       (set frf (subword SF (subword SI rm 1) 0)))
d840 8
a847 1
       (set drf (subword DF rm 0)))
d853 8
a860 1
       (set frf frgh))
d866 4
a869 1
       (set rd (ext DI (subword SI frgh 1))))
d875 9
a883 1
       (set drf (c-call DF "sh64_fmuld" drg drh)))
d889 9
a897 1
       (set frf (c-call SF "sh64_fmuls" frg frh)))
d903 8
a910 1
       (set drf (c-call DF "sh64_fnegd" drgh)))
d916 8
a923 1
       (set frf (c-call SF "sh64_fnegs" frgh)))
d929 2
a930 3
       (unimp "fputscr"))
       ; FIXME: this should work!
       ; (set fpscr (subword SI frgh 0)))
d936 8
a943 1
       (set drf (c-call DF "sh64_fsqrtd" drgh)))
d949 8
a956 1
       (set frf (c-call SF "sh64_fsqrts" frgh)))
d962 4
a965 1
       (set (mem DF (add rm disp10x8)) drf))
d971 6
a976 4
       (sequence ((QI f))
		 (set f (index-of fpf))
		 (set (mem SF (add rm disp10x8)) (reg h-fr f))
		 (set (mem SF (add rm (add disp10x8 4))) (reg h-fr (add f 1)))))
d982 4
a985 1
       (set (mem SF (add rm disp10x4)) frf))
d991 5
a995 1
       (set (mem DF (add rm rn)) drf))
d1001 7
a1007 4
       (sequence ((QI f))
		 (set f (index-of fpf))
		 (set (mem SF (add rm rn)) (reg h-fr f))
		 (set (mem SF (add rm (add rn 4))) (reg h-fr (add f 1)))))
d1013 5
a1017 1
       (set (mem SF (add rm rn)) frf))
d1023 9
a1031 1
       (set drf (c-call DF "sh64_fsubd" drg drh)))
d1037 9
a1045 1
       (set frf (c-call SF "sh64_fsubs" frg frh)))
d1051 8
a1058 1
       (set frf (c-call SF "sh64_ftrcdl" drgh)))
d1064 8
a1071 1
       (set frf (c-call SF "sh64_ftrcsl" frgh)))
d1077 8
a1084 1
       (set drf (c-call DF "sh64_ftrcdq" drgh)))
d1090 8
a1097 1
       (set drf (c-call DF "sh64_ftrcsq" frgh)))
d1103 9
a1111 1
       (c-call "sh64_ftrvs" (index-of mtrxg) (index-of fvh) (index-of fvf)))
d1117 6
a1122 1
       (unimp "getcfg"))
d1128 3
a1130 1
       (set rd crk))
d1135 4
a1138 2
       (+ (f-op 17) (f-25 0) trb (f-ext 5) (f-right 63) rd (f-rsvd 0))
       (set rd trb))
d1144 5
a1148 1
       (unimp "icbi"))
d1154 5
a1158 1
       (set rd (ext DI (mem QI (add rm (ext DI disp10))))))
d1164 5
a1168 1
       (set rd (ext DI (mem SI (add rm (ext DI disp10x4))))))
d1174 5
a1178 1
       (set rd (mem DI (add rm (ext DI disp10x8)))))
d1184 5
a1188 1
       (set rd (zext DI (mem QI (add rm (ext DI disp10))))))
d1194 5
a1198 1
       (set rd (zext DI (mem HI (add rm (ext DI disp10x2))))))
d1204 17
a1220 1
       (set rd (ext DI (mem HI (add rm (ext DI disp10x2))))))
d1226 22
a1247 2
       ; FIXME.
       (unimp "ldhil"))
d1253 35
a1287 2
       ; FIXME.
       (unimp "ldhiq"))
d1293 22
a1314 2
       ; FIXME.
       (unimp "ldlol"))
d1320 22
a1341 2
       ; FIXME;
       (unimp "ldloq"))
d1347 6
a1352 1
       (set rd (ext DI (mem QI (add rm rn)))))
d1358 6
a1363 1
       (set rd (ext DI (mem SI (add rm rn)))))
d1369 6
a1374 1
       (set rd (mem DI (add rm rn))))
d1380 6
a1385 1
       (set rd (zext DI (mem UQI (add rm rn)))))
d1391 6
a1396 1
       (set rd (zext DI (mem UHI (add rm rn)))))
d1402 6
a1407 1
       (set rd (ext DI (mem HI (add rm rn)))))
d1460 4
a1463 1
       (slice-long-unop abs))
d1469 4
a1472 1
       (slice-word-unop abs))
d1478 4
a1481 1
       (slice-long add))
d1487 4
a1490 1
       (slice-word add))
d1492 2
a1493 1
(define-pmacro (-maddsl arg1 arg2) (saturate SI 32 (add arg1 arg2)))
d1498 5
a1502 1
       (slice-long -maddsl))
d1504 2
a1505 1
(define-pmacro (-maddsub arg1 arg2) (usaturate QI 8 (add arg1 arg2)))
d1510 5
a1514 1
       (slice-byte -maddsub))
d1516 2
a1517 1
(define-pmacro (-maddsw arg1 arg2) (saturate HI 16 (add arg1 arg2)))
d1522 5
a1526 1
       (slice-word -maddsw))
d1536 5
a1540 1
       (slice-byte -mcmpeqb))
d1547 5
a1551 1
       (slice-long -mcmpeql))
d1558 5
a1562 1
       (slice-word -mcmpeqw))
d1574 5
a1578 1
       (slice-long -mcmpgtl))
d1585 5
a1589 1
       (slice-byte -mcmpgtub))
d1596 5
a1600 1
       (slice-word -mcmpgtw))
d1606 4
a1609 1
       (set rd (or (and rm rn) (and rd (inv rn)))))
d1616 9
a1624 5
		 (set result0 (saturate HI 16 (subword SI rm 0)))
		 (set result1 (saturate HI 16 (subword SI rm 1)))
		 (set result2 (saturate HI 16 (subword SI rn 0)))
		 (set result3 (saturate HI 16 (subword SI rn 1)))
		 (set rd (-join-hi result3 result2 result1 result0))))
d1632 8
a1639 8
		 (set result0 (saturate QI 8 (subword HI rm 0)))
		 (set result1 (saturate QI 8 (subword HI rm 1)))
		 (set result2 (saturate QI 8 (subword HI rm 2)))
		 (set result3 (saturate QI 8 (subword HI rm 3)))
		 (set result4 (saturate QI 8 (subword HI rn 0)))
		 (set result5 (saturate QI 8 (subword HI rn 1)))
		 (set result6 (saturate QI 8 (subword HI rn 2)))
		 (set result7 (saturate QI 8 (subword HI rn 3)))
d1641 5
a1645 1
				 result3 result2 result1 result0))))
d1653 8
a1660 8
		 (set result0 (usaturate QI 8 (subword HI rm 0)))
		 (set result1 (usaturate QI 8 (subword HI rm 1)))
		 (set result2 (usaturate QI 8 (subword HI rm 2)))
		 (set result3 (usaturate QI 8 (subword HI rm 3)))
		 (set result4 (usaturate QI 8 (subword HI rn 0)))
		 (set result5 (usaturate QI 8 (subword HI rn 1)))
		 (set result6 (usaturate QI 8 (subword HI rn 2)))
		 (set result7 (usaturate QI 8 (subword HI rn 3)))
d1662 5
a1666 1
				 result2 result1 result0))))
d1679 1
a1679 1
		   (set count (mul QI 8 (sub QI 8 n)))
d1682 1
a1682 1
		   (set count (mul QI 8 n))
d1684 4
a1687 1
		   (set rd (or DI rhs (sll DI (and rn mask) count))))))
d1702 14
a1715 9
		 (set result0 (subword SI rd 0))
		 (set result1 (subword SI rd 1))
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
		 (set temp (saturate SI 32 (sll temp 1)))
		 (set result0 (saturate SI 32 (add result0 temp)))
		 (set temp (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
		 (set temp (saturate SI 32 (sll temp 1)))
		 (set result1 (saturate SI 32 (add result1 temp)))
		 (set rd (-join-si result1 result0))))
d1722 14
a1735 9
		 (set result0 (subword SI rd 0))
		 (set result1 (subword SI rd 1))
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
		 (set temp (saturate SI 32 (sll temp 1)))
		 (set result0 (saturate SI 32 (sub result0 temp)))
		 (set temp (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
		 (set temp (saturate SI 32 (sll temp 1)))
		 (set result1 (saturate SI 32 (sub result1 temp)))
		 (set rd (-join-si result1 result0))))
d1741 5
a1745 1
       (slice-long mul))
d1751 5
a1755 1
       (slice-word mul))
d1762 2
a1764 2
		 (set result0 (saturate SI 32 (sra temp 31)))
		 (set temp (mul (zext DI (subword SI rm 1)) (zext DI (subword SI rn 1))))
d1766 5
a1770 1
		 (set rd (-join-si result1 result0))))
d1777 1
a1777 1
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
d1779 2
a1781 2
		 (set result1 (saturate HI 16 (sra temp 15)))
		 (set temp (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
d1783 1
a1783 1
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
d1785 5
a1789 1
		 (set rd (-join-hi result3 result2 result1 result0))))
d1797 1
a1797 1
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
d1799 2
a1801 2
		 (set result1 (saturate HI 16 (sra (add temp c) 15)))
		 (set temp (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
d1803 1
a1803 1
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
d1805 5
a1809 1
		 (set rd (-join-hi result3 result2 result1 result0))))
d1816 7
a1822 3
		 (set result0 (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
		 (set result1 (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
		 (set rd (-join-si result1 result0))))
d1829 7
a1835 3
		 (set result0 (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
		 (set result1 (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
		 (set rd (-join-si result1 result0))))
d1846 4
a1849 1
		 (set rd (add rd acc))))
d1855 2
a1856 1
       (set rd (ext DI imm16)))
d1863 1
a1863 1
		 (set control (and QI rn #x3f))
d1868 4
a1871 1
		 (set rd (-join-hi result3 result2 result1 result0))))
d1878 1
a1878 1
		 (set acc (abs DI (sub (subword QI rm 0) (subword QI rn 1))))
d1886 4
a1889 1
		 (set rd (add rd acc))))
d1891 1
a1891 1
(define-pmacro (-mshaldsl arg) (saturate SI 32 (sll arg (and rn 31))))
d1896 5
a1900 1
       (slice-long-unop -mshaldsl))
d1902 1
a1902 1
(define-pmacro (-mshaldsw arg) (saturate HI 16 (sll arg (and rn 15))))
d1907 5
a1911 1
       (slice-word-unop -mshaldsw))
d1918 4
a1921 1
       (slice-long-unop -mshardl))
d1928 4
a1931 1
       (slice-word-unop -mshardw))
d1937 5
a1941 1
       (set rd (saturate DI 16 (sra rm (and rn 63)))))
d1949 8
a1956 8
		 (set result0 (subword QI rm 4))
		 (set result1 (subword QI rn 4))
		 (set result2 (subword QI rm 5))
		 (set result3 (subword QI rn 5))
		 (set result4 (subword QI rm 6))
		 (set result5 (subword QI rn 6))
		 (set result6 (subword QI rm 7))
		 (set result7 (subword QI rn 7))
d1958 4
a1961 1
				 result2 result1 result0))))
d1968 6
a1973 3
		 (set result0 (subword SI rm 1))
		 (set result1 (subword SI rn 1))
		 (set rd (-join-si result1 result0))))
d1980 8
a1987 5
		 (set result0 (subword HI rm 2))
		 (set result1 (subword HI rn 2))
		 (set result2 (subword HI rm 3))
		 (set result3 (subword HI rn 3))
		 (set rd (-join-hi result3 result2 result1 result0))))
d1995 8
a2002 8
		 (set result0 (subword QI rm 0))
		 (set result1 (subword QI rn 0))
		 (set result2 (subword QI rm 1))
		 (set result3 (subword QI rn 1))
		 (set result4 (subword QI rm 2))
		 (set result5 (subword QI rn 2))
		 (set result6 (subword QI rm 3))
		 (set result7 (subword QI rn 3))
d2004 4
a2007 1
				 result2 result1 result0))))
d2014 6
a2019 3
		 (set result0 (subword SI rm 0))
		 (set result1 (subword SI rn 0))
		 (set rd (-join-si result1 result0))))
d2026 8
a2033 5
		 (set result0 (subword HI rm 0))
		 (set result1 (subword HI rn 0))
		 (set result2 (subword HI rm 1))
		 (set result3 (subword HI rn 1))
		 (set rd (-join-hi result3 result2 result1 result0))))
d2040 4
a2043 1
       (slice-long-unop -mshlldl))
d2050 4
a2053 1
       (slice-word-unop -mshlldw))
d2060 4
a2063 1
       (slice-long-unop -mshlrdl))
d2070 4
a2073 1
       (slice-word-unop -mshlrdw))
d2079 4
a2082 1
       (slice-long sub))
d2088 4
a2091 1
       (slice-word sub))
d2093 2
a2094 1
(define-pmacro (-msubsl arg1 arg2) (saturate SI 32 (sub arg1 arg2)))
d2099 5
a2103 1
       (slice-long -msubsl))
d2105 2
a2106 1
(define-pmacro (-msubsub arg1 arg2) (usaturate QI 8 (sub arg1 arg2)))
d2111 5
a2115 1
       (slice-byte -msubsub))
d2117 2
a2118 1
(define-pmacro (-msubsw arg1 arg2) (saturate HI 16 (sub arg1 arg2)))
d2123 5
a2127 1
       (slice-byte -msubsw))
d2133 5
a2137 1
       (set rd (mul (ext DI (subword SI rm 1)) (ext DI (subword SI rn 1)))))
d2143 5
a2147 1
       (set rd (mul (zext DI (subword SI rm 1)) (zext DI (subword SI rn 1)))))
d2153 2
a2154 1
       (nop))
d2161 3
a2163 1
       (set rd (c-call DI "sh64_nsb" rm)))
d2169 5
a2173 1
       (unimp "ocbi"))
d2179 5
a2183 1
       (unimp "ocbp"))
d2189 5
a2193 1
       (unimp "ocbwb"))
d2199 4
a2202 1
       (set rd (or rm rn)))
d2208 3
a2210 1
       (set rd (or rm (ext DI imm10))))
d2216 5
a2220 1
       (unimp "prefi"))
d2225 6
a2230 2
       (+ (f-op 58) disp16 likely (f-8-2 0) tra (f-rsvd 0))
       (set tra (add disp16 1)))
d2235 7
a2241 2
       (+ (f-op 26) (f-left 63) (f-ext 1) rn likely (f-8-2 0) tra (f-rsvd 0))
       (set tra rn))
d2246 6
a2251 2
       (+ (f-op 59) disp16 likely (f-8-2 0) tra (f-rsvd 0))
       (set tra disp16))
d2256 7
a2262 2
       (+ (f-op 26) (f-left 63) (f-ext 5) rn likely (f-8-2 0) tra (f-rsvd 0))
       (set tra (add pc rn)))
d2268 6
a2273 1
       (unimp "putcfg"))
d2279 3
a2281 1
       (set crj rm))
d2287 2
a2288 1
       (unimp "rte"))
d2294 4
a2297 1
       (set rd (sra rm (and rn 63))))
d2303 4
a2306 1
       (set rd (ext DI (sra (subword SI rm 1) (and rn 63)))))
d2312 3
a2314 1
       (set rd (sra rm uimm6)))
d2320 3
a2322 1
       (set rd (ext DI (sra (subword SI rm 1) (and uimm6 63)))))
d2328 4
a2331 1
       (set rd (sll rm (and rn 63))))
d2337 4
a2340 1
       (set rd (ext DI (sll (subword SI rm 1) (and rn 63)))))
d2346 3
a2348 1
       (set rd (sll rm uimm6)))
d2354 3
a2356 1
       (set rd (ext DI (sll (subword SI rm 1) (and uimm6 63)))))
d2362 4
a2365 1
       (set rd (srl rm (and rn 63))))
d2371 4
a2374 1
       (set rd (ext DI (srl (subword SI rm 1) (and rn 63)))))
d2380 3
a2382 1
       (set rd (srl rm uimm6)))
d2388 3
a2390 1
       (set rd (ext DI (srl (subword SI rm 1) (and uimm6 63)))))
d2396 3
a2398 1
       (set rd (or (sll rd 16) (zext DI uimm16))))
d2404 2
a2405 1
       (unimp "sleep"))
d2411 3
a2413 1
       (set (mem UQI (add rm (ext DI disp10))) (and QI rd #xff)))
d2419 3
a2421 1
       (set (mem SI (add rm (ext DI disp10x4))) (and SI rd #xffffffff)))
d2427 3
a2429 1
       (set (mem DI (add rm (ext DI disp10x8))) rd))
d2435 3
a2437 1
       (set (mem HI (add rm (ext DI disp10x2))) (and HI rd #xffff)))
d2440 16
a2455 4
  (sequence ()
	    (set (mem UQI addr) (and QI val #xff))
	    (set val (srl val 8))
	    (set addr (add addr 1))))
d2464 14
a2477 12
		 (if endian
		     (set val rd)
		     (set val (srl rd (sub 32 (mul 8 bytecount)))))
		 (set addr (add (sub addr bytecount) 1))
		 (if (gt bytecount 3)
		     (-sthi-byte))
		 (if (gt bytecount 2)
		     (-sthi-byte))
		 (if (gt bytecount 1)
		     (-sthi-byte))
		 (if (gt bytecount 0)
		     (-sthi-byte))))
d2486 33
a2518 20
		 (if endian
		     (set val rd)
		     (set val (srl rd (sub 64 (mul 8 bytecount)))))
		 (set addr (add (sub addr bytecount) 1))
		 (if (gt bytecount 7)
		     (-sthi-byte))
		 (if (gt bytecount 6)
		     (-sthi-byte))
		 (if (gt bytecount 5)
		     (-sthi-byte))
		 (if (gt bytecount 4)
		     (-sthi-byte))
		 (if (gt bytecount 3)
		     (-sthi-byte))
		 (if (gt bytecount 2)
		     (-sthi-byte))
		 (if (gt bytecount 1)
		     (-sthi-byte))
		 (if (gt bytecount 0)
		     (-sthi-byte))))
d2524 16
a2539 2
       ; FIXME.
       (unimp "stlol"))
d2545 18
a2562 2
       ; FIXME.
       (unimp "stloq"))
d2568 4
a2571 1
       (set (mem UQI (add rm rn)) (subword QI rd 7)))
d2577 4
a2580 1
       (set (mem SI (add rm rn)) (subword SI rd 1)))
d2586 4
a2589 1
       (set (mem DI (add rm rn)) rd))
d2595 4
a2598 1
       (set (mem HI (add rm rn)) (subword HI rd 3)))
d2604 4
a2607 1
       (set rd (sub rm rn)))
d2613 4
a2616 1
       (set rd (ext DI (sub (subword SI rm 1) (subword SI rn 1)))))
d2626 4
a2629 1
		 (set rd temp)))
d2635 2
a2636 1
       (unimp "synci"))
d2642 2
a2643 1
       (unimp "synco"))
d2649 3
a2651 1
       (c-call "sh64_trapa" rm pc))
d2657 4
a2660 1
       (set rd (xor rm rn)))
d2666 3
a2668 1
       (set rd (xor rm (ext DI imm6))))
@


1.5
log
@	* cpu/sh.cpu: Amend comments to refer to SuperH.
	* cpu/sh64-compact.cpu: Change comment to refer to SuperH.
	* cpu/sh64-media.cpu: Likewise.
	(Saturation): Update manual reference.
@
text
@d2 1
a2 1
; Copyright (C) 2000, 2001 Red Hat, Inc.
d19 1
a19 1
(define-pmacro (dshmi xname xcomment xattrs xsyntax xformat xsemantics)
d26 3
a28 1
    (semantics xsemantics)))
d56 7
a62 7
(dshmf f-op          "Opcode"                       ()  31  6)
(dshmf f-ext         "Extension opcode"             ()  19  4)
(dshmf f-rsvd        "Reserved"		    (RESERVED)   3  4)

(dshmf f-left        "Left register"                ()  25  6)
(dshmf f-right       "Right register"               ()  15  6)
(dshmf f-dest        "Destination register"         ()   9  6)
d78 9
a86 9
(dshmf f-tra         "Target register"              ()   6  3)
(dshmf f-trb         "Target register"              ()  22  3)
(dshmf f-likely      "Likely bit"                   ()   9  1)
(dshmf f-25          "Three unused bits at bit 25"  ()  25  3)
(dshmf f-8-2         "Two unused bits at bit 8"     ()   8  2)

(df f-imm6   "Immediate value (6 bits)"      ((ISA media)) 15 6 INT #f #f)
(df f-imm10  "Immediate value (10 bits)"     ((ISA media)) 19 10 INT #f #f)
(df f-imm16  "Immediate value (16 bits)"     ((ISA media)) 25 16 INT #f #f)
d88 2
a89 2
(dshmf f-uimm6       "Immediate value (6 bits)"     ()  15  6)
(dshmf f-uimm16      "Immediate value (16 bits)"    ()  25 16)
d94 1
a94 1
(df f-disp6	     "Displacement (6 bits)"        ((ISA media)) 15 6 INT #f #f)
d96 1
a96 1
(df f-disp6x32       "Displacement (6 bits)"        ((ISA media)) 15 6 INT
d100 1
a100 1
(df f-disp10         "Displacement (10 bits)"       ((ISA media)) 19 10 INT #f #f)
d102 1
a102 1
(df f-disp10x8       "Displacement (10 bits)"       ((ISA media)) 19 10 INT
d106 1
a106 1
(df f-disp10x4       "Displacement (10 bits)"       ((ISA media)) 19 10 INT
d110 1
a110 1
(df f-disp10x2       "Displacement (10 bits)"       ((ISA media)) 19 10 INT
d114 1
a114 1
(df f-disp16         "Displacement (16 bits)"       ((ISA media) PCREL-ADDR) 25 16 INT
d175 4
a178 1
       (set rd (add rm rn)))
d184 4
a187 1
       (set rd (add (subword SI rm 1) (subword SI rn 1))))
d193 3
a195 1
       (set rd (add rm (ext DI disp10))))
d201 3
a203 1
       (set rd (ext DI (add (ext SI disp10) (subword SI rm 1)))))
d209 4
a212 1
       (set rd (zext DI (add (subword SI rm 1) (subword SI rn 1)))))
d218 5
a222 1
       (unimp "alloco"))
d228 4
a231 1
       (set rd (and rm rn)))
d237 4
a240 1
       (set rd (and rm (inv rn))))
d246 3
a248 1
       (set rd (and rm (ext DI disp10))))
d253 9
a261 3
       (+ (f-op 25) rm (f-ext 1) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (eq rm rn)
	   (set pc tra)))
d266 8
a273 3
       (+ (f-op 57) rm (f-ext 1) imm6 likely (f-8-2 0) tra (f-rsvd 0))
       (if (eq rm (ext DI imm6))
	   (set pc tra)))
d278 9
a286 3
       (+ (f-op 25) rm (f-ext 3) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (ge rm rn)
	   (set pc tra)))
d291 9
a299 3
       (+ (f-op 25) rm (f-ext 11) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (geu rm rn)
	   (set pc tra)))
d304 9
a312 3
       (+ (f-op 25) rm (f-ext 7) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (gt rm rn)
	   (set pc tra)))
d317 9
a325 3
       (+ (f-op 25) rm (f-ext 15) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (gtu rm rn)
	   (set pc tra)))
d330 1
a330 1
       (+ (f-op 17) (f-25 0) trb (f-ext 1) (f-right 63) rd (f-rsvd 0))
d333 5
a337 1
		 (set pc trb)))
d342 9
a350 3
       (+ (f-op 25) rm (f-ext 5) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (ne rm rn)
	   (set pc tra)))
d355 8
a362 3
       (+ (f-op 57) rm (f-ext 5) rn likely (f-8-2 0) tra (f-rsvd 0))
       (if (ne rm (ext DI imm6))
	   (set pc tra)))
d368 2
a369 1
       (c-call "sh64_break" pc))
d392 3
a394 1
		 (set rd result)))
d400 4
a403 1
       (set rd (if DI (eq rm rn) 1 0)))
d409 4
a412 1
       (set rd (if DI (gt rm rn) 1 0)))
d418 4
a421 1
       (set rd (if DI (gtu rm rn) 1 0)))
d428 4
a431 1
	   (set rd rn)))
d438 4
a441 1
	   (set rd rn)))
d447 8
a454 1
       (set drf (c-call DF "sh64_fabsd" drgh)))
d460 8
a467 1
       (set frf (c-call SF "sh64_fabss" frgh)))
d473 9
a481 1
       (set drf (c-call DF "sh64_faddd" drg drh)))
d487 9
a495 1
       (set frf (c-call SF "sh64_fadds" frg frh)))
d501 3
a503 1
       (set rd (zext DI (c-call BI "sh64_fcmpeqd" drg drh))))
d509 3
a511 1
       (set rd (zext DI (c-call BI "sh64_fcmpeqs" frg frh))))
d517 3
a519 1
       (set rd (zext DI (c-call BI "sh64_fcmpged" drg drh))))
d525 3
a527 1
       (set rd (zext DI (c-call BI "sh64_fcmpges" frg frh))))
d533 3
a535 1
       (set rd (zext DI (c-call BI "sh64_fcmpgtd" drg drh))))
d541 3
a543 1
       (set rd (zext DI (c-call BI "sh64_fcmpgts" frg frh))))
d549 3
a551 1
       (set rd (zext DI (c-call BI "sh64_fcmpund" drg drh))))
d557 3
a559 1
       (set rd (zext DI (c-call BI "sh64_fcmpuns" frg frh))))
d565 8
a572 1
       (set frf (c-call SF "sh64_fcnvds" drgh)))
d578 8
a585 1
       (set drf (c-call DF "sh64_fcnvsd" frgh)))
d591 9
a599 1
       (set drf (c-call DF "sh64_fdivd" drg drh)))
d605 9
a613 1
       (set frf (c-call SF "sh64_fdivs" frg frh)))
d619 7
a625 3
       (unimp "fputscr"))
       ; FIXME: this should work!
       ; (set frf fpscr))
d631 12
a642 11
       (sequence ((UQI g) (UQI h) (SF temp))
		 (set g (index-of fvg))
		 (set h (index-of fvh))
		 (set temp (c-call SF "sh64_fmuls" (reg h-fr g) (reg h-fr h)))
		 (set temp (c-call SF "sh64_fadds" temp
		   (c-call SF "sh64_fmuls" (reg h-fr (add g 1)) (reg h-fr (add h 1)))))
		 (set temp (c-call SF "sh64_fadds" temp
		   (c-call SF "sh64_fmuls" (reg h-fr (add g 2)) (reg h-fr (add h 2)))))
		 (set temp (c-call SF "sh64_fadds" temp
		   (c-call SF "sh64_fmuls" (reg h-fr (add g 3)) (reg h-fr (add h 3)))))
		 (set frf temp)))
d648 9
a656 1
       (set drf (mem DF (add rm disp10x8))))
d662 11
a672 4
       (sequence ((QI f))
		 (set f (index-of fpf))
		 (set (reg h-fr f) (mem SF (add rm disp10x8)))
		 (set (reg h-fr (add f 1)) (mem SF (add rm (add disp10x8 4))))))
d678 9
a686 1
       (set frf (mem SF (add rm disp10x4))))
d692 10
a701 1
       (set drf (mem DF (add rm rn))))
d707 12
a718 4
       (sequence ((QI f))
		 (set f (index-of fpf))
		 (set (reg h-fr f) (mem SF (add rm rn)))
		 (set (reg h-fr (add f 1)) (mem SF (add rm (add rn 4))))))
d724 10
a733 1
       (set frf (mem SF (add rm rn))))
d739 8
a746 1
       (set drf (c-call DF "sh64_floatld" frgh)))
d752 8
a759 1
       (set frf (c-call SF "sh64_floatls" frgh)))
d765 8
a772 1
       (set drf (c-call DF "sh64_floatqd" drgh)))
d778 8
a785 1
       (set frf (c-call SF "sh64_floatqs" drgh)))
d791 10
a800 1
       (set frf (c-call SF "sh64_fadds" frf (c-call SF "sh64_fmuls" frg frh))))
d806 8
a813 1
       (set drf drgh))
d819 3
a821 1
       (set rd (subword DI drgh 0)))
d827 8
a834 1
       (set frf (subword SF (subword SI rm 1) 0)))
d840 8
a847 1
       (set drf (subword DF rm 0)))
d853 8
a860 1
       (set frf frgh))
d866 4
a869 1
       (set rd (ext DI (subword SI frgh 1))))
d875 9
a883 1
       (set drf (c-call DF "sh64_fmuld" drg drh)))
d889 9
a897 1
       (set frf (c-call SF "sh64_fmuls" frg frh)))
d903 8
a910 1
       (set drf (c-call DF "sh64_fnegd" drgh)))
d916 8
a923 1
       (set frf (c-call SF "sh64_fnegs" frgh)))
d929 2
a930 3
       (unimp "fputscr"))
       ; FIXME: this should work!
       ; (set fpscr (subword SI frgh 0)))
d936 8
a943 1
       (set drf (c-call DF "sh64_fsqrtd" drgh)))
d949 8
a956 1
       (set frf (c-call SF "sh64_fsqrts" frgh)))
d962 4
a965 1
       (set (mem DF (add rm disp10x8)) drf))
d971 6
a976 4
       (sequence ((QI f))
		 (set f (index-of fpf))
		 (set (mem SF (add rm disp10x8)) (reg h-fr f))
		 (set (mem SF (add rm (add disp10x8 4))) (reg h-fr (add f 1)))))
d982 4
a985 1
       (set (mem SF (add rm disp10x4)) frf))
d991 5
a995 1
       (set (mem DF (add rm rn)) drf))
d1001 7
a1007 4
       (sequence ((QI f))
		 (set f (index-of fpf))
		 (set (mem SF (add rm rn)) (reg h-fr f))
		 (set (mem SF (add rm (add rn 4))) (reg h-fr (add f 1)))))
d1013 5
a1017 1
       (set (mem SF (add rm rn)) frf))
d1023 9
a1031 1
       (set drf (c-call DF "sh64_fsubd" drg drh)))
d1037 9
a1045 1
       (set frf (c-call SF "sh64_fsubs" frg frh)))
d1051 8
a1058 1
       (set frf (c-call SF "sh64_ftrcdl" drgh)))
d1064 8
a1071 1
       (set frf (c-call SF "sh64_ftrcsl" frgh)))
d1077 8
a1084 1
       (set drf (c-call DF "sh64_ftrcdq" drgh)))
d1090 8
a1097 1
       (set drf (c-call DF "sh64_ftrcsq" frgh)))
d1103 9
a1111 1
       (c-call "sh64_ftrvs" (index-of mtrxg) (index-of fvh) (index-of fvf)))
d1117 6
a1122 1
       (unimp "getcfg"))
d1128 3
a1130 1
       (set rd crk))
d1135 4
a1138 2
       (+ (f-op 17) (f-25 0) trb (f-ext 5) (f-right 63) rd (f-rsvd 0))
       (set rd trb))
d1144 5
a1148 1
       (unimp "icbi"))
d1154 5
a1158 1
       (set rd (ext DI (mem QI (add rm (ext DI disp10))))))
d1164 5
a1168 1
       (set rd (ext DI (mem SI (add rm (ext DI disp10x4))))))
d1174 5
a1178 1
       (set rd (mem DI (add rm (ext DI disp10x8)))))
d1184 5
a1188 1
       (set rd (zext DI (mem QI (add rm (ext DI disp10))))))
d1194 5
a1198 1
       (set rd (zext DI (mem HI (add rm (ext DI disp10x2))))))
d1204 5
a1208 1
       (set rd (ext DI (mem HI (add rm (ext DI disp10x2))))))
d1243 5
a1247 1
					      (sub 32 (mul 8 bytecount))))))))))
d1271 5
a1275 1
					     (sub 64 (mul 8 bytecount)))))))))
d1310 5
a1314 1
				   (set rd (ext DI val)))))))
d1337 5
a1341 1
				   (set rd val))))))
d1347 6
a1352 1
       (set rd (ext DI (mem QI (add rm rn)))))
d1358 6
a1363 1
       (set rd (ext DI (mem SI (add rm rn)))))
d1369 6
a1374 1
       (set rd (mem DI (add rm rn))))
d1380 6
a1385 1
       (set rd (zext DI (mem UQI (add rm rn)))))
d1391 6
a1396 1
       (set rd (zext DI (mem UHI (add rm rn)))))
d1402 6
a1407 1
       (set rd (ext DI (mem HI (add rm rn)))))
d1460 4
a1463 1
       (slice-long-unop abs))
d1469 4
a1472 1
       (slice-word-unop abs))
d1478 4
a1481 1
       (slice-long add))
d1487 4
a1490 1
       (slice-word add))
d1498 5
a1502 1
       (slice-long -maddsl))
d1510 5
a1514 1
       (slice-byte -maddsub))
d1522 5
a1526 1
       (slice-word -maddsw))
d1536 5
a1540 1
       (slice-byte -mcmpeqb))
d1547 5
a1551 1
       (slice-long -mcmpeql))
d1558 5
a1562 1
       (slice-word -mcmpeqw))
d1574 5
a1578 1
       (slice-long -mcmpgtl))
d1585 5
a1589 1
       (slice-byte -mcmpgtub))
d1596 5
a1600 1
       (slice-word -mcmpgtw))
d1606 4
a1609 1
       (set rd (or (and rm rn) (and rd (inv rn)))))
d1620 5
a1624 1
		 (set rd (-join-hi result3 result2 result1 result0))))
d1641 5
a1645 1
				 result3 result2 result1 result0))))
d1662 5
a1666 1
				 result2 result1 result0))))
d1684 4
a1687 1
		   (set rd (or DI rhs (sll DI (and rn mask) count))))))
d1712 4
a1715 1
		 (set rd (-join-si result1 result0))))
d1732 4
a1735 1
		 (set rd (-join-si result1 result0))))
d1741 5
a1745 1
       (slice-long mul))
d1751 5
a1755 1
       (slice-word mul))
d1766 5
a1770 1
		 (set rd (-join-si result1 result0))))
d1785 5
a1789 1
		 (set rd (-join-hi result3 result2 result1 result0))))
d1805 5
a1809 1
		 (set rd (-join-hi result3 result2 result1 result0))))
d1818 5
a1822 1
		 (set rd (-join-si result1 result0))))
d1831 5
a1835 1
		 (set rd (-join-si result1 result0))))
d1846 4
a1849 1
		 (set rd (add rd acc))))
d1855 2
a1856 1
       (set rd (ext DI imm16)))
d1868 4
a1871 1
		 (set rd (-join-hi result3 result2 result1 result0))))
d1886 4
a1889 1
		 (set rd (add rd acc))))
d1896 5
a1900 1
       (slice-long-unop -mshaldsl))
d1907 5
a1911 1
       (slice-word-unop -mshaldsw))
d1918 4
a1921 1
       (slice-long-unop -mshardl))
d1928 4
a1931 1
       (slice-word-unop -mshardw))
d1937 5
a1941 1
       (set rd (saturate DI 16 (sra rm (and rn 63)))))
d1958 4
a1961 1
				 result2 result1 result0))))
d1970 4
a1973 1
		 (set rd (-join-si result1 result0))))
d1984 4
a1987 1
		 (set rd (-join-hi result3 result2 result1 result0))))
d2004 4
a2007 1
				 result2 result1 result0))))
d2016 4
a2019 1
		 (set rd (-join-si result1 result0))))
d2030 4
a2033 1
		 (set rd (-join-hi result3 result2 result1 result0))))
d2040 4
a2043 1
       (slice-long-unop -mshlldl))
d2050 4
a2053 1
       (slice-word-unop -mshlldw))
d2060 4
a2063 1
       (slice-long-unop -mshlrdl))
d2070 4
a2073 1
       (slice-word-unop -mshlrdw))
d2079 4
a2082 1
       (slice-long sub))
d2088 4
a2091 1
       (slice-word sub))
d2099 5
a2103 1
       (slice-long -msubsl))
d2111 5
a2115 1
       (slice-byte -msubsub))
d2123 5
a2127 1
       (slice-byte -msubsw))
d2133 5
a2137 1
       (set rd (mul (ext DI (subword SI rm 1)) (ext DI (subword SI rn 1)))))
d2143 5
a2147 1
       (set rd (mul (zext DI (subword SI rm 1)) (zext DI (subword SI rn 1)))))
d2153 2
a2154 1
       (nop))
d2161 3
a2163 1
       (set rd (c-call DI "sh64_nsb" rm)))
d2169 5
a2173 1
       (unimp "ocbi"))
d2179 5
a2183 1
       (unimp "ocbp"))
d2189 5
a2193 1
       (unimp "ocbwb"))
d2199 4
a2202 1
       (set rd (or rm rn)))
d2208 3
a2210 1
       (set rd (or rm (ext DI imm10))))
d2216 5
a2220 1
       (unimp "prefi"))
d2225 6
a2230 2
       (+ (f-op 58) disp16 likely (f-8-2 0) tra (f-rsvd 0))
       (set tra (add disp16 1)))
d2235 7
a2241 2
       (+ (f-op 26) (f-left 63) (f-ext 1) rn likely (f-8-2 0) tra (f-rsvd 0))
       (set tra rn))
d2246 6
a2251 2
       (+ (f-op 59) disp16 likely (f-8-2 0) tra (f-rsvd 0))
       (set tra disp16))
d2256 7
a2262 2
       (+ (f-op 26) (f-left 63) (f-ext 5) rn likely (f-8-2 0) tra (f-rsvd 0))
       (set tra (add pc rn)))
d2268 6
a2273 1
       (unimp "putcfg"))
d2279 3
a2281 1
       (set crj rm))
d2287 2
a2288 1
       (unimp "rte"))
d2294 4
a2297 1
       (set rd (sra rm (and rn 63))))
d2303 4
a2306 1
       (set rd (ext DI (sra (subword SI rm 1) (and rn 63)))))
d2312 3
a2314 1
       (set rd (sra rm uimm6)))
d2320 3
a2322 1
       (set rd (ext DI (sra (subword SI rm 1) (and uimm6 63)))))
d2328 4
a2331 1
       (set rd (sll rm (and rn 63))))
d2337 4
a2340 1
       (set rd (ext DI (sll (subword SI rm 1) (and rn 63)))))
d2346 3
a2348 1
       (set rd (sll rm uimm6)))
d2354 3
a2356 1
       (set rd (ext DI (sll (subword SI rm 1) (and uimm6 63)))))
d2362 4
a2365 1
       (set rd (srl rm (and rn 63))))
d2371 4
a2374 1
       (set rd (ext DI (srl (subword SI rm 1) (and rn 63)))))
d2380 3
a2382 1
       (set rd (srl rm uimm6)))
d2388 3
a2390 1
       (set rd (ext DI (srl (subword SI rm 1) (and uimm6 63)))))
d2396 3
a2398 1
       (set rd (or (sll rd 16) (zext DI uimm16))))
d2404 2
a2405 1
       (unimp "sleep"))
d2411 3
a2413 1
       (set (mem UQI (add rm (ext DI disp10))) (and QI rd #xff)))
d2419 3
a2421 1
       (set (mem SI (add rm (ext DI disp10x4))) (and SI rd #xffffffff)))
d2427 3
a2429 1
       (set (mem DI (add rm (ext DI disp10x8))) rd))
d2435 3
a2437 1
       (set (mem HI (add rm (ext DI disp10x2))) (and HI rd #xffff)))
d2475 3
a2477 1
				   (-sthi-byte))))))
d2498 3
a2500 1
				   (-sthi-byte))))))
d2537 3
a2539 1
				   (-stlo-word))))))
d2560 3
a2562 1
				   (-stlo-long))))))
d2568 4
a2571 1
       (set (mem UQI (add rm rn)) (subword QI rd 7)))
d2577 4
a2580 1
       (set (mem SI (add rm rn)) (subword SI rd 1)))
d2586 4
a2589 1
       (set (mem DI (add rm rn)) rd))
d2595 4
a2598 1
       (set (mem HI (add rm rn)) (subword HI rd 3)))
d2604 4
a2607 1
       (set rd (sub rm rn)))
d2613 4
a2616 1
       (set rd (ext DI (sub (subword SI rm 1) (subword SI rn 1)))))
d2626 4
a2629 1
		 (set rd temp)))
d2635 2
a2636 1
       (unimp "synci"))
d2642 2
a2643 1
       (unimp "synco"))
d2649 3
a2651 1
       (c-call "sh64_trapa" rm pc))
d2657 4
a2660 1
       (set rd (xor rm rn)))
d2666 3
a2668 1
       (set rd (xor rm (ext DI imm6))))
@


1.4
log
@Replace occurrances of 'Hitachi' with 'Renesas'.
@
text
@d1 1
a1 1
; Renesas SHmedia instruction set description.  -*- Scheme -*-
d30 2
a31 1
; See Renesas SH-5 CPU core, volume 2, p. 25 for details.
@


1.3
log
@cgen:
	* cpu/sh64-media.cpu (make-mextr): Fix setting of count.

sim/sh64:
	* sem-media-switch.c, sem-media.c: Regenerate.
@
text
@d1 1
a1 1
; Hitachi SHmedia instruction set description.  -*- Scheme -*-
d30 1
a30 1
; See Hitachi SH-5 CPU core, volume 2, p. 25 for details.
@


1.2
log
@2002-06-25  J"orn Rennecke <joern.rennecke@@superh.com>

	* cpu/sh64-compact.cpu (movw5): Use Correct operand field for reg.
	* cpu/sh64-media.cpu (-ldhi-byte, -ldhi-word, -ldhi-long): New macros.
	(-ldlo-byte, -ldlo-word, -ldlo-long): Likewise.
	(-sthi-word, -sthi-long -stlo-byte, -stlo-word, -stlo-long): Likewise.
	(ldhil, ldhiq, ldlol, ldloq, stlol, stloq): Implement.
	(mshfhib, mshfhil, mshfhiw, mshflob, mshflol, mshflow): Fix indices.
	(-sthi-byte): If there is a single byte to store, store it at
	proper address.
	(sthil, sthiq): Fix big-endian behaviour.
	(mcnvslw, mcnvswb, mcnvswub, mmacfxwl, mmacnfx.wl): Fix indices.
	(mmulfxl, mmulfxw, mmulfxrpw, mmulhiwl, mmullowl): Likewise.
	(saturate): Use Dimode to check if saturation operation is required.
	(usaturate): Likewise.
	(mpermw): Fix mask.
	(-maddsl, -maddsub): Compute to-be-saturated value in wider mode.
	(-maddsw, mmacfxwl, mmacnfx.wl, -mshaldsl, -mshaldsw): Likewise.
	(-mshardl, -mshardw, -msubsl, -msubsub, -msubsw): Likewise.
	(msadubq): Fix subword index in second operand of first subtraction.
@
text
@d1123 1
a1123 1
		   (set count (mul QI 8 (sub QI 8 n)))
d1126 1
a1126 1
		   (set count (mul QI 8 n))
@


1.2.12.1
log
@Merge drow-cplus-branch to:
  cvs rtag -D 2003-12-14 00:00:00 UTC drow-cplus-merge-20031214 gdb+dejagnu
@
text
@d1 1
a1 1
; SuperH SHmedia instruction set description.  -*- Scheme -*-
d30 1
a30 2
; See SuperH (SH) 64 bit RISC Series / SH-5 CPU Core, Volume 2,
; page 11 for details.  (page number refers to 05-CC-10002 V1.0).
d1123 1
a1123 1
		   (set count (mul QI 8 n))
d1126 1
a1126 1
		   (set count (mul QI 8 (sub QI 8 n)))
@


1.2.10.1
log
@2003-03-05  David Carlton  <carlton@@math.stanford.edu>

	* Merge with mainline.  Tag is carlton_dictionary-20030305-merge.
@
text
@d1123 1
a1123 1
		   (set count (mul QI 8 n))
d1126 1
a1126 1
		   (set count (mul QI 8 (sub QI 8 n)))
@


1.2.10.2
log
@2003-04-16  David Carlton  <carlton@@bactrian.org>

	* Merge with mainline; tag is carlton_dictionary-20030416-merge.
@
text
@d1 1
a1 1
; Renesas SHmedia instruction set description.  -*- Scheme -*-
d30 1
a30 1
; See Renesas SH-5 CPU core, volume 2, p. 25 for details.
@


1.2.10.3
log
@2003-05-23  David Carlton  <carlton@@bactrian.org>

	* Merge with mainline; tag is carlton_dictionary-20030523-merge.
@
text
@d1 1
a1 1
; SuperH SHmedia instruction set description.  -*- Scheme -*-
d30 1
a30 2
; See SuperH (SH) 64 bit RISC Series / SH-5 CPU Core, Volume 2,
; page 11 for details.  (page number refers to 05-CC-10002 V1.0).
@


1.1
log
@* Contribute Hitachi SH5 port.
@
text
@d3 1
d35 1
a35 1
  (if mode (lt i (neg mode (sll mode 1 (sub n 1))))
d37 1
a37 1
      (if mode (lt i (sll mode 1 (sub n 1)))
d44 1
a44 1
  (if mode (lt i (const mode 0))
d46 1
a46 1
      (if mode (lt i (sll mode 1 n))
d763 12
d779 18
a796 2
       ; FIXME.
       (unimp "ldhil"))
d802 31
a832 2
       ; FIXME.
       (unimp "ldhiq"))
d838 18
a855 2
       ; FIXME.
       (unimp "ldlol"))
d861 18
a878 2
       ; FIXME;
       (unimp "ldloq"))
d987 2
a988 1
(define-pmacro (-maddsl arg1 arg2) (saturate SI 32 (add arg1 arg2)))
d995 2
a996 1
(define-pmacro (-maddsub arg1 arg2) (usaturate QI 8 (add arg1 arg2)))
d1003 2
a1004 1
(define-pmacro (-maddsw arg1 arg2) (saturate HI 16 (add arg1 arg2)))
d1072 4
a1075 4
		 (set result0 (saturate HI 16 (subword SI rm 0)))
		 (set result1 (saturate HI 16 (subword SI rm 1)))
		 (set result2 (saturate HI 16 (subword SI rn 0)))
		 (set result3 (saturate HI 16 (subword SI rn 1)))
d1084 8
a1091 8
		 (set result0 (saturate QI 8 (subword HI rm 0)))
		 (set result1 (saturate QI 8 (subword HI rm 1)))
		 (set result2 (saturate QI 8 (subword HI rm 2)))
		 (set result3 (saturate QI 8 (subword HI rm 3)))
		 (set result4 (saturate QI 8 (subword HI rn 0)))
		 (set result5 (saturate QI 8 (subword HI rn 1)))
		 (set result6 (saturate QI 8 (subword HI rn 2)))
		 (set result7 (saturate QI 8 (subword HI rn 3)))
d1101 8
a1108 8
		 (set result0 (usaturate QI 8 (subword HI rm 0)))
		 (set result1 (usaturate QI 8 (subword HI rm 1)))
		 (set result2 (usaturate QI 8 (subword HI rm 2)))
		 (set result3 (usaturate QI 8 (subword HI rm 3)))
		 (set result4 (usaturate QI 8 (subword HI rn 0)))
		 (set result5 (usaturate QI 8 (subword HI rn 1)))
		 (set result6 (usaturate QI 8 (subword HI rn 2)))
		 (set result7 (usaturate QI 8 (subword HI rn 3)))
d1143 10
a1152 8
		 (set result0 (subword SI rd 0))
		 (set result1 (subword SI rd 1))
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
		 (set temp (saturate SI 32 (sll temp 1)))
		 (set result0 (saturate SI 32 (add result0 temp)))
		 (set temp (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
		 (set temp (saturate SI 32 (sll temp 1)))
		 (set result1 (saturate SI 32 (add result1 temp)))
d1160 10
a1169 8
		 (set result0 (subword SI rd 0))
		 (set result1 (subword SI rd 1))
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
		 (set temp (saturate SI 32 (sll temp 1)))
		 (set result0 (saturate SI 32 (sub result0 temp)))
		 (set temp (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
		 (set temp (saturate SI 32 (sll temp 1)))
		 (set result1 (saturate SI 32 (sub result1 temp)))
d1189 2
a1191 2
		 (set result0 (saturate SI 32 (sra temp 31)))
		 (set temp (mul (zext DI (subword SI rm 1)) (zext DI (subword SI rn 1))))
d1200 1
a1200 1
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
d1202 2
a1204 2
		 (set result1 (saturate HI 16 (sra temp 15)))
		 (set temp (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
d1206 1
a1206 1
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
d1216 1
a1216 1
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
d1218 2
a1220 2
		 (set result1 (saturate HI 16 (sra (add temp c) 15)))
		 (set temp (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
d1222 1
a1222 1
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
d1231 2
a1232 2
		 (set result0 (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
		 (set result1 (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
d1240 2
a1241 2
		 (set result0 (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
		 (set result1 (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
d1266 1
a1266 1
		 (set control (and QI rn #x3f))
d1278 1
a1278 1
		 (set acc (abs DI (sub (subword QI rm 0) (subword QI rn 1))))
d1288 1
a1288 1
(define-pmacro (-mshaldsl arg) (saturate SI 32 (sll arg (and rn 31))))
d1295 1
a1295 1
(define-pmacro (-mshaldsw arg) (saturate HI 16 (sll arg (and rn 15))))
d1328 8
a1335 8
		 (set result0 (subword QI rm 4))
		 (set result1 (subword QI rn 4))
		 (set result2 (subword QI rm 5))
		 (set result3 (subword QI rn 5))
		 (set result4 (subword QI rm 6))
		 (set result5 (subword QI rn 6))
		 (set result6 (subword QI rm 7))
		 (set result7 (subword QI rn 7))
d1344 2
a1345 2
		 (set result0 (subword SI rm 1))
		 (set result1 (subword SI rn 1))
d1353 4
a1356 4
		 (set result0 (subword HI rm 2))
		 (set result1 (subword HI rn 2))
		 (set result2 (subword HI rm 3))
		 (set result3 (subword HI rn 3))
d1365 8
a1372 8
		 (set result0 (subword QI rm 0))
		 (set result1 (subword QI rn 0))
		 (set result2 (subword QI rm 1))
		 (set result3 (subword QI rn 1))
		 (set result4 (subword QI rm 2))
		 (set result5 (subword QI rn 2))
		 (set result6 (subword QI rm 3))
		 (set result7 (subword QI rn 3))
d1381 2
a1382 2
		 (set result0 (subword SI rm 0))
		 (set result1 (subword SI rn 0))
d1390 4
a1393 4
		 (set result0 (subword HI rm 0))
		 (set result1 (subword HI rn 0))
		 (set result2 (subword HI rm 1))
		 (set result3 (subword HI rn 1))
d1436 2
a1437 1
(define-pmacro (-msubsl arg1 arg2) (saturate SI 32 (sub arg1 arg2)))
d1444 2
a1445 1
(define-pmacro (-msubsub arg1 arg2) (usaturate QI 8 (sub arg1 arg2)))
d1452 2
a1453 1
(define-pmacro (-msubsw arg1 arg2) (saturate HI 16 (sub arg1 arg2)))
d1672 16
a1687 4
  (sequence ()
	    (set (mem UQI addr) (and QI val #xff))
	    (set val (srl val 8))
	    (set addr (add addr 1))))
d1696 12
a1707 12
		 (if endian
		     (set val rd)
		     (set val (srl rd (sub 32 (mul 8 bytecount)))))
		 (set addr (add (sub addr bytecount) 1))
		 (if (gt bytecount 3)
		     (-sthi-byte))
		 (if (gt bytecount 2)
		     (-sthi-byte))
		 (if (gt bytecount 1)
		     (-sthi-byte))
		 (if (gt bytecount 0)
		     (-sthi-byte))))
d1716 31
a1746 20
		 (if endian
		     (set val rd)
		     (set val (srl rd (sub 64 (mul 8 bytecount)))))
		 (set addr (add (sub addr bytecount) 1))
		 (if (gt bytecount 7)
		     (-sthi-byte))
		 (if (gt bytecount 6)
		     (-sthi-byte))
		 (if (gt bytecount 5)
		     (-sthi-byte))
		 (if (gt bytecount 4)
		     (-sthi-byte))
		 (if (gt bytecount 3)
		     (-sthi-byte))
		 (if (gt bytecount 2)
		     (-sthi-byte))
		 (if (gt bytecount 1)
		     (-sthi-byte))
		 (if (gt bytecount 0)
		     (-sthi-byte))))
d1752 14
a1765 2
       ; FIXME.
       (unimp "stlol"))
d1771 16
a1786 2
       ; FIXME.
       (unimp "stloq"))
@


1.1.8.1
log
@Merge w/trunk (kseitz_interps-20020722-merge).
@
text
@a2 1
; Copyright (C) 2002 SuperH Ltd
d34 1
a34 1
  (if mode (lt i (neg DI (sll DI 1 (sub n 1))))
d36 1
a36 1
      (if mode (lt i (sll DI 1 (sub n 1)))
d43 1
a43 1
  (if mode (lt i (const DI 0))
d45 1
a45 1
      (if mode (lt i (sll DI 1 n))
a761 12
(define-pmacro (-ldhi-byte)
  (if (and bytecount 1)
      (set val (add (sll val 8) (zext DI (mem QI addr))))))

(define-pmacro (-ldhi-word)
  (if (and bytecount 2)
      (set val (add (sll val 16) (zext DI (mem HI (and addr -4)))))))

(define-pmacro (-ldhi-long)
  (if (and bytecount 4)
      (set val (add (sll val 32) (zext DI (mem SI (and addr -8)))))))

d766 2
a767 18
       (sequence ((DI addr) (QI bytecount) (SI val))
		 (set addr (add rm disp6))
		 (set bytecount (add (and addr 3) 1))
		 (set val 0)
		 (if (and bytecount 4)
		     (set rd (ext DI (mem SI (and addr -4))))
		     (if endian
			 (sequence () ; Big endian.
				   (-ldhi-word)
				   (-ldhi-byte)
				   (set rd (ext DI val)))
			 (sequence () ; Little endian.
				   (-ldhi-byte)
				   (-ldhi-word)
				   (set rd
					(ext DI
					 (sll SI val
					      (sub 32 (mul 8 bytecount))))))))))
d773 2
a774 31
       (sequence ((DI addr) (QI bytecount) (DI val))
		 (set addr (add rm disp6))
		 (set bytecount (add (and addr 7) 1))
		 (set val 0)
		 (if (and bytecount 8)
		     (set rd (mem DI (and addr -8)))
		     (if endian
			 (sequence () ; Big endian.
				   (-ldhi-long)
				   (-ldhi-word)
				   (-ldhi-byte)
				   (set rd val))
			 (sequence () ; Little endian.
				   (-ldhi-byte)
				   (-ldhi-word)
				   (-ldhi-long)
				   (set rd
					(sll val
					     (sub 64 (mul 8 bytecount)))))))))

(define-pmacro (-ldlo-byte)
  (if (and bytecount 1)
      (set val (add (sll val 8) (zext DI (mem QI addr))))))

(define-pmacro (-ldlo-word)
  (if (and bytecount 2)
      (set val (add (sll val 16) (zext DI (mem HI (and (add addr 1) -2)))))))

(define-pmacro (-ldlo-long)
  (if (and bytecount 4)
      (set val (add (sll val 32) (zext DI (mem SI (and (add addr 3) -4)))))))
d780 2
a781 18
       (sequence ((DI addr) (QI bytecount) (SI val))
		 (set addr (add rm disp6))
		 (set bytecount (sub 4 (and addr 3)))
		 (set val 0)
		 (if (and bytecount 4)
		     (set rd (ext DI (mem SI addr)))
		     (if endian
			 (sequence () ; Big endian.
				   (-ldlo-byte)
				   (-ldlo-word)
				   (set rd
					(ext DI
					 (sll SI val
					      (sub 32 (mul 8 bytecount))))))
			 (sequence () ; Little endian.
				   (-ldlo-word)
				   (-ldlo-byte)
				   (set rd (ext DI val)))))))
d787 2
a788 18
       (sequence ((DI addr) (QI bytecount) (DI val))
		 (set addr (add rm disp6))
		 (set bytecount (sub 8 (and addr 7)))
		 (set val 0)
		 (if (and bytecount 8)
		     (set rd (mem DI addr))
		     (if endian
			 (sequence () ; Big endian.
				   (-ldlo-byte)
				   (-ldlo-word)
				   (-ldlo-long)
				   (set rd
					(sll val (sub 64 (mul 8 bytecount)))))
			 (sequence () ; Little endian.
				   (-ldlo-long)
				   (-ldlo-word)
				   (-ldlo-byte)
				   (set rd val))))))
d897 1
a897 2
(define-pmacro (-maddsl arg1 arg2) (saturate SI 32 (add (ext DI arg1)
							(ext DI arg2))))
d904 1
a904 2
(define-pmacro (-maddsub arg1 arg2) (usaturate QI 8 (add (zext DI arg1)
							 (zext DI arg2))))
d911 1
a911 2
(define-pmacro (-maddsw arg1 arg2) (saturate HI 16 (add (ext DI arg1)
							(ext DI arg2))))
d979 4
a982 4
		 (set result0 (saturate HI 16 (subword SI rm 1)))
		 (set result1 (saturate HI 16 (subword SI rm 0)))
		 (set result2 (saturate HI 16 (subword SI rn 1)))
		 (set result3 (saturate HI 16 (subword SI rn 0)))
d991 8
a998 8
		 (set result0 (saturate QI 8 (subword HI rm 3)))
		 (set result1 (saturate QI 8 (subword HI rm 2)))
		 (set result2 (saturate QI 8 (subword HI rm 1)))
		 (set result3 (saturate QI 8 (subword HI rm 0)))
		 (set result4 (saturate QI 8 (subword HI rn 3)))
		 (set result5 (saturate QI 8 (subword HI rn 2)))
		 (set result6 (saturate QI 8 (subword HI rn 1)))
		 (set result7 (saturate QI 8 (subword HI rn 0)))
d1008 8
a1015 8
		 (set result0 (usaturate QI 8 (subword HI rm 3)))
		 (set result1 (usaturate QI 8 (subword HI rm 2)))
		 (set result2 (usaturate QI 8 (subword HI rm 1)))
		 (set result3 (usaturate QI 8 (subword HI rm 0)))
		 (set result4 (usaturate QI 8 (subword HI rn 3)))
		 (set result5 (usaturate QI 8 (subword HI rn 2)))
		 (set result6 (usaturate QI 8 (subword HI rn 1)))
		 (set result7 (usaturate QI 8 (subword HI rn 0)))
d1050 8
a1057 10
		 (set result0 (subword SI rd 1))
		 (set result1 (subword SI rd 0))
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
		 (set temp (saturate SI 32 (sll DI temp 1)))
		 (set result0 (saturate SI 32 (add (ext DI result0)
						   (ext DI temp))))
		 (set temp (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
		 (set temp (saturate SI 32 (sll DI temp 1)))
		 (set result1 (saturate SI 32 (add (ext DI result1)
						   (ext DI temp))))
d1065 8
a1072 10
		 (set result0 (subword SI rd 1))
		 (set result1 (subword SI rd 0))
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
		 (set temp (saturate SI 32 (sll DI temp 1)))
		 (set result0 (saturate SI 32 (sub (ext DI result0)
						   (ext DI temp))))
		 (set temp (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
		 (set temp (saturate SI 32 (sll DI temp 1)))
		 (set result1 (saturate SI 32 (sub (ext DI result1)
						   (ext DI temp))))
d1092 2
a1094 2
		 (set result0 (saturate SI 32 (sra temp 31)))
		 (set temp (mul (zext DI (subword SI rm 0)) (zext DI (subword SI rn 0))))
d1103 1
a1103 1
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
d1105 2
a1107 2
		 (set result1 (saturate HI 16 (sra temp 15)))
		 (set temp (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
d1109 1
a1109 1
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
d1119 1
a1119 1
		 (set temp (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
d1121 2
a1123 2
		 (set result1 (saturate HI 16 (sra (add temp c) 15)))
		 (set temp (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
d1125 1
a1125 1
		 (set temp (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
d1134 2
a1135 2
		 (set result0 (mul (zext SI (subword HI rm 1)) (zext SI (subword HI rn 1))))
		 (set result1 (mul (zext SI (subword HI rm 0)) (zext SI (subword HI rn 0))))
d1143 2
a1144 2
		 (set result0 (mul (zext SI (subword HI rm 3)) (zext SI (subword HI rn 3))))
		 (set result1 (mul (zext SI (subword HI rm 2)) (zext SI (subword HI rn 2))))
d1169 1
a1169 1
		 (set control (and QI rn #xff))
d1181 1
a1181 1
		 (set acc (abs DI (sub (subword QI rm 0) (subword QI rn 0))))
d1191 1
a1191 1
(define-pmacro (-mshaldsl arg) (saturate SI 32 (sll DI arg (and rn 31))))
d1198 1
a1198 1
(define-pmacro (-mshaldsw arg) (saturate HI 16 (sll DI arg (and rn 15))))
d1231 8
a1238 8
		 (set result0 (subword QI rm 3))
		 (set result1 (subword QI rn 3))
		 (set result2 (subword QI rm 2))
		 (set result3 (subword QI rn 2))
		 (set result4 (subword QI rm 1))
		 (set result5 (subword QI rn 1))
		 (set result6 (subword QI rm 0))
		 (set result7 (subword QI rn 0))
d1247 2
a1248 2
		 (set result0 (subword SI rm 0))
		 (set result1 (subword SI rn 0))
d1256 4
a1259 4
		 (set result0 (subword HI rm 1))
		 (set result1 (subword HI rn 1))
		 (set result2 (subword HI rm 0))
		 (set result3 (subword HI rn 0))
d1268 8
a1275 8
		 (set result0 (subword QI rm 7))
		 (set result1 (subword QI rn 7))
		 (set result2 (subword QI rm 6))
		 (set result3 (subword QI rn 6))
		 (set result4 (subword QI rm 5))
		 (set result5 (subword QI rn 5))
		 (set result6 (subword QI rm 4))
		 (set result7 (subword QI rn 4))
d1284 2
a1285 2
		 (set result0 (subword SI rm 1))
		 (set result1 (subword SI rn 1))
d1293 4
a1296 4
		 (set result0 (subword HI rm 3))
		 (set result1 (subword HI rn 3))
		 (set result2 (subword HI rm 2))
		 (set result3 (subword HI rn 2))
d1339 1
a1339 2
(define-pmacro (-msubsl arg1 arg2) (saturate SI 32 (sub (ext DI arg1)
							(ext DI arg2))))
d1346 1
a1346 2
(define-pmacro (-msubsub arg1 arg2) (usaturate QI 8 (sub (zext DI arg1)
							 (zext DI arg2))))
d1353 1
a1353 2
(define-pmacro (-msubsw arg1 arg2) (saturate HI 16 (sub (ext DI arg1)
							(ext DI arg2))))
d1572 4
a1575 16
  (if (and bytecount 1)
      (sequence ()
		(set (mem UQI addr) (and QI val #xff))
		(set val (srl val 8)))))

(define-pmacro (-sthi-word)
  (if (and bytecount 2)
      (sequence ()
		(set (mem HI (and addr -4)) (and HI val #xffff))
		(set val (srl val 16)))))

(define-pmacro (-sthi-long)
  (if (and bytecount 4)
      (sequence ()
		(set (mem SI (and addr -8)) (and SI val #xffffffff))
		(set val (srl val 32)))))
d1584 12
a1595 12
		 (if (and bytecount 4)
		     (set (mem SI (and addr -4)) rd)
		     (if endian
			 (sequence ()
				   ; Big endian.
				   (set val rd)
				   (-sthi-byte)
				   (-sthi-word))
			 (sequence ()
				   (set val (srl rd (sub 32 (mul 8 bytecount))))
				   (-sthi-word)
				   (-sthi-byte))))))
d1604 20
a1623 31
		 (if (and bytecount 8)
		     (set (mem DI (and addr -8)) rd)
		     (if endian
			 (sequence ()
				   (set val rd)
				   (-sthi-byte)
				   (-sthi-word)
				   (-sthi-long))
			 (sequence ()
				   (set val (srl rd (sub 64 (mul 8 bytecount))))
				   (-sthi-long)
				   (-sthi-word)
				   (-sthi-byte))))))

(define-pmacro (-stlo-byte)
  (if (and bytecount 1)
      (sequence ()
		(set (mem UQI addr) (and QI val #xff))
		(set val (srl val 8)))))

(define-pmacro (-stlo-word)
  (if (and bytecount 2)
      (sequence ()
		(set (mem UHI (and (add addr 1) -2)) (and HI val #xffff))
		(set val (srl val 16)))))

(define-pmacro (-stlo-long)
  (if (and bytecount 4)
      (sequence ()
		(set (mem USI (and (add addr  3) -4)) (and SI val #xffffffff))
		(set val (srl val 32)))))
d1629 2
a1630 14
       (sequence ((DI addr) (QI bytecount) (DI val))
		 (set addr (add rm disp6))
		 (set bytecount (sub 4 (and addr 3)))
		 (if (and bytecount 4)
		     (set (mem USI addr) rd)
		     (if endian
			 (sequence ()
				   (set val (srl rd (sub 32 (mul 8 bytecount))))
				   (-stlo-word)
				   (-stlo-byte))
			 (sequence ()
				   (set val rd)
				   (-stlo-byte)
				   (-stlo-word))))))
d1636 2
a1637 16
       (sequence ((DI addr) (QI bytecount) (DI val))
		 (set addr (add rm disp6))
		 (set bytecount (sub 8 (and addr 7)))
		 (if (and bytecount 8)
		     (set (mem UDI addr) rd)
		     (if endian
			 (sequence ()
				   (set val (srl rd (sub 64 (mul 8 bytecount))))
				   (-stlo-long)
				   (-stlo-word)
				   (-stlo-byte))
			 (sequence ()
				   (set val rd)
				   (-stlo-byte)
				   (-stlo-word)
				   (-stlo-long))))))
@


