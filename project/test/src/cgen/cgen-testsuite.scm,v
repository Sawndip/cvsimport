head	1.1;
access;
symbols
	sid-snapshot-20180601:1.1
	cgen-snapshot-20180601:1.1
	sid-snapshot-20180501:1.1
	cgen-snapshot-20180501:1.1
	sid-snapshot-20180401:1.1
	cgen-snapshot-20180401:1.1
	sid-snapshot-20180301:1.1
	cgen-snapshot-20180301:1.1
	sid-snapshot-20180201:1.1
	cgen-snapshot-20180201:1.1
	sid-snapshot-20180101:1.1
	cgen-snapshot-20180101:1.1
	sid-snapshot-20171201:1.1
	cgen-snapshot-20171201:1.1
	sid-snapshot-20171101:1.1
	cgen-snapshot-20171101:1.1
	sid-snapshot-20171001:1.1
	cgen-snapshot-20171001:1.1
	sid-snapshot-20170901:1.1
	cgen-snapshot-20170901:1.1
	sid-snapshot-20170801:1.1
	cgen-snapshot-20170801:1.1
	sid-snapshot-20170701:1.1
	cgen-snapshot-20170701:1.1
	sid-snapshot-20170601:1.1
	cgen-snapshot-20170601:1.1
	sid-snapshot-20170501:1.1
	cgen-snapshot-20170501:1.1
	sid-snapshot-20170401:1.1
	cgen-snapshot-20170401:1.1
	sid-snapshot-20170301:1.1
	cgen-snapshot-20170301:1.1
	sid-snapshot-20170201:1.1
	cgen-snapshot-20170201:1.1
	sid-snapshot-20170101:1.1
	cgen-snapshot-20170101:1.1
	sid-snapshot-20161201:1.1
	cgen-snapshot-20161201:1.1
	sid-snapshot-20161101:1.1
	cgen-snapshot-20161101:1.1
	sid-snapshot-20160901:1.1
	cgen-snapshot-20160901:1.1
	sid-snapshot-20160801:1.1
	cgen-snapshot-20160801:1.1
	sid-snapshot-20160701:1.1
	cgen-snapshot-20160701:1.1
	sid-snapshot-20160601:1.1
	cgen-snapshot-20160601:1.1
	sid-snapshot-20160501:1.1
	cgen-snapshot-20160501:1.1
	sid-snapshot-20160401:1.1
	cgen-snapshot-20160401:1.1
	sid-snapshot-20160301:1.1
	cgen-snapshot-20160301:1.1
	sid-snapshot-20160201:1.1
	cgen-snapshot-20160201:1.1
	sid-snapshot-20160101:1.1
	cgen-snapshot-20160101:1.1
	sid-snapshot-20151201:1.1
	cgen-snapshot-20151201:1.1
	sid-snapshot-20151101:1.1
	cgen-snapshot-20151101:1.1
	sid-snapshot-20151001:1.1
	cgen-snapshot-20151001:1.1
	sid-snapshot-20150901:1.1
	cgen-snapshot-20150901:1.1
	sid-snapshot-20150801:1.1
	cgen-snapshot-20150801:1.1
	sid-snapshot-20150701:1.1
	cgen-snapshot-20150701:1.1
	sid-snapshot-20150601:1.1
	cgen-snapshot-20150601:1.1
	sid-snapshot-20150501:1.1
	cgen-snapshot-20150501:1.1
	sid-snapshot-20150401:1.1
	cgen-snapshot-20150401:1.1
	sid-snapshot-20150301:1.1
	cgen-snapshot-20150301:1.1
	sid-snapshot-20150201:1.1
	cgen-snapshot-20150201:1.1
	sid-snapshot-20150101:1.1
	cgen-snapshot-20150101:1.1
	sid-snapshot-20141201:1.1
	cgen-snapshot-20141201:1.1
	sid-snapshot-20141101:1.1
	cgen-snapshot-20141101:1.1
	sid-snapshot-20141001:1.1
	cgen-snapshot-20141001:1.1
	sid-snapshot-20140901:1.1
	cgen-snapshot-20140901:1.1
	sid-snapshot-20140801:1.1
	cgen-snapshot-20140801:1.1
	sid-snapshot-20140701:1.1
	cgen-snapshot-20140701:1.1
	sid-snapshot-20140601:1.1
	cgen-snapshot-20140601:1.1
	sid-snapshot-20140501:1.1
	cgen-snapshot-20140501:1.1
	sid-snapshot-20140401:1.1
	cgen-snapshot-20140401:1.1
	sid-snapshot-20140301:1.1
	cgen-snapshot-20140301:1.1
	sid-snapshot-20140201:1.1
	cgen-snapshot-20140201:1.1
	sid-snapshot-20140101:1.1
	cgen-snapshot-20140101:1.1
	sid-snapshot-20131201:1.1
	cgen-snapshot-20131201:1.1
	sid-snapshot-20131101:1.1
	cgen-snapshot-20131101:1.1
	sid-snapshot-20131001:1.1
	cgen-snapshot-20131001:1.1
	sid-snapshot-20130901:1.1
	cgen-snapshot-20130901:1.1
	sid-snapshot-20130801:1.1
	cgen-snapshot-20130801:1.1
	sid-snapshot-20130701:1.1
	cgen-snapshot-20130701:1.1
	sid-snapshot-20130601:1.1
	cgen-snapshot-20130601:1.1
	sid-snapshot-20130501:1.1
	cgen-snapshot-20130501:1.1
	sid-snapshot-20130401:1.1
	cgen-snapshot-20130401:1.1
	sid-snapshot-20130301:1.1
	cgen-snapshot-20130301:1.1
	sid-snapshot-20130201:1.1
	cgen-snapshot-20130201:1.1
	sid-snapshot-20130101:1.1
	cgen-snapshot-20130101:1.1
	sid-snapshot-20121201:1.1
	cgen-snapshot-20121201:1.1
	sid-snapshot-20121101:1.1
	cgen-snapshot-20121101:1.1
	sid-snapshot-20121001:1.1
	cgen-snapshot-20121001:1.1
	sid-snapshot-20120901:1.1
	cgen-snapshot-20120901:1.1
	sid-snapshot-20120801:1.1
	cgen-snapshot-20120801:1.1
	sid-snapshot-20120701:1.1
	cgen-snapshot-20120701:1.1
	sid-snapshot-20120601:1.1
	cgen-snapshot-20120601:1.1
	sid-snapshot-20120501:1.1
	cgen-snapshot-20120501:1.1
	sid-snapshot-20120401:1.1
	cgen-snapshot-20120401:1.1
	sid-snapshot-20120301:1.1
	cgen-snapshot-20120301:1.1
	sid-snapshot-20120201:1.1
	cgen-snapshot-20120201:1.1
	sid-snapshot-20120101:1.1
	cgen-snapshot-20120101:1.1
	sid-snapshot-20111201:1.1
	cgen-snapshot-20111201:1.1
	sid-snapshot-20111101:1.1
	cgen-snapshot-20111101:1.1
	sid-snapshot-20111001:1.1
	cgen-snapshot-20111001:1.1
	sid-snapshot-20110901:1.1
	cgen-snapshot-20110901:1.1
	sid-snapshot-20110801:1.1
	cgen-snapshot-20110801:1.1
	sid-snapshot-20110701:1.1
	cgen-snapshot-20110701:1.1
	sid-snapshot-20110601:1.1
	cgen-snapshot-20110601:1.1
	sid-snapshot-20110501:1.1
	cgen-snapshot-20110501:1.1
	sid-snapshot-20110401:1.1
	cgen-snapshot-20110401:1.1
	sid-snapshot-20110301:1.1
	cgen-snapshot-20110301:1.1
	sid-snapshot-20110201:1.1
	cgen-snapshot-20110201:1.1
	sid-snapshot-20110101:1.1
	cgen-snapshot-20110101:1.1
	sid-snapshot-20101201:1.1
	cgen-snapshot-20101201:1.1
	sid-snapshot-20101101:1.1
	cgen-snapshot-20101101:1.1
	sid-snapshot-20101001:1.1
	cgen-snapshot-20101001:1.1
	sid-snapshot-20100901:1.1
	cgen-snapshot-20100901:1.1
	sid-snapshot-20100801:1.1
	cgen-snapshot-20100801:1.1
	sid-snapshot-20100701:1.1
	cgen-snapshot-20100701:1.1
	sid-snapshot-20100601:1.1
	cgen-snapshot-20100601:1.1
	sid-snapshot-20100501:1.1
	cgen-snapshot-20100501:1.1
	sid-snapshot-20100401:1.1
	cgen-snapshot-20100401:1.1
	sid-snapshot-20100301:1.1
	cgen-snapshot-20100301:1.1
	sid-snapshot-20100201:1.1
	cgen-snapshot-20100201:1.1
	sid-snapshot-20100101:1.1
	cgen-snapshot-20100101:1.1
	sid-snapshot-20091201:1.1
	cgen-snapshot-20091201:1.1
	sid-snapshot-20091101:1.1
	cgen-snapshot-20091101:1.1
	sid-snapshot-20091001:1.1
	cgen-snapshot-20091001:1.1
	sid-snapshot-20090901:1.1
	cgen-snapshot-20090901:1.1
	sid-snapshot-20090801:1.1
	cgen-snapshot-20090801:1.1
	dje-cgen-play1-branch:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2009.07.13.20.55.21;	author devans;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2009.07.14.16.08.50;	author devans;	state Exp;
branches;
next	;


desc
@@


1.1
log
@	Extend pmacro language, add testsuite.
	* Makefile.am (SUBDIRS): Add testsuite.
	* Makefile.in: Regenerate.
	* configure.in (AC_OUTPUT): Create testsuite/Makefile,
	testsuite/test-utils.sh.
	* configure: Regenerate.
	* dev.scm (cload): Handle testsuite app.
	(load-testsuite): New function.
	* pmacros.scm: (-pmacro-debug?): New global.
	(-smacro-table): New global.
	(-smacro-lookup, -smacro-set!): New functions.
	(-pmacro-make): New argument `syntactic-form?', all callers updated.
	(-pmacro-syntactic-form?): New function.
	(-pmacro-expected-number, -pmacro-verify-number): New functions.
	(-pmacro-expected-integer, -pmacro-verify-integer): New functions.
	(-pmacro-expected-non-negative-integer): New function.
	(-pmacro-verify-non-negative-integer): New function.
	(-pmacro-expand-expr-list): New function.
	(-pmacro-process-args-1): Renamed from -pmacro-process-args.
	(-pmacro-process-args): Renamed from -pmacro-invoke.
	(-pmacro-apply, -smacro-apply): New functions.
	(-pmacro-expand): Rewrite syntactic form processing.
	(-pmacro-build-lambda): Reformat.
	(define-pmacro): Watch for more errors in definition.
	(pmacro-debug): New function.
	(pmacro-trace): Set/reset -pmacro-debug?.
	(all existing builtin pmacro helpers): Rename to -pmacro-builtin-foo.
	(-pmacro-builtin-substring): Fix.  Add support for `end' marker.
	(-pmacro-builtin-for-each, et.al.): New helpers for .for-each, .let,
	.if, .case, .cond, .begin, .print, .dump, .error, .list, .ref,
	.length, .replicate, .equals, .and, .or, .not, .eq, .ne, .lt, .gt,
	.le, .ge, .add, .sub, .mul, .div, .rem, .sll, .srl, .sra, .bitand,
	.bitor, .bitxor, bitinv, .car, .cdr, .caar, .cadr, .cdar, .cddr.
	(pmacros-init!): Initialize -smacro-table.
	Rewrite pmacro initialization.
	* read.scm (reader-process-expanded): Renamed from
	-reader-process-expanded.  All callers updated.
	Recognize () as a no-op.
	(cpu-load): Tweak logging messages.
	* utils.scm (message): Add comment.
	* cpu/play.cpu: Add some instructions to play with .let.
	* doc/cgenint.texi: Move some debugging related docs to here from
	cgen.texi.
	* doc/pmacros.texi: Reorganize.  Add docs for new builtin pmacros.
	* testsuite/Makefile.am: New file.
	* testsuite/Makefile.in: New file.
	* testsuite/test-utils.sh.in: New file.
	* testsuite/run-tests.sh: New file.
	* testsuite/testsuite.cpu: New file.
	* testsuite/pmacros-1.test: New file.
@
text
@; CGEN testsuite driver.
; Copyright (C) 2009 Doug Evans
; This file is part of CGEN.
;
; This is a standalone script, we don't load anything until we parse the
; -s argument (keeps reliance off of environment variables, etc.).

; Load the various support routines.

(define (load-files srcdir)
  (load (string-append srcdir "/read.scm"))
  (load (string-append srcdir "/desc.scm"))
  (load (string-append srcdir "/desc-cpu.scm"))
  (load (string-append srcdir "/testsuite.scm"))
)

(define testsuite-arguments
  (list
   (list "-T" "file" "generate $arch-test.h in <file>"
	 #f
	 (lambda (arg) (file-write arg cgen-test.h)))
   )
)

; Kept global so it's available to the other .scm files.
(define srcdir ".")

; Scan argv for -s srcdir.
; We can't process any other args until we find the cgen source dir.
; The result is srcdir.
; We assume "-s" isn't the argument to another option.  Unwise, yes.
; Alternatives are to require it to be the first argument or at least preceed
; any option with a "-s" argument, or to put knowledge of the common argument
; set and common argument parsing code in every top level file.

(define (find-srcdir argv)
  (let loop ((argv argv))
    (if (null? argv)
	(error "`-s srcdir' not present, can't load cgen"))
    (if (string=? "-s" (car argv))
	(begin
	  (if (null? (cdr argv))
	      (error "missing srcdir arg to `-s'"))
	  (cadr argv))
	(loop (cdr argv))))	
)

; Main routine, parses options and calls generators.

(define (cgen-testsuite argv)
  (let ()

    ; Find and set srcdir, then load all Scheme code.
    ; Drop the first argument, it is the script name (i.e. argv[0]).
    (set! srcdir (find-srcdir (cdr argv)))
    (set! %load-path (cons srcdir %load-path))
    (load-files srcdir)

    (display-argv argv)

    (cgen #:argv argv
	  #:app-name "testsuite"
	  #:arg-spec testsuite-arguments
	  #:init testsuite-init!
	  #:finish testsuite-finish!
	  #:analyze testsuite-analyze!)
    )
)

(cgen-testsuite (program-arguments))
@


1.1.2.1
log
@Copy over from trunk.
	Extend pmacro language, add testsuite.
	* Makefile.am (SUBDIRS): Add testsuite.
	* Makefile.in: Regenerate.
	* configure.in (AC_OUTPUT): Create testsuite/Makefile,
	testsuite/test-utils.sh.
	* configure: Regenerate.
	* dev.scm (cload): Handle testsuite app.
	(load-testsuite): New function.
	* pmacros.scm: (-pmacro-debug?): New global.
	(-smacro-table): New global.
	(-smacro-lookup, -smacro-set!): New functions.
	(-pmacro-make): New argument `syntactic-form?', all callers updated.
	(-pmacro-syntactic-form?): New function.
	(-pmacro-expected-number, -pmacro-verify-number): New functions.
	(-pmacro-expected-integer, -pmacro-verify-integer): New functions.
	(-pmacro-expected-non-negative-integer): New function.
	(-pmacro-verify-non-negative-integer): New function.
	(-pmacro-expand-expr-list): New function.
	(-pmacro-process-args-1): Renamed from -pmacro-process-args.
	(-pmacro-process-args): Renamed from -pmacro-invoke.
	(-pmacro-apply, -smacro-apply): New functions.
	(-pmacro-expand): Rewrite syntactic form processing.
	(-pmacro-build-lambda): Reformat.
	(define-pmacro): Watch for more errors in definition.
	(pmacro-debug): New function.
	(pmacro-trace): Set/reset -pmacro-debug?.
	(all existing builtin pmacro helpers): Rename to -pmacro-builtin-foo.
	(-pmacro-builtin-substring): Fix.  Add support for `end' marker.
	(-pmacro-builtin-for-each, et.al.): New helpers for .for-each, .let,
	.if, .case, .cond, .begin, .print, .dump, .error, .list, .ref,
	.length, .replicate, .equals, .and, .or, .not, .eq, .ne, .lt, .gt,
	.le, .ge, .add, .sub, .mul, .div, .rem, .sll, .srl, .sra, .bitand,
	.bitor, .bitxor, bitinv, .car, .cdr, .caar, .cadr, .cdar, .cddr.
	(pmacros-init!): Initialize -smacro-table.
	Rewrite pmacro initialization.
	* read.scm (reader-process-expanded): Renamed from
	-reader-process-expanded.  All callers updated.
	Recognize () as a no-op.
	(cpu-load): Tweak logging messages.
	* utils.scm (message): Add comment.
	* cpu/play.cpu: Add some instructions to play with .let.
	* doc/cgenint.texi: Move some debugging related docs to here from
	cgen.texi.
	* doc/pmacros.texi: Reorganize.  Add docs for new builtin pmacros.
	* testsuite/Makefile.am: New file.
	* testsuite/Makefile.in: New file.
	* testsuite/test-utils.sh.in: New file.
	* testsuite/run-tests.sh: New file.
	* testsuite/testsuite.cpu: New file.
	* testsuite/pmacros-1.test: New file.
@
text
@@

