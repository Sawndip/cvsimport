head	1.13;
access;
symbols
	sid-snapshot-20180601:1.13
	cgen-snapshot-20180601:1.13
	sid-snapshot-20180501:1.13
	cgen-snapshot-20180501:1.13
	sid-snapshot-20180401:1.13
	cgen-snapshot-20180401:1.13
	sid-snapshot-20180301:1.13
	cgen-snapshot-20180301:1.13
	sid-snapshot-20180201:1.13
	cgen-snapshot-20180201:1.13
	sid-snapshot-20180101:1.13
	cgen-snapshot-20180101:1.13
	sid-snapshot-20171201:1.13
	cgen-snapshot-20171201:1.13
	sid-snapshot-20171101:1.13
	cgen-snapshot-20171101:1.13
	sid-snapshot-20171001:1.13
	cgen-snapshot-20171001:1.13
	sid-snapshot-20170901:1.13
	cgen-snapshot-20170901:1.13
	sid-snapshot-20170801:1.13
	cgen-snapshot-20170801:1.13
	sid-snapshot-20170701:1.13
	cgen-snapshot-20170701:1.13
	sid-snapshot-20170601:1.13
	cgen-snapshot-20170601:1.13
	sid-snapshot-20170501:1.13
	cgen-snapshot-20170501:1.13
	sid-snapshot-20170401:1.13
	cgen-snapshot-20170401:1.13
	sid-snapshot-20170301:1.13
	cgen-snapshot-20170301:1.13
	sid-snapshot-20170201:1.13
	cgen-snapshot-20170201:1.13
	sid-snapshot-20170101:1.13
	cgen-snapshot-20170101:1.13
	sid-snapshot-20161201:1.13
	cgen-snapshot-20161201:1.13
	sid-snapshot-20161101:1.13
	cgen-snapshot-20161101:1.13
	sid-snapshot-20160901:1.13
	cgen-snapshot-20160901:1.13
	sid-snapshot-20160801:1.13
	cgen-snapshot-20160801:1.13
	sid-snapshot-20160701:1.13
	cgen-snapshot-20160701:1.13
	sid-snapshot-20160601:1.13
	cgen-snapshot-20160601:1.13
	sid-snapshot-20160501:1.12
	cgen-snapshot-20160501:1.12
	sid-snapshot-20160401:1.12
	cgen-snapshot-20160401:1.12
	sid-snapshot-20160301:1.12
	cgen-snapshot-20160301:1.12
	sid-snapshot-20160201:1.12
	cgen-snapshot-20160201:1.12
	sid-snapshot-20160101:1.12
	cgen-snapshot-20160101:1.12
	sid-snapshot-20151201:1.12
	cgen-snapshot-20151201:1.12
	sid-snapshot-20151101:1.12
	cgen-snapshot-20151101:1.12
	sid-snapshot-20151001:1.12
	cgen-snapshot-20151001:1.12
	sid-snapshot-20150901:1.12
	cgen-snapshot-20150901:1.12
	sid-snapshot-20150801:1.12
	cgen-snapshot-20150801:1.12
	sid-snapshot-20150701:1.12
	cgen-snapshot-20150701:1.12
	sid-snapshot-20150601:1.12
	cgen-snapshot-20150601:1.12
	sid-snapshot-20150501:1.12
	cgen-snapshot-20150501:1.12
	sid-snapshot-20150401:1.12
	cgen-snapshot-20150401:1.12
	sid-snapshot-20150301:1.12
	cgen-snapshot-20150301:1.12
	sid-snapshot-20150201:1.12
	cgen-snapshot-20150201:1.12
	sid-snapshot-20150101:1.12
	cgen-snapshot-20150101:1.12
	sid-snapshot-20141201:1.12
	cgen-snapshot-20141201:1.12
	sid-snapshot-20141101:1.12
	cgen-snapshot-20141101:1.12
	sid-snapshot-20141001:1.12
	cgen-snapshot-20141001:1.12
	sid-snapshot-20140901:1.12
	cgen-snapshot-20140901:1.12
	sid-snapshot-20140801:1.12
	cgen-snapshot-20140801:1.12
	sid-snapshot-20140701:1.12
	cgen-snapshot-20140701:1.12
	sid-snapshot-20140601:1.12
	cgen-snapshot-20140601:1.12
	sid-snapshot-20140501:1.12
	cgen-snapshot-20140501:1.12
	sid-snapshot-20140401:1.12
	cgen-snapshot-20140401:1.12
	sid-snapshot-20140301:1.12
	cgen-snapshot-20140301:1.12
	sid-snapshot-20140201:1.12
	cgen-snapshot-20140201:1.12
	sid-snapshot-20140101:1.12
	cgen-snapshot-20140101:1.12
	sid-snapshot-20131201:1.12
	cgen-snapshot-20131201:1.12
	sid-snapshot-20131101:1.12
	cgen-snapshot-20131101:1.12
	sid-snapshot-20131001:1.12
	cgen-snapshot-20131001:1.12
	sid-snapshot-20130901:1.12
	cgen-snapshot-20130901:1.12
	sid-snapshot-20130801:1.12
	cgen-snapshot-20130801:1.12
	sid-snapshot-20130701:1.12
	cgen-snapshot-20130701:1.12
	sid-snapshot-20130601:1.12
	cgen-snapshot-20130601:1.12
	sid-snapshot-20130501:1.12
	cgen-snapshot-20130501:1.12
	sid-snapshot-20130401:1.12
	cgen-snapshot-20130401:1.12
	sid-snapshot-20130301:1.12
	cgen-snapshot-20130301:1.12
	sid-snapshot-20130201:1.12
	cgen-snapshot-20130201:1.12
	sid-snapshot-20130101:1.12
	cgen-snapshot-20130101:1.12
	sid-snapshot-20121201:1.12
	cgen-snapshot-20121201:1.12
	sid-snapshot-20121101:1.12
	cgen-snapshot-20121101:1.12
	sid-snapshot-20121001:1.12
	cgen-snapshot-20121001:1.12
	sid-snapshot-20120901:1.12
	cgen-snapshot-20120901:1.12
	sid-snapshot-20120801:1.12
	cgen-snapshot-20120801:1.12
	sid-snapshot-20120701:1.12
	cgen-snapshot-20120701:1.12
	sid-snapshot-20120601:1.12
	cgen-snapshot-20120601:1.12
	sid-snapshot-20120501:1.12
	cgen-snapshot-20120501:1.12
	sid-snapshot-20120401:1.12
	cgen-snapshot-20120401:1.12
	sid-snapshot-20120301:1.12
	cgen-snapshot-20120301:1.12
	sid-snapshot-20120201:1.12
	cgen-snapshot-20120201:1.12
	sid-snapshot-20120101:1.12
	cgen-snapshot-20120101:1.12
	sid-snapshot-20111201:1.12
	cgen-snapshot-20111201:1.12
	sid-snapshot-20111101:1.12
	cgen-snapshot-20111101:1.12
	sid-snapshot-20111001:1.12
	cgen-snapshot-20111001:1.12
	sid-snapshot-20110901:1.12
	cgen-snapshot-20110901:1.12
	sid-snapshot-20110801:1.12
	cgen-snapshot-20110801:1.12
	sid-snapshot-20110701:1.12
	cgen-snapshot-20110701:1.12
	sid-snapshot-20110601:1.12
	cgen-snapshot-20110601:1.12
	sid-snapshot-20110501:1.12
	cgen-snapshot-20110501:1.12
	sid-snapshot-20110401:1.12
	cgen-snapshot-20110401:1.12
	sid-snapshot-20110301:1.12
	cgen-snapshot-20110301:1.12
	sid-snapshot-20110201:1.12
	cgen-snapshot-20110201:1.12
	sid-snapshot-20110101:1.12
	cgen-snapshot-20110101:1.12
	sid-snapshot-20101201:1.12
	cgen-snapshot-20101201:1.12
	sid-snapshot-20101101:1.12
	cgen-snapshot-20101101:1.12
	sid-snapshot-20101001:1.12
	cgen-snapshot-20101001:1.12
	sid-snapshot-20100901:1.12
	cgen-snapshot-20100901:1.12
	sid-snapshot-20100801:1.12
	cgen-snapshot-20100801:1.12
	sid-snapshot-20100701:1.12
	cgen-snapshot-20100701:1.12
	sid-snapshot-20100601:1.12
	cgen-snapshot-20100601:1.12
	sid-snapshot-20100501:1.12
	cgen-snapshot-20100501:1.12
	sid-snapshot-20100401:1.12
	cgen-snapshot-20100401:1.12
	sid-snapshot-20100301:1.12
	cgen-snapshot-20100301:1.12
	sid-snapshot-20100201:1.12
	cgen-snapshot-20100201:1.12
	sid-snapshot-20100101:1.12
	cgen-snapshot-20100101:1.12
	sid-snapshot-20091201:1.12
	cgen-snapshot-20091201:1.12
	sid-snapshot-20091101:1.11
	cgen-snapshot-20091101:1.11
	sid-snapshot-20091001:1.10
	cgen-snapshot-20091001:1.10
	arc-sim-20090309:1.6
	sid-snapshot-20090901:1.9
	cgen-snapshot-20090901:1.9
	sid-snapshot-20090801:1.8
	cgen-snapshot-20090801:1.8
	sid-snapshot-20090701:1.8
	cgen-snapshot-20090701:1.8
	dje-cgen-play1-branch:1.8.0.2
	dje-cgen-play1-branchpoint:1.8
	cgen-1_1-branch:1.7.0.2
	cgen-1_1-branchpoint:1.7
	sid-snapshot-20090601:1.6
	cgen-snapshot-20090601:1.6
	sid-snapshot-20090501:1.6
	cgen-snapshot-20090501:1.6
	sid-snapshot-20090401:1.6
	cgen-snapshot-20090401:1.6
	arc-insight_6_8-branch:1.6.0.4
	arc-insight_6_8-branchpoint:1.6
	sid-snapshot-20090301:1.6
	cgen-snapshot-20090301:1.6
	sid-snapshot-20090201:1.6
	cgen-snapshot-20090201:1.6
	sid-snapshot-20090101:1.6
	cgen-snapshot-20090101:1.6
	sid-snapshot-20081201:1.6
	cgen-snapshot-20081201:1.6
	sid-snapshot-20081101:1.6
	cgen-snapshot-20081101:1.6
	sid-snapshot-20081001:1.6
	cgen-snapshot-20081001:1.6
	sid-snapshot-20080901:1.6
	cgen-snapshot-20080901:1.6
	sid-snapshot-20080801:1.6
	cgen-snapshot-20080801:1.6
	sid-snapshot-20080701:1.6
	cgen-snapshot-20080701:1.6
	sid-snapshot-20080601:1.6
	cgen-snapshot-20080601:1.6
	sid-snapshot-20080501:1.6
	cgen-snapshot-20080501:1.6
	sid-snapshot-20080403:1.6
	sid-snapshot-20080401:1.6
	cgen-snapshot-20080401:1.6
	sid-snapshot-20080301:1.6
	cgen-snapshot-20080301:1.6
	sid-snapshot-20080201:1.6
	cgen-snapshot-20080201:1.6
	sid-snapshot-20080101:1.6
	cgen-snapshot-20080101:1.6
	sid-snapshot-20071201:1.6
	cgen-snapshot-20071201:1.6
	sid-snapshot-20071101:1.6
	cgen-snapshot-20071101:1.6
	sid-snapshot-20071001:1.6
	cgen-snapshot-20071001:1.6
	msnyder-fork-checkpoint-branch:1.6.0.2
	msnyder-fork-checkpoint-branchpoint:1.6
	sid-20020905-branchpoint:1.2
	sid-20020905-branch:1.2.0.6
	cagney_regbuf-20020515-branch:1.2.0.4
	cagney_regbuf-20020515-branchpoint:1.2
	cygnus_cvs_20020108_pre:1.2
	cgen-1-1-branch:1.2.0.2
	cgen-1-0:1.1.1.1
	cygnus:1.1.1;
locks; strict;
comment	@# @;


1.13
date	2016.05.09.21.50.25;	author vapier;	state Exp;
branches;
next	1.12;

1.12
date	2009.11.23.00.59.57;	author devans;	state Exp;
branches;
next	1.11;

1.11
date	2009.10.05.18.04.30;	author devans;	state Exp;
branches;
next	1.10;

1.10
date	2009.09.07.22.17.34;	author devans;	state Exp;
branches;
next	1.9;

1.9
date	2009.08.25.16.30.06;	author devans;	state Exp;
branches;
next	1.8;

1.8
date	2009.06.24.15.03.09;	author devans;	state Exp;
branches;
next	1.7;

1.7
date	2009.06.20.21.34.28;	author devans;	state Exp;
branches
	1.7.2.1;
next	1.6;

1.6
date	2003.07.16.05.35.48;	author devans;	state Exp;
branches;
next	1.5;

1.5
date	2003.05.15.07.25.02;	author devans;	state Exp;
branches;
next	1.4;

1.4
date	2003.04.16.18.09.06;	author brolley;	state Exp;
branches;
next	1.3;

1.3
date	2002.12.20.02.22.22;	author devans;	state Exp;
branches;
next	1.2;

1.2
date	2001.04.02.22.04.48;	author bje;	state Exp;
branches;
next	1.1;

1.1
date	2000.07.28.04.11.52;	author bje;	state Exp;
branches
	1.1.1.1;
next	;

1.7.2.1
date	2009.06.24.14.57.46;	author devans;	state Exp;
branches;
next	;

1.1.1.1
date	2000.07.28.04.11.52;	author bje;	state Exp;
branches;
next	;


desc
@@


1.13
log
@cgen: sim: Updates to sim files to match gdb types

The types like MACH and MODEL have changes to SIM_MACH and SIM_MODEL
make updates to match these changes.  This way people dont have to
manually update the generated files in GDB.
@
text
@; Simulator model support, plus misc. things associated with a cpu family.
; Copyright (C) 2000, 2003, 2009 Red Hat, Inc.
; This file is part of CGEN.

; Return C code to define cpu implementation properties.

(define (unit:enum u)
  (gen-c-symbol (string-append "UNIT_"
			       (string-upcase (obj:str-name (unit:model u)))
			       "_"
			       (string-upcase (obj:str-name u))))
)

(define (/gen-cpu-imp-properties)
  (string-list
   "\
/* The properties of this cpu's implementation.  */

static const SIM_MACH_IMP_PROPERTIES @@cpu@@_imp_properties =
{
  sizeof (SIM_CPU),
#if WITH_SCACHE
  sizeof (SCACHE)
#else
  0
#endif
};\n\n"
   )
)

; Insn modeling support.

; Generate code to profile hardware elements.
; ??? Not currently used.

(define (/gen-hw-profile-code)
  ; Fetch profilable input and output operands of the semantic code.
  (let ((in-ops (find op-profilable? (sfmt-in-ops (insn-sfmt insn))))
	(out-ops (find op-profilable? (sfmt-out-ops (insn-sfmt insn)))))
    (string-list
     ; For each operand, record its being get/set.
     (string-list-map (lambda (op) (send op 'gen-profile-code insn #f))
		      in-ops)
     (string-list-map (lambda (op) (send op 'gen-profile-code insn #t))
		      out-ops)
     ))
)

; Return decls of hardware element profilers.
; ??? Not currently used.

(define (/gen-hw-profile-decls)
  (string-list
   "/* Hardware profiling handlers.  */\n\n"
   (string-list-map (lambda (hw)
		      (string-append "extern void @@cpu@@_model_mark_get_"
				     (gen-sym hw) " (SIM_CPU *"
				     (if (hw-scalar? hw)
					 ""
					 ", int") ; FIXME: get index type
				     ");\n"
				     "extern void @@cpu@@_model_mark_set_"
				     (gen-sym hw) " (SIM_CPU *"
				     (if (hw-scalar? hw)
					 ""
					 ", int") ; FIXME: get index type
				     ");\n"))
		    (find hw-profilable? (current-hw-list)))
   "\n"
   )
)

; Return name of profiling handler for MODEL, UNIT.
; Also called by sim.scm.

(define (gen-model-unit-fn-name model unit)
  (string-append "@@cpu@@_model_" (gen-sym model) "_" (gen-sym unit))
)

; Return decls of all insn model handlers.
; This is called from sim-decode.scm.

(define (gen-model-fn-decls)
  (let ((gen-args (lambda (args)
		    (gen-c-args (map (lambda (arg)
				       (stringsym-append
					(mode:c-type (mode:lookup (cadr arg)))
					" /*" (car arg) "*/"))
				     (find (lambda (arg)
					     ; Indices of scalars not passed.
					     (not (null? (cdr arg))))
					   args)))))
	)

    (string-list
     ; /gen-hw-profile-decls
     "/* Function unit handlers (user written).  */\n\n"
     (string-list-map
      (lambda (model)
	(string-list-map (lambda (unit)
			   (stringsym-append
			    "extern int "
			    (gen-model-unit-fn-name model unit)
			    " (SIM_CPU *, const IDESC *,"
			    " int /*unit_num*/, int /*referenced*/"
			    (gen-args (unit:inputs unit))
			    (gen-args (unit:outputs unit))
			    ");\n"))
			 (model:units model)))
      (current-model-list))
     "\n"
     "/* Profiling before/after handlers (user written) */\n\n"
     "extern void @@cpu@@_model_insn_before (SIM_CPU *, int /*first_p*/);\n"
     "extern void @@cpu@@_model_insn_after (SIM_CPU *, int /*last_p*/, int /*cycles*/);\n"
     "\n"
     ))
)

; Return name of profile handler for INSN, MODEL.

(define (/gen-model-insn-fn-name model insn)
  (string-append "model_" (gen-sym model) "_" (gen-sym insn))
)

; Return function to model INSN.

(define (/gen-model-insn-fn model insn)
  (logit 2 "Processing modeling for " (obj:name insn) ": \"" (insn-syntax insn) "\" ...\n")
  (string-list
   "static int\n"
   (/gen-model-insn-fn-name model insn)
   ; sem_arg is a void * to keep cgen specific stuff out of sim-model.h
   " (SIM_CPU *current_cpu, void *sem_arg)\n"
   "{\n"
   (if (with-scache?)
       (gen-define-field-macro (insn-sfmt insn))
       "")
   "  const ARGBUF * UNUSED abuf = SEM_ARGBUF ((SEM_ARG) sem_arg);\n"
   "  const IDESC * UNUSED idesc = abuf->idesc;\n"
   ; or: idesc = & CPU_IDESC (current_cpu) ["
   ; (gen-cpu-insn-enum (mach-cpu (model:mach model)) insn)
   ; "];\n"
   "  int cycles = 0;\n"
   (send insn 'gen-profile-locals model)
   (if (with-scache?)
       ""
       (string-list
	"  IADDR UNUSED pc = GET_H_PC ();\n"
	"  CGEN_INSN_WORD insn = abuf->insn;\n"
	(gen-define-ifmt-ifields (insn-ifmt insn) "  " #f #t)
	(gen-sfmt-op-argbuf-defns (insn-sfmt insn))
	(gen-extract-ifmt-ifields (insn-ifmt insn) "  " #f #t)
	(gen-sfmt-op-argbuf-assigns (insn-sfmt insn))))
   ; Emit code to model the insn.  Function units are handled here.
   (send insn 'gen-profile-code model "cycles")
   "  return cycles;\n"
   (if (with-scache?)
       (gen-undef-field-macro (insn-sfmt insn))
       "")
   "}\n\n")
)

; Return insn modeling handlers.
; ??? Might wish to reduce the amount of output by combining identical cases.
; ??? Modelling of insns could be table driven, but that puts constraints on
; generality.

(define (/gen-model-insn-fns)
  (string-write
   "/* Model handlers for each insn.  */\n\n"
   (lambda () (string-write-map
	       (lambda (model)
		 (string-write-map
		  (lambda (insn) (/gen-model-insn-fn model insn))
		  (real-insns (current-insn-list))))
	       (current-model-list)))
   )
)

; Generate timing table entry for function unit U while executing INSN.
; U is a <unit> object.
; ARGS is a list of overriding arguments from INSN.

(define (/gen-insn-unit-timing model insn u args)
  (string-append
   "{ "
   "(int) " (unit:enum u) ", "
   (number->string (unit:issue u)) ", "
   (let ((cycles (assq-ref args 'cycles)))
     (if cycles
	 (number->string (car cycles))
	 (number->string (unit:done u))))
   " }, "
   )
)

; Generate timing table entry for MODEL for INSN.

(define (/gen-insn-timing model insn)
  ; Instruction timing is stored as an associative list based on the model.
  (let ((timing (assq (obj:name model) (insn-timing insn))))
    ;(display timing) (newline)
    (string-list
     "  { "
     (gen-cpu-insn-enum (mach-cpu (model:mach model)) insn)
     ", "
     (if (obj-has-attr? insn 'VIRTUAL)
	 "0"
	 (/gen-model-insn-fn-name model insn))
     ", { "
     (string-drop
      -2
      (if (not timing)
	  (/gen-insn-unit-timing model insn (model-default-unit model) nil)
	  (let ((units (timing:units (cdr timing))))
	    (string-map (lambda (iunit)
			  (/gen-insn-unit-timing model insn
						 (iunit:unit iunit)
						 (iunit:args iunit)))
			units))))
     " } },\n"
     ))
)

; Generate model timing table for MODEL.

(define (/gen-model-timing-table model)
  (string-write
   "/* Model timing data for `" (obj:str-name model) "'.  */\n\n"
   "static const INSN_TIMING " (gen-sym model) "_timing[] = {\n"
   (lambda () (string-write-map (lambda (insn) (/gen-insn-timing model insn))
				(non-alias-insns (current-insn-list))))
   "};\n\n"
   )
)

; Return C code to define model profiling support stuff.

(define (/gen-model-profile-data)
  (string-write
   "/* We assume UNIT_NONE == 0 because the tables don't always terminate\n"
   "   entries with it.  */\n\n"
   (lambda () (string-write-map /gen-model-timing-table (current-model-list)))
   )
)

; Return C code to define the model table for MACH.

(define (/gen-mach-model-table mach)
  (string-list
   "\
static const SIM_MODEL " (gen-sym mach) "_models[] =\n{\n"
   (string-list-map (lambda (model)
		      (string-list "  { "
				   "\"" (obj:str-name model) "\", "
				   "& " (gen-sym (model:mach model)) "_mach, "
				   (model:enum model) ", "
				   "TIMING_DATA (& "
				   (gen-sym model)
				   "_timing[0]), "
				   (gen-sym model) "_model_init"
				   " },\n"))
		    (find (lambda (model) (eq? (obj:name mach)
					       (obj:name (model:mach model))))
			  (current-model-list)))
   "  { 0 }\n"
   "};\n\n"
   )
)

; Return C code to define model init fn.

(define (/gen-model-init-fn model)
  (string-list "\
static void\n"
(gen-sym model) "_model_init (SIM_CPU *cpu)
{
  CPU_MODEL_DATA (cpu) = (void *) zalloc (sizeof (MODEL_"
   (string-upcase (gen-sym model))
   "_DATA));
}\n\n"
   )
)

; Return C code to define model data and support fns.

(define (/gen-model-defns)
  (string-write
   (lambda () (string-write-map /gen-model-init-fn (current-model-list)))
   "#if WITH_PROFILE_MODEL_P
#define TIMING_DATA(td) td
#else
#define TIMING_DATA(td) 0
#endif\n\n"
   (lambda () (string-write-map /gen-mach-model-table (current-mach-list)))
   )
)

; Return C definitions for this cpu family variant.

(define (/gen-cpu-defns)
  (string-list "\

static void
@@cpu@@_prepare_run (SIM_CPU *cpu)
{
  if (CPU_IDESC (cpu) == NULL)
    @@prefix@@_init_idesc_table (cpu);
}

static const CGEN_INSN *
@@cpu@@_get_idata (SIM_CPU *cpu, int inum)
{
  return CPU_IDESC (cpu) [inum].idata;
}

")
)

; Return C code to define the machine data.

(define (/gen-mach-defns)
  (string-list-map
   (lambda (mach)
     (gen-obj-sanitize
      mach
      (string-list "\
static void\n"
(gen-sym mach) "_init_cpu (SIM_CPU *cpu)
{
  CPU_REG_FETCH (cpu) = " (gen-sym (mach-cpu mach)) "_fetch_register;
  CPU_REG_STORE (cpu) = " (gen-sym (mach-cpu mach)) "_store_register;
  CPU_PC_FETCH (cpu) = " (gen-sym (mach-cpu mach)) "_h_pc_get;
  CPU_PC_STORE (cpu) = " (gen-sym (mach-cpu mach)) "_h_pc_set;
  CPU_GET_IDATA (cpu) = @@cpu@@_get_idata;
  CPU_MAX_INSNS (cpu) = @@PREFIX@@_INSN__MAX;
  CPU_INSN_NAME (cpu) = cgen_insn_name;
  CPU_FULL_ENGINE_FN (cpu) = @@prefix@@_engine_run_full;
#if WITH_FAST
  CPU_FAST_ENGINE_FN (cpu) = @@prefix@@_engine_run_fast;
#else
  CPU_FAST_ENGINE_FN (cpu) = @@prefix@@_engine_run_full;
#endif
}

const SIM_MACH " (gen-sym mach) "_mach =
{
  \"" (obj:str-name mach) "\", "
  "\"" (mach-bfd-name mach) "\", "
  (mach-enum mach) ",\n"
  "  " (number->string (cpu-word-bitsize (mach-cpu mach))) ", "
  ; FIXME: addr-bitsize: delete
  (number->string (cpu-word-bitsize (mach-cpu mach))) ", "
  "& " (gen-sym mach) "_models[0], "
  "& " (gen-sym (mach-cpu mach)) "_imp_properties,
  " (gen-sym mach) "_init_cpu,
  @@cpu@@_prepare_run
};

")))

   (current-mach-list))
)

; Top level file generators.

; Generate model.c

(define (cgen-model.c)
  (logit 1 "Generating " (gen-cpu-name) "'s model.c ...\n")

  (sim-analyze-insns!)

  ; Turn parallel execution support on if cpu needs it.
  (set-with-parallel?! (state-parallel-exec?))

  (string-write
   (gen-c-copyright "Simulator model support for @@cpu@@."
		  CURRENT-COPYRIGHT CURRENT-PACKAGE)
   "\
#define WANT_CPU @@cpu@@
#define WANT_CPU_@@CPU@@

#include \"sim-main.h\"

/* The profiling data is recorded here, but is accessed via the profiling
   mechanism.  After all, this is information for profiling.  */

#if WITH_PROFILE_MODEL_P

"
   /gen-model-insn-fns
   /gen-model-profile-data
"#endif /* WITH_PROFILE_MODEL_P */\n\n"

   /gen-model-defns
   /gen-cpu-imp-properties
   /gen-cpu-defns
   /gen-mach-defns
   )
)
@


1.12
log
@	* mach.scm (<derived-arch-data>): New member large-insn-word?.
	(/adata-set-derived!): Set it.
	(adata-large-insn-word?): New function.
	* sim-arch.scm (/gen-cpuall-includes): Don't #include cgen-engine.h
	here.
	* sim-cpu.scm (cgen-cpu.h): #include it here.
	(/gen-cpu-defines): Define CGEN_INSN_WORD.
	(/gen-no-scache-semantic-fn): Use CGEN_INSN_WORD instead of
	CGEN_INSN_INT.
	* sim-decode.scm (/gen-idesc-decls): Ditto.
	(/gen-extract-case, /gen-decode-fn): Ditto.
	* sim-model.scm (/gen-model-insn-fn): Ditto.
	* sim.scm (gen-argbuf-type): Ditto.
@
text
@d19 1
a19 1
static const MACH_IMP_PROPERTIES @@cpu@@_imp_properties =
d252 1
a252 1
static const MODEL " (gen-sym mach) "_models[] =\n{\n"
d346 1
a346 1
const MACH " (gen-sym mach) "_mach =
@


1.11
log
@	* sim-model.scm (@@cpu@@_prepare_run): Use @@prefix@@, not @@cpu@@,
	for @@foo@@_init_idesc_table.
@
text
@d149 1
a149 1
	"  CGEN_INSN_INT insn = abuf->insn;\n"
@


1.10
log
@	* read.scm (rtl-version-equal?): New function.
	(rtl-version-at-least?, rtl-version-older?): New functions.

	* *.scm: Use / to prefix "local" vars/fns, for r6rs compliance.
	* pmacros.scm (/pmacro-builtin-splice): Refer to $unsplice for
	rtl versions >= 0.9.
	(pmacros-init!): Tweak to prepare for $<pmacro> for builtin pmacros.
@
text
@d308 1
a308 1
    @@cpu@@_init_idesc_table (cpu);
@


1.9
log
@	* sim-model.scm (-gen-mach-defns): Use @@PREFIX@@_INSN__MAX instead of
	@@CPU@@_INSN__MAX.  Use @@prefix@@ instead of @@cpu@@ for engine_run
	routines.
@
text
@d14 1
a14 1
(define (-gen-cpu-imp-properties)
d36 1
a36 1
(define (-gen-hw-profile-code)
d52 1
a52 1
(define (-gen-hw-profile-decls)
d96 1
a96 1
     ; -gen-hw-profile-decls
d121 1
a121 1
(define (-gen-model-insn-fn-name model insn)
d127 1
a127 1
(define (-gen-model-insn-fn model insn)
d131 1
a131 1
   (-gen-model-insn-fn-name model insn)
d168 1
a168 1
(define (-gen-model-insn-fns)
d174 1
a174 1
		  (lambda (insn) (-gen-model-insn-fn model insn))
d184 1
a184 1
(define (-gen-insn-unit-timing model insn u args)
d199 1
a199 1
(define (-gen-insn-timing model insn)
d209 1
a209 1
	 (-gen-model-insn-fn-name model insn))
d214 1
a214 1
	  (-gen-insn-unit-timing model insn (model-default-unit model) nil)
d217 1
a217 1
			  (-gen-insn-unit-timing model insn
d227 1
a227 1
(define (-gen-model-timing-table model)
d231 1
a231 1
   (lambda () (string-write-map (lambda (insn) (-gen-insn-timing model insn))
d239 1
a239 1
(define (-gen-model-profile-data)
d243 1
a243 1
   (lambda () (string-write-map -gen-model-timing-table (current-model-list)))
d249 1
a249 1
(define (-gen-mach-model-table mach)
d273 1
a273 1
(define (-gen-model-init-fn model)
d287 1
a287 1
(define (-gen-model-defns)
d289 1
a289 1
   (lambda () (string-write-map -gen-model-init-fn (current-model-list)))
d295 1
a295 1
   (lambda () (string-write-map -gen-mach-model-table (current-mach-list)))
d301 1
a301 1
(define (-gen-cpu-defns)
d322 1
a322 1
(define (-gen-mach-defns)
d392 2
a393 2
   -gen-model-insn-fns
   -gen-model-profile-data
d396 4
a399 4
   -gen-model-defns
   -gen-cpu-imp-properties
   -gen-cpu-defns
   -gen-mach-defns
@


1.8
log
@	* All *.scm files: Update copyright year.
	* utils.scm (copyright-fsf, copyright-redhat): Ditto.
@
text
@d336 1
a336 1
  CPU_MAX_INSNS (cpu) = @@CPU@@_INSN__MAX;
d338 1
a338 1
  CPU_FULL_ENGINE_FN (cpu) = @@cpu@@_engine_run_full;
d340 1
a340 1
  CPU_FAST_ENGINE_FN (cpu) = @@cpu@@_engine_run_fast;
d342 1
a342 1
  CPU_FAST_ENGINE_FN (cpu) = @@cpu@@_engine_run_full;
@


1.7
log
@	* desc-cpu.scm (cgen-desc.h): Tweak logit message for consistency.
	(cgen-desc.c): Ditto.
	* sid-cpu.scm (cgen-desc.h, cgen-cpu.h, cgen-defs.h): Ditto.
	(cgen-write.cxx, cgen-semantics.cxx, cgen-sem-switch.cxx): Ditto.
	* sid-decode.scm (cgen-decode.h, cgen-decode.cxx): Ditto.
	* sid-model.scm (cgen-model.cxx, cgen-model.h): Ditto.
	* sim-arch.scm (cgen-arch.h, cgen-arch.c): Ditto.
	(cgen-cpuall.h, cgen-ops.c): Ditto.
	* sim-cpu.scm (cgen-cpu.h, cgen-defs.h, cgen-cpu.c): Ditto.
	(cgen-read.c, cgen-write.c, cgen-semantics.c): Ditto.
	(cgen-sem-switch.c): Ditto.
	* sim-decode.scm (cgen-decode.h, cgen-decode.c): Ditto.
	* sim-model.c (cgen-model.c): Ditto.
@
text
@d2 1
a2 1
; Copyright (C) 2000, 2003 Red Hat, Inc.
@


1.7.2.1
log
@	* All *.scm files: Update copyright year.
	* utils.scm (copyright-fsf, copyright-redhat): Ditto.
@
text
@d2 1
a2 1
; Copyright (C) 2000, 2003, 2009 Red Hat, Inc.
@


1.6
log
@	Add guile 1.6.4 support.
	- empty list must be quoted
	- string functions have stricter type checking
	- eval now takes a second argument
	- symbol-bound? is deprecated
	* attr.scm (-attr-parse): Use stringsym-append to build errtxt.
	(bitset-attr->list): Ensure arg to string-cut is a string.
	(attr-parse): Ensure args to string-ref and string-drop1 are strings.
	(<enum-attribute>,gen-value-for-defn): Fetch string name of self.
	* cos.scm (-class-list): Must quote empty list.
	(-class-parent-classes,-class-compute-class-desc): Ditto.
	(class-make,make,object-reset!): Ditto.
	(method-make-make!): Call eval1 instead of eval.
	(method-make-forward!,method-make-virtual-forward!): Ditto.
	* decode.scm (subdtable-add): Use stringsym-append instead of
	string-append.
	(-gen-exprtable-name): Fetch string name of exprtable-entry-insn.
	(-build-decode-table-entry): Fetch string name of insn.
	* desc-cpu.scm (-gen-isa-table-defns): Fetch string name of isa.
	(-gen-mach-table-defns): Ditto for mach.
	(gen-ifld-defns): Ditto for ifld.
	(gen-hw-table-defns): Ditto for hw.
	(gen-operand-table): Ditto for op.
	(gen-insn-table-entry): Ditto for insn.
	* desc.scm (gen-attr-table-defn): Ditto for attr.
	(<keyword>,gen-defn): Don't pass symbols to string-append.
	* enum.scm (parse-enum-vals): Use symbolstr-append instead of
	symbol-append.
	(enum-vals-upcase): Use symbol-upcase to build result.
	(-enum-parse): Use stringsym-append to build errtxt.
	* fixup.scm (*guile-major-version*,*guile-minor-version*): New globals.
	(eval1): New function.
	(symbol-bound?): Provide own version if >= guile 1.6.
	* hardware.scm (define-keyword): Use string-append instead of
	symbol-append.
	* html.scm (gen-html-header,gen-table-of-contents,gen-arch-intro,
	cgen.html,cgen-insn.html): Convert current-arch-name to a string
	before using.
	(gen-list-entry): Handle either symbol or string `name' arg.
	(gen-obj-doc-header): Fetch string name of `o' arg.
	(define-cpu-intro): Ditto for cpu.
	(gen-mach-intro): Ditto for mach.
	(gen-model-intro): Ditto for model.
	(gen-isa-intro): Ditto for isa.
	(gen-machine-doc-1): Ditto for isa.
	(gen-reg-doc-1): Convert mach to string first.
	(gen-insn-doc-1): Ditto.  Convert model/unit names to strings first.
	(gen-insn-doc-list): Fetch string name of mach.  Convert insn name
	to string first.
	(gen-insn-categories): Fetch string name of mach.  Convert
	enum-val-name to string first.
	(gen-insn-docs): Fetch string name of mach.
	* ifield.scm (ifld-ilk): Result is a string.
	* iformat.scm (-ifmt-search-key): Convert attr value to string first.
	Fetch string name of ifld.
	(-sfmt-search-key): Similarily for ifld and op.
	* insn.scm (syntax-make): Fetch string name of syntax element.
	* mach.scm (-cpu-parse): Use stringsym-append to build errtxt.
	* minsn.scm (minsn-make-alias): Fetch string name of minsn.
	* mode.scm (mode:c-type): Result is a string.
	(mode:enum): Fetch string name of mode.
	(-mode-parse): Use stringsym-append to build errtxt.
	* model.scm (model:enum): Fetch string name of model.
	(-model-parse): Use stringsym-append to build errtxt.
	(parse-insn-timing): Must quote empty list.
	* opc-itab.scm (-gen-minsn-table-entry): Fetch string name of minsn.
	(-gen-minsn-opcode-entry): Ditto.
	* opcodes.scm (<operand>,gen-function-name): `what' arg is a symbol,
	convert to string.
	(read-cpu.opc): Convert current-arch-name to a string before using.
	* operand.scm (<operand>,gen-pretty-name): Ensure `name' is a string.
	(<derived-operand>): Must quote empty list.
	(op-sort): Simplify, call alpha-sort-obj-list to do sort.
	* pgmr-tools.scm (pgmr-pretty-print-insn-value): Fetch string name
	of ifld.
	* pmacros.scm (-pmacro-build-lambda): Use eval1 instead of eval.
	(-pmacro-sym): Must convert symbols to strings before passing to
	string-append.
	(-pmacro-str): Ditto.
	(pmacros-init!): Use eval1 instead of eval.
	* read.scm (keep-mach-atlist?): Simplify, use bitset-attr->list.
	(keep-isa-atlist?): Ditto.
	(cmd-if): Use eval1 instead of eval.
	* rtl-c.scm (<c-expr>,get-name): Fetch string name of self.
	(-rtl-c-get): Fetch string name of src.
	(s-unop): Ditto for mode.
	(s-binop,s-binop-with-bit,s-shop,s-convop,s-cmpop): Ditto.
	(-gen-par-temp-defns,subword): Ditto.
	(join): Use stringsym-append instead of string-append.
	* rtl-traverse.scm (rtx-option?): Convert option to string first.
	(rtx-traverse-debug): Fetch string name of rtx-obj.
	* rtl.scm (def-rtx-node): Use eval1 instead of eval.
	(def-rtx-syntax-node,def-rtx-operand-node,def-rtx-macro-node): Ditto.
	(rtx-pretty-name): Result is a string.
	(-rtx-hw-name): Use symbolstr-append instead of symbol-append.
	* semantics.scm (semantic-compile): Simplify, use alpha-sort-obj-list.
	* sid-cpu.scm (cgen-write.cxx): Convert current-arch-name to a string
	before using.
	(-gen-sfrag-case): Fetch string name of user.
	* sid-model.scm (unit:enum): Fetch string name of unit.
	* sid.scm (<hw-memory>,cxmake-get): Fetch string name of mode.
	(<hw-memory>,gen-set-quiet): Ditto.
	(gen-mode-defs): Ditto.
	(sim-finish!): Convert current-arch-name to a string before using.
	* sim-cpu.scm (-gen-scache-semantic-fn): Fetch string name of insn.
	(-gen-no-scache-semantic-fn): Ditto.
	(cgen-defs.h): Fetch string name of isa.
	(cgen-read.c): Convert current-arch-name to a string before using.
	(cgen-write.c): Ditto.
	* sim-model.scm (unit:enum): Fetch string name of unit.
	(gen-model-fn-decls): Use stringsym-append instead of string-append.
	(-gen-model-timing-table): Fetch string name of model.
	(-gen-mach-model-table): Ditto.
	(-gen-mach-defns): Fetch string name of mach.
	* sim.scm (gen-reg-access-defn): Fetch string name of hw.
	(<hw-memory>,cxmake-get): Fetch string name of mode.
	(<hw-memory>,gen-set-quiet): Ditto.
	(gen-mode-defs): Ditto.
	(sim-finish!): Must quote empty list.
	* utils-cgen.scm (<ident>): Must quote empty list.
	(obj:str-name): New fn.
	(parse-comment): Result is a string.
	(parse-symbol): Result is a symbol.
	(parse-string): Result is a string.
	(keyword-list?): Convert arg to string before calling string-ref.
	(keyword-list->arg-list): Ditto.
	(gen-attr-name): Convert attr-name to string first.
	(alpha-sort-obj-list): Use symbol<? instead of string<?.
	* utils-gen.scm (attr-gen-decl): Fetch string name of attr.
	(gen-define-ifmt-ifields): Ditto for fld.
	* utils.scm (gen-c-symbol): Ensure str is a string before calling
	map-over-string.
	(gen-file-name): Ditto.
	(symbol-downcase,symbol-upcase,symbol<?): New fns.
	(stringsym-append,symbolstr-append,->string,->symbol): New fns.
	(reduce): Call eval1 instead of eval.
	* cpu/m32r.cpu (addi): Don't use `#.'.
@
text
@d370 1
a370 1
  (logit 1 "Generating " (gen-cpu-name) " model.c ...\n")
@


1.5
log
@	* Makefile.am (srcroot): New var.
	(html): New rule.
	* Makefile.in: Regenerate.
	* cgen-doc.scm: New file.
	* html.scm: New file.
	* gen-all-doc: New file.
	* dev.scm (cload): Handle DOC application.
	(load-doc): New fn.
	* machs.scm (machs-for-cpu): New fn.
	* model.scm (models-for-cpu): New fn.
	* utils.scm (gen-c-copyright): Renamed from gen-copyright.
	All uses updated.
	(iota): Rewrite to be identical to pmacro version.  All uses updated.
	* utils-cgen.scm (alpha-sort-obj-list): New fn.
@
text
@d9 1
a9 1
			       (string-upcase (obj:name (unit:model u)))
d11 1
a11 1
			       (string-upcase (obj:name u))))
d86 1
a86 1
				       (string-append
d101 1
a101 1
			   (string-append
d229 1
a229 1
   "/* Model timing data for `" (obj:name model) "'.  */\n\n"
d255 1
a255 1
				   "\"" (obj:name model) "\", "
d348 1
a348 1
  \"" (obj:name mach) "\", "
@


1.4
log
@2003-04-16  Dave Brolley  <brolley@@redhat.com>

        * doc/rtl.texi (Iiming): Correct example to use 'model-name'.
        * utils.scm (copyright-fsf): Update generate copyright years.
        (copyright-cygnus): Ditto.
        * sid.scm (-op-gen-set-trace): Generate code to fill in bitmask of modified
        operands.
        (-gen-arch-model-decls): Don't generate unit enum declaration or MAX_UNITS
        here.
        (<operand>'gen-profile-code): New parameter 'when'.
        (<iunit>'gen-profile-code): Ditto.
        (<insn>'gen-profile-code): Ditto.
        (<unit>'gen-profile-code): Ditto. Only generate 'referenced' and
        'insn_reference' for the 'after' function.
        * model.scm (unit:enum): Moved to sim-model.scm.
        * sim-model.scm (unit:enum): Moved from model.scm.
        * sid-decode.scm (-gen-scache-decls): Generate the 'written' field.
        * cgen-sid.scm (sim-arguments): Document the generation of model.h.
        * sid-model.scm (unit:enum): New version for sid.
        (gen-model-class-name): New function.
        (gen-model-unit-fn-decl): New function.
        (gen-model-fn-decls): Call gen-model-unit-fn-decl.
        (gen-model-unit-fn-name): New parameter 'when'.
        (-gen-model-insn-fn-name): Ditto.
        (-gen-model-insn-qualified-fn-name): New function.
        (-gen-model-insn-fn-decl): New function.
        (-gen-model-insn-fn-decls): New function.
        (-gen-model-insn-fn): New parameter 'when'. Call
        -gen-model-insn-qualified-fn-name.
        (-gen-model-insn-fns): Generate the constructor for the model. Generate
        functions for modelling insn before and after execution.
        (-gen-model-class-decls): New function.
        (" (gen-model-class-name model) "): New function.
        (gen-model-classes): New function.
        (-gen-insn-timing): Generate functions for modelling insn before and after
        execution.
        (-gen-insn-unit-timing): Generate class-qualified names.
        (-gen-model-timing-table): Ditto.
        (cgen-model.cxx): Generate #include for @@cpu@@.h. Omit generation of code
        not needed (yet) by sid.
        (cgen-model.h): New function.
@
text
@d378 1
a378 1
   (gen-copyright "Simulator model support for @@cpu@@."
@


1.3
log
@	Back out sim*.scm changes of 2001-04-02  Ben Elliston  <bje@@redhat.com>
	Instead do:
	* sim-decode.scm (-gen-decode-insn-globals): Use @@PREFIX@@_INSN__MAX
	as size of IDESC-TABLE-VAR.
	(@@prefix@@_init_idesc_table): Ditto.
	* sim-model.scm (-gen-mach-defns): Ditto.
	* sim.scm (gen-cpu-insn-enum-decl): Rename last elm from max to -max.

	* utils-scm.scm (-gen-decode-insn-entry): Fix some spacing in output.

	* insn.scm (-parse-insn-format-symbol): Improve error message.
	(-parse-insn-format): Ditto.
@
text
@d2 1
a2 1
; Copyright (C) 2000 Red Hat, Inc.
d6 7
@


1.2
log
@2001-04-02  Ben Elliston  <bje@@redhat.com>

	* sim-decode.scm (@@prefix@@_init_idesc_table): Compute tabsize
	using the size of the table and its elements.
	(-gen-decode-insn-globals): Define the idesc table's size to be
	the last instruction enum plus one, not @@PREFIX@@_INSN_MAX.
	* sim-model.scm (-gen-mach-defns): Define CPU_MAX_INSNS as the
	last instruction enum plus one, not @@CPU@@_INSN_MAX.
@
text
@d316 5
a320 7
  (let* ((insns (gen-obj-list-enums (non-multi-insns (current-insn-list))))
	 (last-insn (string-upcase (gen-c-symbol (caar (list-take -1 insns))))))
    (string-list-map
     (lambda (mach)
       (gen-obj-sanitize
	mach
	(string-list "\
d329 1
a329 1
  CPU_MAX_INSNS (cpu) = @@CPU@@_INSN_" last-insn " + 1;
d355 1
a355 1
   (current-mach-list)))
@


1.1
log
@Initial revision
@
text
@d316 7
a322 5
  (string-list-map
   (lambda (mach)
     (gen-obj-sanitize
      mach
      (string-list "\
d331 1
a331 1
  CPU_MAX_INSNS (cpu) = @@CPU@@_INSN_MAX;
d357 1
a357 1
   (current-mach-list))
@


1.1.1.1
log
@CGEN 1.0 import
@
text
@@
