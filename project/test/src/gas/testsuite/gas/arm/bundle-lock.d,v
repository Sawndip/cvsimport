head	1.1;
access;
symbols
	binutils-2_24-branch:1.1.0.4
	binutils-2_24-branchpoint:1.1
	binutils-2_23_2:1.1
	binutils-2_23_1:1.1
	binutils-2_23:1.1
	binutils-2_23-branch:1.1.0.2
	binutils-2_23-branchpoint:1.1
	binutils_latest_snapshot:1.1;
locks; strict;
comment	@# @;


1.1
date	2012.03.13.16.59.57;	author roland;	state Exp;
branches;
next	;


desc
@@


1.1
log
@gas/
2012-03-12  Roland McGrath  <mcgrathr@@google.com>

	* config/tc-arm.c (arm_frag_max_var): New function.
	* config/tc-arm.h: Declare it.
	(md_frag_max_var): New macro.

	* config/tc-i386.c (i386_frag_max_var): New function.
	* config/tc-i386.h: Declare it.
	(md_frag_max_var): New macro.

	* doc/as.texinfo (Bundle directives): New node.
	(Pseudo Ops): Add it to the menu.
	* NEWS: Mention new feature.
	* read.c [md_frag_max_var] (HANDLE_BUNDLE): New macro.
	[HANDLE_BUNDLE] (bundle_align_p2): New variable.
	[HANDLE_BUNDLE] (bundle_lock_frchain, bundle_lock_frag): New variables.
	[HANDLE_BUNDLE] (start_bundle, pending_bundle_size, finish_bundle):
	New functions.
	(assemble_one): New function if [HANDLE_BUNDLE], #define directly
	to md_assembly if not.
	(read_a_source_file): Call assemble_one in place of md_assemble.
	(read_a_source_file) [HANDLE_BUNDLE]: Check for unterminated
	.bundle_lock at end of processing.
	[HANDLE_BUNDLE] (s_bundle_align_mode, s_bundle_lock, s_bundle_unlock):
	New functions.
	[HANDLE_BUNDLE] (potable): Add their entries.
	* read.h: Declare new functions.

gas/testsuite/
2012-03-12  Roland McGrath  <mcgrathr@@google.com>

	* gas/i386/bundle-bad.s: New file.
	* gas/i386/bundle-bad.d: New file.
	* gas/i386/bundle-bad.l: New file.
	* gas/i386/i386.exp: Run it.

	* gas/arm/bundle.s: New file.
	* gas/arm/bundle.d: New file.
	* gas/arm/bundle-lock.s: New file.
	* gas/arm/bundle-lock.d: New file.

	* gas/i386/bundle.s: New file.
	* gas/i386/bundle.d: New file.
	* gas/i386/x86-64-bundle.s: New file.
	* gas/i386/x86-64-bundle.d: New file.
	* gas/i386/bundle-lock.s: New file.
	* gas/i386/bundle-lock.d: New file.
	* gas/i386/i386.exp: Run them.
@
text
@#name: ARM .bundle_lock
#as: -march=armv7-a
#objdump: -drw

.*: +file format .*arm.*

Disassembly of section \.text:

# This is testing the .bundle_lock feature, with 16-byte bundles.  To keep
# this file simple, we just verify that every 16-byte boundary appears in
# the disassembly as either bkpt (what we use for padding to the chosen
# offset) or adds (what we use at the beginning of each bundle-locked
# sequence).

0+0000 <arm_sequence_1_offset_0>:
#...
 *0:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *10:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *20:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *30:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *40:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *50:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *60:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *70:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *80:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *90:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *a0:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *b0:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *c0:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *d0:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *e0:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *f0:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *100:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *110:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *120:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *130:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *140:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
 *150:\s+(e1200070\s+bkpt|e0900001\s+adds)\s+.+
#...
0+160 <thumb_sequence_1_offset_0>:
 *160:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *170:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *180:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *190:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *1a0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *1b0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *1c0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *1d0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *1e0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *1f0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *200:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *210:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *220:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *230:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *240:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *250:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *260:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *270:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *280:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *290:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *2a0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *2b0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *2c0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *2d0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *2e0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *2f0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *300:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *310:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *320:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *330:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *340:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *350:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *360:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *370:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *380:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *390:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *3a0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *3b0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *3c0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *3d0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *3e0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *3f0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *400:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *410:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *420:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *430:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *440:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *450:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *460:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *470:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *480:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *490:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *4a0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *4b0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *4c0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *4d0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *4e0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *4f0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *500:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *510:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *520:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *530:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *540:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *550:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *560:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *570:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *580:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *590:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *5a0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *5b0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *5c0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *5d0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *5e0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *5f0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *600:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *610:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *620:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *630:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *640:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *650:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *660:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *670:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *680:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *690:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *6a0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *6b0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *6c0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *6d0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *6e0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *6f0:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *700:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *710:\s+(be00\s+bkpt|1840\s+adds)\s+.+
#...
 *720:\s+e1200070\s+bkpt\s+.+
#...
@
